var timer;var active_so_num;var active_room_id;var thisClick;function toggleDisplay(a){$(".room_line").removeClass("active_room_line");$("#"+active_room_id).addClass("active_room_line");$("[id^=tr_attachments_]").finish().hide(250);$("[id^=div_attachments_]").finish().hide(100);$("[id^=tr_edit_so_]").finish().hide(250);$("[id^=div_edit_so_]").finish().hide(100);$(".tr_room_actions").hide(300).find("div").slideUp(150).html("");$(".add_room").hide(300).find("div").slideUp(150).html("")}function scrollLocation(a){setTimeout(function(){$(window).scrollTo($(a),800,{offset:-125})},300)}$("body").on("keyup","#global_search",function(){checkTransition(function(){clearIntervals();var f=$("#search_display");var c=$("#main_display");var a=$("#global_search");var d=$("#search_results_table");var b='<tr><td colspan="7" class="text-md-center"><span id="global_search_status"><i class="fa fa-3x fa-spin fa-spinner" style="width: auto;margin-right: 10px;"></i></span></td></tr>';var e='<tr><td colspan="7">No results found.</td></tr>';c.attr("data-search","true");d.html(b);if(a.val().length>=3){scrollPosition=$(window).scrollTop();c.hide();f.show();clearTimeout(timer);timer=setTimeout(function(){if(a.val().length>=1){$.post("/html/search/so_list.php",{find:a.val()},function(g){d.html(g);$("#search_results_global_table").trigger("update");if(g!==""){$('[data-toggle="tooltip"]').tooltip();$(".delivery_date").datepicker({autoclose:true,todayHighlight:true})}else{d.html(e)}})}else{c.show();f.hide()}},100)}else{c.show();f.hide()}})}).on("keyup keypress","#global_search",function(a){if(a.keyCode===13){a.preventDefault();$("#global_search").trigger("keyup");return false}}).on("click","#global_search_button",function(){$("#global_search").trigger("keyup")}).on("click","#btn_search_to_main",function(){checkTransition(function(){backFromSearch()})}).on("click",".wc-edit-queue",function(){$("#global_search").val($(this).attr("id")).trigger("keyup")}).on("click","[id^=edit_so_]",function(a){thisClick=this;a.stopPropagation();checkTransition(function(){active_so_num=$(thisClick).attr("id").replace("edit_so_","");toggleDisplay();$("#tr_edit_so_"+active_so_num).show();$("#div_edit_so_"+active_so_num).slideDown(250)});scrollLocation("#show_room_"+active_so_num)}).on("click","[id^=show_room_]",function(){thisClick=this;checkTransition(function(){active_so_num=$(thisClick).attr("id").replace("show_room_","");toggleDisplay();$("#tr_room_"+active_so_num).show();$("#div_room_"+active_so_num).slideDown(250)})}).on("click",".edit_room",function(a){thisClick=this;a.stopPropagation();active_room_id=$(thisClick).attr("id");active_so_num=$(thisClick).data("sonum");checkTransition(function(){active_room_id=$(thisClick).attr("id");active_so_num=$(thisClick).data("sonum");toggleDisplay();$.post("/html/pricing/index.php?room_id="+active_room_id,function(b){$("#"+active_room_id+".tr_room_actions").show().find("div").html(b).slideDown(150)});scrollLocation("#"+active_room_id+".tr_room_actions")})}).on("click",".activate_op",function(){var g=$(this).data("opid");var c=$(this).data("roomid");var a=$(this).data("soid");var b=$(this).parent().data("opnum");var f=$(this).closest("ul").data("bracket");var e;var d="";if(String(b).slice(-2)!=="98"){d='<span class="pull-right cursor-hand text-md-center deactivate_op" data-opid="'+g+'" data-roomid="'+c+'" data-soid="'+a+'"> <i class="fa fa-arrow-circle-right" style="width: 18px;"></i></span>'}e='<li class="active_ops_'+c+'" id="active_ops_'+c+'" data-opnum="'+b+'" data-opid="'+g+'">';e+='<input type="radio" name="'+f+'" id="op_'+g+"_room_"+c+'" value="'+g+'">';e+='<label for="op_'+g+"_room_"+c+'">'+$(this).parent().text().trim()+"</label>";e+=d;e+="</li>";$("#activeops_"+c+"_"+f).append(e);tinysort("ul#activeops_"+c+"_"+f+">li",{data:"opnum"});$(this).parent().remove()}).on("click",".deactivate_op",function(){var f=$(this).data("opid");var c=$(this).data("roomid");var a=$(this).data("soid");var b=$(this).parent().data("opnum");var e=$(this).closest("ul").data("bracket");var d;d='<li class="inactive_ops_'+c+'" id="inactive_ops_'+c+'" data-opnum="'+b+'" data-opid="'+f+'">';d+='<span class="pull-left cursor-hand text-md-center activate_op" data-opid="'+f+'" data-roomid="'+c+'" data-soid="'+a+'" style="height:18px;width:18px;"> <i class="fa fa-arrow-circle-left" style="margin:5px;"></i></span>';d+='<label for="op_'+f+"_room_"+c+'">'+$(this).parent().text().trim()+"</label>";d+="</li>";$("#inactiveops_"+c+"_"+e).append(d);tinysort("ul#inactiveops_"+c+"_"+e+">li",{data:"opnum"});$(this).parent().remove()}).on("click",".edit_room_save",function(f){f.stopPropagation();var a=this;var d={};$(a).removeClass("edit_room_save");var c=$("#room_edit_"+active_room_id).serialize();var b=$(".active_ops_"+active_room_id).map(function(){return $(this).data("opid")}).get();b=JSON.stringify(b);$("input[type='hidden']").each(function(){var h=$(this);var i=$(this).attr("id");var e=["X","Xxx","AX","DX","TX","Xx","WX","1cXXXX","3gXXXX","HW","KW"];if($.inArray(h.val(),e)>=0){d[i]={};h.parent().find(".selected").find("input").each(function(){d[i][$(this).attr("name")]=$(this).val()})}});var g=JSON.stringify(d);$.post("/ondemand/room_actions.php?action=update_room",{active_ops:b,customVals:g,editInfo:c},function(e){$("body").append(e)}).done(function(){$(a).addClass("edit_room_save");$("#room_notes").val("")});unsaved=false}).on("click",".add_iteration",function(b){thisClick=this;var a;b.stopPropagation();checkTransition(function(){active_room_id=$(thisClick).data("roomid");active_so_num=$(thisClick).data("sonum");var d;var c;var e;if($(thisClick).data("addto")==="sequence"){d=$.post("/ondemand/play_fetch.php?action=get_next_iteration&output=sequence&roomid="+active_room_id,function(f){a=f});e="Adding Sequence"}else{c=$.post("/ondemand/play_fetch.php?action=get_next_iteration&output=iteration&roomid="+active_room_id,function(f){a=f});e="Adding Iteration"}$.when(d,c).done(function(){toggleDisplay();$.post("/html/search/room_add_section.php?room_id="+active_room_id,function(f){$("#"+active_room_id+".tr_room_actions").show().find("div").html(f).slideDown(150);$("#add_iteration_header_"+active_room_id).html(e);$("#edit_iteration_"+active_room_id).attr("value",a);$("#vin_iteration_"+active_room_id).val(a)})})});scrollLocation("#"+active_room_id+".tr_room_actions")}).on("click",".iteration_save",function(c){c.stopPropagation();if($("input[name='room_name']").val()===""){$.confirm({title:"Unable to Save",content:"Cannot save with no room name!",buttons:{ok:function(){}}})}else{var b=$("#add_iteration").serialize();var a=$(".active_ops").map(function(){return $(this).data("opid")}).get();a=JSON.stringify(a);$.post("/ondemand/room_actions.php?action=create_room",{active_ops:a,editInfo:b},function(d){$("body").append(d)});unsaved=false}}).on("click",".save_so",function(){var a=$("#form_so_"+active_so_num).serialize();$.post("/ondemand/so_actions.php?action=save_so&"+a+"&so_num="+active_so_num,function(b){$("body").append(b)});unsaved=false}).on("click",".reply_to_inquiry",function(b){b.preventDefault();var a=$(this).attr("id");$("[id^=inquiry_reply_line_]").not("#inquiry_reply_line_"+a).hide(100);$("#inquiry_reply_line_"+a).toggle(250)}).on("click",".inquiry_reply_btn",function(){var a=$(this).attr("id");var b=$("#inquiry_reply_"+a).val();$.post("/ondemand/so_actions.php?action=reply_inquiry",{reply:b,id:a},function(c){$("body").append(c);$("#inquiry_reply_line_"+a).val("").hide(100)});unsaved=false}).on("click","[id^=show_vin_]",function(a){thisClick=this;a.stopPropagation();checkTransition(function(){active_so_num=$(thisClick).attr("id").replace("show_vin_room_","");toggleDisplay();$("#tr_vin_"+active_so_num).show();$("#div_vin_"+active_so_num).slideDown(250)})}).on("click","[id^=show_attachments_room_]",function(a){thisClick=this;a.stopPropagation();checkTransition(function(){active_room_id=$(thisClick).attr("id").replace("show_attachments_room_","");toggleDisplay();$("#tr_attachments_"+active_room_id).show();$("#div_attachments_"+active_room_id).slideDown(250);setTimeout(function(){$(window).scrollTo($("#show_single_room_"+active_room_id),800,{offset:-100})},300)})}).on("click","[id^=print_]",function(a){thisClick=this;a.stopPropagation();checkTransition(function(){active_room_id=$(thisClick).attr("id").replace("print_","");toggleDisplay();$("#tr_print_"+active_room_id).show();$("#div_print_"+active_room_id).slideDown(250);setTimeout(function(){$(window).scrollTo($("#show_single_room_"+active_room_id),800,{offset:-100})},300)})}).on("click","#add_attachment",function(){$("#modalAddAttachment").modal("show")}).on("click","#submit_attachments",function(c){c.stopPropagation();var d=$("#r_attachments_footer");var a=$(this).parent().html();d.html("");var b=new FormData($("#room_attachments")[0]);b.append("roomid",active_room_id);$.ajax({url:"/ondemand/room_actions.php?action=upload_attachment",xhr:function(){var e=new window.XMLHttpRequest();e.upload.addEventListener("progress",function(f){if(f.lengthComputable){var g=f.loaded/f.total;g=parseInt(g*100);d.html(g+"%");if(g===100){d.html(a);$("#modalAddAttachment").modal("hide")}}},false);return e},type:"POST",data:b,cache:false,processData:false,contentType:false,success:function(e){$("body").append(e)}});unsaved=false}).on("click","#copy_vin",function(){var b=$("#copy_vin_target").find(":selected").text();var a=$(this);$.confirm({title:"Are you sure you want to copy this VIN?",content:"You are overwriting <strong>ALL</strong> VIN information located at "+b+" - please confirm you wish to proceed.",buttons:{confirm:function(){var d=$(a).data("roomid");var c=$("#copy_vin_target").find(":selected").val();console.log("Copy From: "+d+", Copy To: "+c);$.post("/ondemand/room_actions.php?action=copy_vin",{copy_from:d,copy_to:c},function(e){$("body").append(e)})},cancel:function(){}}})}).on("change","input[name='note_type']",function(){var b=$("#room_notes");var a=$("#note_id");switch($(this).val()){case"room_note":b.val("").focus();a.val("");break;case"delivery_note":$.post("/ondemand/play_fetch.php?action=get_note&room_id="+active_room_id+"&note_type=room_note_delivery",function(d){if(d!==""){var c=JSON.parse(d);a.val(c.id);b.val(c.note).focus()}else{b.val("").focus();a.val("")}});break;case"global_note":$.post("/ondemand/play_fetch.php?action=get_note&room_id="+active_room_id+"&note_type=room_note_global",function(d){if(d!==""){var c=JSON.parse(d);a.val(c.id);b.val(c.note).focus()}else{b.val("").focus();a.val("")}});break;case"fin_sample_note":$.post("/ondemand/play_fetch.php?action=get_note&room_id="+active_room_id+"&note_type=room_note_fin_sample",function(d){if(d!==""){var c=JSON.parse(d);a.val(c.id);b.val(c.note).focus()}else{b.val("").focus();a.val("")}});break;default:b.val("").focus();a.val("");break}}).on("change","#hide_empty_fields",function(){if($(this).is(":checked")){$("input[value='']").show();$(".s_addr_empty").show();$(".con_empty").show();$(".billing_empty").show()}else{$("input[value='']").hide();if(!$("#secondary_addr_chk").is(":checked")){$(".s_addr_empty").hide()}if(!$("#contractor_chk").is(":checked")){$(".con_empty").hide()}if(!$("#billing_addr_chk").is(":checked")){$(".billing_empty").hide()}}}).on("click","#appliance_worksheets",function(a){thisClick=this;checkTransition(function(){active_room_id=$(thisClick).data("roomid");toggleDisplay();setTimeout(function(){$.post("/html/search/appliance_ws.php?room_id="+active_room_id+"&id=1",function(b){$("#"+active_room_id+".tr_room_actions").show().find("div").html(b).slideDown(150)});scrollLocation("#"+active_room_id+".tr_room_actions")},350)})}).on("change","#sheet_type",function(){$.post("/html/search/appliance_ws_info.php?room_id="+active_room_id+"&id="+$(this).val(),function(a){$(".sheet_data").html(a);$(":input","#appliance_info").not(":button, :submit, :reset, :hidden, select").val("")})}).on("click",".appliance_ws_save",function(a){a.stopPropagation();var b=$("#appliance_info").serialize();$.post("/ondemand/room_actions.php?action=save_app_worksheet&room="+active_room_id+"&"+b,function(c){if(c!=="false"){$(".print_app_ws").attr("id",c);displayToast("success","Successfully saved worksheet information.","Worksheet Saved")}else{displayToast("error","Unable to save worksheet. Please refresh your page.","Unable to Save")}});unsaved=false}).on("click",".load_app_worksheet",function(a){a.stopPropagation();var b=$(this).attr("id");$.post("/ondemand/room_actions.php?action=load_app_worksheet&id="+b,function(e){var c=JSON.parse(e);var d=JSON.parse(c.values);$("#sheet_type").val(c.spec).trigger("change");$(".print_app_ws").attr("id",c.id);setTimeout(function(){$.each(d,function(f,g){$("#"+f).val(g)});$("#notes").val(c.notes)},150)})}).on("click",".print_app_ws",function(a){a.stopPropagation();var b=$(this).attr("id");$(".appliance_ws_save").trigger("click");window.open("/print/appliance_spec.php?ws_id="+b,"_blank")}).on("click","#generate_code",function(b){var a=$(this).data("so");$.ajax({url:"/ondemand/so_actions.php?action=generate_code&so_num="+a,dataType:"text",async:false,processData:false,contentType:false,type:"POST",success:function(c){let copyFrom=document.createElement("textarea");document.body.appendChild(copyFrom);copyFrom.textContent="https://dev.3erp.us/dealer/index.php?key="+c;copyFrom.select();document.execCommand("copy");copyFrom.remove();displayToast("success","Copied code to clipboard!","Code Copied")}})}).on("click","#submit_quote",function(a){a.stopPropagation();$(".edit_room_save").trigger("click");if($("#vin_code_"+active_room_id).val().indexOf("?")>-1){displayToast("error","Unable to submit while there are still TBD VIN items.","Unable to Submit")}else{$.post("/ondemand/room_actions.php?action=submit_quote",{roomid:active_room_id},function(b){$("body").append(b)})}});$(document).on("scroll",function(){$(".dropdown_options").hide()});