var timer;var active_so_num;var active_room_id;var thisClick;$("body").on("keyup","#global_search",function(){checkTransition(function(){globalFunctions.clearIntervals();let searchDisplay=$("#search_display");let input=$("#global_search");let mainDisplay=$("#main_display");let loading_spinner='<div class="text-md-center" style="color:#FFF;"><span id="global_search_status"><i class="fa fa-3x fa-spin fa-spinner" style="width: auto;margin-right: 10px;"></i></span></div>';mainDisplay.attr("data-search","true");searchDisplay.html(loading_spinner);if(input.val().length>=3){scrollPosition=$(window).scrollTop();mainDisplay.hide();searchDisplay.show();clearTimeout(timer);timer=setTimeout(function(){if(input.val().length>=1){$.post("/html/search/search_results.php",{find:input.val()},function(a){searchDisplay.html(a)})}else{mainDisplay.show();searchDisplay.hide()}},100)}else{mainDisplay.show();searchDisplay.hide()}})}).on("keyup keypress","#global_search",function(a){if(a.keyCode===13){a.preventDefault();$("#global_search").trigger("keyup");return false}}).on("click","#global_search_button",function(){$("#global_search").trigger("keyup")}).on("click","#btn_search_to_main",function(){checkTransition(function(){globalFunctions.backFromSearch()})}).on("click",".wc-edit-queue",function(){$("#global_search").val($(this).attr("id")).trigger("keyup")}).on("click","#edit_so",function(a){$(this).find("i").removeClass("zmdi zmdi-edit").addClass("fa fa-spin fa-spinner");let thisClick=this;active_so_num=$(this).attr("data-sonum");let container=$(this).parents().eq(3).find(".edit_so");a.stopPropagation();checkTransition(function(){if(container.is(":visible")){container.html("").hide();$(thisClick).find("i").removeClass("fa fa-spin fa-spinner").addClass("zmdi zmdi-edit")}else{$(".edit_so").html("").hide();$.get("/html/search/ajax/edit_so.php",{so_num:active_so_num},function(b){container.html(b).show()}).done(function(){$(thisClick).find("i").removeClass("fa fa-spin fa-spinner").addClass("zmdi zmdi-edit")})}})}).on("click","[id^=show_room_]",function(){thisClick=this;checkTransition(function(){active_so_num=$(thisClick).attr("id").replace("show_room_","");$("#tr_room_"+active_so_num).show();$("#div_room_"+active_so_num).slideDown(250)})}).on("click",".edit_room",function(a){$(this).find("i").removeClass("zmdi zmdi-edit").addClass("fa fa-spin fa-spinner");let thisClick=this;active_room_id=$(this).attr("id");active_so_num=$(this).attr("data-sonum");let roomSearchTable=searchTable[active_so_num];let tr=$(this).closest("tr");let row=roomSearchTable.row(tr);a.stopPropagation();checkTransition(function(){if(row.child.isShown()){row.child("").hide();tr.removeClass("shown");$(thisClick).find("i").removeClass("fa fa-spin fa-spinner").addClass("zmdi zmdi-edit")}else{roomSearchTable.rows().every(function(){if(this.child.isShown()){this.child("").hide();$(this.node()).removeClass("shown")}});$.get("/html/pricing/index.php",{room_id:active_room_id},function(b){row.child(b,"no-row-hover").show();tr.addClass("shown")}).done(function(){$(thisClick).find("i").removeClass("fa fa-spin fa-spinner").addClass("zmdi zmdi-edit")})}})}).on("click",".activate_op",function(){var h=$(this).data("opid");var c=$(this).data("roomid");var a=$(this).data("soid");var b=$(this).parent().data("opnum");var g=$(this).closest("ul").data("bracket");var f;var e="";if(String(b).slice(-2)!=="98"){e='<span class="pull-right cursor-hand text-md-center deactivate_op" data-opid="'+h+'" data-roomid="'+c+'" data-soid="'+a+'"> <i class="fa fa-arrow-circle-right" style="width: 18px;"></i></span>'}f='<li class="active_ops_'+c+'" id="active_ops_'+c+'" data-opnum="'+b+'" data-opid="'+h+'">';f+='<input type="radio" name="'+g+'" id="op_'+h+"_room_"+c+'" value="'+h+'">';f+='<label for="op_'+h+"_room_"+c+'">'+$(this).parent().text().trim()+"</label>";f+=e;f+="</li>";$("#activeops_"+c+"_"+g).append(f);tinysort("ul#activeops_"+c+"_"+g+">li",{data:"opnum"});$(this).parent().remove()}).on("click",".deactivate_op",function(){var g=$(this).data("opid");var c=$(this).data("roomid");var a=$(this).data("soid");var b=$(this).parent().data("opnum");var f=$(this).closest("ul").data("bracket");var e;e='<li class="inactive_ops_'+c+'" id="inactive_ops_'+c+'" data-opnum="'+b+'" data-opid="'+g+'">';e+='<span class="pull-left cursor-hand text-md-center activate_op" data-opid="'+g+'" data-roomid="'+c+'" data-soid="'+a+'" style="height:18px;width:18px;"> <i class="fa fa-arrow-circle-left" style="margin:5px;"></i></span>';e+='<label for="op_'+g+"_room_"+c+'">'+$(this).parent().text().trim()+"</label>";e+="</li>";$("#inactiveops_"+c+"_"+f).append(e);tinysort("ul#inactiveops_"+c+"_"+f+">li",{data:"opnum"});$(this).parent().remove()}).on("click",".save_so",function(){var a=$("#form_so_"+active_so_num).serialize();$.post("/ondemand/so_actions.php?action=save_so&"+a+"&so_num="+active_so_num,function(b){$("body").append(b)});let note=$("#inquiry").val();if(note!==""){let d=new Date();let month=d.getMonth()+1;let date=month+"/"+d.getDate()+"/"+d.getFullYear();let hours=d.getHours();let mins=d.getMinutes();let secs=d.getSeconds();let am_pm=null;if(hours<12){am_pm="AM"}else{am_pm="PM"}if(hours===0){hours=12}if(hours>12){hours=hours-12}mins=mins+"";if(mins.length===1){mins="0"+mins}secs=secs+"";if(secs.length===1){secs="0"+secs}let time=hours+":"+mins+":"+secs+" "+am_pm;let followup_on=$("#inquiry_followup_date").val();let followup_by=$("#inquiry_requested_of :selected").text();let followup="";if(followup_on!==""){followup="(Followup by "+followup_by+" on "+followup_on+")"}let output='<tr><td width="26px" style="padding-right:5px;"><button class="btn waves-effect btn-primary pull-right reply_to_inquiry" id="10381"> <i class="zmdi zmdi-mail-reply"></i> </button></td>  <td>'+note+" -- <small><em>"+nameOfUser+" on "+date+" "+time+" "+followup+' </em></small></td></tr><tr style="height:2px;"><td colspan="2" style="background-color:#000;"></td></tr><tr style="height:5px;"><td colspan="2"></td></tr>';$(".so_note_box table tr:eq(2)").before(output);$("#inquiry").val("");$("#inquiry_followup_date").val("");$("#inquiry_requested_of").val("null")}unsaved=false}).on("click",".reply_to_inquiry",function(b){b.preventDefault();var a=$(this).attr("id");$("[id^=inquiry_reply_line_]").not("#inquiry_reply_line_"+a).hide(100);$("#inquiry_reply_line_"+a).toggle(250)}).on("click",".inquiry_reply_btn",function(){var a=$(this).attr("id");var b=$("#inquiry_reply_"+a).val();$.post("/ondemand/so_actions.php?action=reply_inquiry",{reply:b,id:a},function(c){$("body").append(c);$("#inquiry_reply_line_"+a).val("").hide(100)});unsaved=false}).on("click","[id^=show_attachments_room_]",function(a){thisClick=this;a.stopPropagation();checkTransition(function(){active_room_id=$(thisClick).attr("id").replace("show_attachments_room_","");$("#tr_attachments_"+active_room_id).show();$("#div_attachments_"+active_room_id).slideDown(250);setTimeout(function(){$(window).scrollTo($("#show_single_room_"+active_room_id),800,{offset:-100})},300)})}).on("click","#add_attachment",function(){$("#modalAddAttachment").modal("show")}).on("click","#submit_attachments",function(c){c.stopPropagation();var f=$("#r_attachments_footer");var a=$(this).parent().html();f.html("");var b=new FormData($("#room_attachments")[0]);b.append("roomid",active_room_id);$.ajax({url:"/ondemand/room_actions.php?action=upload_attachment",xhr:function(){var e=new window.XMLHttpRequest();e.upload.addEventListener("progress",function(g){if(g.lengthComputable){var h=g.loaded/g.total;h=parseInt(h*100);f.html(h+"%");if(h===100){f.html(a);$("#modalAddAttachment").modal("hide")}}},false);return e},type:"POST",data:b,cache:false,processData:false,contentType:false,success:function(e){$("body").append(e)}});unsaved=false}).on("change","input[name='note_type']",function(){var b=$("#room_notes");var a=$("#note_id");switch($(this).val()){case"room_note":b.val("").focus();a.val("");break;case"delivery_note":$.post("/ondemand/play_fetch.php?action=get_note&room_id="+active_room_id+"&note_type=room_note_delivery",function(e){if(e!==""){var c=JSON.parse(e);a.val(c.id);b.val(c.note).focus()}else{b.val("").focus();a.val("")}});break;case"global_note":$.post("/ondemand/play_fetch.php?action=get_note&room_id="+active_room_id+"&note_type=room_note_global",function(e){if(e!==""){var c=JSON.parse(e);a.val(c.id);b.val(c.note).focus()}else{b.val("").focus();a.val("")}});break;case"fin_sample_note":$.post("/ondemand/play_fetch.php?action=get_note&room_id="+active_room_id+"&note_type=room_note_fin_sample",function(e){if(e!==""){var c=JSON.parse(e);a.val(c.id);b.val(c.note).focus()}else{b.val("").focus();a.val("")}});break;default:b.val("").focus();a.val("");break}}).on("change","#hide_empty_fields",function(){if($(this).is(":checked")){$("input[value='']").show();$(".s_addr_empty").show();$(".con_empty").show();$(".billing_empty").show()}else{$("input[value='']").hide();if(!$("#secondary_addr_chk").is(":checked")){$(".s_addr_empty").hide()}if(!$("#contractor_chk").is(":checked")){$(".con_empty").hide()}if(!$("#billing_addr_chk").is(":checked")){$(".billing_empty").hide()}}}).on("click","#generate_code",function(b){var a=$(this).data("so");$.ajax({url:"/ondemand/so_actions.php?action=generate_code&so_num="+a,dataType:"text",async:false,processData:false,contentType:false,type:"POST",success:function(c){let copyFrom=document.createElement("textarea");document.body.appendChild(copyFrom);copyFrom.textContent="https://dev.3erp.us/dealer/index.php?key="+c;copyFrom.select();document.execCommand("copy");copyFrom.remove();displayToast("success","Copied code to clipboard!","Code Copied")}})}).on("click",".add_room_trigger",function(a){a.stopPropagation();active_so_num=$(this).attr("data-sonum");$.post("/html/search/modal/add_room.php",{addType:"room",so_num:active_so_num},function(b){$("#modalAddRoom").html(b).modal("show")})}).on("click","#modalAddRoomCreate",function(){let room_data=$("#modalAddRoomData").serialize();$.post("/html/search/ajax/room_actions.php?action=add_new_room",{data:room_data},function(a){$("body").append(a)});$("#modalAddRoom").modal("hide");unsaved=false}).on("click",".add_iteration",function(a){thisClick=this;a.stopPropagation();checkTransition(function(){active_room_id=$(thisClick).attr("data-roomid");active_so_num=$(thisClick).attr("data-sonum");let addTo=$(thisClick).attr("data-addto");console.log(active_so_num);$.post("/html/search/modal/add_room.php",{so_num:active_so_num,addType:addTo,room_id:active_room_id},function(b){$("#modalAddRoom").html(b).modal("show")})})}).on("click",".iteration_save",function(c){c.stopPropagation();if($("input[name='room_name']").val()===""){$.confirm({title:"Unable to Save",content:"Cannot save with no room name!",buttons:{ok:function(){}}})}else{var b=$("#add_iteration").serialize();var a=$(".active_ops").map(function(){return $(this).data("opid")}).get();a=JSON.stringify(a);$.post("/ondemand/room_actions.php?action=create_room",{active_ops:a,editInfo:b},function(e){$("body").append(e)});unsaved=false}});