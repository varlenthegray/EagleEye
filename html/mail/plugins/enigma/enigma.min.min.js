window.rcmail&&rcmail.addEventListener("init",function(b){if(rcmail.env.task=="settings"){if(rcmail.gui_objects.keyslist){rcmail.keys_list=new rcube_list_widget(rcmail.gui_objects.keyslist,{multiselect:true,draggable:false,keyboard:false});rcmail.keys_list.addEventListener("select",function(a){rcmail.enigma_keylist_select(a)}).addEventListener("keypress",function(a){rcmail.enigma_keylist_keypress(a)}).init().focus();rcmail.enigma_list();rcmail.register_command("firstpage",function(a){return rcmail.enigma_list_page("first")});rcmail.register_command("previouspage",function(a){return rcmail.enigma_list_page("previous")});rcmail.register_command("nextpage",function(a){return rcmail.enigma_list_page("next")});rcmail.register_command("lastpage",function(a){return rcmail.enigma_list_page("last")})}if(rcmail.env.action=="plugin.enigmakeys"){rcmail.register_command("search",function(a){return rcmail.enigma_search(a)},true);rcmail.register_command("reset-search",function(a){return rcmail.enigma_search_reset(a)},true);rcmail.register_command("plugin.enigma-import",function(){rcmail.enigma_import()},true);rcmail.register_command("plugin.enigma-import-search",function(){rcmail.enigma_import_search()},true);rcmail.register_command("plugin.enigma-key-export",function(){rcmail.enigma_export()});rcmail.register_command("plugin.enigma-key-export-selected",function(){rcmail.enigma_export(true)});rcmail.register_command("plugin.enigma-key-import",function(){rcmail.enigma_key_import()},true);rcmail.register_command("plugin.enigma-key-delete",function(a){return rcmail.enigma_delete()});rcmail.register_command("plugin.enigma-key-create",function(a){return rcmail.enigma_key_create()},true);rcmail.register_command("plugin.enigma-key-save",function(a){return rcmail.enigma_key_create_save()},true);rcmail.addEventListener("responseafterplugin.enigmakeys",function(){rcmail.enable_command("plugin.enigma-key-export",rcmail.env.rowcount>0)});if(rcmail.gui_objects.importform){$("#rcmimportsearch").keydown(function(a){if(a.which==13){rcmail.enigma_import_search();return false}});$('input[type="button"]:first').focus()}}}else{if(rcmail.env.task=="mail"){if(rcmail.env.action=="compose"){rcmail.addEventListener("beforesend",function(a){rcmail.enigma_beforesend_handler(a)}).addEventListener("beforesavedraft",function(a){rcmail.enigma_beforesavedraft_handler(a)});$("input,label",$("#enigmamenu")).mouseup(function(a){a.stopPropagation()});$("a.button.enigma").prop("tabindex",$("#messagetoolbar > a:first").prop("tabindex"))}$.each(["encrypt","sign"],function(){if(rcmail.env["enigma_force_"+this]){$('[name="_enigma_'+this+'"]').prop("checked",true)}});if(rcmail.env.enigma_password_request){rcmail.enigma_password_request(rcmail.env.enigma_password_request)}}}});rcube_webmail.prototype.enigma_key_import=function(){this.enigma_loadframe("&_action=plugin.enigmakeys&_a=import")};rcube_webmail.prototype.enigma_key_create=function(){this.enigma_loadframe("&_action=plugin.enigmakeys&_a=create")};rcube_webmail.prototype.enigma_key_create_save=function(){var l,j,i=[],g=$("#key-pass").val(),h=$("#key-pass-confirm").val(),k=$("#key-size").val();$('[name="identity[]"]:checked').each(function(){i.push({name:$(this).data("name")||"",email:$(this).data("email")})});if(!g||!h){return alert(this.get_label("enigma.formerror"))}if(g!=h){return alert(this.get_label("enigma.passwordsdiffer"))}if(!i.length){return alert(this.get_label("enigma.noidentselected"))}if(window.openpgp&&(window.msCrypto||(window.crypto&&(window.crypto.getRandomValues||window.crypto.subtle)))){j=this.set_busy(true,"enigma.keygenerating");l={numBits:k,userIds:i,passphrase:g};openpgp.generateKey(l).then(function(b){var a={_a:"import",_keys:b.privateKeyArmored,_generated:1,_passwd:g,_keyid:b.key.primaryKey.fingerprint};rcmail.http_post("plugin.enigmakeys",a,j)},function(a){console.error(a);rcmail.set_busy(false,null,j);rcmail.display_message(rcmail.get_label("enigma.keygenerateerror"),"error")})}else{rcmail.display_message(rcmail.get_label("enigma.keygennosupport"),"error")}};rcube_webmail.prototype.enigma_key_create_success=function(){parent.rcmail.enigma_list(1)};rcube_webmail.prototype.enigma_delete=function(){var f=this.keys_list.get_selection();if(!f.length||!confirm(this.get_label("enigma.keyremoveconfirm"))){return}var d=this.display_message(this.get_label("enigma.keyremoving"),"loading"),e={_a:"delete",_keys:f};this.http_post("plugin.enigmakeys",e,d)};rcube_webmail.prototype.enigma_export=function(j){var f=false,h=this.keys_list,i=j?h.get_selection().join(","):"*",g={_keys:i};if(!i.length){return}if(i=="*"){f=true}else{$.each(h.get_selection(),function(){flags=$(h.rows[this].obj).data("flags");if(flags&&flags.indexOf("p")>=0){f=true;return false}})}if(f){return this.show_popup_dialog(this.get_label("enigma.keyexportprompt"),this.get_label("enigma.exportkeys"),[{text:this.get_label("enigma.onlypubkeys"),click:function(a){rcmail.enigma_export_submit(g);$(this).remove()}},{text:this.get_label("enigma.withprivkeys"),click:function(a){g._priv=1;rcmail.enigma_export_submit(g);$(this).remove()}}],{width:400})}this.enigma_export_submit(g)};rcube_webmail.prototype.enigma_export_submit=function(h){var g="keyexport-"+new Date().getTime(),e=$("<form>").attr({target:g,method:"post",style:"display:none",action:"?_action=plugin.enigmakeys&_task=settings&_a=export"}),f=$("<iframe>").attr({name:g,style:"display:none"});e.append($("<input>").attr({name:"_token",value:this.env.request_token}));$.each(h,function(a,b){e.append($("<input>").attr({name:a,value:b}))});f.appendTo(document.body);e.appendTo(document.body).submit()};rcube_webmail.prototype.enigma_import=function(){var i,f,g,h="keyexport-"+new Date().getTime(),j=$("<iframe>").attr({name:h,style:"display:none"});if(i=this.gui_objects.importform){f=document.getElementById("rcmimportfile");if(f&&!f.value){alert(this.get_label("selectimportfile"));return}g=this.set_busy(true,"importwait");j.appendTo(document.body);$(i).attr({target:h,action:this.add_url(i.action,"_unlock",g)}).submit()}};rcube_webmail.prototype.enigma_import_search=function(){var c,d;if(c=this.gui_objects.importform){d=$("#rcmimportsearch").val();if(!d){return}this.enigma_find_publickey(d)}};rcube_webmail.prototype.enigma_keylist_select=function(d){var f=d.get_single_selection(),e;if(f){e="&_action=plugin.enigmakeys&_a=info&_id="+f}this.enigma_loadframe(e);this.enable_command("plugin.enigma-key-delete","plugin.enigma-key-export-selected",d.selection.length>0)};rcube_webmail.prototype.enigma_keylist_keypress=function(b){if(b.modkey==CONTROL_KEY){return}if(b.key_pressed==b.DELETE_KEY||b.key_pressed==b.BACKSPACE_KEY){this.command("plugin.enigma-key-delete")}else{if(b.key_pressed==33){this.command("previouspage")}else{if(b.key_pressed==34){this.command("nextpage")}}}};rcube_webmail.prototype.enigma_loadframe=function(d){var c;if(c=this.get_frame_window(this.env.contentframe)){if(!d){if(c.location&&c.location.href.indexOf(this.env.blankpage)<0){c.location.href=this.env.blankpage}if(this.env.frame_lock){this.set_busy(false,null,this.env.frame_lock)}return}this.env.frame_lock=this.set_busy(true,"loading");c.location.href=this.env.comm_path+"&_framed=1"+d}};rcube_webmail.prototype.enigma_search=function(d){if(!d&&this.gui_objects.qsearchbox){d=this.gui_objects.qsearchbox.value}if(d||this.env.search_request){var f={_a:"search",_q:d},e=this.set_busy(true,"searching");this.env.current_page=1;this.enigma_loadframe();this.enigma_clear_list();this.http_post("plugin.enigmakeys",f,e)}return false};rcube_webmail.prototype.enigma_search_reset=function(c){var d=this.env.search_request;this.reset_qsearch();if(d){this.enigma_loadframe();this.enigma_clear_list();this.enigma_list()}return false};rcube_webmail.prototype.enigma_list=function(h,e){if(this.is_framed()){return parent.rcmail.enigma_list(h,e)}var g={_a:"list"},f=this.set_busy(true,"loading");this.env.current_page=h?h:1;if(this.env.search_request){g._q=this.env.search_request}if(h){g._p=h}this.enigma_clear_list(e);this.http_post("plugin.enigmakeys",g,f)};rcube_webmail.prototype.enigma_list_page=function(b){if(b=="next"){b=this.env.current_page+1}else{if(b=="last"){b=this.env.pagecount}else{if(b=="prev"&&this.env.current_page>1){b=this.env.current_page-1}else{if(b=="first"&&this.env.current_page>1){b=1}}}}this.enigma_list(b)};rcube_webmail.prototype.enigma_clear_list=function(b){if(b!==false){this.enigma_loadframe()}if(this.keys_list){this.keys_list.clear(true)}this.enable_command("plugin.enigma-key-delete","plugin.enigma-key-delete-selected",false)};rcube_webmail.prototype.enigma_add_list_row=function(o){if(!this.gui_objects.keyslist||!this.keys_list){return false}var m=this.keys_list,i=this.gui_objects.keyslist.tBodies[0],n=i.rows.length,k=n%2,p="message"+(k?" even":" odd"),l=document.createElement("tr"),j=document.createElement("td");l.id="rcmrow"+o.id;l.className=p;if(o.flags){$(l).data("flags",o.flags)}j.innerHTML=o.name;l.appendChild(j);m.insert_row(l)};rcube_webmail.prototype.enigma_beforesend_handler=function(b){this.env.last_action="send";this.enigma_compose_handler(b)};rcube_webmail.prototype.enigma_beforesavedraft_handler=function(b){this.env.last_action="savedraft";this.enigma_compose_handler(b)};rcube_webmail.prototype.enigma_compose_handler=function(d){var c=this.gui_objects.messageform;$("#enigmamenu input").each(function(){var a=this.id+"_cpy",b=$("#"+a);if(!b.length){b=$(this).clone();b.prop({id:a,type:"hidden"}).appendTo(c)}b.val(this.checked?"1":"")});if(this.env.last_action=="savedraft"){$('input[name="_enigma_sign"]',c).val(0)}};rcube_webmail.prototype.enigma_import_attachment=function(f){var d=this.set_busy(true,"loading"),e={_uid:this.env.uid,_mbox:this.env.mailbox,_part:f};this.http_post("plugin.enigmaimport",e,d);return false};rcube_webmail.prototype.enigma_password_request=function(l){if(!l||!l.keyid){return}var g=this,j=this.get_label("enigma.enterkeypass"),h=$('<div class="prompt">'),k=$('<div class="message">').appendTo(h),i=$("<input>").attr({type:"password",size:30}).keypress(function(a){if(a.which==13){(g.is_framed()?window.parent.$:$)(".ui-dialog-buttonpane button.mainaction:visible").click()}}).appendTo(h);l.key=l.keyid;if(l.keyid.length>8){l.keyid=l.keyid.substr(l.keyid.length-8)}$.each(["keyid","user"],function(){j=j.replace("$"+this,l[this])});k.text(j);this.show_popup_dialog(h,this.get_label("enigma.enterkeypasstitle"),[{text:this.get_label("save"),"class":"mainaction",click:function(b){b.stopPropagation();var a=g.is_framed()?window.parent.$:$;l.password=i.val();if(!l.password){i.focus();return}g.enigma_password_submit(l);a(this).remove()}},{text:this.get_label("cancel"),click:function(b){var a=g.is_framed()?window.parent.$:$;b.stopPropagation();a(this).remove()}}],{width:400});if(this.is_framed()&&parent.rcmail.message_list){parent.rcmail.message_list.blur()}};rcube_webmail.prototype.enigma_password_submit=function(i){var f,j;if(this.env.action=="compose"&&!i["compose-init"]){return this.enigma_password_compose_submit(i)}else{if(this.env.action=="plugin.enigmakeys"&&(j=this.gui_objects.importform)){if(!$('input[name="_keyid"]',j).length){$(j).append($("<input>").attr({type:"hidden",name:"_keyid",value:i.key})).append($("<input>").attr({type:"hidden",name:"_passwd",value:i.password}))}return this.enigma_import()}}f=i.nolock?null:this.set_busy(true,"loading");j=$("<form>").attr({method:"post",action:i.action||location.href,style:"display:none"}).append($("<input>").attr({type:"hidden",name:"_keyid",value:i.key})).append($("<input>").attr({type:"hidden",name:"_passwd",value:i.password})).append($("<input>").attr({type:"hidden",name:"_token",value:this.env.request_token})).append($("<input>").attr({type:"hidden",name:"_unlock",value:f}));$.each(i,function(a,b){if(a.indexOf("input")==0){j.append($("<input>").attr({type:"hidden",name:a.substring(5),value:b}))}});if(i.iframe){var g="enigma_frame_"+(new Date()).getTime(),h=$("<iframe>").attr({style:"display:none",name:g}).appendTo(document.body);j.attr("target",g)}j.appendTo(document.body).submit()};rcube_webmail.prototype.enigma_password_compose_submit=function(c){var d=this.gui_objects.messageform;if(!$('input[name="_keyid"]',d).length){$(d).append($("<input>").attr({type:"hidden",name:"_keyid",value:c.key})).append($("<input>").attr({type:"hidden",name:"_passwd",value:c.password}))}else{$('input[name="_keyid"]',d).val(c.key);$('input[name="_passwd"]',d).val(c.password)}this.submit_messageform(this.env.last_action=="savedraft")};rcube_webmail.prototype.enigma_key_not_found=function(b){return this.show_popup_dialog(b.text,b.title,[{text:b.button,click:function(a){$(this).remove();rcmail.enigma_find_publickey(b.email)}}],{width:400,dialogClass:"error"})};rcube_webmail.prototype.enigma_find_publickey=function(b){this.mailvelope_search_pubkeys([b],function(a){},function(e){var f=rcmail.set_busy(true,"enigma.importwait"),a={_a:"import",_keys:e};if(rcmail.env.action=="plugin.enigmakeys"){a._refresh=1}rcmail.http_post("plugin.enigmakeys",a,f)})};