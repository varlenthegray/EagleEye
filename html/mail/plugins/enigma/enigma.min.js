window.rcmail&&rcmail.addEventListener("init",function(a){if(rcmail.env.task=="settings"){if(rcmail.gui_objects.keyslist){rcmail.keys_list=new rcube_list_widget(rcmail.gui_objects.keyslist,{multiselect:true,draggable:false,keyboard:false});rcmail.keys_list.addEventListener("select",function(b){rcmail.enigma_keylist_select(b)}).addEventListener("keypress",function(b){rcmail.enigma_keylist_keypress(b)}).init().focus();rcmail.enigma_list();rcmail.register_command("firstpage",function(b){return rcmail.enigma_list_page("first")});rcmail.register_command("previouspage",function(b){return rcmail.enigma_list_page("previous")});rcmail.register_command("nextpage",function(b){return rcmail.enigma_list_page("next")});rcmail.register_command("lastpage",function(b){return rcmail.enigma_list_page("last")})}if(rcmail.env.action=="plugin.enigmakeys"){rcmail.register_command("search",function(b){return rcmail.enigma_search(b)},true);rcmail.register_command("reset-search",function(b){return rcmail.enigma_search_reset(b)},true);rcmail.register_command("plugin.enigma-import",function(){rcmail.enigma_import()},true);rcmail.register_command("plugin.enigma-import-search",function(){rcmail.enigma_import_search()},true);rcmail.register_command("plugin.enigma-key-export",function(){rcmail.enigma_export()});rcmail.register_command("plugin.enigma-key-export-selected",function(){rcmail.enigma_export(true)});rcmail.register_command("plugin.enigma-key-import",function(){rcmail.enigma_key_import()},true);rcmail.register_command("plugin.enigma-key-delete",function(b){return rcmail.enigma_delete()});rcmail.register_command("plugin.enigma-key-create",function(b){return rcmail.enigma_key_create()},true);rcmail.register_command("plugin.enigma-key-save",function(b){return rcmail.enigma_key_create_save()},true);rcmail.addEventListener("responseafterplugin.enigmakeys",function(){rcmail.enable_command("plugin.enigma-key-export",rcmail.env.rowcount>0)});if(rcmail.gui_objects.importform){$("#rcmimportsearch").keydown(function(b){if(b.which==13){rcmail.enigma_import_search();return false}});$('input[type="button"]:first').focus()}}}else{if(rcmail.env.task=="mail"){if(rcmail.env.action=="compose"){rcmail.addEventListener("beforesend",function(b){rcmail.enigma_beforesend_handler(b)}).addEventListener("beforesavedraft",function(b){rcmail.enigma_beforesavedraft_handler(b)});$("input,label",$("#enigmamenu")).mouseup(function(b){b.stopPropagation()});$("a.button.enigma").prop("tabindex",$("#messagetoolbar > a:first").prop("tabindex"))}$.each(["encrypt","sign"],function(){if(rcmail.env["enigma_force_"+this]){$('[name="_enigma_'+this+'"]').prop("checked",true)}});if(rcmail.env.enigma_password_request){rcmail.enigma_password_request(rcmail.env.enigma_password_request)}}}});rcube_webmail.prototype.enigma_key_import=function(){this.enigma_loadframe("&_action=plugin.enigmakeys&_a=import")};rcube_webmail.prototype.enigma_key_create=function(){this.enigma_loadframe("&_action=plugin.enigmakeys&_a=create")};rcube_webmail.prototype.enigma_key_create_save=function(){var c,e,f=[],b=$("#key-pass").val(),a=$("#key-pass-confirm").val(),d=$("#key-size").val();$('[name="identity[]"]:checked').each(function(){f.push({name:$(this).data("name")||"",email:$(this).data("email")})});if(!b||!a){return alert(this.get_label("enigma.formerror"))}if(b!=a){return alert(this.get_label("enigma.passwordsdiffer"))}if(!f.length){return alert(this.get_label("enigma.noidentselected"))}if(window.openpgp&&(window.msCrypto||(window.crypto&&(window.crypto.getRandomValues||window.crypto.subtle)))){e=this.set_busy(true,"enigma.keygenerating");c={numBits:d,userIds:f,passphrase:b};openpgp.generateKey(c).then(function(g){var h={_a:"import",_keys:g.privateKeyArmored,_generated:1,_passwd:b,_keyid:g.key.primaryKey.fingerprint};rcmail.http_post("plugin.enigmakeys",h,e)},function(g){console.error(g);rcmail.set_busy(false,null,e);rcmail.display_message(rcmail.get_label("enigma.keygenerateerror"),"error")})}else{rcmail.display_message(rcmail.get_label("enigma.keygennosupport"),"error")}};rcube_webmail.prototype.enigma_key_create_success=function(){parent.rcmail.enigma_list(1)};rcube_webmail.prototype.enigma_delete=function(){var c=this.keys_list.get_selection();if(!c.length||!confirm(this.get_label("enigma.keyremoveconfirm"))){return}var b=this.display_message(this.get_label("enigma.keyremoving"),"loading"),a={_a:"delete",_keys:c};this.http_post("plugin.enigmakeys",a,b)};rcube_webmail.prototype.enigma_export=function(c){var b=false,e=this.keys_list,d=c?e.get_selection().join(","):"*",a={_keys:d};if(!d.length){return}if(d=="*"){b=true}else{$.each(e.get_selection(),function(){flags=$(e.rows[this].obj).data("flags");if(flags&&flags.indexOf("p")>=0){b=true;return false}})}if(b){return this.show_popup_dialog(this.get_label("enigma.keyexportprompt"),this.get_label("enigma.exportkeys"),[{text:this.get_label("enigma.onlypubkeys"),click:function(f){rcmail.enigma_export_submit(a);$(this).remove()}},{text:this.get_label("enigma.withprivkeys"),click:function(f){a._priv=1;rcmail.enigma_export_submit(a);$(this).remove()}}],{width:400})}this.enigma_export_submit(a)};rcube_webmail.prototype.enigma_export_submit=function(c){var d="keyexport-"+new Date().getTime(),b=$("<form>").attr({target:d,method:"post",style:"display:none",action:"?_action=plugin.enigmakeys&_task=settings&_a=export"}),a=$("<iframe>").attr({name:d,style:"display:none"});b.append($("<input>").attr({name:"_token",value:this.env.request_token}));$.each(c,function(f,e){b.append($("<input>").attr({name:f,value:e}))});a.appendTo(document.body);b.appendTo(document.body).submit()};rcube_webmail.prototype.enigma_import=function(){var d,b,a,e="keyexport-"+new Date().getTime(),c=$("<iframe>").attr({name:e,style:"display:none"});if(d=this.gui_objects.importform){b=document.getElementById("rcmimportfile");if(b&&!b.value){alert(this.get_label("selectimportfile"));return}a=this.set_busy(true,"importwait");c.appendTo(document.body);$(d).attr({target:e,action:this.add_url(d.action,"_unlock",a)}).submit()}};rcube_webmail.prototype.enigma_import_search=function(){var b,a;if(b=this.gui_objects.importform){a=$("#rcmimportsearch").val();if(!a){return}this.enigma_find_publickey(a)}};rcube_webmail.prototype.enigma_keylist_select=function(b){var c=b.get_single_selection(),a;if(c){a="&_action=plugin.enigmakeys&_a=info&_id="+c}this.enigma_loadframe(a);this.enable_command("plugin.enigma-key-delete","plugin.enigma-key-export-selected",b.selection.length>0)};rcube_webmail.prototype.enigma_keylist_keypress=function(a){if(a.modkey==CONTROL_KEY){return}if(a.key_pressed==a.DELETE_KEY||a.key_pressed==a.BACKSPACE_KEY){this.command("plugin.enigma-key-delete")}else{if(a.key_pressed==33){this.command("previouspage")}else{if(a.key_pressed==34){this.command("nextpage")}}}};rcube_webmail.prototype.enigma_loadframe=function(a){var b;if(b=this.get_frame_window(this.env.contentframe)){if(!a){if(b.location&&b.location.href.indexOf(this.env.blankpage)<0){b.location.href=this.env.blankpage}if(this.env.frame_lock){this.set_busy(false,null,this.env.frame_lock)}return}this.env.frame_lock=this.set_busy(true,"loading");b.location.href=this.env.comm_path+"&_framed=1"+a}};rcube_webmail.prototype.enigma_search=function(b){if(!b&&this.gui_objects.qsearchbox){b=this.gui_objects.qsearchbox.value}if(b||this.env.search_request){var c={_a:"search",_q:b},a=this.set_busy(true,"searching");this.env.current_page=1;this.enigma_loadframe();this.enigma_clear_list();this.http_post("plugin.enigmakeys",c,a)}return false};rcube_webmail.prototype.enigma_search_reset=function(b){var a=this.env.search_request;this.reset_qsearch();if(a){this.enigma_loadframe();this.enigma_clear_list();this.enigma_list()}return false};rcube_webmail.prototype.enigma_list=function(c,b){if(this.is_framed()){return parent.rcmail.enigma_list(c,b)}var d={_a:"list"},a=this.set_busy(true,"loading");this.env.current_page=c?c:1;if(this.env.search_request){d._q=this.env.search_request}if(c){d._p=c}this.enigma_clear_list(b);this.http_post("plugin.enigmakeys",d,a)};rcube_webmail.prototype.enigma_list_page=function(a){if(a=="next"){a=this.env.current_page+1}else{if(a=="last"){a=this.env.pagecount}else{if(a=="prev"&&this.env.current_page>1){a=this.env.current_page-1}else{if(a=="first"&&this.env.current_page>1){a=1}}}}this.enigma_list(a)};rcube_webmail.prototype.enigma_clear_list=function(a){if(a!==false){this.enigma_loadframe()}if(this.keys_list){this.keys_list.clear(true)}this.enable_command("plugin.enigma-key-delete","plugin.enigma-key-delete-selected",false)};rcube_webmail.prototype.enigma_add_list_row=function(d){if(!this.gui_objects.keyslist||!this.keys_list){return false}var f=this.keys_list,b=this.gui_objects.keyslist.tBodies[0],e=b.rows.length,h=e%2,c="message"+(h?" even":" odd"),g=document.createElement("tr"),a=document.createElement("td");g.id="rcmrow"+d.id;g.className=c;if(d.flags){$(g).data("flags",d.flags)}a.innerHTML=d.name;g.appendChild(a);f.insert_row(g)};rcube_webmail.prototype.enigma_beforesend_handler=function(a){this.env.last_action="send";this.enigma_compose_handler(a)};rcube_webmail.prototype.enigma_beforesavedraft_handler=function(a){this.env.last_action="savedraft";this.enigma_compose_handler(a)};rcube_webmail.prototype.enigma_compose_handler=function(a){var b=this.gui_objects.messageform;$("#enigmamenu input").each(function(){var d=this.id+"_cpy",c=$("#"+d);if(!c.length){c=$(this).clone();c.prop({id:d,type:"hidden"}).appendTo(b)}c.val(this.checked?"1":"")});if(this.env.last_action=="savedraft"){$('input[name="_enigma_sign"]',b).val(0)}};rcube_webmail.prototype.enigma_import_attachment=function(c){var b=this.set_busy(true,"loading"),a={_uid:this.env.uid,_mbox:this.env.mailbox,_part:c};this.http_post("plugin.enigmaimport",a,b);return false};rcube_webmail.prototype.enigma_password_request=function(c){if(!c||!c.keyid){return}var b=this,e=this.get_label("enigma.enterkeypass"),a=$('<div class="prompt">'),d=$('<div class="message">').appendTo(a),f=$("<input>").attr({type:"password",size:30}).keypress(function(g){if(g.which==13){(b.is_framed()?window.parent.$:$)(".ui-dialog-buttonpane button.mainaction:visible").click()}}).appendTo(a);c.key=c.keyid;if(c.keyid.length>8){c.keyid=c.keyid.substr(c.keyid.length-8)}$.each(["keyid","user"],function(){e=e.replace("$"+this,c[this])});d.text(e);this.show_popup_dialog(a,this.get_label("enigma.enterkeypasstitle"),[{text:this.get_label("save"),"class":"mainaction",click:function(g){g.stopPropagation();var h=b.is_framed()?window.parent.$:$;c.password=f.val();if(!c.password){f.focus();return}b.enigma_password_submit(c);h(this).remove()}},{text:this.get_label("cancel"),click:function(g){var h=b.is_framed()?window.parent.$:$;g.stopPropagation();h(this).remove()}}],{width:400});if(this.is_framed()&&parent.rcmail.message_list){parent.rcmail.message_list.blur()}};rcube_webmail.prototype.enigma_password_submit=function(d){var b,c;if(this.env.action=="compose"&&!d["compose-init"]){return this.enigma_password_compose_submit(d)}else{if(this.env.action=="plugin.enigmakeys"&&(c=this.gui_objects.importform)){if(!$('input[name="_keyid"]',c).length){$(c).append($("<input>").attr({type:"hidden",name:"_keyid",value:d.key})).append($("<input>").attr({type:"hidden",name:"_passwd",value:d.password}))}return this.enigma_import()}}b=d.nolock?null:this.set_busy(true,"loading");c=$("<form>").attr({method:"post",action:d.action||location.href,style:"display:none"}).append($("<input>").attr({type:"hidden",name:"_keyid",value:d.key})).append($("<input>").attr({type:"hidden",name:"_passwd",value:d.password})).append($("<input>").attr({type:"hidden",name:"_token",value:this.env.request_token})).append($("<input>").attr({type:"hidden",name:"_unlock",value:b}));$.each(d,function(g,f){if(g.indexOf("input")==0){c.append($("<input>").attr({type:"hidden",name:g.substring(5),value:f}))}});if(d.iframe){var a="enigma_frame_"+(new Date()).getTime(),e=$("<iframe>").attr({style:"display:none",name:a}).appendTo(document.body);c.attr("target",a)}c.appendTo(document.body).submit()};rcube_webmail.prototype.enigma_password_compose_submit=function(b){var a=this.gui_objects.messageform;if(!$('input[name="_keyid"]',a).length){$(a).append($("<input>").attr({type:"hidden",name:"_keyid",value:b.key})).append($("<input>").attr({type:"hidden",name:"_passwd",value:b.password}))}else{$('input[name="_keyid"]',a).val(b.key);$('input[name="_passwd"]',a).val(b.password)}this.submit_messageform(this.env.last_action=="savedraft")};rcube_webmail.prototype.enigma_key_not_found=function(a){return this.show_popup_dialog(a.text,a.title,[{text:a.button,click:function(b){$(this).remove();rcmail.enigma_find_publickey(a.email)}}],{width:400,dialogClass:"error"})};rcube_webmail.prototype.enigma_find_publickey=function(a){this.mailvelope_search_pubkeys([a],function(b){},function(d){var c=rcmail.set_busy(true,"enigma.importwait"),b={_a:"import",_keys:d};if(rcmail.env.action=="plugin.enigmakeys"){b._refresh=1}rcmail.http_post("plugin.enigmakeys",b,c)})};