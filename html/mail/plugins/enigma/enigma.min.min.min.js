window.rcmail&&rcmail.addEventListener("init",function(a){if(rcmail.env.task=="settings"){if(rcmail.gui_objects.keyslist){rcmail.keys_list=new rcube_list_widget(rcmail.gui_objects.keyslist,{multiselect:true,draggable:false,keyboard:false});rcmail.keys_list.addEventListener("select",function(b){rcmail.enigma_keylist_select(b)}).addEventListener("keypress",function(b){rcmail.enigma_keylist_keypress(b)}).init().focus();rcmail.enigma_list();rcmail.register_command("firstpage",function(b){return rcmail.enigma_list_page("first")});rcmail.register_command("previouspage",function(b){return rcmail.enigma_list_page("previous")});rcmail.register_command("nextpage",function(b){return rcmail.enigma_list_page("next")});rcmail.register_command("lastpage",function(b){return rcmail.enigma_list_page("last")})}if(rcmail.env.action=="plugin.enigmakeys"){rcmail.register_command("search",function(b){return rcmail.enigma_search(b)},true);rcmail.register_command("reset-search",function(b){return rcmail.enigma_search_reset(b)},true);rcmail.register_command("plugin.enigma-import",function(){rcmail.enigma_import()},true);rcmail.register_command("plugin.enigma-import-search",function(){rcmail.enigma_import_search()},true);rcmail.register_command("plugin.enigma-key-export",function(){rcmail.enigma_export()});rcmail.register_command("plugin.enigma-key-export-selected",function(){rcmail.enigma_export(true)});rcmail.register_command("plugin.enigma-key-import",function(){rcmail.enigma_key_import()},true);rcmail.register_command("plugin.enigma-key-delete",function(b){return rcmail.enigma_delete()});rcmail.register_command("plugin.enigma-key-create",function(b){return rcmail.enigma_key_create()},true);rcmail.register_command("plugin.enigma-key-save",function(b){return rcmail.enigma_key_create_save()},true);rcmail.addEventListener("responseafterplugin.enigmakeys",function(){rcmail.enable_command("plugin.enigma-key-export",rcmail.env.rowcount>0)});if(rcmail.gui_objects.importform){$("#rcmimportsearch").keydown(function(b){if(b.which==13){rcmail.enigma_import_search();return false}});$('input[type="button"]:first').focus()}}}else{if(rcmail.env.task=="mail"){if(rcmail.env.action=="compose"){rcmail.addEventListener("beforesend",function(b){rcmail.enigma_beforesend_handler(b)}).addEventListener("beforesavedraft",function(b){rcmail.enigma_beforesavedraft_handler(b)});$("input,label",$("#enigmamenu")).mouseup(function(b){b.stopPropagation()});$("a.button.enigma").prop("tabindex",$("#messagetoolbar > a:first").prop("tabindex"))}$.each(["encrypt","sign"],function(){if(rcmail.env["enigma_force_"+this]){$('[name="_enigma_'+this+'"]').prop("checked",true)}});if(rcmail.env.enigma_password_request){rcmail.enigma_password_request(rcmail.env.enigma_password_request)}}}});rcube_webmail.prototype.enigma_key_import=function(){this.enigma_loadframe("&_action=plugin.enigmakeys&_a=import")};rcube_webmail.prototype.enigma_key_create=function(){this.enigma_loadframe("&_action=plugin.enigmakeys&_a=create")};rcube_webmail.prototype.enigma_key_create_save=function(){var a,c,d=[],f=$("#key-pass").val(),e=$("#key-pass-confirm").val(),b=$("#key-size").val();$('[name="identity[]"]:checked').each(function(){d.push({name:$(this).data("name")||"",email:$(this).data("email")})});if(!f||!e){return alert(this.get_label("enigma.formerror"))}if(f!=e){return alert(this.get_label("enigma.passwordsdiffer"))}if(!d.length){return alert(this.get_label("enigma.noidentselected"))}if(window.openpgp&&(window.msCrypto||(window.crypto&&(window.crypto.getRandomValues||window.crypto.subtle)))){c=this.set_busy(true,"enigma.keygenerating");a={numBits:b,userIds:d,passphrase:f};openpgp.generateKey(a).then(function(g){var h={_a:"import",_keys:g.privateKeyArmored,_generated:1,_passwd:f,_keyid:g.key.primaryKey.fingerprint};rcmail.http_post("plugin.enigmakeys",h,c)},function(g){console.error(g);rcmail.set_busy(false,null,c);rcmail.display_message(rcmail.get_label("enigma.keygenerateerror"),"error")})}else{rcmail.display_message(rcmail.get_label("enigma.keygennosupport"),"error")}};rcube_webmail.prototype.enigma_key_create_success=function(){parent.rcmail.enigma_list(1)};rcube_webmail.prototype.enigma_delete=function(){var a=this.keys_list.get_selection();if(!a.length||!confirm(this.get_label("enigma.keyremoveconfirm"))){return}var c=this.display_message(this.get_label("enigma.keyremoving"),"loading"),b={_a:"delete",_keys:a};this.http_post("plugin.enigmakeys",b,c)};rcube_webmail.prototype.enigma_export=function(a){var e=false,c=this.keys_list,b=a?c.get_selection().join(","):"*",d={_keys:b};if(!b.length){return}if(b=="*"){e=true}else{$.each(c.get_selection(),function(){flags=$(c.rows[this].obj).data("flags");if(flags&&flags.indexOf("p")>=0){e=true;return false}})}if(e){return this.show_popup_dialog(this.get_label("enigma.keyexportprompt"),this.get_label("enigma.exportkeys"),[{text:this.get_label("enigma.onlypubkeys"),click:function(f){rcmail.enigma_export_submit(d);$(this).remove()}},{text:this.get_label("enigma.withprivkeys"),click:function(f){d._priv=1;rcmail.enigma_export_submit(d);$(this).remove()}}],{width:400})}this.enigma_export_submit(d)};rcube_webmail.prototype.enigma_export_submit=function(a){var b="keyexport-"+new Date().getTime(),d=$("<form>").attr({target:b,method:"post",style:"display:none",action:"?_action=plugin.enigmakeys&_task=settings&_a=export"}),c=$("<iframe>").attr({name:b,style:"display:none"});d.append($("<input>").attr({name:"_token",value:this.env.request_token}));$.each(a,function(f,e){d.append($("<input>").attr({name:f,value:e}))});c.appendTo(document.body);d.appendTo(document.body).submit()};rcube_webmail.prototype.enigma_import=function(){var b,e,d,c="keyexport-"+new Date().getTime(),a=$("<iframe>").attr({name:c,style:"display:none"});if(b=this.gui_objects.importform){e=document.getElementById("rcmimportfile");if(e&&!e.value){alert(this.get_label("selectimportfile"));return}d=this.set_busy(true,"importwait");a.appendTo(document.body);$(b).attr({target:c,action:this.add_url(b.action,"_unlock",d)}).submit()}};rcube_webmail.prototype.enigma_import_search=function(){var b,a;if(b=this.gui_objects.importform){a=$("#rcmimportsearch").val();if(!a){return}this.enigma_find_publickey(a)}};rcube_webmail.prototype.enigma_keylist_select=function(c){var a=c.get_single_selection(),b;if(a){b="&_action=plugin.enigmakeys&_a=info&_id="+a}this.enigma_loadframe(b);this.enable_command("plugin.enigma-key-delete","plugin.enigma-key-export-selected",c.selection.length>0)};rcube_webmail.prototype.enigma_keylist_keypress=function(a){if(a.modkey==CONTROL_KEY){return}if(a.key_pressed==a.DELETE_KEY||a.key_pressed==a.BACKSPACE_KEY){this.command("plugin.enigma-key-delete")}else{if(a.key_pressed==33){this.command("previouspage")}else{if(a.key_pressed==34){this.command("nextpage")}}}};rcube_webmail.prototype.enigma_loadframe=function(a){var b;if(b=this.get_frame_window(this.env.contentframe)){if(!a){if(b.location&&b.location.href.indexOf(this.env.blankpage)<0){b.location.href=this.env.blankpage}if(this.env.frame_lock){this.set_busy(false,null,this.env.frame_lock)}return}this.env.frame_lock=this.set_busy(true,"loading");b.location.href=this.env.comm_path+"&_framed=1"+a}};rcube_webmail.prototype.enigma_search=function(c){if(!c&&this.gui_objects.qsearchbox){c=this.gui_objects.qsearchbox.value}if(c||this.env.search_request){var a={_a:"search",_q:c},b=this.set_busy(true,"searching");this.env.current_page=1;this.enigma_loadframe();this.enigma_clear_list();this.http_post("plugin.enigmakeys",a,b)}return false};rcube_webmail.prototype.enigma_search_reset=function(b){var a=this.env.search_request;this.reset_qsearch();if(a){this.enigma_loadframe();this.enigma_clear_list();this.enigma_list()}return false};rcube_webmail.prototype.enigma_list=function(a,d){if(this.is_framed()){return parent.rcmail.enigma_list(a,d)}var b={_a:"list"},c=this.set_busy(true,"loading");this.env.current_page=a?a:1;if(this.env.search_request){b._q=this.env.search_request}if(a){b._p=a}this.enigma_clear_list(d);this.http_post("plugin.enigmakeys",b,c)};rcube_webmail.prototype.enigma_list_page=function(a){if(a=="next"){a=this.env.current_page+1}else{if(a=="last"){a=this.env.pagecount}else{if(a=="prev"&&this.env.current_page>1){a=this.env.current_page-1}else{if(a=="first"&&this.env.current_page>1){a=1}}}}this.enigma_list(a)};rcube_webmail.prototype.enigma_clear_list=function(a){if(a!==false){this.enigma_loadframe()}if(this.keys_list){this.keys_list.clear(true)}this.enable_command("plugin.enigma-key-delete","plugin.enigma-key-delete-selected",false)};rcube_webmail.prototype.enigma_add_list_row=function(g){if(!this.gui_objects.keyslist||!this.keys_list){return false}var a=this.keys_list,e=this.gui_objects.keyslist.tBodies[0],h=e.rows.length,c=h%2,f="message"+(c?" even":" odd"),b=document.createElement("tr"),d=document.createElement("td");b.id="rcmrow"+g.id;b.className=f;if(g.flags){$(b).data("flags",g.flags)}d.innerHTML=g.name;b.appendChild(d);a.insert_row(b)};rcube_webmail.prototype.enigma_beforesend_handler=function(a){this.env.last_action="send";this.enigma_compose_handler(a)};rcube_webmail.prototype.enigma_beforesavedraft_handler=function(a){this.env.last_action="savedraft";this.enigma_compose_handler(a)};rcube_webmail.prototype.enigma_compose_handler=function(a){var b=this.gui_objects.messageform;$("#enigmamenu input").each(function(){var d=this.id+"_cpy",c=$("#"+d);if(!c.length){c=$(this).clone();c.prop({id:d,type:"hidden"}).appendTo(b)}c.val(this.checked?"1":"")});if(this.env.last_action=="savedraft"){$('input[name="_enigma_sign"]',b).val(0)}};rcube_webmail.prototype.enigma_import_attachment=function(a){var c=this.set_busy(true,"loading"),b={_uid:this.env.uid,_mbox:this.env.mailbox,_part:a};this.http_post("plugin.enigmaimport",b,c);return false};rcube_webmail.prototype.enigma_password_request=function(a){if(!a||!a.keyid){return}var f=this,c=this.get_label("enigma.enterkeypass"),e=$('<div class="prompt">'),b=$('<div class="message">').appendTo(e),d=$("<input>").attr({type:"password",size:30}).keypress(function(g){if(g.which==13){(f.is_framed()?window.parent.$:$)(".ui-dialog-buttonpane button.mainaction:visible").click()}}).appendTo(e);a.key=a.keyid;if(a.keyid.length>8){a.keyid=a.keyid.substr(a.keyid.length-8)}$.each(["keyid","user"],function(){c=c.replace("$"+this,a[this])});b.text(c);this.show_popup_dialog(e,this.get_label("enigma.enterkeypasstitle"),[{text:this.get_label("save"),"class":"mainaction",click:function(g){g.stopPropagation();var h=f.is_framed()?window.parent.$:$;a.password=d.val();if(!a.password){d.focus();return}f.enigma_password_submit(a);h(this).remove()}},{text:this.get_label("cancel"),click:function(g){var h=f.is_framed()?window.parent.$:$;g.stopPropagation();h(this).remove()}}],{width:400});if(this.is_framed()&&parent.rcmail.message_list){parent.rcmail.message_list.blur()}};rcube_webmail.prototype.enigma_password_submit=function(b){var e,a;if(this.env.action=="compose"&&!b["compose-init"]){return this.enigma_password_compose_submit(b)}else{if(this.env.action=="plugin.enigmakeys"&&(a=this.gui_objects.importform)){if(!$('input[name="_keyid"]',a).length){$(a).append($("<input>").attr({type:"hidden",name:"_keyid",value:b.key})).append($("<input>").attr({type:"hidden",name:"_passwd",value:b.password}))}return this.enigma_import()}}e=b.nolock?null:this.set_busy(true,"loading");a=$("<form>").attr({method:"post",action:b.action||location.href,style:"display:none"}).append($("<input>").attr({type:"hidden",name:"_keyid",value:b.key})).append($("<input>").attr({type:"hidden",name:"_passwd",value:b.password})).append($("<input>").attr({type:"hidden",name:"_token",value:this.env.request_token})).append($("<input>").attr({type:"hidden",name:"_unlock",value:e}));$.each(b,function(g,f){if(g.indexOf("input")==0){a.append($("<input>").attr({type:"hidden",name:g.substring(5),value:f}))}});if(b.iframe){var d="enigma_frame_"+(new Date()).getTime(),c=$("<iframe>").attr({style:"display:none",name:d}).appendTo(document.body);a.attr("target",d)}a.appendTo(document.body).submit()};rcube_webmail.prototype.enigma_password_compose_submit=function(b){var a=this.gui_objects.messageform;if(!$('input[name="_keyid"]',a).length){$(a).append($("<input>").attr({type:"hidden",name:"_keyid",value:b.key})).append($("<input>").attr({type:"hidden",name:"_passwd",value:b.password}))}else{$('input[name="_keyid"]',a).val(b.key);$('input[name="_passwd"]',a).val(b.password)}this.submit_messageform(this.env.last_action=="savedraft")};rcube_webmail.prototype.enigma_key_not_found=function(a){return this.show_popup_dialog(a.text,a.title,[{text:a.button,click:function(b){$(this).remove();rcmail.enigma_find_publickey(a.email)}}],{width:400,dialogClass:"error"})};rcube_webmail.prototype.enigma_find_publickey=function(a){this.mailvelope_search_pubkeys([a],function(b){},function(d){var c=rcmail.set_busy(true,"enigma.importwait"),b={_a:"import",_keys:d};if(rcmail.env.action=="plugin.enigmakeys"){b._refresh=1}rcmail.http_post("plugin.enigmakeys",b,c)})};