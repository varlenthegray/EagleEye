(function(b){b.fn.tagedit=function(o){o=b.extend(true,{autocompleteURL:null,checkToDeleteURL:null,deletedPostfix:"-d",addedPostfix:"-a",additionalListClass:"",allowEdit:true,allowDelete:true,allowAdd:true,direction:"ltr",animSpeed:500,autocompleteOptions:{select:function(d,c){b(this).val(c.item.value).trigger("transformToTag",[c.item.id]);return false}},breakKeyCodes:[13,44],checkNewEntriesCaseSensitive:false,texts:{removeLinkTitle:"Remove from list.",saveEditLinkTitle:"Save changes.",deleteLinkTitle:"Delete this tag from database.",deleteConfirmation:"Are you sure to delete this entry?",deletedElementTitle:"This Element will be deleted.",breakEditLinkTitle:"Cancel",forceDeleteConfirmation:"There are more records using this tag, are you sure do you want to remove it?"},tabindex:false},o||{});if(this.length==0){return}if(o.autocompleteURL){o.autocompleteOptions.source=o.autocompleteURL}var p=this.attr("dir");if(p&&p.length>0){o.direction=this.attr("dir")}var z=this;var A=null;var a=new RegExp("^(.*)\\[([0-9]*?("+o.deletedPostfix+"|"+o.addedPostfix+")?)?]$","i");var y=z.eq(0).attr("name").match(a);if(y&&y.length==4){y=y[1]}else{alert("elementname dows not match the expected format (regexp: "+a+")");return}var w;if(!o.tabindex&&(w=z.eq(0).attr("tabindex"))){o.tabindex=w}u();function u(){var d='<ul class="tagedit-list '+o.additionalListClass+'">';z.each(function(g){var e=b(this).attr("name").match(a);if(e&&e.length==4&&(o.deleteEmptyItems==false||b(this).val().length>0)){if(e[1].length>0){var h=typeof e[2]!="undefined"?e[2]:"",f="tagedit-"+y+"-"+(h||g);d+='<li class="tagedit-listelement tagedit-listelement-old" aria-labelledby="'+f+'">';d+='<span dir="'+o.direction+'" id="'+f+'">'+b(this).val()+"</span>";d+='<input type="hidden" name="'+y+"["+h+']" value="'+b(this).val()+'" />';if(o.allowDelete){d+='<a class="tagedit-close" title="'+o.texts.removeLinkTitle+'" aria-label="'+o.texts.removeLinkTitle+" "+b(this).val()+'">x</a>'}d+="</li>"}}});z.last().after(d);var c=z.last().next();z.remove();z=c;if(o.deletedPostfix.length>0){z.find('input[name$="'+o.deletedPostfix+']"]').each(function(){t(b(this).parent())})}d='<li class="tagedit-listelement tagedit-listelement-new">';if(o.allowAdd){d+='<input type="text" name="'+y+'[]" value="" id="tagedit-input" disabled="disabled" class="tagedit-input-disabled" dir="'+o.direction+'"/>'}d+="</li>";d+="</ul>";z.append(d).attr("tabindex",o.tabindex).find("#tagedit-input").attr("tabindex",o.tabindex).each(function(){b(this).autoGrowInput({comfortZone:15,minWidth:15,maxWidth:20000});b(this).bind("transformToTag",function(g,e){var i=(typeof e!="undefined"&&(e.length>0||e>0));var k=i==true||o.autocompleteOptions.noCheck?false:true;var h=s(b(this).val(),k);if(h[0]===true||(h[0]===false&&typeof h[1]=="string")){if(i==false&&typeof h[1]=="string"){i=true;e=h[1]}if(o.allowAdd==true||i){var f="tagedit-"+y+"-"+e;d='<li class="tagedit-listelement tagedit-listelement-old" aria-labelledby="'+f+'">';d+='<span dir="'+o.direction+'" id="'+f+'">'+b(this).val()+"</span>";var j=i?y+"["+e+o.addedPostfix+"]":y+"[]";d+='<input type="hidden" name="'+j+'" value="'+b(this).val()+'" />';d+='<a class="tagedit-close" title="'+o.texts.removeLinkTitle+'" aria-label="'+o.texts.removeLinkTitle+" "+b(this).val()+'">x</a>';d+="</li>";b(this).parent().before(d)}}b(this).val("");if(o.autocompleteOptions.source){if(b(this).is(":ui-autocomplete")){b(this).autocomplete("close")}}}).keydown(function(f){var g=f.keyCode>0?f.keyCode:f.which;switch(g){case 46:if(!A){break}case 8:if(A){A.fadeOut(o.animSpeed,function(){b(this).remove()});r();f.preventDefault();return false}else{if(b(this).val().length==0){var i=z.find("li.tagedit-listelement-old").last();i.fadeOut(o.animSpeed,function(){i.remove()});f.preventDefault();return false}}break;case 9:if(b(this).val().length>0&&b("ul.ui-autocomplete #ui-active-menuitem").length==0){b(this).trigger("transformToTag");f.preventDefault();return false}break;case 37:case 39:if(b(this).val().length==0){var e=g==37?-1:1,h=z.find("li.tagedit-listelement-old");x=h.length,next=0;h.each(function(k,j){if(b(j).hasClass("tagedit-listelement-focus")){x=k;return true}});r();next=Math.max(0,x+e);if(h.get(next)){A=h.eq(next).addClass("tagedit-listelement-focus");b(this).attr("aria-activedescendant",A.attr("aria-labelledby"));if(o.autocompleteOptions.source!=false){b(this).autocomplete("close").autocomplete("disable")}}f.preventDefault();return false}break;default:if(A!==null){f.preventDefault();f.bubble=false;return false}}return true}).keypress(function(e){var f=e.keyCode>0?e.keyCode:e.which;if(b.inArray(f,o.breakKeyCodes)>-1){if(b(this).val().length>0&&b("ul.ui-autocomplete #ui-active-menuitem").length==0){b(this).trigger("transformToTag")}e.preventDefault();return false}else{if(b(this).val().length>0){r()}}return true}).bind("paste",function(e){var f=b(this);if(e.type=="paste"){setTimeout(function(){f.trigger("transformToTag")},1)}}).blur(function(){if(b(this).val().length==0){b(this).attr("disabled","disabled").addClass("tagedit-input-disabled")}else{var e=b(this);b(this).data("blurtimer",window.setTimeout(function(){e.val("")},500))}r();if(o.tabindex){z.attr("tabindex",o.tabindex)}}).focus(function(){window.clearTimeout(b(this).data("blurtimer"));z.attr("tabindex","-1")});if(o.autocompleteOptions.source!=false){b(this).autocomplete(o.autocompleteOptions)}}).end().click(function(e){switch(e.target.tagName){case"A":b(e.target).parent().fadeOut(o.animSpeed,function(){b(e.target).parent().remove();z.find("#tagedit-input").focus()});break;case"INPUT":case"SPAN":case"LI":if(b(e.target).hasClass("tagedit-listelement-deleted")==false&&b(e.target).parent("li").hasClass("tagedit-listelement-deleted")==false){return v(e)}default:b(this).find("#tagedit-input").removeAttr("disabled").removeClass("tagedit-input-disabled").focus()}return false}).focus(function(e){b(this).click()})}function r(){if(A){if(o.autocompleteOptions.source!=false){z.find("#tagedit-input").autocomplete("enable")}A.removeClass("tagedit-listelement-focus");A=null;z.find("#tagedit-input").removeAttr("aria-activedescendant")}}function v(e){if(o.allowEdit==false){return}var f=e.target.tagName=="SPAN"?b(e.target).parent():b(e.target);var c=null;f.bind("finishEdit",function(h,g){window.clearTimeout(c);var i=b(this).find(":text");var j=s(i.val(),true);if(i.val().length>0&&(typeof g=="undefined"||g===false)&&(j[0]==true)){b(this).find(":hidden").val(i.val());b(this).find("span").html(i.val())}i.remove();b(this).find("a.tagedit-save, a.tagedit-break, a.tagedit-delete").remove();b(this).removeClass("tagedit-listelement-edit").unbind("finishEdit");return false});var d=f.find(":hidden");html='<input type="text" name="tmpinput" autocomplete="off" value="'+d.val()+'" class="tagedit-edit-input" dir="'+o.direction+'"/>';html+='<a class="tagedit-save" title="'+o.texts.saveEditLinkTitle+'">o</a>';html+='<a class="tagedit-break" title="'+o.texts.breakEditLinkTitle+'">x</a>';if(o.allowDelete==true&&f.find(":hidden").length>0&&typeof f.find(":hidden").attr("name").match(a)[3]!="undefined"){html+='<a class="tagedit-delete" title="'+o.texts.deleteLinkTitle+'">d</a>'}d.after(html);f.addClass("tagedit-listelement-edit").find("a.tagedit-save").click(function(){b(this).parent().trigger("finishEdit");return false}).end().find("a.tagedit-break").click(function(){b(this).parent().trigger("finishEdit",[true]);return false}).end().find("a.tagedit-delete").click(function(){window.clearTimeout(c);if(confirm(o.texts.deleteConfirmation)){var g=q(b(this).parent());if(!g&&confirm(o.texts.forceDeleteConfirmation)){t(b(this).parent())}if(g){t(b(this).parent())}b(this).parent().find(":text").trigger("finishEdit",[true])}else{b(this).parent().find(":text").trigger("finishEdit",[true])}return false}).end().find(":text").focus().autoGrowInput({comfortZone:10,minWidth:15,maxWidth:20000}).keypress(function(g){switch(g.keyCode){case 13:g.preventDefault();b(this).parent().trigger("finishEdit");return false;case 27:g.preventDefault();b(this).parent().trigger("finishEdit",[true]);return false}return true}).blur(function(){var g=b(this);c=window.setTimeout(function(){g.parent().trigger("finishEdit",[true])},500)})}function q(e){if(o.checkToDeleteURL===null){return false}var g=e.find("input:hidden").attr("name");var c=new RegExp("\\d");var d=g.match(c);var f=false;b.ajax({async:false,url:o.checkToDeleteURL,dataType:"json",type:"POST",data:{tagId:d},complete:function(i,h){var j=b.parseJSON(i.responseText);if(j.success===true){f=j.allowDelete}}});return f}function t(c){c.trigger("finishEdit",[true]).addClass("tagedit-listelement-deleted").attr("title",o.deletedElementTitle);c.find(":hidden").each(function(){var d=new RegExp("("+o.addedPostfix+"|"+o.deletedPostfix+")?]");var e=b(this).attr("name").replace(d,o.deletedPostfix+"]");b(this).attr("name",e)})}function s(i,k){k=typeof k=="undefined"?false:k;var d=null;var h=o.checkNewEntriesCaseSensitive==true?i:i.toLowerCase();var l=true;z.find("li.tagedit-listelement-old input:hidden").each(function(){var m=o.checkNewEntriesCaseSensitive==true?b(this).val():b(this).val().toLowerCase();if(m==h){l=false}});if(l==true&&k==true&&o.autocompleteOptions.source!=false){var g=[];if(b.isArray(o.autocompleteOptions.source)){g=o.autocompleteOptions.source}else{if(b.isFunction(o.autocompleteOptions.source)){o.autocompleteOptions.source({term:i},function(m){g=m})}else{if(typeof o.autocompleteOptions.source==="string"){var e=o.autocompleteOptions.source;if(e.match(/\?/)){e+="&"}else{e+="?"}e+="term="+i;b.ajax({async:false,url:e,dataType:"json",complete:function(n,m){g=b.parseJSON(n.responseText)}})}}}for(var c=0;c<g.length;c++){var f=g[c].label?g[c].label:g[c];var j=o.checkNewEntriesCaseSensitive==true?f:f.toLowerCase();if(j==h){l=false;d=typeof g[c]=="string"?c:g[c].id;break}}}return new Array(l,d)}}})(jQuery);(function(b){b.fn.autoGrowInput=function(a){a=b.extend({maxWidth:1000,minWidth:0,comfortZone:70},a);this.filter("input:text").each(function(){var i=a.minWidth||b(this).width(),h="",k=b(this),j=b("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:k.css("fontSize"),fontFamily:k.css("fontFamily"),fontWeight:k.css("fontWeight"),letterSpacing:k.css("letterSpacing"),whiteSpace:"nowrap"}),l=function(){if(h===(h=k.val())){return}var c=h.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");j.html(c);var e=j.width(),d=(e+a.comfortZone)>=i?e+a.comfortZone:i,f=k.width(),g=(d<f&&d>=i)||(d>i&&d<a.maxWidth);if(g){k.width(d)}};j.insertAfter(k);b(this).bind("keyup keydown blur update",l);l()});return this}})(jQuery);