if(window.rcmail){rcmail.addEventListener("init",function(e){if(rcmail.env.task=="mail"){if(rcmail.env.action!="show"){rcmail.env.message_commands.push("managesieve-create")}else{rcmail.enable_command("managesieve-create",true)}}if(rcmail.env.task=="mail"||rcmail.env.action.startsWith("plugin.managesieve")){if(!rcmail.env.framed){rcmail.env.ms_tip_layer=$('<div id="managesieve-tip" class="popupmenu"></div>');rcmail.env.ms_tip_layer.appendTo(document.body)}}rcmail.register_command("plugin.managesieve-save",function(){rcmail.managesieve_save()});rcmail.register_command("plugin.managesieve-act",function(){rcmail.managesieve_act()});rcmail.register_command("plugin.managesieve-add",function(){rcmail.managesieve_add()});rcmail.register_command("plugin.managesieve-del",function(){rcmail.managesieve_del()});rcmail.register_command("plugin.managesieve-move",function(){rcmail.managesieve_move()});rcmail.register_command("plugin.managesieve-setadd",function(){rcmail.managesieve_setadd()});rcmail.register_command("plugin.managesieve-setdel",function(){rcmail.managesieve_setdel()});rcmail.register_command("plugin.managesieve-setact",function(){rcmail.managesieve_setact()});rcmail.register_command("plugin.managesieve-setget",function(){rcmail.managesieve_setget()});rcmail.register_command("plugin.managesieve-seteditraw",function(){rcmail.managesieve_seteditraw()});if(rcmail.env.action.startsWith("plugin.managesieve")){if(rcmail.gui_objects.sieveform){rcmail.enable_command("plugin.managesieve-save",true);sieve_form_init()}else{if(rcmail.gui_objects.sievesetrawform){rcmail.enable_command("plugin.managesieve-save",true);sieve_raw_editor_init()}else{rcmail.enable_command("plugin.managesieve-add","plugin.managesieve-setadd",!rcmail.env.sieveconnerror)}}var d,f=rcmail.env.currentset;if(rcmail.gui_objects.filterslist){rcmail.filters_list=new rcube_list_widget(rcmail.gui_objects.filterslist,{multiselect:false,draggable:true,keyboard:true});rcmail.filters_list.addEventListener("select",function(a){rcmail.managesieve_select(a)}).addEventListener("dragstart",function(a){rcmail.managesieve_dragstart(a)}).addEventListener("dragend",function(a){rcmail.managesieve_dragend(a)}).addEventListener("initrow",function(a){a.obj.onmouseover=function(){rcmail.managesieve_focus_filter(a)};a.obj.onmouseout=function(){rcmail.managesieve_unfocus_filter(a)}}).init()}if(rcmail.gui_objects.filtersetslist){rcmail.filtersets_list=new rcube_list_widget(rcmail.gui_objects.filtersetslist,{multiselect:false,draggable:false,keyboard:true});rcmail.filtersets_list.init().focus();if(f!=null){f=rcmail.managesieve_setid(f);rcmail.filtersets_list.select(f)}rcmail.filtersets_list.addEventListener("select",function(a){rcmail.managesieve_setselect(a)});d=rcmail.filtersets_list.rowcount;rcmail.enable_command("plugin.managesieve-set",true);rcmail.enable_command("plugin.managesieve-setact","plugin.managesieve-setget",d>0);rcmail.enable_command("plugin.managesieve-setdel",d>1);rcmail.enable_command("plugin.managesieve-seteditraw",d>0&&rcmail.env.raw_sieve_editor);$("tr",rcmail.gui_objects.filtersetslist).each(function(b,a){rcmail.managesieve_fixdragend(a)})}}if(rcmail.gui_objects.sieveform&&rcmail.env.rule_disabled){$("#disabled").attr("checked",true)}})}rcube_webmail.prototype.managesieve_add=function(){this.load_managesieveframe("",true)};rcube_webmail.prototype.managesieve_del=function(){var c=this.filters_list.get_single_selection();if(confirm(this.get_label("managesieve.filterdeleteconfirm"))){var d=this.set_busy(true,"loading");this.http_post("plugin.managesieve-action","_act=delete&_fid="+this.filters_list.rows[c].uid,d)}};rcube_webmail.prototype.managesieve_act=function(){var c=this.filters_list.get_single_selection(),d=this.set_busy(true,"loading");this.http_post("plugin.managesieve-action","_act=act&_fid="+this.filters_list.rows[c].uid,d)};rcube_webmail.prototype.managesieve_select=function(d){var f=d.get_single_selection();if(f!=null){f=d.rows[f].uid;this.load_managesieveframe("_fid="+f)}var e=typeof(f)!="undefined"&&f!=null;this.enable_command("plugin.managesieve-act","plugin.managesieve-del",e)};rcube_webmail.prototype.managesieve_setselect=function(d){this.show_contentframe(false);this.filters_list.clear(true);this.enable_command("plugin.managesieve-setdel",d.rowcount>1);this.enable_command("plugin.managesieve-setact","plugin.managesieve-setget",d.rowcount>0);this.enable_command("plugin.managesieve-seteditraw",d.rowcount>0&&this.env.raw_sieve_editor);var c=d.get_single_selection();if(c!=null){this.managesieve_list(this.env.filtersets[c])}};rcube_webmail.prototype.managesieve_rowid=function(f){var e,d=this.filters_list.rows;for(e in d){if(d[e]!=null&&d[e].uid==f){return e}}};rcube_webmail.prototype.managesieve_setid=function(d){for(var c in this.env.filtersets){if(this.env.filtersets[c]==d){return c}}};rcube_webmail.prototype.managesieve_list=function(d){var c=this.set_busy(true,"loading");this.http_post("plugin.managesieve-action","_act=list&_set="+urlencode(d),c)};rcube_webmail.prototype.managesieve_setget=function(){var c=this.filtersets_list.get_single_selection(),d=this.env.filtersets[c];this.goto_url("plugin.managesieve-action",{_act:"setget",_set:d},false,true)};rcube_webmail.prototype.managesieve_setact=function(){var g=this.filtersets_list.get_single_selection(),e=this.set_busy(true,"loading"),f=this.env.filtersets[g],i=$("#rcmrow"+g).hasClass("disabled")?"setact":"deact";this.http_post("plugin.managesieve-action","_act="+i+"&_set="+urlencode(f),e)};rcube_webmail.prototype.managesieve_setdel=function(){if(!confirm(this.get_label("managesieve.setdeleteconfirm"))){return false}var f=this.filtersets_list.get_single_selection(),d=this.set_busy(true,"loading"),e=this.env.filtersets[f];this.http_post("plugin.managesieve-action","_act=setdel&_set="+urlencode(e),d)};rcube_webmail.prototype.managesieve_seteditraw=function(){var c=this.filtersets_list.get_single_selection(),d=this.env.filtersets[c];this.load_managesieveframe("_seteditraw=1&_set="+urlencode(d),true)};rcube_webmail.prototype.managesieve_setadd=function(){this.load_managesieveframe("_newset=1",true)};rcube_webmail.prototype.managesieve_updatelist=function(p,s){this.set_busy(true);switch(p){case"del":var u=s.id,n=this.filters_list;n.remove_row(this.managesieve_rowid(s.id));this.show_contentframe(false);this.reset_filters_list();$("tr",this.filters_list.list).each(function(){if(this.style.display=="none"){$(this).detach();return}var a=this.id.substr(6);$(this).off();if(a>u){this.uid=a-1;$(this).attr("id","rcmrow"+this.uid)}});n.init();break;case"update":var o,i=$("#rcmrow"+this.managesieve_rowid(s.id));if(s.name){$("td",i).text(s.name)}if(s.disabled){i.addClass("disabled")}else{i.removeClass("disabled")}$("#disabled",$("iframe").contents()).prop("checked",s.disabled);break;case"add":var n=this.filters_list,i=$('<tr><td class="name"></td></tr>');$("td",i).text(s.name);i.attr("id","rcmrow"+s.id);if(s.disabled){i.addClass("disabled")}n.insert_row(i.get(0));n.highlight_row(s.id);this.enable_command("plugin.managesieve-del","plugin.managesieve-act",true);break;case"list":var o,m,q,t,n=this.filters_list;if(s.clear){n.clear()}for(o in s.list){t=s.list[o];m=document.createElement("TR");q=document.createElement("TD");$(q).text(t.name);q.className="name";m.id="rcmrow"+t.id;if(t["class"]){m.className=t["class"]}m.appendChild(q);n.insert_row(m)}if(s.set){n.highlight_row(s.set)}else{this.enable_command("plugin.managesieve-del","plugin.managesieve-act",false)}break;case"setact":var u=this.managesieve_setid(s.name),i=$("#rcmrow"+u);if(s.active){if(s.all){$("tr",this.gui_objects.filtersetslist).addClass("disabled")}i.removeClass("disabled")}else{i.addClass("disabled")}break;case"setdel":var u=this.managesieve_setid(s.name);this.filtersets_list.remove_row(u);this.filters_list.clear();this.show_contentframe(false);this.enable_command("plugin.managesieve-setdel","plugin.managesieve-setact","plugin.managesieve-setget",false);delete this.env.filtersets[u];break;case"setadd":var u="S"+new Date().getTime(),n=this.filtersets_list,i=$('<tr class="disabled"><td class="name"></td></tr>');$("td",i).text(s.name);i.attr("id","rcmrow"+u);this.env.filtersets[u]=s.name;n.insert_row(i.get(0));if(s.index!=n.rowcount-1){i.detach();var r=$("tr:visible",n.list).get(s.index);i.insertBefore(r)}n.select(u);this.managesieve_fixdragend(i);break;case"refresh":this.reset_filters_list(true);break}this.set_busy(false)};rcube_webmail.prototype.reset_filters_list=function(d){this.filters_list.clear_selection();this.enable_command("plugin.managesieve-act","plugin.managesieve-del",false);if(d){var c=this.filtersets_list.get_single_selection();this.filters_list.clear(true);this.managesieve_list(this.env.filtersets[c])}};rcube_webmail.prototype.load_managesieveframe=function(f,d){if(d){this.reset_filters_list()}if(this.env.contentframe&&window.frames&&window.frames[this.env.contentframe]){var e=this.set_busy(true,"loading");target=window.frames[this.env.contentframe];target.location.href=this.env.comm_path+"&_action=plugin.managesieve-action&_framed=1&_unlock="+e+(f?("&"+f):"")}};rcube_webmail.prototype.managesieve_dragstart=function(d){var c=this.filters_list.get_single_selection();this.drag_active=true;this.drag_filter=c};rcube_webmail.prototype.managesieve_dragend=function(c){if(this.drag_active){if(this.drag_filter_target){var d=this.set_busy(true,"loading");this.show_contentframe(false);this.http_post("plugin.managesieve-action","_act=move&_fid="+this.drag_filter+"&_to="+this.drag_filter_target,d)}this.drag_active=false}};rcube_webmail.prototype.managesieve_fixdragend=function(d){var c=this;$(d).on("mouseup"+((bw.iphone||bw.ipad)?" touchend":""),function(a){if(c.drag_active){c.filters_list.drag_mouse_up(a)}})};rcube_webmail.prototype.managesieve_focus_filter=function(d){var c=d.id.replace(/^rcmrow/,"");if(this.drag_active&&c!=this.drag_filter){this.drag_filter_target=c;$(d.obj).addClass(c<this.drag_filter?"filtermoveup":"filtermovedown")}};rcube_webmail.prototype.managesieve_unfocus_filter=function(b){if(this.drag_active){$(b.obj).removeClass("filtermoveup filtermovedown");this.drag_filter_target=null}};rcube_webmail.prototype.managesieve_save=function(){if(this.env.action=="plugin.managesieve-vacation"){var d=$(this.gui_objects.sieveform).serialize();this.http_post("plugin.managesieve-vacation",d,this.display_message(this.get_label("managesieve.vacation.saving"),"loading"));return}if(this.gui_objects.sieveform){if(parent.rcmail&&parent.rcmail.filters_list&&this.gui_objects.sieveform.name!="filtersetform"){var c=parent.rcmail.filters_list.get_single_selection();if(c!=null){this.gui_objects.sieveform.elements._fid.value=parent.rcmail.filters_list.rows[c].uid}}this.gui_objects.sieveform.submit()}else{if(this.gui_objects.sievesetrawform){this.gui_objects.sievesetrawform.submit()}}};rcube_webmail.prototype.managesieve_ruleadd=function(b){this.http_post("plugin.managesieve-action","_act=ruleadd&_rid="+b)};rcube_webmail.prototype.managesieve_rulefill=function(g,i,k){if(g!=""){var j=document.getElementById("rules"),f=document.createElement("div");this.managesieve_insertrow(j,f,k);f.setAttribute("id","rulerow"+i);f.className="rulerow";f.innerHTML=g;$('textarea[data-type="list"]',f).each(function(){smart_field_init(this)});this.managesieve_formbuttons(j)}};rcube_webmail.prototype.managesieve_ruledel=function(c){if($("#ruledel"+c).hasClass("disabled")){return}if(confirm(this.get_label("managesieve.ruledeleteconfirm"))){var d=document.getElementById("rulerow"+c);d.parentNode.removeChild(d);this.managesieve_formbuttons(document.getElementById("rules"))}};rcube_webmail.prototype.managesieve_actionadd=function(b){this.http_post("plugin.managesieve-action","_act=actionadd&_aid="+b)};rcube_webmail.prototype.managesieve_actionfill=function(g,i,k){if(g!=""){var j=document.getElementById("actions"),f=document.createElement("div");this.managesieve_insertrow(j,f,k);f.className="actionrow";f.setAttribute("id","actionrow"+i);f.innerHTML=g;$('textarea[data-type="list"]',f).each(function(){smart_field_init(this)});this.managesieve_formbuttons(j)}};rcube_webmail.prototype.managesieve_actiondel=function(c){if($("#actiondel"+c).hasClass("disabled")){return}if(confirm(this.get_label("managesieve.actiondeleteconfirm"))){var d=document.getElementById("actionrow"+c);d.parentNode.removeChild(d);this.managesieve_formbuttons(document.getElementById("actions"))}};rcube_webmail.prototype.managesieve_insertrow=function(g,i,e){for(var f=0;f<g.childNodes.length;f++){if(g.childNodes[f].id==(g.id=="rules"?"rulerow":"actionrow")+e){break}}if(g.childNodes[f+1]){g.insertBefore(i,g.childNodes[f+1])}else{g.appendChild(i)}};rcube_webmail.prototype.managesieve_formbuttons=function(g){var e,f,i=[];for(e=0;e<g.childNodes.length;e++){if(g.id=="rules"&&g.childNodes[e].id){if(/rulerow/.test(g.childNodes[e].id)){i.push("ruledel"+g.childNodes[e].id.replace(/rulerow/,""))}}else{if(g.childNodes[e].id){if(/actionrow/.test(g.childNodes[e].id)){i.push("actiondel"+g.childNodes[e].id.replace(/actionrow/,""))}}}}for(e=0;e<i.length;e++){f=document.getElementById(i[e]);if(e>0||i.length>1){$(f).removeClass("disabled")}else{$(f).addClass("disabled")}}};rcube_webmail.prototype.managesieve_vacation_addresses=function(c){var d=this.set_busy(true,"loading");this.http_post("plugin.managesieve-action",{_act:"addresses",_aid:c},d)};rcube_webmail.prototype.managesieve_vacation_addresses_update=function(f,d){var e=$("#vacation_addresses,#action_addresses"+(f||""));smart_field_reset(e.get(0),d)};function rule_header_select(E){var C=document.getElementById("header"+E),q=document.getElementById("rule_size"+E),D=document.getElementById("rule_message"+E),x=document.getElementById("rule_op"+E),z=document.getElementById("custom_header"+E+"_list"),F=document.getElementById("custom_var"+E+"_list"),t=document.getElementById("rule_mod"+E),r=document.getElementById("rule_trans"+E),y=document.getElementById("rule_comp"+E),v=document.getElementById("rule_date_part"+E),A=document.getElementById("rule_date_header_div"+E),u=$("#rule_op"+E),B=C.value,s=[x,z,F,t,r,y,q];if(B=="size"){if(D){s.push(D)}$.each(s,function(){this.style.display="none"});q.style.display="inline"}else{if(B=="message"&&D){$.each(s,function(){this.style.display="none"});D.style.display="inline"}else{z.style.display=B!="..."?"none":"inline-block";F.style.display=B!="string"?"none":"inline-block";q.style.display="none";x.style.display="inline";y.style.display="";t.style.display=B=="body"||B=="currentdate"||B=="date"||B=="string"?"none":"block";r.style.display=B=="body"?"block":"none";if(D){D.style.display=B=="message"?"block":"none"}}}if(v){v.style.display=B=="currentdate"||B=="date"?"inline":"none"}if(A){A.style.display=B=="date"?"":"none"}$('[value="exists"],[value="notexists"]',u).prop("disabled",B=="string");if(!u.val()){u.val("contains")}rule_op_select(x,E,B);rule_mod_select(E,B);C.style.width=B=="..."?"40px":""}function rule_op_select(e,g,i){var f=document.getElementById("rule_target"+g+"_list");if(!i){i=document.getElementById("header"+g).value}f.style.display=e.value.match(/^(exists|notexists)$/)||i.match(/^(size|message)$/)?"none":"inline-block"}function rule_trans_select(f){var d=document.getElementById("rule_trans_op"+f),e=document.getElementById("rule_trans_type"+f);e.style.display=d.value!="content"?"none":"inline"}function rule_mod_select(j,k){var l=document.getElementById("rule_mod_op"+j),m=document.getElementById("rule_mod_type"+j),g=document.getElementById("rule_duplicate_div"+j),i=document.getElementById("rule_index_div"+j);if(!k){k=document.getElementById("header"+j).value}m.style.display=l.value!="address"&&l.value!="envelope"?"none":"inline";if(i){i.style.display=!k.match(/^(body|currentdate|size|message|string)$/)&&l.value!="envelope"?"":"none"}if(g){g.style.display=k=="message"?"":"none"}}function rule_join_radio(b){$("#rules").css("display",b=="any"?"none":"block")}function rule_adv_switch(g,i){var i=$(i),e=i.hasClass("hide"),f=$("#rule_advanced"+g);if(e){f.hide();i.removeClass("hide").addClass("show")}else{f.show();i.removeClass("show").addClass("hide")}}function action_type_select(j){var k=document.getElementById("action_type"+j),m=k.value,l={},g={mailbox:document.getElementById("action_mailbox"+j),target:document.getElementById("redirect_target"+j),target_area:document.getElementById("action_target_area"+j),flags:document.getElementById("action_flags"+j),vacation:document.getElementById("action_vacation"+j),set:document.getElementById("action_set"+j),notify:document.getElementById("action_notify"+j)};if(m=="fileinto"||m=="fileinto_copy"){l.mailbox=1}else{if(m=="redirect"||m=="redirect_copy"){l.target=1}else{if(m.match(/^reject|ereject$/)){l.target_area=1}else{if(m.match(/^(add|set|remove)flag$/)){l.flags=1}else{if(m=="vacation"){l.vacation=1}else{if(m=="set"){l.set=1}else{if(m=="notify"){l.notify=1}}}}}}}for(var i in g){g[i].style.display=!l[i]?"none":"inline"}}function vacation_action_select(){var b=$("#vacation_action").val();$("#action_target_span")[b=="discard"||b=="keep"?"hide":"show"]()}function smart_field_init(i){var g=i.id+"_list",f=$('<span class="listarea"></span>'),e=i.value?i.value.split("\n"):[""];if($("#"+g).length){return}$.each(e,function(a,b){f.append(smart_field_row(b,i.name,a,$(i).data("size")))});f.attr("id",g);i=$(i);if(i.attr("disabled")){f.hide()}else{i.prop("disabled",true)}i.after(f);if(i.hasClass("error")){f.addClass("error");rcmail.managesieve_tip_register([[g,i.data("tip")]])}}function smart_field_row(l,p,k,o){var j,m='<span class="listelement"><span class="reset"></span><input type="text"></span>',n=$(m),q={value:l,name:p+"[]"};if(o){q.size=o}j=$("input",n).attr(q).keydown(function(f){var d=$(this);if(f.which==13){var c=d.attr("name").replace(/\[\]$/,""),g=(new Date()).getTime(),a=smart_field_row("",c,g,o);d.parent().after(a);$("input",a).focus()}else{if((f.which==8||f.which==46)&&d.val()==""){var b=d.parent(),e=b.parent().children();if(e.length>1){if(b.prev().length){b.prev().children("input").focus()}else{b.next().children("input").focus()}b.remove();return false}}}});$('span[class="reset"]',n).click(function(){var a=$(this.parentNode);if(a.parent().children().length>1){a.remove()}else{$("input",a).val("").focus()}});return n}function smart_field_reset(i,e){var g=i.id+"_list",f=e.length?e:[""];area=$("#"+g);area.empty();$.each(f,function(a,b){area.append(smart_field_row(b,i.name,a,$(i).data("size")))})}rcube_webmail.prototype.managesieve_tip_register=function(f){var g,e=parent.rcmail,i=e?parent.rcmail.env.ms_tip_layer:rcmail.env.ms_tip_layer;for(g in f){$("#"+f[g][0]).data("tip",f[g][1]).mouseleave(function(a){i.hide()}).mouseenter(function(c){var n=$(this),b=n.offset(),d=b.left,m=b.top-12,a=n.width();if(e){b=$((rcmail.env.task=="mail"?"#sievefilterform > iframe":"#filter-box"),parent.document).offset();m+=b.top;d+=b.left}i.html(n.data("tip"));m-=i.height();i.css({left:d,top:m,minWidth:(a-2)+"px"}).show()})}};function sieve_formattime(i,o){var c,k,n,l="",m=rcmail.env.time_format||"H:i";for(c=0;c<m.length;c++){k=m.charAt(c);switch(k){case"a":l+=i>=12?"pm":"am";break;case"A":l+=i>=12?"PM":"AM";break;case"g":case"h":n=i==0?12:i>12?i-12:i;l+=(k=="h"&&i<10?"0":"")+i;break;case"G":l+=i;break;case"H":l+=(i<10?"0":"")+i;break;case"i":l+=(o<10?"0":"")+o;break;case"s":l+="00";default:l+=k}}return l}function sieve_form_init(){var b=rcmail.gui_objects.sieveform;if(rcmail.env.action=="plugin.managesieve"&&rcmail.env.task=="mail"){parent.rcmail.managesieve_dialog_resize(b)}$('input[type="text"]:first',b).focus();$('textarea[data-type="list"]',b).each(function(){smart_field_init(this)});$('[name="_header[]"]',b).each(function(){if(/([0-9]+)$/.test(this.id)){rule_header_select(RegExp.$1)}});if($.datepicker&&rcmail.env.date_format){$.datepicker.setDefaults({dateFormat:rcmail.env.date_format,changeMonth:true,showOtherMonths:true,selectOtherMonths:true,onSelect:function(a){$(this).focus().val(a)}});$("input.datepicker").datepicker()}$("#vacation_timefrom, #vacation_timeto").attr("autocomplete","off").autocomplete({delay:100,minLength:1,source:function(g,f){var i,a=[];for(i=0;i<24;i++){a.push(sieve_formattime(i,0))}a.push(sieve_formattime(23,59));return f(a)},open:function(a,l){var k=$(this),i=k.val(),m=k.autocomplete("widget").css("width","10em"),j=k.data("ui-autocomplete").menu;if(i&&i.length){m.children().each(function(){var c=$(this);if(c.text().indexOf(i)==0){j._scrollIntoView(c)}})}},select:function(a,d){$(this).val(d.item.value);return false}}).click(function(){$(this).autocomplete("search",$(this).val()||" ")});$("input.error").each(function(){if(String(this.id).match(/([0-9]+)$/)){$("#ruleadv"+RegExp.$1+".show").click()}})}var cmeditor;function cmCreateErrorElem(c){var d=document.createElement("div");d.style.color="#822";d.innerHTML="â—";d.title=c;return d}function cmScrollToError(){var d=$(".CodeMirror-lines .line-error"),e=$(".CodeMirror-scroll"),f=d.parent();e.scrollTop(d.offset().top-e.offset().top-Math.round(e.height()/2))}function sieve_raw_editor_init(){var b=document.getElementById("rawfiltersettxt");if(b&&!cmeditor){cmeditor=CodeMirror.fromTextArea(b,{mode:"sieve",lineNumbers:true,gutters:["CodeMirror-linenumbers","errorGutter"],styleActiveLine:true});$.each(rcmail.env.sieve_errors||[],function(a,f){var e=Number(f.line)-1;cmeditor.addLineClass(e,"background","line-error");cmeditor.setGutterMarker(e,"errorGutter",cmCreateErrorElem(f.msg));if(!a){cmScrollToError()}})}}rcube_webmail.prototype.managesieve_create=function(k){if(!k&&this.env.action!="show"){var m=this.message_list.get_single_selection(),n=this.set_busy(true,"loading");this.http_post("plugin.managesieve-action",{_uid:m},n);return}if(!this.env.sieve_headers||!this.env.sieve_headers.length){return}var o,i,l={},j=$("#sievefilterform");if(!j.length){j=$('<div id="sievefilterform"></div>');$("body").append(j)}i="<fieldset><legend>"+this.get_label("managesieve.usedata")+"</legend><ul>";for(o in this.env.sieve_headers){i+='<li><input type="checkbox" name="headers[]" id="sievehdr'+o+'" value="'+o+'" checked="checked" /><label for="sievehdr'+o+'">'+this.env.sieve_headers[o][0]+":</label> "+this.env.sieve_headers[o][1]+"</li>"}i+="</ul></fieldset>";j.html(i);l[this.get_label("managesieve.nextstep")]=function(){var b=$('input[name="headers[]"]:checked',j);if(!b.length){alert(rcmail.get_label("managesieve.nodata"));return}var c=rcmail.get_task_url("mail");c=rcmail.add_url(c,"_action","plugin.managesieve");c=rcmail.add_url(c,"_framed",1);b.map(function(){var d=rcmail.env.sieve_headers[this.value];c=rcmail.add_url(c,"r["+this.value+"]",d[0]+":"+d[1])});var a=$("<iframe>").attr({src:c,frameborder:0});j.empty().append(a).dialog("widget").resize();l={};l[rcmail.get_label("save")]=function(){var d=$("iframe",j).get(0).contentWindow;d.rcmail.managesieve_save()};j.dialog("option","buttons",l)};j.dialog({modal:false,resizable:true,closeOnEscape:true,title:this.get_label("managesieve.newfilter"),close:function(){rcmail.managesieve_dialog_close()},buttons:l,minWidth:600,minHeight:300,height:250}).show();this.env.managesieve_dialog=j};rcube_webmail.prototype.managesieve_dialog_close=function(){var b=this.env.managesieve_dialog;b.html("");b.dialog("destroy").hide()};rcube_webmail.prototype.managesieve_dialog_resize=function(g){var f=this.env.managesieve_dialog,i=$(window),e=$(g);width=$("fieldset:first",g).width(),height=e.height(),w=i.width(),h=i.height();f.dialog("option",{height:Math.min(h-20,height+120),width:Math.min(w-20,width+65)})};