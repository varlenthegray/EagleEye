if(window.rcmail){rcmail.addEventListener("init",function(a){if(rcmail.env.task=="mail"){if(rcmail.env.action!="show"){rcmail.env.message_commands.push("managesieve-create")}else{rcmail.enable_command("managesieve-create",true)}}if(rcmail.env.task=="mail"||rcmail.env.action.startsWith("plugin.managesieve")){if(!rcmail.env.framed){rcmail.env.ms_tip_layer=$('<div id="managesieve-tip" class="popupmenu"></div>');rcmail.env.ms_tip_layer.appendTo(document.body)}}rcmail.register_command("plugin.managesieve-save",function(){rcmail.managesieve_save()});rcmail.register_command("plugin.managesieve-act",function(){rcmail.managesieve_act()});rcmail.register_command("plugin.managesieve-add",function(){rcmail.managesieve_add()});rcmail.register_command("plugin.managesieve-del",function(){rcmail.managesieve_del()});rcmail.register_command("plugin.managesieve-move",function(){rcmail.managesieve_move()});rcmail.register_command("plugin.managesieve-setadd",function(){rcmail.managesieve_setadd()});rcmail.register_command("plugin.managesieve-setdel",function(){rcmail.managesieve_setdel()});rcmail.register_command("plugin.managesieve-setact",function(){rcmail.managesieve_setact()});rcmail.register_command("plugin.managesieve-setget",function(){rcmail.managesieve_setget()});rcmail.register_command("plugin.managesieve-seteditraw",function(){rcmail.managesieve_seteditraw()});if(rcmail.env.action.startsWith("plugin.managesieve")){if(rcmail.gui_objects.sieveform){rcmail.enable_command("plugin.managesieve-save",true);sieve_form_init()}else{if(rcmail.gui_objects.sievesetrawform){rcmail.enable_command("plugin.managesieve-save",true);sieve_raw_editor_init()}else{rcmail.enable_command("plugin.managesieve-add","plugin.managesieve-setadd",!rcmail.env.sieveconnerror)}}var b,c=rcmail.env.currentset;if(rcmail.gui_objects.filterslist){rcmail.filters_list=new rcube_list_widget(rcmail.gui_objects.filterslist,{multiselect:false,draggable:true,keyboard:true});rcmail.filters_list.addEventListener("select",function(d){rcmail.managesieve_select(d)}).addEventListener("dragstart",function(d){rcmail.managesieve_dragstart(d)}).addEventListener("dragend",function(d){rcmail.managesieve_dragend(d)}).addEventListener("initrow",function(d){d.obj.onmouseover=function(){rcmail.managesieve_focus_filter(d)};d.obj.onmouseout=function(){rcmail.managesieve_unfocus_filter(d)}}).init()}if(rcmail.gui_objects.filtersetslist){rcmail.filtersets_list=new rcube_list_widget(rcmail.gui_objects.filtersetslist,{multiselect:false,draggable:false,keyboard:true});rcmail.filtersets_list.init().focus();if(c!=null){c=rcmail.managesieve_setid(c);rcmail.filtersets_list.select(c)}rcmail.filtersets_list.addEventListener("select",function(d){rcmail.managesieve_setselect(d)});b=rcmail.filtersets_list.rowcount;rcmail.enable_command("plugin.managesieve-set",true);rcmail.enable_command("plugin.managesieve-setact","plugin.managesieve-setget",b>0);rcmail.enable_command("plugin.managesieve-setdel",b>1);rcmail.enable_command("plugin.managesieve-seteditraw",b>0&&rcmail.env.raw_sieve_editor);$("tr",rcmail.gui_objects.filtersetslist).each(function(d,f){rcmail.managesieve_fixdragend(f)})}}if(rcmail.gui_objects.sieveform&&rcmail.env.rule_disabled){$("#disabled").attr("checked",true)}})}rcube_webmail.prototype.managesieve_add=function(){this.load_managesieveframe("",true)};rcube_webmail.prototype.managesieve_del=function(){var b=this.filters_list.get_single_selection();if(confirm(this.get_label("managesieve.filterdeleteconfirm"))){var a=this.set_busy(true,"loading");this.http_post("plugin.managesieve-action","_act=delete&_fid="+this.filters_list.rows[b].uid,a)}};rcube_webmail.prototype.managesieve_act=function(){var b=this.filters_list.get_single_selection(),a=this.set_busy(true,"loading");this.http_post("plugin.managesieve-action","_act=act&_fid="+this.filters_list.rows[b].uid,a)};rcube_webmail.prototype.managesieve_select=function(b){var c=b.get_single_selection();if(c!=null){c=b.rows[c].uid;this.load_managesieveframe("_fid="+c)}var a=typeof(c)!="undefined"&&c!=null;this.enable_command("plugin.managesieve-act","plugin.managesieve-del",a)};rcube_webmail.prototype.managesieve_setselect=function(a){this.show_contentframe(false);this.filters_list.clear(true);this.enable_command("plugin.managesieve-setdel",a.rowcount>1);this.enable_command("plugin.managesieve-setact","plugin.managesieve-setget",a.rowcount>0);this.enable_command("plugin.managesieve-seteditraw",a.rowcount>0&&this.env.raw_sieve_editor);var b=a.get_single_selection();if(b!=null){this.managesieve_list(this.env.filtersets[b])}};rcube_webmail.prototype.managesieve_rowid=function(c){var a,b=this.filters_list.rows;for(a in b){if(b[a]!=null&&b[a].uid==c){return a}}};rcube_webmail.prototype.managesieve_setid=function(a){for(var b in this.env.filtersets){if(this.env.filtersets[b]==a){return b}}};rcube_webmail.prototype.managesieve_list=function(a){var b=this.set_busy(true,"loading");this.http_post("plugin.managesieve-action","_act=list&_set="+urlencode(a),b)};rcube_webmail.prototype.managesieve_setget=function(){var b=this.filtersets_list.get_single_selection(),a=this.env.filtersets[b];this.goto_url("plugin.managesieve-action",{_act:"setget",_set:a},false,true)};rcube_webmail.prototype.managesieve_setact=function(){var d=this.filtersets_list.get_single_selection(),b=this.set_busy(true,"loading"),a=this.env.filtersets[d],c=$("#rcmrow"+d).hasClass("disabled")?"setact":"deact";this.http_post("plugin.managesieve-action","_act="+c+"&_set="+urlencode(a),b)};rcube_webmail.prototype.managesieve_setdel=function(){if(!confirm(this.get_label("managesieve.setdeleteconfirm"))){return false}var c=this.filtersets_list.get_single_selection(),b=this.set_busy(true,"loading"),a=this.env.filtersets[c];this.http_post("plugin.managesieve-action","_act=setdel&_set="+urlencode(a),b)};rcube_webmail.prototype.managesieve_seteditraw=function(){var b=this.filtersets_list.get_single_selection(),a=this.env.filtersets[b];this.load_managesieveframe("_seteditraw=1&_set="+urlencode(a),true)};rcube_webmail.prototype.managesieve_setadd=function(){this.load_managesieveframe("_newset=1",true)};rcube_webmail.prototype.managesieve_updatelist=function(f,c){this.set_busy(true);switch(f){case"del":var a=c.id,j=this.filters_list;j.remove_row(this.managesieve_rowid(c.id));this.show_contentframe(false);this.reset_filters_list();$("tr",this.filters_list.list).each(function(){if(this.style.display=="none"){$(this).detach();return}var i=this.id.substr(6);$(this).off();if(i>a){this.uid=i-1;$(this).attr("id","rcmrow"+this.uid)}});j.init();break;case"update":var g,l=$("#rcmrow"+this.managesieve_rowid(c.id));if(c.name){$("td",l).text(c.name)}if(c.disabled){l.addClass("disabled")}else{l.removeClass("disabled")}$("#disabled",$("iframe").contents()).prop("checked",c.disabled);break;case"add":var j=this.filters_list,l=$('<tr><td class="name"></td></tr>');$("td",l).text(c.name);l.attr("id","rcmrow"+c.id);if(c.disabled){l.addClass("disabled")}j.insert_row(l.get(0));j.highlight_row(c.id);this.enable_command("plugin.managesieve-del","plugin.managesieve-act",true);break;case"list":var g,k,e,b,j=this.filters_list;if(c.clear){j.clear()}for(g in c.list){b=c.list[g];k=document.createElement("TR");e=document.createElement("TD");$(e).text(b.name);e.className="name";k.id="rcmrow"+b.id;if(b["class"]){k.className=b["class"]}k.appendChild(e);j.insert_row(k)}if(c.set){j.highlight_row(c.set)}else{this.enable_command("plugin.managesieve-del","plugin.managesieve-act",false)}break;case"setact":var a=this.managesieve_setid(c.name),l=$("#rcmrow"+a);if(c.active){if(c.all){$("tr",this.gui_objects.filtersetslist).addClass("disabled")}l.removeClass("disabled")}else{l.addClass("disabled")}break;case"setdel":var a=this.managesieve_setid(c.name);this.filtersets_list.remove_row(a);this.filters_list.clear();this.show_contentframe(false);this.enable_command("plugin.managesieve-setdel","plugin.managesieve-setact","plugin.managesieve-setget",false);delete this.env.filtersets[a];break;case"setadd":var a="S"+new Date().getTime(),j=this.filtersets_list,l=$('<tr class="disabled"><td class="name"></td></tr>');$("td",l).text(c.name);l.attr("id","rcmrow"+a);this.env.filtersets[a]=c.name;j.insert_row(l.get(0));if(c.index!=j.rowcount-1){l.detach();var d=$("tr:visible",j.list).get(c.index);l.insertBefore(d)}j.select(a);this.managesieve_fixdragend(l);break;case"refresh":this.reset_filters_list(true);break}this.set_busy(false)};rcube_webmail.prototype.reset_filters_list=function(a){this.filters_list.clear_selection();this.enable_command("plugin.managesieve-act","plugin.managesieve-del",false);if(a){var b=this.filtersets_list.get_single_selection();this.filters_list.clear(true);this.managesieve_list(this.env.filtersets[b])}};rcube_webmail.prototype.load_managesieveframe=function(c,b){if(b){this.reset_filters_list()}if(this.env.contentframe&&window.frames&&window.frames[this.env.contentframe]){var a=this.set_busy(true,"loading");target=window.frames[this.env.contentframe];target.location.href=this.env.comm_path+"&_action=plugin.managesieve-action&_framed=1&_unlock="+a+(c?("&"+c):"")}};rcube_webmail.prototype.managesieve_dragstart=function(a){var b=this.filters_list.get_single_selection();this.drag_active=true;this.drag_filter=b};rcube_webmail.prototype.managesieve_dragend=function(b){if(this.drag_active){if(this.drag_filter_target){var a=this.set_busy(true,"loading");this.show_contentframe(false);this.http_post("plugin.managesieve-action","_act=move&_fid="+this.drag_filter+"&_to="+this.drag_filter_target,a)}this.drag_active=false}};rcube_webmail.prototype.managesieve_fixdragend=function(a){var b=this;$(a).on("mouseup"+((bw.iphone||bw.ipad)?" touchend":""),function(c){if(b.drag_active){b.filters_list.drag_mouse_up(c)}})};rcube_webmail.prototype.managesieve_focus_filter=function(a){var b=a.id.replace(/^rcmrow/,"");if(this.drag_active&&b!=this.drag_filter){this.drag_filter_target=b;$(a.obj).addClass(b<this.drag_filter?"filtermoveup":"filtermovedown")}};rcube_webmail.prototype.managesieve_unfocus_filter=function(a){if(this.drag_active){$(a.obj).removeClass("filtermoveup filtermovedown");this.drag_filter_target=null}};rcube_webmail.prototype.managesieve_save=function(){if(this.env.action=="plugin.managesieve-vacation"){var a=$(this.gui_objects.sieveform).serialize();this.http_post("plugin.managesieve-vacation",a,this.display_message(this.get_label("managesieve.vacation.saving"),"loading"));return}if(this.gui_objects.sieveform){if(parent.rcmail&&parent.rcmail.filters_list&&this.gui_objects.sieveform.name!="filtersetform"){var b=parent.rcmail.filters_list.get_single_selection();if(b!=null){this.gui_objects.sieveform.elements._fid.value=parent.rcmail.filters_list.rows[b].uid}}this.gui_objects.sieveform.submit()}else{if(this.gui_objects.sievesetrawform){this.gui_objects.sievesetrawform.submit()}}};rcube_webmail.prototype.managesieve_ruleadd=function(a){this.http_post("plugin.managesieve-action","_act=ruleadd&_rid="+a)};rcube_webmail.prototype.managesieve_rulefill=function(a,e,c){if(a!=""){var d=document.getElementById("rules"),b=document.createElement("div");this.managesieve_insertrow(d,b,c);b.setAttribute("id","rulerow"+e);b.className="rulerow";b.innerHTML=a;$('textarea[data-type="list"]',b).each(function(){smart_field_init(this)});this.managesieve_formbuttons(d)}};rcube_webmail.prototype.managesieve_ruledel=function(b){if($("#ruledel"+b).hasClass("disabled")){return}if(confirm(this.get_label("managesieve.ruledeleteconfirm"))){var a=document.getElementById("rulerow"+b);a.parentNode.removeChild(a);this.managesieve_formbuttons(document.getElementById("rules"))}};rcube_webmail.prototype.managesieve_actionadd=function(a){this.http_post("plugin.managesieve-action","_act=actionadd&_aid="+a)};rcube_webmail.prototype.managesieve_actionfill=function(a,e,c){if(a!=""){var d=document.getElementById("actions"),b=document.createElement("div");this.managesieve_insertrow(d,b,c);b.className="actionrow";b.setAttribute("id","actionrow"+e);b.innerHTML=a;$('textarea[data-type="list"]',b).each(function(){smart_field_init(this)});this.managesieve_formbuttons(d)}};rcube_webmail.prototype.managesieve_actiondel=function(b){if($("#actiondel"+b).hasClass("disabled")){return}if(confirm(this.get_label("managesieve.actiondeleteconfirm"))){var a=document.getElementById("actionrow"+b);a.parentNode.removeChild(a);this.managesieve_formbuttons(document.getElementById("actions"))}};rcube_webmail.prototype.managesieve_insertrow=function(d,c,b){for(var a=0;a<d.childNodes.length;a++){if(d.childNodes[a].id==(d.id=="rules"?"rulerow":"actionrow")+b){break}}if(d.childNodes[a+1]){d.insertBefore(c,d.childNodes[a+1])}else{d.appendChild(c)}};rcube_webmail.prototype.managesieve_formbuttons=function(d){var b,a,c=[];for(b=0;b<d.childNodes.length;b++){if(d.id=="rules"&&d.childNodes[b].id){if(/rulerow/.test(d.childNodes[b].id)){c.push("ruledel"+d.childNodes[b].id.replace(/rulerow/,""))}}else{if(d.childNodes[b].id){if(/actionrow/.test(d.childNodes[b].id)){c.push("actiondel"+d.childNodes[b].id.replace(/actionrow/,""))}}}}for(b=0;b<c.length;b++){a=document.getElementById(c[b]);if(b>0||c.length>1){$(a).removeClass("disabled")}else{$(a).addClass("disabled")}}};rcube_webmail.prototype.managesieve_vacation_addresses=function(b){var a=this.set_busy(true,"loading");this.http_post("plugin.managesieve-action",{_act:"addresses",_aid:b},a)};rcube_webmail.prototype.managesieve_vacation_addresses_update=function(c,b){var a=$("#vacation_addresses,#action_addresses"+(c||""));smart_field_reset(a.get(0),b)};function rule_header_select(b){var d=document.getElementById("header"+b),p=document.getElementById("rule_size"+b),c=document.getElementById("rule_message"+b),j=document.getElementById("rule_op"+b),g=document.getElementById("custom_header"+b+"_list"),a=document.getElementById("custom_var"+b+"_list"),m=document.getElementById("rule_mod"+b),o=document.getElementById("rule_trans"+b),i=document.getElementById("rule_comp"+b),k=document.getElementById("rule_date_part"+b),f=document.getElementById("rule_date_header_div"+b),l=$("#rule_op"+b),e=d.value,n=[j,g,a,m,o,i,p];if(e=="size"){if(c){n.push(c)}$.each(n,function(){this.style.display="none"});p.style.display="inline"}else{if(e=="message"&&c){$.each(n,function(){this.style.display="none"});c.style.display="inline"}else{g.style.display=e!="..."?"none":"inline-block";a.style.display=e!="string"?"none":"inline-block";p.style.display="none";j.style.display="inline";i.style.display="";m.style.display=e=="body"||e=="currentdate"||e=="date"||e=="string"?"none":"block";o.style.display=e=="body"?"block":"none";if(c){c.style.display=e=="message"?"block":"none"}}}if(k){k.style.display=e=="currentdate"||e=="date"?"inline":"none"}if(f){f.style.display=e=="date"?"":"none"}$('[value="exists"],[value="notexists"]',l).prop("disabled",e=="string");if(!l.val()){l.val("contains")}rule_op_select(j,b,e);rule_mod_select(b,e);d.style.width=e=="..."?"40px":""}function rule_op_select(b,d,c){var a=document.getElementById("rule_target"+d+"_list");if(!c){c=document.getElementById("header"+d).value}a.style.display=b.value.match(/^(exists|notexists)$/)||c.match(/^(size|message)$/)?"none":"inline-block"}function rule_trans_select(c){var b=document.getElementById("rule_trans_op"+c),a=document.getElementById("rule_trans_type"+c);a.style.display=b.value!="content"?"none":"inline"}function rule_mod_select(f,e){var d=document.getElementById("rule_mod_op"+f),c=document.getElementById("rule_mod_type"+f),b=document.getElementById("rule_duplicate_div"+f),a=document.getElementById("rule_index_div"+f);if(!e){e=document.getElementById("header"+f).value}c.style.display=d.value!="address"&&d.value!="envelope"?"none":"inline";if(a){a.style.display=!e.match(/^(body|currentdate|size|message|string)$/)&&d.value!="envelope"?"":"none"}if(b){b.style.display=e=="message"?"":"none"}}function rule_join_radio(a){$("#rules").css("display",a=="any"?"none":"block")}function rule_adv_switch(d,c){var c=$(c),b=c.hasClass("hide"),a=$("#rule_advanced"+d);if(b){a.hide();c.removeClass("hide").addClass("show")}else{a.show();c.removeClass("show").addClass("hide")}}function action_type_select(f){var e=document.getElementById("action_type"+f),c=e.value,d={},b={mailbox:document.getElementById("action_mailbox"+f),target:document.getElementById("redirect_target"+f),target_area:document.getElementById("action_target_area"+f),flags:document.getElementById("action_flags"+f),vacation:document.getElementById("action_vacation"+f),set:document.getElementById("action_set"+f),notify:document.getElementById("action_notify"+f)};if(c=="fileinto"||c=="fileinto_copy"){d.mailbox=1}else{if(c=="redirect"||c=="redirect_copy"){d.target=1}else{if(c.match(/^reject|ereject$/)){d.target_area=1}else{if(c.match(/^(add|set|remove)flag$/)){d.flags=1}else{if(c=="vacation"){d.vacation=1}else{if(c=="set"){d.set=1}else{if(c=="notify"){d.notify=1}}}}}}}for(var a in b){b[a].style.display=!d[a]?"none":"inline"}}function vacation_action_select(){var a=$("#vacation_action").val();$("#action_target_span")[a=="discard"||a=="keep"?"hide":"show"]()}function smart_field_init(c){var d=c.id+"_list",a=$('<span class="listarea"></span>'),b=c.value?c.value.split("\n"):[""];if($("#"+d).length){return}$.each(b,function(f,e){a.append(smart_field_row(e,c.name,f,$(c).data("size")))});a.attr("id",d);c=$(c);if(c.attr("disabled")){a.hide()}else{c.prop("disabled",true)}c.after(a);if(c.hasClass("error")){a.addClass("error");rcmail.managesieve_tip_register([[d,c.data("tip")]])}}function smart_field_row(i,d,a,e){var b,g='<span class="listelement"><span class="reset"></span><input type="text"></span>',f=$(g),c={value:i,name:d+"[]"};if(e){c.size=e}b=$("input",f).attr(c).keydown(function(o){var j=$(this);if(o.which==13){var k=j.attr("name").replace(/\[\]$/,""),n=(new Date()).getTime(),m=smart_field_row("",k,n,e);j.parent().after(m);$("input",m).focus()}else{if((o.which==8||o.which==46)&&j.val()==""){var l=j.parent(),p=l.parent().children();if(p.length>1){if(l.prev().length){l.prev().children("input").focus()}else{l.next().children("input").focus()}l.remove();return false}}}});$('span[class="reset"]',f).click(function(){var j=$(this.parentNode);if(j.parent().children().length>1){j.remove()}else{$("input",j).val("").focus()}});return f}function smart_field_reset(c,b){var d=c.id+"_list",a=b.length?b:[""];area=$("#"+d);area.empty();$.each(a,function(f,e){area.append(smart_field_row(e,c.name,f,$(c).data("size")))})}rcube_webmail.prototype.managesieve_tip_register=function(a){var d,b=parent.rcmail,c=b?parent.rcmail.env.ms_tip_layer:rcmail.env.ms_tip_layer;for(d in a){$("#"+a[d][0]).data("tip",a[d][1]).mouseleave(function(f){c.hide()}).mouseenter(function(j){var f=$(this),k=f.offset(),i=k.left,g=k.top-12,l=f.width();if(b){k=$((rcmail.env.task=="mail"?"#sievefilterform > iframe":"#filter-box"),parent.document).offset();g+=k.top;i+=k.left}c.html(f.data("tip"));g-=c.height();c.css({left:i,top:g,minWidth:(l-2)+"px"}).show()})}};function sieve_formattime(a,d){var b,j,e,g="",f=rcmail.env.time_format||"H:i";for(b=0;b<f.length;b++){j=f.charAt(b);switch(j){case"a":g+=a>=12?"pm":"am";break;case"A":g+=a>=12?"PM":"AM";break;case"g":case"h":e=a==0?12:a>12?a-12:a;g+=(j=="h"&&a<10?"0":"")+a;break;case"G":g+=a;break;case"H":g+=(a<10?"0":"")+a;break;case"i":g+=(d<10?"0":"")+d;break;case"s":g+="00";default:g+=j}}return g}function sieve_form_init(){var a=rcmail.gui_objects.sieveform;if(rcmail.env.action=="plugin.managesieve"&&rcmail.env.task=="mail"){parent.rcmail.managesieve_dialog_resize(a)}$('input[type="text"]:first',a).focus();$('textarea[data-type="list"]',a).each(function(){smart_field_init(this)});$('[name="_header[]"]',a).each(function(){if(/([0-9]+)$/.test(this.id)){rule_header_select(RegExp.$1)}});if($.datepicker&&rcmail.env.date_format){$.datepicker.setDefaults({dateFormat:rcmail.env.date_format,changeMonth:true,showOtherMonths:true,selectOtherMonths:true,onSelect:function(b){$(this).focus().val(b)}});$("input.datepicker").datepicker()}$("#vacation_timefrom, #vacation_timeto").attr("autocomplete","off").autocomplete({delay:100,minLength:1,source:function(d,e){var c,b=[];for(c=0;c<24;c++){b.push(sieve_formattime(c,0))}b.push(sieve_formattime(23,59));return e(b)},open:function(b,d){var e=$(this),g=e.val(),c=e.autocomplete("widget").css("width","10em"),f=e.data("ui-autocomplete").menu;if(g&&g.length){c.children().each(function(){var i=$(this);if(i.text().indexOf(g)==0){f._scrollIntoView(i)}})}},select:function(b,c){$(this).val(c.item.value);return false}}).click(function(){$(this).autocomplete("search",$(this).val()||" ")});$("input.error").each(function(){if(String(this.id).match(/([0-9]+)$/)){$("#ruleadv"+RegExp.$1+".show").click()}})}var cmeditor;function cmCreateErrorElem(b){var a=document.createElement("div");a.style.color="#822";a.innerHTML="â—";a.title=b;return a}function cmScrollToError(){var b=$(".CodeMirror-lines .line-error"),a=$(".CodeMirror-scroll"),c=b.parent();a.scrollTop(b.offset().top-a.offset().top-Math.round(a.height()/2))}function sieve_raw_editor_init(){var a=document.getElementById("rawfiltersettxt");if(a&&!cmeditor){cmeditor=CodeMirror.fromTextArea(a,{mode:"sieve",lineNumbers:true,gutters:["CodeMirror-linenumbers","errorGutter"],styleActiveLine:true});$.each(rcmail.env.sieve_errors||[],function(b,c){var d=Number(c.line)-1;cmeditor.addLineClass(d,"background","line-error");cmeditor.setGutterMarker(d,"errorGutter",cmCreateErrorElem(c.msg));if(!b){cmScrollToError()}})}}rcube_webmail.prototype.managesieve_create=function(g){if(!g&&this.env.action!="show"){var e=this.message_list.get_single_selection(),d=this.set_busy(true,"loading");this.http_post("plugin.managesieve-action",{_uid:e},d);return}if(!this.env.sieve_headers||!this.env.sieve_headers.length){return}var c,b,f={},a=$("#sievefilterform");if(!a.length){a=$('<div id="sievefilterform"></div>');$("body").append(a)}b="<fieldset><legend>"+this.get_label("managesieve.usedata")+"</legend><ul>";for(c in this.env.sieve_headers){b+='<li><input type="checkbox" name="headers[]" id="sievehdr'+c+'" value="'+c+'" checked="checked" /><label for="sievehdr'+c+'">'+this.env.sieve_headers[c][0]+":</label> "+this.env.sieve_headers[c][1]+"</li>"}b+="</ul></fieldset>";a.html(b);f[this.get_label("managesieve.nextstep")]=function(){var j=$('input[name="headers[]"]:checked',a);if(!j.length){alert(rcmail.get_label("managesieve.nodata"));return}var i=rcmail.get_task_url("mail");i=rcmail.add_url(i,"_action","plugin.managesieve");i=rcmail.add_url(i,"_framed",1);j.map(function(){var l=rcmail.env.sieve_headers[this.value];i=rcmail.add_url(i,"r["+this.value+"]",l[0]+":"+l[1])});var k=$("<iframe>").attr({src:i,frameborder:0});a.empty().append(k).dialog("widget").resize();f={};f[rcmail.get_label("save")]=function(){var l=$("iframe",a).get(0).contentWindow;l.rcmail.managesieve_save()};a.dialog("option","buttons",f)};a.dialog({modal:false,resizable:true,closeOnEscape:true,title:this.get_label("managesieve.newfilter"),close:function(){rcmail.managesieve_dialog_close()},buttons:f,minWidth:600,minHeight:300,height:250}).show();this.env.managesieve_dialog=a};rcube_webmail.prototype.managesieve_dialog_close=function(){var a=this.env.managesieve_dialog;a.html("");a.dialog("destroy").hide()};rcube_webmail.prototype.managesieve_dialog_resize=function(d){var a=this.env.managesieve_dialog,c=$(window),b=$(d);width=$("fieldset:first",d).width(),height=b.height(),w=c.width(),h=c.height();a.dialog("option",{height:Math.min(h-20,height+120),width:Math.min(w-20,width+65)})};