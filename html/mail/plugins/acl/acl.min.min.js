if(window.rcmail){rcmail.addEventListener("init",function(){if(rcmail.gui_objects.acltable){rcmail.acl_list_init();if(rcmail.env.acl_users_source){var b=rcmail.is_framed()?parent.rcmail:rcmail;b.init_address_input_events($("#acluser"),{action:"settings/plugin.acl-autocomplete"});b.set_env({autocomplete_max:rcmail.env.autocomplete_max,autocomplete_min_length:rcmail.env.autocomplete_min_length});b.add_label("autocompletechars",rcmail.labels.autocompletechars);b.add_label("autocompletemore",rcmail.labels.autocompletemore);b.addEventListener("autocomplete_insert",function(a){if(a.field.id!="acluser"){return}a.field.value=a.insert.replace(/[ ,;]+$/,"")})}}rcmail.enable_command("acl-create","acl-save","acl-cancel","acl-mode-switch",true);rcmail.enable_command("acl-delete","acl-edit",false);if(rcmail.env.acl_advanced){$("#acl-switch").addClass("selected")}})}rcube_webmail.prototype.acl_create=function(){this.acl_init_form()};rcube_webmail.prototype.acl_edit=function(){var b=this.acl_list.get_single_selection();if(b){this.acl_init_form(b)}};rcube_webmail.prototype.acl_delete=function(){var b=this.acl_get_usernames();if(b&&b.length&&confirm(this.get_label("acl.deleteconfirm"))){this.http_post("settings/plugin.acl",{_act:"delete",_user:b.join(","),_mbox:this.env.mailbox},this.set_busy(true,"acl.deleting"))}};rcube_webmail.prototype.acl_save=function(){var h,e,g="",f=$("#acluser",this.acl_form).val();$((this.env.acl_advanced?"#advancedrights :checkbox":"#simplerights :checkbox"),this.acl_form).map(function(){if(this.checked){g+=this.value}});if(e=$("input:checked[name=usertype]",this.acl_form).val()){if(e!="user"){f=e}}if(!f){alert(this.get_label("acl.nouser"));return}if(!g){alert(this.get_label("acl.norights"));return}h={_act:"save",_user:f,_acl:g,_mbox:this.env.mailbox};if(this.acl_id){h._old=this.acl_id}this.http_post("settings/plugin.acl",h,this.set_busy(true,"acl.saving"))};rcube_webmail.prototype.acl_cancel=function(){this.ksearch_blur();this.acl_popup.dialog("close")};rcube_webmail.prototype.acl_update=function(b){if(b.old){this.acl_remove_row(b.old)}else{if(this.env.acl[b.id]){this.acl_remove_row(b.id)}}this.acl_add_row(b,true);this.ksearch_blur();this.acl_popup.dialog("close")};rcube_webmail.prototype.acl_mode_switch=function(b){this.env.acl_advanced=!this.env.acl_advanced;this.enable_command("acl-delete","acl-edit",false);this.http_request("settings/plugin.acl","_act=list&_mode="+(this.env.acl_advanced?"advanced":"simple")+"&_mbox="+urlencode(this.env.mailbox),this.set_busy(true,"loading"))};rcube_webmail.prototype.acl_list_init=function(){var b=this.env.acl_advanced?"addClass":"removeClass";$("#acl-switch")[b]("selected");$(this.gui_objects.acltable)[b]("advanced");this.acl_list=new rcube_list_widget(this.gui_objects.acltable,{multiselect:true,draggable:false,keyboard:true});this.acl_list.addEventListener("select",function(a){rcmail.acl_list_select(a)}).addEventListener("dblclick",function(a){rcmail.acl_list_dblclick(a)}).addEventListener("keypress",function(a){rcmail.acl_list_keypress(a)}).init()};rcube_webmail.prototype.acl_list_select=function(b){rcmail.enable_command("acl-delete",b.selection.length>0);rcmail.enable_command("acl-edit",b.selection.length==1);b.focus()};rcube_webmail.prototype.acl_list_dblclick=function(b){this.acl_edit()};rcube_webmail.prototype.acl_list_keypress=function(b){if(b.key_pressed==b.ENTER_KEY){this.command("acl-edit")}else{if(b.key_pressed==b.DELETE_KEY||b.key_pressed==b.BACKSPACE_KEY){if(!this.acl_form||!this.acl_form.is(":visible")){this.command("acl-delete")}}}};rcube_webmail.prototype.acl_list_update=function(b){$(this.gui_objects.acltable).html(b);this.acl_list_init()};rcube_webmail.prototype.acl_get_usernames=function(){var j=[],k,h,i,l,m=this.acl_list,n=m.get_selection();for(k=0,h=n.length;k<h;k++){if(this.env.acl_specials.length&&$.inArray(n[k],this.env.acl_specials)>=0){j.push(n[k])}else{if(l=m.rows[n[k]]){i=$("td.user",l.obj);if(i.length==1){j.push(i.text())}}}}return j};rcube_webmail.prototype.acl_remove_row=function(c){var d=this.acl_list;d.remove_row(c);d.clear_selection();$("#rcmrow"+c).remove();this.env.acl[c]=null;this.enable_command("acl-delete",d.selection.length>0);this.enable_command("acl-edit",d.selection.length==1)};rcube_webmail.prototype.acl_add_row=function(t,s){var r,q,v=[],n=[],u=t.id,p=this.acl_list,o=this.env.acl_advanced?[]:this.env.acl_items,m=this.gui_objects.acltable,l=$("thead > tr",m).clone();$("th",l).map(function(){var c=$("<td>"),a=$(this).attr("title"),b=this.className.replace(/^acl/,"");if(a){c.attr("title",a)}if(o&&o[b]){b=o[b]}if(b=="user"){c.addClass(b).append($("<a>").text(t.username))}else{c.addClass(this.className+" "+rcmail.acl_class(t.acl,b)).text("")}$(this).replaceWith(c)});l.attr("id","rcmrow"+u);l=l.get(0);this.env.acl[u]=t.acl;for(r in this.env.acl){if(this.env.acl[r]){if(this.env.acl_specials.length&&$.inArray(r,this.env.acl_specials)>=0){n.push(r)}else{v.push(r)}}}v.sort();v=n.concat(v);for(r=0,q=v.length;r<q;r++){if(v[r]==u){break}}if(r&&r<q){$("#rcmrow"+v[r-1]).after(l);p.init_row(l);p.rowcount++}else{p.insert_row(l)}if(s){p.select_row(t.id)}};rcube_webmail.prototype.acl_init_form=function(D){var v,p,z,B="",s="user",A,y=$("body"),x=$("#advancedrights"),q=$("#simplerights"),C=$("#acluser"),w=$("#usertype");if(!this.acl_form){var r=function(){$('input[value="user"]').prop("checked",true)};C.click(r).keypress(r)}this.acl_form=$("#aclform");if(this.env.acl_advanced){x.show();q.hide();v=x}else{q.show();x.hide();v=q}A=$(":checkbox",v);A.attr("checked",false);if(D&&(p=this.acl_list.rows[D])){p=p.obj;A.map(function(){z=$("td."+this.id,p);if(z.length&&z.hasClass("enabled")){this.checked=true}});if(!this.env.acl_specials.length||$.inArray(D,this.env.acl_specials)<0){B=$("td.user",p).text()}else{s=D}}else{A.filter(function(){return this.id.match(/^acl([lrs]|read)$/)}).prop("checked",true)}C.val(B);$("input[value="+s+"]").prop("checked",true);this.acl_id=D;var t={},u=this,y=document.body;t[this.get_label("save")]=function(a){u.command("acl-save")};t[this.get_label("cancel")]=function(a){u.command("acl-cancel")};this.acl_popup=this.show_popup_dialog(this.acl_form.show(),D?this.get_label("acl.editperms"):this.get_label("acl.newuser"),t,{button_classes:["mainaction"],modal:true,closeOnEscape:true,close:function(a,b){(u.is_framed()?parent.rcmail:u).ksearch_hide();u.acl_form.appendTo(y).hide();$(this).remove();window.focus()}});if(s=="user"){C.focus()}else{$("input:checked",w).focus()}};rcube_webmail.prototype.acl_class=function(h,j){var f,g,i=0;h=String(h);j=String(j);for(f=0,g=j.length;f<g;f++){if(h.indexOf(j[f])>-1){i++}}if(i==g){return"enabled"}else{if(i){return"partial"}}return"disabled"};