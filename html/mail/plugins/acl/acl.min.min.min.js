if(window.rcmail){rcmail.addEventListener("init",function(){if(rcmail.gui_objects.acltable){rcmail.acl_list_init();if(rcmail.env.acl_users_source){var a=rcmail.is_framed()?parent.rcmail:rcmail;a.init_address_input_events($("#acluser"),{action:"settings/plugin.acl-autocomplete"});a.set_env({autocomplete_max:rcmail.env.autocomplete_max,autocomplete_min_length:rcmail.env.autocomplete_min_length});a.add_label("autocompletechars",rcmail.labels.autocompletechars);a.add_label("autocompletemore",rcmail.labels.autocompletemore);a.addEventListener("autocomplete_insert",function(b){if(b.field.id!="acluser"){return}b.field.value=b.insert.replace(/[ ,;]+$/,"")})}}rcmail.enable_command("acl-create","acl-save","acl-cancel","acl-mode-switch",true);rcmail.enable_command("acl-delete","acl-edit",false);if(rcmail.env.acl_advanced){$("#acl-switch").addClass("selected")}})}rcube_webmail.prototype.acl_create=function(){this.acl_init_form()};rcube_webmail.prototype.acl_edit=function(){var a=this.acl_list.get_single_selection();if(a){this.acl_init_form(a)}};rcube_webmail.prototype.acl_delete=function(){var a=this.acl_get_usernames();if(a&&a.length&&confirm(this.get_label("acl.deleteconfirm"))){this.http_post("settings/plugin.acl",{_act:"delete",_user:a.join(","),_mbox:this.env.mailbox},this.set_busy(true,"acl.deleting"))}};rcube_webmail.prototype.acl_save=function(){var a,d,b="",c=$("#acluser",this.acl_form).val();$((this.env.acl_advanced?"#advancedrights :checkbox":"#simplerights :checkbox"),this.acl_form).map(function(){if(this.checked){b+=this.value}});if(d=$("input:checked[name=usertype]",this.acl_form).val()){if(d!="user"){c=d}}if(!c){alert(this.get_label("acl.nouser"));return}if(!b){alert(this.get_label("acl.norights"));return}a={_act:"save",_user:c,_acl:b,_mbox:this.env.mailbox};if(this.acl_id){a._old=this.acl_id}this.http_post("settings/plugin.acl",a,this.set_busy(true,"acl.saving"))};rcube_webmail.prototype.acl_cancel=function(){this.ksearch_blur();this.acl_popup.dialog("close")};rcube_webmail.prototype.acl_update=function(a){if(a.old){this.acl_remove_row(a.old)}else{if(this.env.acl[a.id]){this.acl_remove_row(a.id)}}this.acl_add_row(a,true);this.ksearch_blur();this.acl_popup.dialog("close")};rcube_webmail.prototype.acl_mode_switch=function(a){this.env.acl_advanced=!this.env.acl_advanced;this.enable_command("acl-delete","acl-edit",false);this.http_request("settings/plugin.acl","_act=list&_mode="+(this.env.acl_advanced?"advanced":"simple")+"&_mbox="+urlencode(this.env.mailbox),this.set_busy(true,"loading"))};rcube_webmail.prototype.acl_list_init=function(){var a=this.env.acl_advanced?"addClass":"removeClass";$("#acl-switch")[a]("selected");$(this.gui_objects.acltable)[a]("advanced");this.acl_list=new rcube_list_widget(this.gui_objects.acltable,{multiselect:true,draggable:false,keyboard:true});this.acl_list.addEventListener("select",function(b){rcmail.acl_list_select(b)}).addEventListener("dblclick",function(b){rcmail.acl_list_dblclick(b)}).addEventListener("keypress",function(b){rcmail.acl_list_keypress(b)}).init()};rcube_webmail.prototype.acl_list_select=function(a){rcmail.enable_command("acl-delete",a.selection.length>0);rcmail.enable_command("acl-edit",a.selection.length==1);a.focus()};rcube_webmail.prototype.acl_list_dblclick=function(a){this.acl_edit()};rcube_webmail.prototype.acl_list_keypress=function(a){if(a.key_pressed==a.ENTER_KEY){this.command("acl-edit")}else{if(a.key_pressed==a.DELETE_KEY||a.key_pressed==a.BACKSPACE_KEY){if(!this.acl_form||!this.acl_form.is(":visible")){this.command("acl-delete")}}}};rcube_webmail.prototype.acl_list_update=function(a){$(this.gui_objects.acltable).html(a);this.acl_list_init()};rcube_webmail.prototype.acl_get_usernames=function(){var d=[],c,f,e,b,a=this.acl_list,g=a.get_selection();for(c=0,f=g.length;c<f;c++){if(this.env.acl_specials.length&&$.inArray(g[c],this.env.acl_specials)>=0){d.push(g[c])}else{if(b=a.rows[g[c]]){e=$("td.user",b.obj);if(e.length==1){d.push(e.text())}}}}return d};rcube_webmail.prototype.acl_remove_row=function(b){var a=this.acl_list;a.remove_row(b);a.clear_selection();$("#rcmrow"+b).remove();this.env.acl[b]=null;this.enable_command("acl-delete",a.selection.length>0);this.enable_command("acl-edit",a.selection.length==1)};rcube_webmail.prototype.acl_add_row=function(j,k){var a,b,h=[],e=[],i=j.id,c=this.acl_list,d=this.env.acl_advanced?[]:this.env.acl_items,f=this.gui_objects.acltable,g=$("thead > tr",f).clone();$("th",g).map(function(){var n=$("<td>"),m=$(this).attr("title"),l=this.className.replace(/^acl/,"");if(m){n.attr("title",m)}if(d&&d[l]){l=d[l]}if(l=="user"){n.addClass(l).append($("<a>").text(j.username))}else{n.addClass(this.className+" "+rcmail.acl_class(j.acl,l)).text("")}$(this).replaceWith(n)});g.attr("id","rcmrow"+i);g=g.get(0);this.env.acl[i]=j.acl;for(a in this.env.acl){if(this.env.acl[a]){if(this.env.acl_specials.length&&$.inArray(a,this.env.acl_specials)>=0){e.push(a)}else{h.push(a)}}}h.sort();h=e.concat(h);for(a=0,b=h.length;a<b;a++){if(h[a]==i){break}}if(a&&a<b){$("#rcmrow"+h[a-1]).after(g);c.init_row(g);c.rowcount++}else{c.insert_row(g)}if(k){c.select_row(j.id)}};rcube_webmail.prototype.acl_init_form=function(b){var l,f,h,e="",o="user",g,i=$("body"),j=$("#advancedrights"),d=$("#simplerights"),c=$("#acluser"),k=$("#usertype");if(!this.acl_form){var a=function(){$('input[value="user"]').prop("checked",true)};c.click(a).keypress(a)}this.acl_form=$("#aclform");if(this.env.acl_advanced){j.show();d.hide();l=j}else{d.show();j.hide();l=d}g=$(":checkbox",l);g.attr("checked",false);if(b&&(f=this.acl_list.rows[b])){f=f.obj;g.map(function(){h=$("td."+this.id,f);if(h.length&&h.hasClass("enabled")){this.checked=true}});if(!this.env.acl_specials.length||$.inArray(b,this.env.acl_specials)<0){e=$("td.user",f).text()}else{o=b}}else{g.filter(function(){return this.id.match(/^acl([lrs]|read)$/)}).prop("checked",true)}c.val(e);$("input[value="+o+"]").prop("checked",true);this.acl_id=b;var n={},m=this,i=document.body;n[this.get_label("save")]=function(p){m.command("acl-save")};n[this.get_label("cancel")]=function(p){m.command("acl-cancel")};this.acl_popup=this.show_popup_dialog(this.acl_form.show(),b?this.get_label("acl.editperms"):this.get_label("acl.newuser"),n,{button_classes:["mainaction"],modal:true,closeOnEscape:true,close:function(q,p){(m.is_framed()?parent.rcmail:m).ksearch_hide();m.acl_form.appendTo(i).hide();$(this).remove();window.focus()}});if(o=="user"){c.focus()}else{$("input:checked",k).focus()}};rcube_webmail.prototype.acl_class=function(c,a){var e,d,b=0;c=String(c);a=String(a);for(e=0,d=a.length;e<d;e++){if(c.indexOf(a[e])>-1){b++}}if(b==d){return"enabled"}else{if(b){return"partial"}}return"disabled"};