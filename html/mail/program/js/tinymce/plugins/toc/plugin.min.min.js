tinymce.PluginManager.add("toc",function(B){function G(a){return B.schema.isValidChild("div",a)}function q(a){return a&&B.dom.is(a,"."+C.className)&&B.getBody().contains(a)}function b(){var a=this;a.disabled(B.readonly||!k()),B.on("LoadContent SetContent change",function(){a.disabled(B.readonly||!k())})}function x(c){var a,d=[];for(a=1;a<=c;a++){d.push("h"+a)}return d.join(",")}function k(){return !(!C||!E(C).length)}function E(a){var d=x(a.depth),c=A(d);return c.length&&/^h[1-9]$/i.test(a.headerTag)&&(c=c.filter(function(f,e){return !B.dom.hasClass(e.parentNode,a.className)})),tinymce.map(c,function(f){return f.id||(f.id=z()),{id:f.id,level:parseInt(f.nodeName.replace(/^H/i,""),10),title:A.text(f)}})}function H(c){var a,d=9;for(a=0;a<c.length;a++){if(c[a].level<d&&(d=c[a].level),1==d){return d}}return d}function w(c,e){var d="<"+c+' contenteditable="true">',a="</"+c+">";return d+B.dom.encode(e)+a}function D(c){var a=F(c);return'<div class="'+c.className+'" contenteditable="false">'+a+"</div>"}function F(h){var f,p,g,d,l="",m=E(h),a=H(m)-1;if(!m.length){return""}for(l+=w(h.headerTag,tinymce.translate("Table of Contents")),f=0;f<m.length;f++){if(g=m[f],d=m[f+1]&&m[f+1].level,a===g.level){l+="<li>"}else{for(p=a;p<g.level;p++){l+="<ul><li>"}}if(l+='<a href="#'+g.id+'">'+g.title+"</a>",d!==g.level&&d){for(p=g.level;p>d;p--){l+="</li></ul><li>"}}else{l+="</li>",d||(l+="</ul>")}a=g.level}return l}var C,A=B.$,j={depth:3,headerTag:"h2",className:"mce-toc"},v=function(c){var a=0;return function(){var d=(new Date).getTime().toString(32);return c+d+(a++).toString(32)}},z=v("mcetoc_");B.on("PreInit",function(){var c=B.settings,a=parseInt(c.toc_depth,10)||0;C={depth:a>=1&&a<=9?a:j.depth,headerTag:G(c.toc_header)?c.toc_header:j.headerTag,className:c.toc_class?B.dom.encode(c.toc_class):j.className}}),B.on("PreProcess",function(c){var a=A("."+C.className,c.node);a.length&&(a.removeAttr("contentEditable"),a.find("[contenteditable]").removeAttr("contentEditable"))}),B.on("SetContent",function(){var a=A("."+C.className);a.length&&(a.attr("contentEditable",!1),a.children(":first-child").attr("contentEditable",!0))});var y=function(a){return !a.length||B.dom.getParents(a[0],".mce-offscreen-selection").length>0};B.addCommand("mceInsertToc",function(){var a=A("."+C.className);y(a)?B.insertContent(D(C)):B.execCommand("mceUpdateToc")}),B.addCommand("mceUpdateToc",function(){var a=A("."+C.className);a.length&&B.undoManager.transact(function(){a.html(F(C))})}),B.addButton("toc",{tooltip:"Table of Contents",cmd:"mceInsertToc",icon:"toc",onPostRender:b}),B.addButton("tocupdate",{tooltip:"Update",cmd:"mceUpdateToc",icon:"reload"}),B.addContextToolbar(q,"tocupdate"),B.addMenuItem("toc",{text:"Table of Contents",context:"insert",cmd:"mceInsertToc",onPostRender:b})});