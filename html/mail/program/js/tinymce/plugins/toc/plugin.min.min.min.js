tinymce.PluginManager.add("toc",function(e){function s(b){return e.schema.isValidChild("div",b)}function d(b){return b&&e.dom.is(b,"."+c.className)&&e.getBody().contains(b)}function m(){var b=this;b.disabled(e.readonly||!g()),e.on("LoadContent SetContent change",function(){b.disabled(e.readonly||!g())})}function n(k){var b,j=[];for(b=1;b<=k;b++){j.push("h"+b)}return j.join(",")}function g(){return !(!c||!u(c).length)}function u(b){var j=n(b.depth),k=f(j);return k.length&&/^h[1-9]$/i.test(b.headerTag)&&(k=k.filter(function(q,v){return !e.dom.hasClass(v.parentNode,b.className)})),tinymce.map(k,function(q){return q.id||(q.id=i()),{id:q.id,level:parseInt(q.nodeName.replace(/^H/i,""),10),title:f.text(q)}})}function r(k){var b,j=9;for(b=0;b<k.length;b++){if(k[b].level<j&&(j=k[b].level),1==j){return j}}return j}function o(q,j){var k="<"+q+' contenteditable="true">',b="</"+q+">";return k+e.dom.encode(j)+b}function a(j){var b=t(j);return'<div class="'+j.className+'" contenteditable="false">'+b+"</div>"}function t(q){var w,x,v,y,k="",b=u(q),j=r(b)-1;if(!b.length){return""}for(k+=o(q.headerTag,tinymce.translate("Table of Contents")),w=0;w<b.length;w++){if(v=b[w],y=b[w+1]&&b[w+1].level,j===v.level){k+="<li>"}else{for(x=j;x<v.level;x++){k+="<ul><li>"}}if(k+='<a href="#'+v.id+'">'+v.title+"</a>",y!==v.level&&y){for(x=v.level;x>y;x--){k+="</li></ul><li>"}}else{k+="</li>",y||(k+="</ul>")}j=v.level}return k}var c,f=e.$,h={depth:3,headerTag:"h2",className:"mce-toc"},p=function(j){var b=0;return function(){var k=(new Date).getTime().toString(32);return j+k+(b++).toString(32)}},i=p("mcetoc_");e.on("PreInit",function(){var j=e.settings,b=parseInt(j.toc_depth,10)||0;c={depth:b>=1&&b<=9?b:h.depth,headerTag:s(j.toc_header)?j.toc_header:h.headerTag,className:j.toc_class?e.dom.encode(j.toc_class):h.className}}),e.on("PreProcess",function(j){var b=f("."+c.className,j.node);b.length&&(b.removeAttr("contentEditable"),b.find("[contenteditable]").removeAttr("contentEditable"))}),e.on("SetContent",function(){var b=f("."+c.className);b.length&&(b.attr("contentEditable",!1),b.children(":first-child").attr("contentEditable",!0))});var l=function(b){return !b.length||e.dom.getParents(b[0],".mce-offscreen-selection").length>0};e.addCommand("mceInsertToc",function(){var b=f("."+c.className);l(b)?e.insertContent(a(c)):e.execCommand("mceUpdateToc")}),e.addCommand("mceUpdateToc",function(){var b=f("."+c.className);b.length&&e.undoManager.transact(function(){b.html(t(c))})}),e.addButton("toc",{tooltip:"Table of Contents",cmd:"mceInsertToc",icon:"toc",onPostRender:m}),e.addButton("tocupdate",{tooltip:"Update",cmd:"mceUpdateToc",icon:"reload"}),e.addContextToolbar(d,"tocupdate"),e.addMenuItem("toc",{text:"Table of Contents",context:"insert",cmd:"mceInsertToc",onPostRender:m})});