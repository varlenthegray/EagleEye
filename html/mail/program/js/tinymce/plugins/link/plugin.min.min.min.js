tinymce.PluginManager.add("link",function(i){function t(b){return b&&"A"===b.nodeName&&b.href}function a(b){return tinymce.util.Tools.grep(b,t).length>0}function h(b){return i.dom.getParent(b,"a[href]")}function o(){return h(i.selection.getStart())}function d(j){var b=j.getAttribute("data-mce-href");return b?b:j.getAttribute("href")}function c(){var b=i.plugins.contextmenu;return !!b&&b.isContextMenuVisible()}function r(j){var q,b,k;return !!(i.settings.link_context_toolbar&&!c()&&t(j)&&(q=i.selection,b=q.getRng(),k=b.startContainer,3==k.nodeType&&q.isCollapsed()&&b.startOffset>0&&b.startOffset<k.data.length))}function p(j,b){document.body.appendChild(j),j.dispatchEvent(b),document.body.removeChild(j)}function e(k){if(!tinymce.Env.ie||tinymce.Env.ie>10){var w=document.createElement("a");w.target="_blank",w.href=k,w.rel="noreferrer noopener";var j=document.createEvent("MouseEvents");j.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),p(w,j)}else{var q=window.open("","_blank");if(q){q.opener=null;var b=q.document;b.open(),b.write('<meta http-equiv="refresh" content="0; url='+tinymce.DOM.encode(k)+'">'),b.close()}}}function u(b){if(b){var j=d(b);if(/^#/.test(j)){var k=i.$(j);k.length&&i.selection.scrollIntoView(k[0],!0)}else{e(b.href)}}}function g(){u(o())}function l(){var b=this,j=function(k){a(k.parents)?b.show():b.hide()};a(i.dom.getParents(i.selection.getStart()))||b.hide(),i.on("nodechange",j),b.on("remove",function(){i.off("nodechange",j)})}function f(b){return function(){var j=i.settings.link_list;"string"==typeof j?tinymce.util.XHR.send({url:j,success:function(k){b(tinymce.util.JSON.parse(k))}}):"function"==typeof j?j(b):b(j)}}function s(k,b,j){function q(x,w){return w=w||[],tinymce.each(x,function(y){var z={text:y.text||y.title};y.menu?z.menu=q(y.menu):(z.value=y.value,b&&b(z)),w.push(z)}),w}return q(k,j||[])}function m(D){function x(L){var K=af.find("#text");(!K.value()||L.lastControl&&K.value()==L.lastControl.text())&&K.value(L.control.text()),af.find("#href").value(L.control.value())}function A(K){var L=[];if(tinymce.each(i.dom.select("a:not([href])"),function(O){var M=O.name||O.id;M&&L.push({text:M,value:"#"+M,selected:K.indexOf("#"+M)!=-1})}),L.length){return L.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:L,onselect:x}}}function k(){!E&&0===G.text.length&&b&&this.parent().parent().find("#text")[0].value(this.value())}function y(K){var L=K.meta||{};j&&j.value(i.convertURL(this.value(),"href")),tinymce.each(K.meta,function(O,P){var M=af.find("#"+P);"text"===P?0===E.length&&(M.value(O),G.text=O):M.value(O)}),L.attach&&(n={href:this.value(),attach:L.attach}),L.text||k.call(this)}function N(M){var K=J.getContent();if(/</.test(K)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(K)||K.indexOf("href=")==-1)){return !1}if(M){var L,O=M.childNodes;if(0===O.length){return !1}for(L=O.length-1;L>=0;L--){if(3!=O[L].nodeType){return !1}}}return !0}function C(K){K.meta=af.toJSON()}var w,ae,E,af,b,z,j,F,ad,I,H,B,G={},J=i.selection,q=i.dom;w=J.getNode(),ae=q.getParent(w,"a[href]"),b=N(),G.text=E=ae?ae.innerText||ae.textContent:J.getContent({format:"text"}),G.href=ae?q.getAttrib(ae,"href"):"",ae?G.target=q.getAttrib(ae,"target"):i.settings.default_link_target&&(G.target=i.settings.default_link_target),(B=q.getAttrib(ae,"rel"))&&(G.rel=B),(B=q.getAttrib(ae,"class"))&&(G["class"]=B),(B=q.getAttrib(ae,"title"))&&(G.title=B),b&&(z={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){G.text=this.value()}}),D&&(j={type:"listbox",label:"Link list",values:s(D,function(K){K.value=i.convertURL(K.value||K.url,"href")},[{text:"None",value:""}]),onselect:x,value:i.convertURL(G.href,"href"),onPostRender:function(){j=this}}),i.settings.target_list!==!1&&(i.settings.target_list||(i.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),ad={name:"target",type:"listbox",label:"Target",values:s(i.settings.target_list)}),i.settings.rel_list&&(F={name:"rel",type:"listbox",label:"Rel",values:s(i.settings.rel_list)}),i.settings.link_class_list&&(I={name:"class",type:"listbox",label:"Class",values:s(i.settings.link_class_list,function(K){K.value&&(K.textStyle=function(){return i.formatter.getCssText({inline:"a",classes:[K.value]})})})}),i.settings.link_title!==!1&&(H={name:"title",type:"textbox",label:"Title",value:G.title}),af=i.windowManager.open({title:"Insert link",data:G,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:y,onkeyup:k,onbeforecall:C},z,H,A(G.href),j,F,ad,I],onSubmit:function(M){function O(R,T){var S=i.selection.getRng();tinymce.util.Delay.setEditorTimeout(i,function(){i.windowManager.confirm(R,function(U){i.selection.setRng(S),T(U)})})}function L(T,V){function S(W){return W=U(W),W?[W,R].join(" "):R}function U(X){var W=new RegExp("("+R.replace(" ","|")+")","g");return X&&(X=tinymce.trim(X.replace(W,""))),X?X:null}var R="noopener noreferrer";return V?S(T):U(T)}function P(){var R={href:Q,target:G.target?G.target:null,rel:G.rel?G.rel:null,"class":G["class"]?G["class"]:null,title:G.title?G.title:null};i.settings.allow_unsafe_link_target||(R.rel=L(R.rel,"_blank"==R.target)),Q===n.href&&(n.attach(),n={}),ae?(i.focus(),b&&G.text!=E&&("innerText" in ae?ae.innerText=G.text:ae.textContent=G.text),q.setAttribs(ae,R),J.select(ae),i.undoManager.add()):b?i.insertContent(q.createHTML("a",R,q.encode(G.text))):i.execCommand("mceInsertLink",!1,R)}function K(){i.undoManager.transact(P)}var Q;return G=tinymce.extend(G,M.data),(Q=G.href)?Q.indexOf("@")>0&&Q.indexOf("//")==-1&&Q.indexOf("mailto:")==-1?void O("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(R){R&&(Q="mailto:"+Q),K()}):i.settings.link_assume_external_targets&&!/^\w+:/i.test(Q)||!i.settings.link_assume_external_targets&&/^\s*www[\.|\d\.]/i.test(Q)?void O("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(R){R&&(Q="http://"+Q),K()}):void K():void i.execCommand("unlink")}})}var n={},v=function(b){return b.altKey===!0&&b.shiftKey===!1&&b.ctrlKey===!1&&b.metaKey===!1};i.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:f(m),stateSelector:"a[href]"}),i.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),i.addContextToolbar&&(i.addButton("openlink",{icon:"newtab",tooltip:"Open link",onclick:g}),i.addContextToolbar(r,"openlink | link unlink")),i.addShortcut("Meta+K","",f(m)),i.addCommand("mceLink",f(m)),i.on("click",function(j){var b=h(j.target);b&&tinymce.util.VK.metaKeyPressed(j)&&(j.preventDefault(),u(b))}),i.on("keydown",function(j){var b=o();b&&13===j.keyCode&&v(j)&&(j.preventDefault(),u(b))}),this.showDialog=m,i.addMenuItem("openlink",{text:"Open link",icon:"newtab",onclick:g,onPostRender:l,prependToContext:!0}),i.addMenuItem("link",{icon:"link",text:"Link",shortcut:"Meta+K",onclick:f(m),stateSelector:"a[href]",context:"insert",prependToContext:!0})});