tinymce._beforeUnloadHandler=function(){var a;return tinymce.each(tinymce.editors,function(b){b.plugins.autosave&&b.plugins.autosave.storeDraft(),!a&&b.isDirty()&&b.getParam("autosave_ask_before_unload",!0)&&(a=b.translate("You have unsaved changes are you sure you want to navigate away?"))}),a},tinymce.PluginManager.add("autosave",function(v){function A(c,a){var d={s:1000,m:60000};return c=/^(\d+)([ms]?)$/.exec(""+(c||a)),(c[2]?d[c[2]]:1)*parseInt(c,10)}function j(){var a=parseInt(g.getItem(z+"time"),10)||0;return !((new Date).getTime()-a>q.autosave_retention)||(b(!1),!1)}function b(a){g.removeItem(z+"draft"),g.removeItem(z+"time"),a!==!1&&v.fire("RemoveDraft")}function m(){!x()&&v.isDirty()&&(g.setItem(z+"draft",v.getContent({format:"raw",no_events:!0})),g.setItem(z+"time",(new Date).getTime()),v.fire("StoreDraft"))}function h(){j()&&(v.setContent(g.getItem(z+"draft"),{format:"raw"}),v.fire("RestoreDraft"))}function y(){w||(setInterval(function(){v.removed||m()},q.autosave_interval),w=!0)}function B(){var a=this;a.disabled(!j()),v.on("StoreDraft RestoreDraft RemoveDraft",function(){a.disabled(!j())}),y()}function k(){v.undoManager.beforeChange(),h(),b(),v.undoManager.add()}function x(a){var c=v.settings.forced_root_block;return a=tinymce.trim("undefined"==typeof a?v.getBody().innerHTML:a),""===a||new RegExp("^<"+c+"[^>]*>((\xa0|&nbsp;|[ \t]|<br[^>]*>)+?|)</"+c+">|<br>$","i").test(a)}var z,w,q=v.settings,g=tinymce.util.LocalStorage;z=q.autosave_prefix||"tinymce-autosave-{path}{query}-{id}-",z=z.replace(/\{path\}/g,document.location.pathname),z=z.replace(/\{query\}/g,document.location.search),z=z.replace(/\{id\}/g,v.id),q.autosave_interval=A(q.autosave_interval,"30s"),q.autosave_retention=A(q.autosave_retention,"20m"),v.addButton("restoredraft",{title:"Restore last draft",onclick:k,onPostRender:B}),v.addMenuItem("restoredraft",{text:"Restore last draft",onclick:k,onPostRender:B,context:"file"}),v.settings.autosave_restore_when_empty!==!1&&(v.on("init",function(){j()&&x()&&h()}),v.on("saveContent",function(){b()})),window.onbeforeunload=tinymce._beforeUnloadHandler,this.hasDraft=j,this.storeDraft=m,this.restoreDraft=h,this.removeDraft=b,this.isEmpty=x});