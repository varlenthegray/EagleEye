tinymce.PluginManager.add("textpattern",function(j){function p(){return k&&(g.sort(function(c,a){return c.start.length>a.start.length?-1:c.start.length<a.start.length?1:0}),k=!1),g}function f(c){for(var i=p(),a=0;a<i.length;a++){if(0===c.indexOf(i[a].start)&&(!i[a].end||c.lastIndexOf(i[a].end)==c.length-i[a].end.length)){return i[a]}}}function b(t,v,s){var l,u,c;for(l=p(),c=0;c<l.length;c++){if(u=l[c],u.end&&t.substr(v-u.end.length-s,u.end.length)==u.end){return u}}}function h(D){function w(){v=v.splitText(C),v.splitText(A-C-r),v.deleteData(0,e.start.length),v.deleteData(v.data.length-e.end.length,e.end.length)}var n,B,E,v,A,C,z,y,e,r,x;if(n=j.selection,B=j.dom,n.isCollapsed()&&(E=n.getRng(!0),v=E.startContainer,A=E.startOffset,z=v.data,r=D?1:0,3==v.nodeType&&(e=b(z,A,r),e&&(C=Math.max(0,A-r),C=z.lastIndexOf(e.start,C-e.end.length-1),C!==-1&&(y=B.createRng(),y.setStart(v,C),y.setEnd(v,A-r),e=f(y.toString()),e&&e.end&&!(v.data.length<=e.start.length+e.end.length)))))){return x=j.formatter.get(e.format),x&&x[0].inline?(w(),j.formatter.apply(e.format,{},v),v):void 0}}function d(){var C,e,w,n,A,D,v,z,B,y,x;if(C=j.selection,e=j.dom,C.isCollapsed()&&(v=e.getParent(C.getStart(),"p"))){for(B=new tinymce.dom.TreeWalker(v,v);A=B.next();){if(3==A.nodeType){n=A;break}}if(n){if(z=f(n.data),!z){return}if(y=C.getRng(!0),w=y.startContainer,x=y.startOffset,n==w&&(x=Math.max(0,x-z.start.length)),tinymce.trim(n.data).length==z.start.length){return}z.format&&(D=j.formatter.get(z.format),D&&D[0].block&&(n.deleteData(0,z.start.length),j.formatter.apply(z.format,{},n),y.setStart(w,x),y.collapse(!0),C.setRng(y))),z.cmd&&j.undoManager.transact(function(){n.deleteData(0,z.start.length),j.execCommand(z.cmd)})}}}function m(){var a,c;c=h(),c&&(a=j.dom.createRng(),a.setStart(c,c.data.length),a.setEnd(c,c.data.length),j.selection.setRng(a)),d()}function q(){var e,s,i,l,c;e=h(!0),e&&(c=j.dom,s=e.data.slice(-1),/[\u00a0 ]/.test(s)&&(e.deleteData(e.data.length-1,1),i=c.doc.createTextNode(s),e.nextSibling?c.insertAfter(i,e.nextSibling):e.parentNode.appendChild(i),l=c.createRng(),l.setStart(i,1),l.setEnd(i,1),j.selection.setRng(l)))}var g,k=!0;g=j.settings.textpattern_patterns||[{start:"*",end:"*",format:"italic"},{start:"**",end:"**",format:"bold"},{start:"#",format:"h1"},{start:"##",format:"h2"},{start:"###",format:"h3"},{start:"####",format:"h4"},{start:"#####",format:"h5"},{start:"######",format:"h6"},{start:"1. ",cmd:"InsertOrderedList"},{start:"* ",cmd:"InsertUnorderedList"},{start:"- ",cmd:"InsertUnorderedList"}],j.on("keydown",function(a){13!=a.keyCode||tinymce.util.VK.modifierPressed(a)||m()},!0),j.on("keyup",function(a){32!=a.keyCode||tinymce.util.VK.modifierPressed(a)||q()}),this.getPatterns=p,this.setPatterns=function(a){g=a,k=!0}});