tinymce.PluginManager.add("template",function(h){function d(a){return function(){var e=h.settings.templates;return"function"==typeof e?void e(a):void ("string"==typeof e?tinymce.util.XHR.send({url:e,success:function(i){a(tinymce.util.JSON.parse(i))}}):a(e))}}function k(m){function q(l){function r(v){if(v.indexOf("<html>")==-1){var w="";tinymce.each(h.contentCSS,function(n){w+='<link type="text/css" rel="stylesheet" href="'+h.documentBaseURI.toAbsolute(n)+'">'});var u=h.settings.body_class||"";u.indexOf("=")!=-1&&(u=h.getParam("body_class","","hash"),u=u[h.id]||""),v="<!DOCTYPE html><html><head>"+w+'</head><body class="'+u+'">'+v+"</body></html>"}v=j(v,"template_preview_replace_values");var s=p.find("iframe")[0].getEl().contentWindow.document;s.open(),s.write(v),s.close()}var i=l.control.value();i.url?tinymce.util.XHR.send({url:i.url,success:function(n){e=n,r(e)}}):(e=i.content,r(e)),p.find("#description")[0].text(l.control.value().description)}var p,e,o=[];if(!m||0===m.length){var a=h.translate("No templates defined.");return void h.notificationManager.open({text:a,type:"info"})}tinymce.each(m,function(i){o.push({selected:!o.length,text:i.title,value:{url:i.url,content:i.content,description:i.description}})}),p=h.windowManager.open({title:"Insert template",layout:"flex",direction:"column",align:"stretch",padding:15,spacing:10,items:[{type:"form",flex:0,padding:0,items:[{type:"container",label:"Templates",items:{type:"listbox",label:"Templates",name:"template",values:o,onselect:q}}]},{type:"label",name:"description",label:"Description",text:"\xa0"},{type:"iframe",flex:1,border:1}],onsubmit:function(){b(!1,e)},minWidth:Math.min(tinymce.DOM.getViewPort().w,h.getParam("template_popup_width",600)),minHeight:Math.min(tinymce.DOM.getViewPort().h,h.getParam("template_popup_height",500))}),p.find("listbox")[0].fire("select")}function g(m,v){function q(i,a){if(i=""+i,i.length<a){for(var o=0;o<a-i.length;o++){i="0"+i}}return i}var l="Sun Mon Tue Wed Thu Fri Sat Sun".split(" "),u="Sunday Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" "),e="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),p="January February March April May June July August September October November December".split(" ");return v=v||new Date,m=m.replace("%D","%m/%d/%Y"),m=m.replace("%r","%I:%M:%S %p"),m=m.replace("%Y",""+v.getFullYear()),m=m.replace("%y",""+v.getYear()),m=m.replace("%m",q(v.getMonth()+1,2)),m=m.replace("%d",q(v.getDate(),2)),m=m.replace("%H",""+q(v.getHours(),2)),m=m.replace("%M",""+q(v.getMinutes(),2)),m=m.replace("%S",""+q(v.getSeconds(),2)),m=m.replace("%I",""+((v.getHours()+11)%12+1)),m=m.replace("%p",""+(v.getHours()<12?"AM":"PM")),m=m.replace("%B",""+h.translate(p[v.getMonth()])),m=m.replace("%b",""+h.translate(e[v.getMonth()])),m=m.replace("%A",""+h.translate(u[v.getDay()])),m=m.replace("%a",""+h.translate(l[v.getDay()])),m=m.replace("%%","%")}function c(a){var i=h.dom,e=h.getParam("template_replace_values");f(i.select("*",a),function(l){f(e,function(n,m){i.hasClass(l,m)&&"function"==typeof e[m]&&e[m](l)})})}function j(a,e){return f(h.getParam(e),function(i,l){"function"==typeof i&&(i=i(l)),a=a.replace(new RegExp("\\{\\$"+l+"\\}","g"),i)}),a}function b(o,r){function i(l,a){return new RegExp("\\b"+a+"\\b","g").test(l.className)}var e,q,m=h.dom,p=h.selection.getContent();r=j(r,"template_replace_values"),e=m.create("div",null,r),q=m.select(".mceTmpl",e),q&&q.length>0&&(e=m.create("div",null),e.appendChild(q[0].cloneNode(!0))),f(m.select("*",e),function(a){i(a,h.getParam("template_cdate_classes","cdate").replace(/\s+/g,"|"))&&(a.innerHTML=g(h.getParam("template_cdate_format",h.getLang("template.cdate_format")))),i(a,h.getParam("template_mdate_classes","mdate").replace(/\s+/g,"|"))&&(a.innerHTML=g(h.getParam("template_mdate_format",h.getLang("template.mdate_format")))),i(a,h.getParam("template_selected_content_classes","selcontent").replace(/\s+/g,"|"))&&(a.innerHTML=p)}),c(e),h.execCommand("mceInsertContent",!1,e.innerHTML),h.addVisual()}var f=tinymce.each;h.addCommand("mceInsertTemplate",b),h.addButton("template",{title:"Insert template",onclick:d(k)}),h.addMenuItem("template",{text:"Template",onclick:d(k),context:"insert"}),h.on("PreProcess",function(a){var e=h.dom;f(e.select("div",a.node),function(i){e.hasClass(i,"mceTmpl")&&(f(e.select("*",i),function(l){e.hasClass(l,h.getParam("template_mdate_classes","mdate").replace(/\s+/g,"|"))&&(l.innerHTML=g(h.getParam("template_mdate_format",h.getLang("template.mdate_format"))))}),c(i))})})});