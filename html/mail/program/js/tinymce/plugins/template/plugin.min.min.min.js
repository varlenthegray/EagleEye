tinymce.PluginManager.add("template",function(l){function o(b){return function(){var c=l.settings.templates;return"function"==typeof c?void c(b):void ("string"==typeof c?tinymce.util.XHR.send({url:c,success:function(d){b(tinymce.util.JSON.parse(d))}}):b(c))}}function e(b){function d(j){function q(t){if(t.indexOf("<html>")==-1){var r="";tinymce.each(l.contentCSS,function(s){r+='<link type="text/css" rel="stylesheet" href="'+l.documentBaseURI.toAbsolute(s)+'">'});var x=l.settings.body_class||"";x.indexOf("=")!=-1&&(x=l.getParam("body_class","","hash"),x=x[l.id]||""),t="<!DOCTYPE html><html><head>"+r+'</head><body class="'+x+'">'+t+"</body></html>"}t=i(t,"template_preview_replace_values");var y=g.find("iframe")[0].getEl().contentWindow.document;y.open(),y.write(t),y.close()}var k=j.control.value();k.url?tinymce.util.XHR.send({url:k.url,success:function(r){f=r,q(f)}}):(f=k.content,q(f)),g.find("#description")[0].text(j.control.value().description)}var g,f,h=[];if(!b||0===b.length){var c=l.translate("No templates defined.");return void l.notificationManager.open({text:c,type:"info"})}tinymce.each(b,function(j){h.push({selected:!h.length,text:j.title,value:{url:j.url,content:j.content,description:j.description}})}),g=l.windowManager.open({title:"Insert template",layout:"flex",direction:"column",align:"stretch",padding:15,spacing:10,items:[{type:"form",flex:0,padding:0,items:[{type:"container",label:"Templates",items:{type:"listbox",label:"Templates",name:"template",values:h,onselect:d}}]},{type:"label",name:"description",label:"Description",text:"\xa0"},{type:"iframe",flex:1,border:1}],onsubmit:function(){a(!1,f)},minWidth:Math.min(tinymce.DOM.getViewPort().w,l.getParam("template_popup_width",600)),minHeight:Math.min(tinymce.DOM.getViewPort().h,l.getParam("template_popup_height",500))}),g.find("listbox")[0].fire("select")}function m(b,d){function g(q,k){if(q=""+q,q.length<k){for(var r=0;r<k-q.length;r++){q="0"+q}}return q}var c="Sun Mon Tue Wed Thu Fri Sat Sun".split(" "),f="Sunday Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" "),j="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),h="January February March April May June July August September October November December".split(" ");return d=d||new Date,b=b.replace("%D","%m/%d/%Y"),b=b.replace("%r","%I:%M:%S %p"),b=b.replace("%Y",""+d.getFullYear()),b=b.replace("%y",""+d.getYear()),b=b.replace("%m",g(d.getMonth()+1,2)),b=b.replace("%d",g(d.getDate(),2)),b=b.replace("%H",""+g(d.getHours(),2)),b=b.replace("%M",""+g(d.getMinutes(),2)),b=b.replace("%S",""+g(d.getSeconds(),2)),b=b.replace("%I",""+((d.getHours()+11)%12+1)),b=b.replace("%p",""+(d.getHours()<12?"AM":"PM")),b=b.replace("%B",""+l.translate(h[d.getMonth()])),b=b.replace("%b",""+l.translate(j[d.getMonth()])),b=b.replace("%A",""+l.translate(f[d.getDay()])),b=b.replace("%a",""+l.translate(c[d.getDay()])),b=b.replace("%%","%")}function p(b){var c=l.dom,d=l.getParam("template_replace_values");n(c.select("*",b),function(f){n(d,function(h,g){c.hasClass(f,g)&&"function"==typeof d[g]&&d[g](f)})})}function i(b,c){return n(l.getParam(c),function(f,d){"function"==typeof f&&(f=f(d)),b=b.replace(new RegExp("\\{\\$"+d+"\\}","g"),f)}),b}function a(j,d){function c(q,k){return new RegExp("\\b"+k+"\\b","g").test(q.className)}var h,f,b=l.dom,g=l.selection.getContent();d=i(d,"template_replace_values"),h=b.create("div",null,d),f=b.select(".mceTmpl",h),f&&f.length>0&&(h=b.create("div",null),h.appendChild(f[0].cloneNode(!0))),n(b.select("*",h),function(k){c(k,l.getParam("template_cdate_classes","cdate").replace(/\s+/g,"|"))&&(k.innerHTML=m(l.getParam("template_cdate_format",l.getLang("template.cdate_format")))),c(k,l.getParam("template_mdate_classes","mdate").replace(/\s+/g,"|"))&&(k.innerHTML=m(l.getParam("template_mdate_format",l.getLang("template.mdate_format")))),c(k,l.getParam("template_selected_content_classes","selcontent").replace(/\s+/g,"|"))&&(k.innerHTML=g)}),p(h),l.execCommand("mceInsertContent",!1,h.innerHTML),l.addVisual()}var n=tinymce.each;l.addCommand("mceInsertTemplate",a),l.addButton("template",{title:"Insert template",onclick:o(e)}),l.addMenuItem("template",{text:"Template",onclick:o(e),context:"insert"}),l.on("PreProcess",function(b){var c=l.dom;n(c.select("div",b.node),function(d){c.hasClass(d,"mceTmpl")&&(n(c.select("*",d),function(f){c.hasClass(f,l.getParam("template_mdate_classes","mdate").replace(/\s+/g,"|"))&&(f.innerHTML=m(l.getParam("template_mdate_format",l.getLang("template.mdate_format"))))}),p(d))})})});