tinymce.PluginManager.add("fullpage",function(k){function w(){var a=g();k.windowManager.open({title:"Document properties",data:a,defaults:{type:"textbox",size:40},body:[{name:"title",label:"Title"},{name:"keywords",label:"Keywords"},{name:"description",label:"Description"},{name:"robots",label:"Robots"},{name:"author",label:"Author"},{name:"docencoding",label:"Encoding"}],onSubmit:function(c){b(tinymce.extend(a,c.data))}})}function g(){function d(o,a){var r=o.attr(a);return r||""}var l,e,i=j(),c={};return c.fontface=k.getParam("fullpage_default_fontface",""),c.fontsize=k.getParam("fullpage_default_fontsize",""),l=i.firstChild,7==l.type&&(c.xml_pi=!0,e=/encoding="([^"]+)"/.exec(l.value),e&&(c.docencoding=e[1])),l=i.getAll("#doctype")[0],l&&(c.doctype="<!DOCTYPE"+l.value+">"),l=i.getAll("title")[0],l&&l.firstChild&&(c.title=l.firstChild.value),v(i.getAll("meta"),function(s){var a,u=s.attr("name"),o=s.attr("http-equiv");u?c[u.toLowerCase()]=s.attr("content"):"Content-Type"==o&&(a=/charset\s*=\s*(.*)\s*/gi.exec(s.attr("content")),a&&(c.docencoding=a[1]))}),l=i.getAll("html")[0],l&&(c.langcode=d(l,"lang")||d(l,"xml:lang")),c.stylesheets=[],tinymce.each(i.getAll("link"),function(a){"stylesheet"==a.attr("rel")&&c.stylesheets.push(a.attr("href"))}),l=i.getAll("body")[0],l&&(c.langdir=d(l,"dir"),c.style=d(l,"style"),c.visited_color=d(l,"vlink"),c.link_color=d(l,"link"),c.active_color=d(l,"alink")),c}function b(B){function l(c,a,o){c.attr(a,o?o:void 0)}function d(a){A.firstChild?A.insert(a,A.firstChild):A.append(a)}var i,A,C,z,y,e=k.dom;i=j(),A=i.getAll("head")[0],A||(z=i.getAll("html")[0],A=new m("head",1),z.firstChild?z.insert(A,z.firstChild,!0):z.append(A)),z=i.firstChild,B.xml_pi?(y='version="1.0"',B.docencoding&&(y+=' encoding="'+B.docencoding+'"'),7!=z.type&&(z=new m("xml",7),i.insert(z,i.firstChild,!0)),z.value=y):z&&7==z.type&&z.remove(),z=i.getAll("#doctype")[0],B.doctype?(z||(z=new m("#doctype",10),B.xml_pi?i.insert(z,i.firstChild):d(z)),z.value=B.doctype.substring(9,B.doctype.length-1)):z&&z.remove(),z=null,v(i.getAll("meta"),function(a){"Content-Type"==a.attr("http-equiv")&&(z=a)}),B.docencoding?(z||(z=new m("meta",1),z.attr("http-equiv","Content-Type"),z.shortEnded=!0,d(z)),z.attr("content","text/html; charset="+B.docencoding)):z&&z.remove(),z=i.getAll("title")[0],B.title?(z?z.empty():(z=new m("title",1),d(z)),z.append(new m("#text",3)).value=B.title):z&&z.remove(),v("keywords,description,author,copyright,robots".split(","),function(t){var D,o,c=i.getAll("meta"),r=B[t];for(D=0;D<c.length;D++){if(o=c[D],o.attr("name")==t){return void (r?o.attr("content",r):o.remove())}}r&&(z=new m("meta",1),z.attr("name",t),z.attr("content",r),z.shortEnded=!0,d(z))});var u={};tinymce.each(i.getAll("link"),function(a){"stylesheet"==a.attr("rel")&&(u[a.attr("href")]=a)}),tinymce.each(B.stylesheets,function(a){u[a]||(z=new m("link",1),z.attr({rel:"stylesheet",text:"text/css",href:a}),z.shortEnded=!0,d(z)),delete u[a]}),tinymce.each(u,function(a){a.remove()}),z=i.getAll("body")[0],z&&(l(z,"dir",B.langdir),l(z,"style",B.style),l(z,"vlink",B.visited_color),l(z,"link",B.link_color),l(z,"alink",B.active_color),e.setAttribs(k.getBody(),{style:B.style,dir:B.dir,vLink:B.visited_color,link:B.link_color,aLink:B.active_color})),z=i.getAll("html")[0],z&&(l(z,"lang",B.langcode),l(z,"xml:lang",B.langcode)),A.firstChild||A.remove(),C=new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(i),h=C.substring(0,C.indexOf("</body>"))}function j(){return new tinymce.html.DomParser({validate:!1,root_name:"#document"}).parse(h)}function f(B){function i(d){return d.replace(/<\/?[A-Z]+/g,function(n){return n.toLowerCase()})}var a,e,C,A,z=B.content,c="",l=k.dom;if(!B.selection&&!("raw"==B.format&&h||B.source_view&&k.getParam("fullpage_hide_in_source_view"))){0!==z.length||B.source_view||(z=tinymce.trim(h)+"\n"+tinymce.trim(z)+"\n"+tinymce.trim(p)),z=z.replace(/<(\/?)BODY/gi,"<$1body"),a=z.indexOf("<body"),a!=-1?(a=z.indexOf(">",a),h=i(z.substring(0,a+1)),e=z.indexOf("</body",a),e==-1&&(e=z.length),B.content=z.substring(a+1,e),p=i(z.substring(e))):(h=q(),p="\n</body>\n</html>"),C=j(),v(C.getAll("style"),function(d){d.firstChild&&(c+=d.firstChild.value)}),A=C.getAll("body")[0],A&&l.setAttribs(k.getBody(),{style:A.attr("style")||"",dir:A.attr("dir")||"",vLink:A.attr("vlink")||"",link:A.attr("link")||"",aLink:A.attr("alink")||""}),l.remove("fullpage_styles");var y=k.getDoc().getElementsByTagName("head")[0];c&&(l.add(y,"style",{id:"fullpage_styles"},c),A=l.get("fullpage_styles"),A.styleSheet&&(A.styleSheet.cssText=c));var u={};tinymce.each(y.getElementsByTagName("link"),function(d){"stylesheet"==d.rel&&d.getAttribute("data-mce-fullpage")&&(u[d.href]=d)}),tinymce.each(C.getAll("link"),function(n){var d=n.attr("href");return !d||(u[d]||"stylesheet"!=n.attr("rel")||l.add(y,"link",{rel:"stylesheet",text:"text/css",href:d,"data-mce-fullpage":"1"}),void delete u[d])}),tinymce.each(u,function(d){d.parentNode.removeChild(d)})}}function q(){var a,d="",c="";return k.getParam("fullpage_default_xml_pi")&&(d+='<?xml version="1.0" encoding="'+k.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'),d+=k.getParam("fullpage_default_doctype","<!DOCTYPE html>"),d+="\n<html>\n<head>\n",(a=k.getParam("fullpage_default_title"))&&(d+="<title>"+a+"</title>\n"),(a=k.getParam("fullpage_default_encoding"))&&(d+='<meta http-equiv="Content-Type" content="text/html; charset='+a+'" />\n'),(a=k.getParam("fullpage_default_font_family"))&&(c+="font-family: "+a+";"),(a=k.getParam("fullpage_default_font_size"))&&(c+="font-size: "+a+";"),(a=k.getParam("fullpage_default_text_color"))&&(c+="color: "+a+";"),d+="</head>\n<body"+(c?' style="'+c+'"':"")+">\n"}function x(a){a.selection||a.source_view&&k.getParam("fullpage_hide_in_source_view")||(a.content=tinymce.trim(h)+"\n"+tinymce.trim(a.content)+"\n"+tinymce.trim(p))}var h,p,v=tinymce.each,m=tinymce.html.Node;k.addCommand("mceFullPageProperties",w),k.addButton("fullpage",{title:"Document properties",cmd:"mceFullPageProperties"}),k.addMenuItem("fullpage",{text:"Document properties",cmd:"mceFullPageProperties",context:"file"}),k.on("BeforeSetContent",f),k.on("GetContent",x)});