tinymce.PluginManager.add("fullpage",function(e){function t(){var b=n();e.windowManager.open({title:"Document properties",data:b,defaults:{type:"textbox",size:40},body:[{name:"title",label:"Title"},{name:"keywords",label:"Keywords"},{name:"description",label:"Description"},{name:"robots",label:"Robots"},{name:"author",label:"Author"},{name:"docencoding",label:"Encoding"}],onSubmit:function(f){r(tinymce.extend(b,f.data))}})}function n(){function h(p,k){var m=p.attr(k);return m||""}var b,g,f=i(),j={};return j.fontface=e.getParam("fullpage_default_fontface",""),j.fontsize=e.getParam("fullpage_default_fontsize",""),b=f.firstChild,7==b.type&&(j.xml_pi=!0,g=/encoding="([^"]+)"/.exec(b.value),g&&(j.docencoding=g[1])),b=f.getAll("#doctype")[0],b&&(j.doctype="<!DOCTYPE"+b.value+">"),b=f.getAll("title")[0],b&&b.firstChild&&(j.title=b.firstChild.value),u(f.getAll("meta"),function(p){var k,m=p.attr("name"),q=p.attr("http-equiv");m?j[m.toLowerCase()]=p.attr("content"):"Content-Type"==q&&(k=/charset\s*=\s*(.*)\s*/gi.exec(p.attr("content")),k&&(j.docencoding=k[1]))}),b=f.getAll("html")[0],b&&(j.langcode=h(b,"lang")||h(b,"xml:lang")),j.stylesheets=[],tinymce.each(f.getAll("link"),function(k){"stylesheet"==k.attr("rel")&&j.stylesheets.push(k.attr("href"))}),b=f.getAll("body")[0],b&&(j.langdir=h(b,"dir"),j.style=h(b,"style"),j.visited_color=h(b,"vlink"),j.link_color=h(b,"link"),j.active_color=h(b,"alink")),j}function r(f){function h(y,w,x){y.attr(w,x?x:void 0)}function m(w){g.firstChild?g.insert(w,g.firstChild):g.append(w)}var j,g,b,p,q,k=e.dom;j=i(),g=j.getAll("head")[0],g||(p=j.getAll("html")[0],g=new d("head",1),p.firstChild?p.insert(g,p.firstChild,!0):p.append(g)),p=j.firstChild,f.xml_pi?(q='version="1.0"',f.docencoding&&(q+=' encoding="'+f.docencoding+'"'),7!=p.type&&(p=new d("xml",7),j.insert(p,j.firstChild,!0)),p.value=q):p&&7==p.type&&p.remove(),p=j.getAll("#doctype")[0],f.doctype?(p||(p=new d("#doctype",10),f.xml_pi?j.insert(p,j.firstChild):m(p)),p.value=f.doctype.substring(9,f.doctype.length-1)):p&&p.remove(),p=null,u(j.getAll("meta"),function(w){"Content-Type"==w.attr("http-equiv")&&(p=w)}),f.docencoding?(p||(p=new d("meta",1),p.attr("http-equiv","Content-Type"),p.shortEnded=!0,m(p)),p.attr("content","text/html; charset="+f.docencoding)):p&&p.remove(),p=j.getAll("title")[0],f.title?(p?p.empty():(p=new d("title",1),m(p)),p.append(new d("#text",3)).value=f.title):p&&p.remove(),u("keywords,description,author,copyright,robots".split(","),function(w){var y,z,A=j.getAll("meta"),x=f[w];for(y=0;y<A.length;y++){if(z=A[y],z.attr("name")==w){return void (x?z.attr("content",x):z.remove())}}x&&(p=new d("meta",1),p.attr("name",w),p.attr("content",x),p.shortEnded=!0,m(p))});var v={};tinymce.each(j.getAll("link"),function(w){"stylesheet"==w.attr("rel")&&(v[w.attr("href")]=w)}),tinymce.each(f.stylesheets,function(w){v[w]||(p=new d("link",1),p.attr({rel:"stylesheet",text:"text/css",href:w}),p.shortEnded=!0,m(p)),delete v[w]}),tinymce.each(v,function(w){w.remove()}),p=j.getAll("body")[0],p&&(h(p,"dir",f.langdir),h(p,"style",f.style),h(p,"vlink",f.visited_color),h(p,"link",f.link_color),h(p,"alink",f.active_color),k.setAttribs(e.getBody(),{style:f.style,dir:f.dir,vLink:f.visited_color,link:f.link_color,aLink:f.active_color})),p=j.getAll("html")[0],p&&(h(p,"lang",f.langcode),h(p,"xml:lang",f.langcode)),g.firstChild||g.remove(),b=new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(j),l=b.substring(0,b.indexOf("</body>"))}function i(){return new tinymce.html.DomParser({validate:!1,root_name:"#document"}).parse(l)}function o(f){function j(x){return x.replace(/<\/?[A-Z]+/g,function(y){return y.toLowerCase()})}var v,k,b,g,p=f.content,m="",h=e.dom;if(!f.selection&&!("raw"==f.format&&l||f.source_view&&e.getParam("fullpage_hide_in_source_view"))){0!==p.length||f.source_view||(p=tinymce.trim(l)+"\n"+tinymce.trim(p)+"\n"+tinymce.trim(c)),p=p.replace(/<(\/?)BODY/gi,"<$1body"),v=p.indexOf("<body"),v!=-1?(v=p.indexOf(">",v),l=j(p.substring(0,v+1)),k=p.indexOf("</body",v),k==-1&&(k=p.length),f.content=p.substring(v+1,k),c=j(p.substring(k))):(l=a(),c="\n</body>\n</html>"),b=i(),u(b.getAll("style"),function(x){x.firstChild&&(m+=x.firstChild.value)}),g=b.getAll("body")[0],g&&h.setAttribs(e.getBody(),{style:g.attr("style")||"",dir:g.attr("dir")||"",vLink:g.attr("vlink")||"",link:g.attr("link")||"",aLink:g.attr("alink")||""}),h.remove("fullpage_styles");var q=e.getDoc().getElementsByTagName("head")[0];m&&(h.add(q,"style",{id:"fullpage_styles"},m),g=h.get("fullpage_styles"),g.styleSheet&&(g.styleSheet.cssText=m));var w={};tinymce.each(q.getElementsByTagName("link"),function(x){"stylesheet"==x.rel&&x.getAttribute("data-mce-fullpage")&&(w[x.href]=x)}),tinymce.each(b.getAll("link"),function(y){var x=y.attr("href");return !x||(w[x]||"stylesheet"!=y.attr("rel")||h.add(q,"link",{rel:"stylesheet",text:"text/css",href:x,"data-mce-fullpage":"1"}),void delete w[x])}),tinymce.each(w,function(x){x.parentNode.removeChild(x)})}}function a(){var b,f="",g="";return e.getParam("fullpage_default_xml_pi")&&(f+='<?xml version="1.0" encoding="'+e.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'),f+=e.getParam("fullpage_default_doctype","<!DOCTYPE html>"),f+="\n<html>\n<head>\n",(b=e.getParam("fullpage_default_title"))&&(f+="<title>"+b+"</title>\n"),(b=e.getParam("fullpage_default_encoding"))&&(f+='<meta http-equiv="Content-Type" content="text/html; charset='+b+'" />\n'),(b=e.getParam("fullpage_default_font_family"))&&(g+="font-family: "+b+";"),(b=e.getParam("fullpage_default_font_size"))&&(g+="font-size: "+b+";"),(b=e.getParam("fullpage_default_text_color"))&&(g+="color: "+b+";"),f+="</head>\n<body"+(g?' style="'+g+'"':"")+">\n"}function s(b){b.selection||b.source_view&&e.getParam("fullpage_hide_in_source_view")||(b.content=tinymce.trim(l)+"\n"+tinymce.trim(b.content)+"\n"+tinymce.trim(c))}var l,c,u=tinymce.each,d=tinymce.html.Node;e.addCommand("mceFullPageProperties",t),e.addButton("fullpage",{title:"Document properties",cmd:"mceFullPageProperties"}),e.addMenuItem("fullpage",{text:"Document properties",cmd:"mceFullPageProperties",context:"file"}),e.on("BeforeSetContent",o),e.on("GetContent",s)});