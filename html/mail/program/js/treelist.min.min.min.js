function rcube_treelist_widget(O,o){o=$.extend({id_prefix:"",autoexpand:1000,selectable:false,scroll_delay:500,scroll_step:5,scroll_speed:20,save_state:false,keyboard:true,tabexit:true,parent_focus:false,check_droptarget:function(p){return !p.virtual}},o||{});var a=$(O),M=o.data||[],k={},W=null,Z=false,v=false,C="",ac=false,x={},P=[],ad,K,U=0,q=0,w,G,z,h,A,t,g,Y=(a.attr("id")||o.id_prefix||"0"),r=this;this.container=a;this.expand=ae;this.collapse=u;this.select=n;this.render=N;this.reset=i;this.drag_start=c;this.drag_end=aa;this.intersects=X;this.droppable=ag;this.draggable=D;this.update=I;this.insert=ai;this.remove=y;this.get_item=f;this.get_node=j;this.get_selection=V;this.is_search=F;this.reset_search=b;if(!a.length){return}if(o.data){Q({children:M})}else{H()}if(W){T(s(W,true))}a.attr("role","tree").on("focusin",function(p){ac=true}).on("focusout",function(p){ac=false}).on("click","div.treetoggle",function(p){E(B($(this).parent()));p.stopPropagation()}).on("click","li",function(p){if($(p.target).is("input")){return true}var aj=o.selectable?k[B($(this))]:null;if(aj&&!aj.virtual){n(aj.id);p.stopPropagation()}}).on("mousedown","a",function(p){var ak=$(p.target),aj=k[B(ak.closest("li"))];if(aj&&aj.virtual&&!ak.attr("href")){p.preventDefault();p.stopPropagation();return false}});if(o.searchbox){G=$(o.searchbox).off("keyup.treelist").on("keyup.treelist",function(p){var ak=rcube_event.get_keycode(p),aj=rcube_event.get_modifier(p);switch(ak){case 9:break;case 13:J(this.value,true);return rcube_event.cancel(p);case 27:b();break;case 38:case 37:case 39:case 40:return;default:J(this.value,false);break}}).attr("autocomplete","off");G.parent().find("a.reset").off("click.treelist").on("click.treelist",function(p){b();return false})}$(document.body).on("keydown",m);if(o.parent_focus){a.parent(":not(body)").click(function(p){if($(p.target).is("input")){return true}if(!ac&&W){$(f(W)).find(":focusable").first().focus()}else{if(!ac){a.children("li:has(:focusable)").first().find(":focusable").first().focus()}}})}function u(aj,am,p){var al;if(al=k[aj]){al.collapsed=typeof p=="undefined"||p;ab(al);if(am&&al.children){for(var ak=0;ak<al.children.length;ak++){u(al.children[ak].id,am,p)}}r.triggerEvent(al.collapsed?"collapse":"expand",al);e(aj,al.collapsed)}}function ae(p,aj){u(p,aj,false)}function E(p,aj){var ak;if(ak=k[p]){u(p,aj,!ak.collapsed)}}function n(p){if(r.triggerEvent("beforeselect",k[p])===false){return}if(W){s(W,true).removeClass("selected").removeAttr("aria-selected");if(v){s(W).removeClass("selected").removeAttr("aria-selected")}W=null}if(!p){return}var aj=s(p,true);if(aj.length){aj.addClass("selected").attr("aria-selected","true");W=p;if(v){s(p).addClass("selected").attr("aria-selected","true")}T(aj)}r.triggerEvent("select",k[p])}function V(){return W}function j(p){return k[p]}function f(p,aj){return s(p,aj).get(0)}function ai(al,am,ak){var an,p,aj=am?k[am]:null;search_=v;if(k[al.id]){return}state=af(al.id,al.collapsed);if(state!==undefined){al.collapsed=state}if(aj){al.level=aj.level+1;if(!aj.children){aj.children=[]}v=false;aj.children.push(al);p=s(am);if(aj.children.length==1){ah(aj,null,p);an=s(al.id)}else{an=ah(al,p.children("ul").first())}if(search_){v=search_;if(!an.is(":visible")){$("<li>").attr("id",an.attr("id")+"--xsR").attr("class",an.attr("class")).addClass("searchresult__").append(an.children().first().clone(true,true)).appendTo(a)}}}else{al.level=0;M.push(al);an=ah(al,a)}k[al.id]=al;if(typeof al.html=="object"){k[al.id].html=s(al.id,true).children()}if(ak){S(an,typeof ak=="string"?'[class~="'+ak+'"]':"")}}function I(aj,ao,al){var am,ak,ap,p,an=k[aj];if(an){am=s(aj);ak=am.parent();if(ao.id||ao.html||ao.children||ao.classes||ao.parent){if(ao.parent&&(ap=k[ao.parent])){if(ak.closest("li").length&&(p=k[B(ak.closest("li"))])){p.children=$.grep(p.children,function(ar,aq){return ar.id!=an.id})}ak=s(ao.parent).children("ul").first();if(!ap.children){ap.children=[]}ap.children.push(an)}else{if(ao.parent!==undefined){ak=a}}$.extend(an,ao);am=ah(an,ak,am)}if(an.id!=aj){delete k[aj];k[an.id]=an}if(al){S(am,typeof al=="string"?'[class~="'+al+'"]':"")}}}function S(am,an){var p,al,ak=am.get(0).id,aj=am.children().first().text().toUpperCase();am.parent().children("li"+an).each(function(ao,ap){if(ao==0){p=ap}if(ap.id==ak){}else{if(ap.id!=ak&&aj>=$(ap).children().first().text().toUpperCase()){al=ap}else{return false}}});if(al){am.insertAfter(al)}else{if(p&&p.id!=ak){am.insertBefore(p)}}H()}function y(p){var al,aj,ak;if(al=k[p]){aj=s(p,true);ak=aj.parent();aj.remove();al.deleted=true;delete k[p];if(v){s(p,false).remove()}if(!ak.children().length){ak.parent().find("div.treetoggle").remove();ak.remove()}return true}return false}function H(){M=R(a,0)}function ab(p){var aj=s(p.id,true);aj.attr("aria-expanded",p.collapsed?"false":"true");aj.children("ul").first()[(p.collapsed?"hide":"show")]();aj.children("div.treetoggle").removeClass("collapsed expanded").addClass(p.collapsed?"collapsed":"expanded");r.triggerEvent("toggle",p)}function i(p){n("");M=[];k={};Z=false;if(p){if(t){if(A){D("destroy")}D(t)}if(g){if(h){ag("destroy")}ag(g)}H()}else{a.html("")}b()}function J(al,p){al=String(al).toLowerCase();if(!al.length){return b()}else{if(al==C&&!p){return 0}}var aj=[];var ak=function(am){$.each(am,function(ap,aq){var an,ao;if(!aq.virtual&&!aq.deleted&&String(aq.text).toLowerCase().indexOf(al)>=0&&aj.indexOf(aq.id)<0){an=s(aq.id);if(an.data("filtered")){return}ao=$("<li>").attr("id",an.attr("id")+"--xsR").attr("class",an.attr("class")).addClass("searchresult__").append(an.children(":not(div.treetoggle,ul)").clone(true,true)).appendTo(a);aj.push(aq.id)}if(aq.children&&aq.children.length){ak(aq.children)}})};if(v){$(a).children("li.searchresult__").remove();v=false}$(a).children("li").hide().removeClass("selected");ak(M);v=true;r.triggerEvent("search",{query:al,last:C,count:aj.length,ids:aj,execute:p||false});C=al;return aj.count}function b(){if(G){G.val("")}$(a).children("li.searchresult__").remove();$(a).children("li").filter(function(){return !$(this).data("filtered")}).show();v=false;r.triggerEvent("search",{query:false,last:C});C="";if(W){n(W)}}function F(){return v}function N(){if(r.triggerEvent("renderBefore",M)===false){return}a.html("");for(var p=0;p<M.length;p++){M[p].level=0;ah(M[p],a)}r.triggerEvent("renderAfter",a)}function ah(aj,p,am){if(aj.deleted){return}var an=$("<li>").attr("id",o.id_prefix+(o.id_encode?o.id_encode(aj.id):aj.id)).attr("role","treeitem").addClass((aj.classes||[]).join(" ")).data("id",aj.id);if(am){am.replaceWith(an);if(p){an.appendTo(p)}}else{an.appendTo(p)}if(typeof aj.html=="string"){an.html(aj.html)}else{if(typeof aj.html=="object"){an.append(aj.html)}}if(!aj.text){aj.text=an.children().first().text()}if(aj.virtual){an.addClass("virtual")}if(aj.id==W){an.addClass("selected")}if(aj.children&&aj.children.length){an.attr("aria-expanded",aj.collapsed?"false":"true");$('<div class="treetoggle '+(aj.collapsed?"collapsed":"expanded")+'">&nbsp;</div>').appendTo(an);var al=$("<ul>").appendTo(an).attr("class",aj.childlistclass).attr("role","group");if(aj.collapsed){al.hide()}for(var ak=0;ak<aj.children.length;ak++){aj.children[ak].level=aj.level+1;ah(aj.children[ak],al)}}return an}function R(ak,p){var aj=[];ak.children("li").each(function(an,aq){var ap,al=$(aq),am=al.children("ul");var ao={id:B(al),classes:String(al.attr("class")).split(" "),virtual:al.hasClass("virtual"),level:p,html:al.children().first().get(0).outerHTML,text:al.children().first().text(),children:R(am,p+1)};if(am.length){ao.childlistclass=am.attr("class")}if(ao.children.length){if(ao.collapsed===undefined){ao.collapsed=am.css("display")=="none"}ap=af(ao.id,ao.collapsed);if(ap!==undefined){ao.collapsed=ap;am[(ap?"hide":"show")]()}if(!al.children("div.treetoggle").length){$('<div class="treetoggle '+(ao.collapsed?"collapsed":"expanded")+'">&nbsp;</div>').appendTo(al)}al.attr("aria-expanded",ao.collapsed?"false":"true")}if(al.hasClass("selected")){al.attr("aria-selected","true");W=ao.id}al.data("id",ao.id);al.attr("role","treeitem").attr("aria-level",ao.level+1);if(ao.virtual){al.children("a:first").attr("tabindex","0")}aj.push(ao);k[ao.id]=ao});ak.attr("role",p==0?"tree":"group");return aj}function Q(aj){if(aj.id){k[aj.id]=aj}for(var p=0;aj.children&&p<aj.children.length;p++){Q(aj.children[p])}}function B(aj){var p=String(aj.attr("id")).replace(new RegExp("^"+(o.id_prefix)||"%"),"").replace(/--xsR$/,"");return o.id_decode?o.id_decode(p):p}function s(p,al){var aj=o.id_encode?o.id_encode(p):p,ak=v&&!al?"--xsR":"";return $("#"+o.id_prefix+aj+ak,a)}function T(ak){var p=a.parent(),al=p.scrollTop(),aj=ak.offset().top-p.offset().top;if(aj<0||aj+ak.height()>p.height()){p.scrollTop(aj+al)}}function e(p,ak){if(o.save_state&&window.rcmail){var aj="treelist-"+Y;if(!z){z=rcmail.local_storage_get_item(aj,{})}if(z[p]!=ak){z[p]=ak;rcmail.local_storage_set_item(aj,z)}}}function af(p){if(o.save_state&&window.rcmail){if(!z){z=rcmail.local_storage_get_item("treelist-"+Y,{})}return z[p]}return undefined}function m(p){var ao=p.target||{},am=rcube_event.get_keycode(p);if(!ac||ao.nodeName=="INPUT"&&am!=38&&am!=40||ao.nodeName=="TEXTAREA"||ao.nodeName=="SELECT"){return true}switch(am){case 38:case 40:case 63232:case 63233:var an=o.keyboard?a.find(":focus").closest("li"):[];if(an.length){L(an,(mod=am==38||am==63232?-1:1))}return rcube_event.cancel(p);case 37:case 39:var aj,al,an=a.find(":focus").closest("li");if(an.length){aj=B(an);al=k[aj];if(al&&al.children.length&&al.collapsed!=(am==37)){E(aj,rcube_event.get_modifier(p)==SHIFT_KEY)}}return false;case 9:if(o.keyboard&&o.tabexit){var ak=rcube_event.get_modifier(p)==SHIFT_KEY?"first":"last";d(a.find("li[role=treeitem]:has(a)")[ak]().find("a:"+ak))}break}return true}function L(am,an,al){var ao=an<0?"prev":"next",aj=am[ao](),ak,p;if(an>0&&!al&&am.children("ul[role=group]:visible").length){am.children("ul").children("li:first").find("a:first").focus()}else{if(an<0&&!al&&aj.children("ul[role=group]:visible").length){aj.children("ul").children("li:last").find("a:first").focus()}else{if(aj.length&&aj.find("a:first").focus().length){}else{p=am.parent().closest("li[role=treeitem]");if(p.length){if(an<0){p.find("a:first").focus()}else{L(p,an,true)}}}}}}function d(aj){if(aj.length){var ak=a.parent().get(0)||{scrollTop:0},p=ak.scrollTop||ak.scrollY;aj.focus();ak.scrollTop=p}}function c(am){if(!am&&Z){return}Z=true;var ak,al,an,aj=a.offset();U=bw.ie?0:window.pageYOffset;q=a.parent().scrollTop();aj.top+=q;x={x1:aj.left,y1:aj.top,x2:aj.left+a.width(),y2:aj.top+a.height()};P=[];for(var p in k){ak=s(p);al=ak.children().first().get(0);if(al&&(an=al.offsetHeight)){aj=$(al).offset();aj.top+=q;P[p]={x1:aj.left,y1:aj.top,x2:aj.left+al.offsetWidth,y2:aj.top+an,on:p==K}}}if(a.height()>a.parent().height()){a.parent().mousemove(function(aq){var ao=0,ap=rcube_event.get_mouse_pos(aq);ap.y-=a.parent().offset().top;if(ap.y<25&&q>0){ao=-1}else{if(ap.y>a.parent().height()-25){ao=1}}if(Z&&ao!=0){if(!w){w=window.setTimeout(function(){l(ao)},o.scroll_delay)}}else{if(w){window.clearTimeout(w);w=null}}}).mouseleave(function(){if(w){window.clearTimeout(w);w=null}})}}function aa(){if(!Z){return}Z=false;w=null;if(ad){clearTimeout(ad);ad=null;K=null}$("li.droptarget",a).removeClass("droptarget")}function l(p){if(!Z){return}var aj=q;a.parent().get(0).scrollTop+=o.scroll_step*p;q=a.parent().scrollTop();w=null;if(q!=aj){w=window.setTimeout(function(){l(p)},o.scroll_speed)}}function X(am,al){var ak=bw.ie?-document.documentElement.scrollTop:U,ap=a.parent().scrollTop(),an=null;am.top=am.y+ap-ak;if(am.x<x.x1||am.x>=x.x2||am.top<x.y1||am.top>=x.y2){if(al){$("li.droptarget",a).removeClass("droptarget")}return an}var aj,p,ao;for(aj in P){p=P[aj];if(am.x>=p.x1&&am.x<p.x2&&am.top>=p.y1&&am.top<p.y2){ao=k[aj];if(ao.children&&ao.children.length&&ao.collapsed&&o.autoexpand&&K!=aj){if(ad){clearTimeout(ad)}K=aj;ad=setTimeout(function(){ae(K);c(true);K=null;if(h){$.ui.ddmanager.prepareOffsets($.ui.ddmanager.current,null)}},o.autoexpand)}else{if(ad&&K!=aj){clearTimeout(ad);K=null;ad=null}}if(o.check_droptarget(ao)){if(al){s(aj).addClass("droptarget");p.on=true}an=aj}else{an=null}}else{if(p.on){s(aj).removeClass("droptarget");p.on=false}}}return an}function ag(p){if(!p){p={}}if($.type(p)=="string"){if(p=="destroy"){h=null}$("li:not(.virtual)",a).droppable(p);return this}g=p;var aj=$.extend({greedy:true,tolerance:"pointer",hoverClass:"droptarget",addClasses:false},p);aj.activate=function(al,ak){c();h=ak;if(p.activate){p.activate(al,ak)}};aj.deactivate=function(al,ak){aa();h=null;if(p.deactivate){p.deactivate(al,ak)}};aj.over=function(al,ak){X(rcube_event.get_mouse_pos(al),false);if(p.over){p.over(al,ak)}};$("li:not(.virtual)",a).droppable(aj);return this}function D(p){if(!p){p={}}if($.type(p)=="string"){if(p=="destroy"){A=null}$("li:not(.virtual)",a).draggable(p);return this}t=p;var aj=$.extend({appendTo:"body",revert:"invalid",iframeFix:true,addClasses:false,cursorAt:{left:-20,top:5},create:function(al,ak){A=ak},helper:function(ak){return $("<div>").attr("id","rcmdraglayer").text($.trim($(ak.target).first().text()))}},p);$("li:not(.virtual)",a).draggable(aj);return this}}rcube_treelist_widget.prototype.addEventListener=rcube_event_engine.prototype.addEventListener;rcube_treelist_widget.prototype.removeEventListener=rcube_event_engine.prototype.removeEventListener;rcube_treelist_widget.prototype.triggerEvent=rcube_event_engine.prototype.triggerEvent;