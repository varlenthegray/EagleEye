var GOOGIE_CUR_LANG,GOOGIE_DEFAULT_LANG="en";function GoogieSpell(a,d,c){var e=this,b=rcmail.get_cookie("language");GOOGIE_CUR_LANG=b!=null?b:GOOGIE_DEFAULT_LANG;this.array_keys=function(h){var g=[];for(var f in h){g.push([f])}return g};this.img_dir=a;this.server_url=d;this.org_lang_to_word={da:"Dansk",de:"Deutsch",en:"English",es:"Español",fr:"Français",it:"Italiano",nl:"Nederlands",pl:"Polski",pt:"Português",ru:"Русский",fi:"Suomi",sv:"Svenska"};this.lang_to_word=this.org_lang_to_word;this.langlist_codes=this.array_keys(this.lang_to_word);this.show_change_lang_pic=true;this.change_lang_pic_placement="right";this.report_state_change=true;this.ta_scroll_top=0;this.el_scroll_top=0;this.lang_chck_spell="Check spelling";this.lang_revert="Revert to";this.lang_close="Close";this.lang_rsm_edt="Resume editing";this.lang_no_error_found="No spelling errors found";this.lang_no_suggestions="No suggestions";this.lang_learn_word="Add to dictionary";this.show_spell_img=false;this.decoration=true;this.use_close_btn=false;this.edit_layer_dbl_click=true;this.report_ta_not_found=true;this.custom_ajax_error=null;this.custom_no_spelling_error=null;this.custom_menu_builder=[];this.custom_item_evaulator=null;this.extra_menu_items=[];this.custom_spellcheck_starter=null;this.main_controller=true;this.has_dictionary=c;this.lang_state_observer=null;this.spelling_state_observer=null;this.show_menu_observer=null;this.all_errors_fixed_observer=null;this.use_focus=false;this.focus_link_t=null;this.focus_link_b=null;this.cnt_errors=0;this.cnt_errors_fixed=0;$(document).click(function(g){var f=$(g.target);if(f.attr("googie_action_btn")!="1"&&e.isLangWindowShown()){e.hideLangWindow()}if(f.attr("googie_action_btn")!="1"&&e.isErrorWindowShown()){e.hideErrorWindow()}});this.decorateTextarea=function(g){this.text_area=typeof g==="string"?document.getElementById(g):g;if(this.text_area){if(!this.spell_container&&this.decoration){var k=document.createElement("table"),m=document.createElement("tbody"),f=document.createElement("tr"),l=document.createElement("td"),j=this.isDefined(this.force_width)?this.force_width:this.text_area.offsetWidth,h=this.isDefined(this.force_height)?this.force_height:16;f.appendChild(l);m.appendChild(f);$(k).append(m).insertBefore(this.text_area).width("100%").height(h);$(l).height(h).width(j).css("text-align","right");this.spell_container=l}this.checkSpellingState()}else{if(this.report_ta_not_found){alert("Text area not found")}}};this.setSpellContainer=function(f){this.spell_container=typeof f==="string"?document.getElementById(f):f};this.setLanguages=function(f){this.lang_to_word=f;this.langlist_codes=this.array_keys(f)};this.setCurrentLanguage=function(g){GOOGIE_CUR_LANG=g;var f=new Date();f.setTime(f.getTime()+365*24*60*60*1000);rcmail.set_cookie("language",g,f)};this.setForceWidthHeight=function(g,f){this.force_width=g;this.force_height=f};this.setDecoration=function(f){this.decoration=f};this.dontUseCloseButtons=function(){this.use_close_btn=false};this.appendNewMenuItem=function(f,g,h){this.extra_menu_items.push([f,g,h])};this.appendCustomMenuBuilder=function(g,f){this.custom_menu_builder.push([g,f])};this.setFocus=function(){try{this.focus_link_b.focus();this.focus_link_t.focus();return true}catch(f){return false}};this.setStateChanged=function(f){this.state=f;if(this.spelling_state_observer!=null&&this.report_state_change){this.spelling_state_observer(f,this)}};this.setReportStateChange=function(f){this.report_state_change=f};this.getUrl=function(){return this.server_url+GOOGIE_CUR_LANG};this.escapeSpecial=function(f){return f?f.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):""};this.createXMLReq=function(f){return'<?xml version="1.0" encoding="utf-8" ?><spellrequest textalreadyclipped="0" ignoredups="0" ignoredigits="1" ignoreallcaps="1"><text>'+f+"</text></spellrequest>"};this.spellCheck=function(g){this.prepare(g);var f=this.escapeSpecial(this.orginal_text),h=this;$.ajax({type:"POST",url:this.getUrl(),data:this.createXMLReq(f),dataType:"text",error:function(j){if(h.custom_ajax_error){h.custom_ajax_error(h)}else{alert("An error was encountered on the server. Please try again later.")}if(h.main_controller){$(h.spell_span).remove();h.removeIndicator()}h.checkSpellingState()},success:function(j){h.processData(j);if(!h.results.length){if(!h.custom_no_spelling_error){h.flashNoSpellingErrorState()}else{h.custom_no_spelling_error(h)}}h.removeIndicator()}})};this.learnWord=function(f,g){f=this.escapeSpecial(f.innerHTML);var j=this,h='<?xml version="1.0" encoding="utf-8" ?><learnword><text>'+f+"</text></learnword>";$.ajax({type:"POST",url:this.getUrl(),data:h,dataType:"text",error:function(k){if(j.custom_ajax_error){j.custom_ajax_error(j)}else{alert("An error was encountered on the server. Please try again later.")}},success:function(k){}})};this.prepare=function(g,f){this.cnt_errors_fixed=0;this.cnt_errors=0;this.setStateChanged("checking_spell");this.orginal_text="";if(!f&&this.main_controller){this.appendIndicator(this.spell_span)}this.error_links=[];this.ta_scroll_top=this.text_area.scrollTop;this.ignore=g;this.hideLangWindow();var h=$(this.text_area);if(h.val()==""||g){if(!this.custom_no_spelling_error){this.flashNoSpellingErrorState()}else{this.custom_no_spelling_error(this)}this.removeIndicator();return}this.createEditLayer(h.width(),h.height());this.createErrorWindow();$("body").append(this.error_window);try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(j){}if(this.main_controller){$(this.spell_span).off("click")}this.orginal_text=h.val()};this.parseResult=function(s){var o=/\w+="(\d+|true)"/g,l=/\t/g,h=s.match(/<c[^>]*>[^<]*<\/c>/g),n=[];if(h==null){return n}for(var p=0,r=h.length;p<r;p++){var g=[];this.errorFound();g.attrs=[];var u,m,f=h[p].match(o);for(var k=0;k<f.length;k++){u=f[k].split(/=/);m=u[1].replace(/"/g,"");g.attrs[u[0]]=m!="true"?parseInt(m):m}g.suggestions=[];var t=h[p].replace(/<[^>]*>/g,""),j=t.split(l);for(var q=0;q<j.length;q++){if(j[q]!=""){g.suggestions.push(j[q])}}n.push(g)}return n};this.processData=function(f){this.results=this.parseResult(f);if(this.results.length){this.showErrorsInIframe();this.resumeEditingState()}};this.createErrorWindow=function(){this.error_window=document.createElement("div");$(this.error_window).addClass("googie_window popupmenu").attr("googie_action_btn","1")};this.isErrorWindowShown=function(){return $(this.error_window).is(":visible")};this.hideErrorWindow=function(){$(this.error_window).hide();$(this.error_window_iframe).hide()};this.updateOrginalText=function(g,k,m,n){var f=this.orginal_text.substring(0,g),o=this.orginal_text.substring(g+k.length),l=m.length-k.length;this.orginal_text=f+m+o;$(this.text_area).val(this.orginal_text);for(var h=0,j=this.results.length;h<j;h++){if(h!=n&&h>n){this.results[h]["attrs"]["o"]+=l}}};this.saveOldValue=function(g,f){g.is_changed=true;g.old_value=f};this.createListSeparator=function(){var g=document.createElement("td"),f=document.createElement("tr");$(g).html(" ").attr("googie_action_btn","1").css({cursor:"default","font-size":"3px","border-top":"1px solid #ccc","padding-top":"3px"});f.appendChild(g);return f};this.correctError=function(h,g,f,k){var m=g.innerHTML,j=f.nodeType==3?f.nodeValue:f.innerHTML,n=this.results[h]["attrs"]["o"];if(k){var l=g.previousSibling.innerHTML;g.previousSibling.innerHTML=l.slice(0,l.length-1);m=" "+m;n--}this.hideErrorWindow();this.updateOrginalText(n,m,j,h);$(g).html(j).css("color","green").attr("is_corrected",true);this.results[h]["attrs"]["l"]=j.length;if(!this.isDefined(g.old_value)){this.saveOldValue(g,m)}this.errorFixed()};this.ignoreError=function(g,f){$(g).removeAttr("class").css("color","").off();this.hideErrorWindow()};this.showErrorWindow=function(f,C){if(this.show_menu_observer){this.show_menu_observer(this)}var y=this,z=$(f).offset(),m=document.createElement("table"),o=document.createElement("tbody");$(this.error_window).html("");$(m).addClass("googie_list").attr("googie_action_btn","1");var D=false;for(var g=0;g<this.custom_menu_builder.length;g++){var B=this.custom_menu_builder[g];if(B[0](this.results[C])){D=B[1](this,o,f);break}}if(!D){var q=this.results[C]["suggestions"],x=this.results[C]["attrs"]["o"],k=this.results[C]["attrs"]["l"],L,E,M;if(this.has_dictionary&&!$(f).attr("is_corrected")){L=document.createElement("tr"),E=document.createElement("td"),M=document.createElement("span");$(M).text(this.lang_learn_word);$(E).attr("googie_action_btn","1").css("cursor","default").mouseover(y.item_onmouseover).mouseout(y.item_onmouseout).click(function(O){y.learnWord(f,C);y.ignoreError(f,C)});E.appendChild(M);L.appendChild(E);o.appendChild(L)}for(var h=0,k=q.length;h<k;h++){L=document.createElement("tr"),E=document.createElement("td"),M=document.createElement("span");$(M).html(q[h]);$(E).mouseover(this.item_onmouseover).mouseout(this.item_onmouseout).click(function(O){y.correctError(C,f,O.target.firstChild)});E.appendChild(M);L.appendChild(E);o.appendChild(L)}if(f.is_changed&&f.innerHTML!=f.old_value){var s=f.old_value,u=document.createElement("tr"),r=document.createElement("td"),I=document.createElement("span");$(I).addClass("googie_list_revert").html(this.lang_revert+" "+s);$(r).mouseover(this.item_onmouseover).mouseout(this.item_onmouseout).click(function(O){y.updateOrginalText(x,f.innerHTML,s,C);$(f).removeAttr("is_corrected").css("color","#b91414").html(s);y.hideErrorWindow()});r.appendChild(I);u.appendChild(r);o.appendChild(u)}var H=document.createElement("tr"),G=document.createElement("td"),K=document.createElement("input"),l=document.createElement("img"),t=document.createElement("form");var w=function(){if(K.value!=""){if(!y.isDefined(f.old_value)){y.saveOldValue(f,f.innerHTML)}y.updateOrginalText(x,f.innerHTML,K.value,C);$(f).attr("is_corrected",true).css("color","green").text(K.value);y.hideErrorWindow()}return false};$(K).width(120).css({margin:0,padding:0}).val($(f).text()).attr("googie_action_btn","1");$(G).css("cursor","default").attr("googie_action_btn","1");$(l).attr("src",this.img_dir+"ok.gif").width(32).height(16).css({cursor:"pointer","margin-left":"2px","margin-right":"2px"}).click(w);$(t).attr("googie_action_btn","1").css({margin:0,padding:0,cursor:"default","white-space":"nowrap"}).submit(w);t.appendChild(K);t.appendChild(l);G.appendChild(t);H.appendChild(G);o.appendChild(H);if(this.extra_menu_items.length>0){o.appendChild(this.createListSeparator())}var F=function(R){if(R<y.extra_menu_items.length){var Q=y.extra_menu_items[R];if(!Q[2]||Q[2](f,y)){var P=document.createElement("tr"),O=document.createElement("td");$(O).html(Q[0]).mouseover(y.item_onmouseover).mouseout(y.item_onmouseout).click(function(){return Q[1](f,y)});P.appendChild(O);o.appendChild(P)}F(R+1)}};F(0);F=null;if(this.use_close_btn){o.appendChild(this.createCloseButton(this.hideErrorWindow))}}m.appendChild(o);this.error_window.appendChild(m);var A=$(this.error_window).height(),N=$(this.error_window).width(),n=$(document).height(),J=$(document).width(),p=z.top+A+20<n?z.top+20:z.top-A,v=z.left+N<J?z.left:z.left-N;$(this.error_window).css({top:p+"px",left:v+"px"}).show();if(document.all&&!window.opera){if(!this.error_window_iframe){var j=$("<iframe>").css({position:"absolute","z-index":-1});$("body").append(j);this.error_window_iframe=j}$(this.error_window_iframe).css({top:this.error_window.offsetTop,left:this.error_window.offsetLeft,width:this.error_window.offsetWidth,height:this.error_window.offsetHeight}).show()}};this.createEditLayer=function(f,h){this.edit_layer=document.createElement("div");$(this.edit_layer).addClass("googie_edit_layer").attr("id","googie_edit_layer").width(f).height(h);if(this.text_area.nodeName.toLowerCase()!="input"||$(this.text_area).val()==""){$(this.edit_layer).css("overflow","auto")}else{$(this.edit_layer).css("overflow","hidden")}var g=this;if(this.edit_layer_dbl_click){$(this.edit_layer).dblclick(function(k){if(k.target.className!="googie_link"&&!g.isErrorWindowShown()){g.resumeEditing();var j=function(){$(g.text_area).focus();j=null};window.setTimeout(j,10)}return false})}};this.resumeEditing=function(){this.setStateChanged("ready");if(this.edit_layer){this.el_scroll_top=this.edit_layer.scrollTop}this.hideErrorWindow();if(this.main_controller){$(this.spell_span).removeClass().addClass("googie_no_style")}if(!this.ignore){if(this.use_focus){$(this.focus_link_t).remove();$(this.focus_link_b).remove()}$(this.edit_layer).remove();$(this.text_area).show();if(this.el_scroll_top!=undefined){this.text_area.scrollTop=this.el_scroll_top}}this.checkSpellingState(false)};this.createErrorLink=function(k,g){var f=document.createElement("span"),h=this,j=function(l){h.showErrorWindow(f,g);j=null;return false};$(f).html(k).addClass("googie_link").click(j).removeAttr("is_corrected").attr({googie_action_btn:"1",g_id:g});return f};this.createPart=function(g){if(g==" "){return document.createTextNode(" ")}g=this.escapeSpecial(g);g=g.replace(/\n/g,"<br>");g=g.replace(/    /g," &nbsp;");g=g.replace(/^ /g,"&nbsp;");g=g.replace(/ $/g,"&nbsp;");var f=document.createElement("span");$(f).html(g);return f};this.showErrorsInIframe=function(){var s=document.createElement("div"),k=0,h=this.results;if(h.length>0){for(var j=0,q=h.length;j<q;j++){var g=h[j]["attrs"]["o"],o=h[j]["attrs"]["l"],p=this.orginal_text.substring(k,g),r=this.createPart(p);s.appendChild(r);k+=g-k;var m=this.createErrorLink(this.orginal_text.substr(g,o),j);this.error_links.push(m);s.appendChild(m);k+=o}var l=this.orginal_text.substr(k,this.orginal_text.length),n=this.createPart(l);s.appendChild(n)}else{s.innerHTML=this.orginal_text}$(s).css("text-align","left");var f=this;if(this.custom_item_evaulator){$.map(this.error_links,function(t){f.custom_item_evaulator(f,t)})}$(this.edit_layer).append(s);$(this.text_area).hide();$(this.edit_layer).insertBefore(this.text_area);if(this.use_focus){this.focus_link_t=this.createFocusLink("focus_t");this.focus_link_b=this.createFocusLink("focus_b");$(this.focus_link_t).insertBefore(this.edit_layer);$(this.focus_link_b).insertAfter(this.edit_layer)}};this.createLangWindow=function(){this.language_window=document.createElement("div");$(this.language_window).addClass("googie_window popupmenu").width(100).attr("googie_action_btn","1");var l=document.createElement("table"),g=document.createElement("tbody"),k=this,h,j,f;$(l).addClass("googie_list").width("100%");this.lang_elms=[];for(i=0;i<this.langlist_codes.length;i++){h=document.createElement("tr");j=document.createElement("td");f=document.createElement("span");$(f).text(this.lang_to_word[this.langlist_codes[i]]);this.lang_elms.push(j);$(j).attr("googieId",this.langlist_codes[i]).click(function(m){k.deHighlightCurSel();k.setCurrentLanguage($(this).attr("googieId"));if(k.lang_state_observer!=null){k.lang_state_observer()}k.highlightCurSel();k.hideLangWindow()}).mouseover(function(m){if(this.className!="googie_list_selected"){this.className="googie_list_onhover"}}).mouseout(function(m){if(this.className!="googie_list_selected"){this.className="googie_list_onout"}});j.appendChild(f);h.appendChild(j);g.appendChild(h)}if(this.use_close_btn){g.appendChild(this.createCloseButton(function(){k.hideLangWindow.apply(k)}))}this.highlightCurSel();l.appendChild(g);this.language_window.appendChild(l)};this.isLangWindowShown=function(){return $(this.language_window).is(":visible")};this.hideLangWindow=function(){$(this.language_window).hide();$(this.switch_lan_pic).removeClass().addClass("googie_lang_3d_on")};this.showLangWindow=function(j){if(this.show_menu_observer){this.show_menu_observer(this)}this.createLangWindow();$("body").append(this.language_window);var h=$(j).offset(),l=$(j).height(),m=$(j).width(),k=$(this.language_window).height(),n=$(document).height(),g=this.change_lang_pic_placement=="right"?h.left-100+m:h.left+m,f=h.top+k<n?h.top+l:h.top-k-4;$(this.language_window).css({top:f+"px",left:g+"px"}).show();this.highlightCurSel()};this.deHighlightCurSel=function(){$(this.lang_cur_elm).removeClass().addClass("googie_list_onout")};this.highlightCurSel=function(){if(GOOGIE_CUR_LANG==null){GOOGIE_CUR_LANG=GOOGIE_DEFAULT_LANG}for(var f=0;f<this.lang_elms.length;f++){if($(this.lang_elms[f]).attr("googieId")==GOOGIE_CUR_LANG){this.lang_elms[f].className="googie_list_selected";this.lang_cur_elm=this.lang_elms[f]}else{this.lang_elms[f].className="googie_list_onout"}}};this.createChangeLangPic=function(){var f=$("<img>").attr({src:this.img_dir+"change_lang.gif",alt:"Change language",googie_action_btn:"1"}),g=document.createElement("span");e=this;$(g).addClass("googie_lang_3d_on").append(f).click(function(h){var j=this.tagName.toLowerCase()=="img"?this.parentNode:this;if($(j).hasClass("googie_lang_3d_click")){j.className="googie_lang_3d_on";e.hideLangWindow()}else{j.className="googie_lang_3d_click";e.showLangWindow(j)}});return g};this.createSpellDiv=function(){var f=document.createElement("span");$(f).addClass("googie_check_spelling_link").text(this.lang_chck_spell);if(this.show_spell_img){$(f).append(" ").append($("<img>").attr("src",this.img_dir+"spellc.gif"))}return f};this.flashNoSpellingErrorState=function(h){this.setStateChanged("no_error_found");var f=this;if(this.main_controller){var g;if(h){var k=function(){h();f.checkSpellingState()};g=k}else{g=function(){f.checkSpellingState()}}var j=$("<span>").text(this.lang_no_error_found);$(this.switch_lan_pic).hide();$(this.spell_span).empty().append(j).removeClass().addClass("googie_check_spelling_ok");window.setTimeout(g,1000)}};this.resumeEditingState=function(){this.setStateChanged("resume_editing");if(this.main_controller){var h=$("<span>").text(this.lang_rsm_edt);var f=this;$(this.switch_lan_pic).hide();$(this.spell_span).empty().off().append(h).click(function(){f.resumeEditing()}).removeClass().addClass("googie_resume_editing")}try{this.edit_layer.scrollTop=this.ta_scroll_top}catch(g){}};this.checkSpellingState=function(f){if(f){this.setStateChanged("ready")}if(this.show_change_lang_pic){this.switch_lan_pic=this.createChangeLangPic()}else{this.switch_lan_pic=document.createElement("span")}var h=this.createSpellDiv(),g=this;if(this.custom_spellcheck_starter){$(h).click(function(j){g.custom_spellcheck_starter()})}else{$(h).click(function(j){g.spellCheck()})}if(this.main_controller){if(this.change_lang_pic_placement=="left"){$(this.spell_container).empty().append(this.switch_lan_pic).append(" ").append(h)}else{$(this.spell_container).empty().append(h).append(" ").append(this.switch_lan_pic)}}this.spell_span=h};this.isDefined=function(f){return(f!==undefined&&f!==null)};this.errorFixed=function(){this.cnt_errors_fixed++;if(this.all_errors_fixed_observer){if(this.cnt_errors_fixed==this.cnt_errors){this.hideErrorWindow();this.all_errors_fixed_observer()}}};this.errorFound=function(){this.cnt_errors++};this.createCloseButton=function(f){return this.createButton(this.lang_close,"googie_list_close",f)};this.createButton=function(j,l,h){var g=document.createElement("tr"),k=document.createElement("td"),f;if(l){f=document.createElement("span");$(f).addClass(l).html(j)}else{f=document.createTextNode(j)}$(k).click(h).mouseover(this.item_onmouseover).mouseout(this.item_onmouseout);k.appendChild(f);g.appendChild(k);return g};this.removeIndicator=function(f){if(window.rcmail){rcmail.set_busy(false,null,this.rc_msg_id)}};this.appendIndicator=function(f){if(window.rcmail){this.rc_msg_id=rcmail.set_busy(true,"checking")}};this.createFocusLink=function(f){var g=document.createElement("a");$(g).attr({href:"javascript:;",name:f});return g};this.item_onmouseover=function(f){if(this.className!="googie_list_revert"&&this.className!="googie_list_close"){this.className="googie_list_onhover"}else{this.parentNode.className="googie_list_onhover"}};this.item_onmouseout=function(f){if(this.className!="googie_list_revert"&&this.className!="googie_list_close"){this.className="googie_list_onout"}else{this.parentNode.className="googie_list_onout"}}};