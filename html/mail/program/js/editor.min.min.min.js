function rcube_text_editor(a,c){var b=this,e=location.href.replace(/[?#].*$/,"").replace(/\/$/,""),d={selector:"#"+($("#"+c).is(".mce_editor")?c:"fake-editor-id"),cache_suffix:"s=4050800",theme:"modern",language:a.lang,content_css:rcmail.assets_path("program/resources/tinymce/content.css"),menubar:false,statusbar:false,toolbar_items_size:"small",extended_valid_elements:"font[face|size|color|style],span[id|class|align|style]",fontsize_formats:"8pt 9pt 10pt 11pt 12pt 14pt 18pt 24pt 36pt",relative_urls:false,remove_script_host:false,convert_urls:false,image_description:false,paste_webkit_style:"color font-size font-family",paste_data_images:true,browser_spellcheck:true};this.spellcheck_observer=function(){};if(a.spellchecker){this.spellchecker=a.spellchecker;if(a.spellcheck_observer){this.spellchecker.spelling_state_observer=this.spellcheck_observer=a.spellcheck_observer}}if(!tinymce.registered_request_token){tinymce.registered_request_token=true;tinymce.util.XHR.on("beforeSend",function(f){f.xhr.setRequestHeader("X-Roundcube-Request",rcmail.env.request_token)})}if(a.mode=="identity"){$.extend(d,{plugins:"autolink charmap code colorpicker hr image link paste tabfocus textcolor",toolbar:"bold italic underline alignleft aligncenter alignright alignjustify | outdent indent charmap hr link unlink image code forecolor | fontselect fontsizeselect",file_browser_callback:function(i,h,f,g){b.file_browser_callback(i,h,f)},file_browser_callback_types:"image"})}else{$.extend(d,{plugins:"autolink charmap code colorpicker directionality link lists image media nonbreaking paste table tabfocus textcolor searchreplace spellchecker",toolbar:"bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent ltr rtl blockquote | forecolor backcolor | fontselect fontsizeselect | link unlink table | $extra charmap image media | code searchreplace undo redo",spellchecker_rpc_url:e+"/?_task=utils&_action=spell_html&_remote=1",spellchecker_language:rcmail.env.spell_lang,accessibility_focus:false,file_browser_callback:function(i,h,f,g){b.file_browser_callback(i,h,f)},file_browser_callback_types:"image media"})}$.each(a.extra_plugins||[],function(){if(d.plugins.indexOf(this)<0){d.plugins=d.plugins+" "+this}});$.each(a.extra_buttons||[],function(){if(d.toolbar.indexOf(this)<0){d.toolbar=d.toolbar.replace("$extra","$extra "+this)}});$.each(a.disabled_plugins||[],function(){d.plugins=d.plugins.replace(this,"")});$.each(a.disabled_buttons||[],function(){d.toolbar=d.toolbar.replace(this,"")});d.toolbar=d.toolbar.replace("$extra","").replace(/\|\s+\|/g,"|");if(window.rcmail_editor_settings){$.extend(d,window.rcmail_editor_settings)}d.setup=function(f){f.on("init",function(g){b.init_callback(g)});f.on("SpellcheckStart SpellcheckEnd",function(g){b.spellcheck_active=g.type=="spellcheckstart";b.spellcheck_observer()});f.on("keypress",function(){rcmail.compose_type_activity++})};this.id=c;this.editor=null;tinymce.init(d);this.init_callback=function(h){this.editor=h.target;if(rcmail.env.action!="compose"){return}var f=$("#"+this.id),g=$("div.mce-toolbar-grp:first",f.parent()).height();if(g>200||g>f.height()){return setTimeout(function(){b.init_callback(h)},300)}var j={},k=rcube_find_object("_from"),i=rcmail.env.compose_focus_elem;if(rcmail.env.default_font){j["font-family"]=rcmail.env.default_font}if(rcmail.env.default_font_size){j["font-size"]=rcmail.env.default_font_size}if(j["font-family"]||j["font-size"]){$(this.editor.getBody()).css(j)}if(k&&k.type=="select-one"){if(!rcmail.env.identities_initialized){rcmail.change_identity(k)}if(i&&i.id!=this.id&&i.nodeName!="BODY"){window.focus();i.focus();rcmail.env.compose_focus_elem=null}}b.tabindex(i&&i.id==b.id);$(window).resize()};this.tabindex=function(l){if(rcmail.env.task=="mail"&&this.editor){var j=this.editor.getElement(),i=this.editor.getBody(),h=this.editor.getContentAreaContainer().childNodes[0];if(j&&h){h.tabIndex=j.tabIndex}if(j.tabIndex>0){var g=null,k=[":prev",":next"],f=tinymce.DOM.select("*[tabindex="+j.tabIndex+"]:not(iframe)");tinymce.each(f,function(m,n){if(m.id==b.id){g=n;return false}});if(g!==null){if(f[g-1]&&f[g-1].id){k[0]=f[g-1].id}if(f[g+1]&&f[g+1].id){k[1]=f[g+1].id}this.editor.settings.tabfocus_elements=k.join(",")}}if(bw.mz&&bw.vendver<25){$(i).prop("contenteditable",false).prop("contenteditable",true)}if(l){i.focus()}}};this.toggle=function(i,p){var k,h,l,m="\u0002\u0003",j=$("#"+this.id),o=rcmail.env.identity?rcmail.env.signatures[rcmail.env.identity]:null,g=o&&o.text&&o.text.length>1;this.spellcheck_stop();if(i){h=j.val();if(g){h=h.replace(/\r\n/,"\n");h=h.replace(o.text.replace(/\r\n/,"\n"),m)}var f=function(r){if(g){r=r.replace(m,'<div id="_rc_sig">'+o.html+"</div>")}j.val(r);tinymce.execCommand("mceAddEditor",false,b.id);if(b.editor){var q=$(b.editor.getBody());b.tabindex(true);b.editor.selection.setCursorLocation(q.children().first().get(0))}};if(!p){l=rcmail.plain2html(h,f)}else{f(h);l=true}}else{if(this.editor){if(g){if(k=this.editor.dom.get("_rc_sig")){k=k.innerHTML}this.editor.dom.setHTML("_rc_sig",m)}h=this.editor.getContent();var n=function(q){tinymce.execCommand("mceRemoveEditor",false,b.id);b.editor=null;if(g){q=q.replace(m,"\n"+o.text)}j.val(q).focus();rcmail.set_caret_pos(j.get(0),0)};if(!p){l=rcmail.html2plain(h,n)}else{n(j.val());l=true}if(!l&&k){this.editor.dom.setHTML("_rc_sig",k)}}}return l};this.spellcheck_start=function(){if(this.editor){tinymce.execCommand("mceSpellCheck",true);this.spellcheck_observer()}else{if(this.spellchecker&&this.spellchecker.spellCheck){this.spellchecker.spellCheck()}}};this.spellcheck_stop=function(){var f=this.editor;if(f){if(f.plugins&&f.plugins.spellchecker&&this.spellcheck_active){f.execCommand("mceSpellCheck",false);this.spellcheck_observer()}}else{if(f=this.spellchecker){if(f.state&&f.state!="ready"&&f.state!="no_error_found"){$(f.spell_span).trigger("click")}}}};this.spellcheck_state=function(){var f;if(this.editor){return this.spellcheck_active}else{if((f=this.spellchecker)&&f.state){return f.state!="ready"&&f.state!="no_error_found"}}};this.spellcheck_resume=function(g){var f=this.editor;if(f){f.plugins.spellchecker.markErrors(g)}else{if(f=this.spellchecker){f.prepare(false,true);f.processData(g)}}};this.get_language=function(){if(this.editor){return this.editor.settings.spellchecker_language||rcmail.env.spell_lang}else{if(this.spellchecker){return GOOGIE_CUR_LANG}}};this.set_language=function(g){var f=this.editor;if(f){f.settings.spellchecker_language=g}if(f=this.spellchecker){f.setCurrentLanguage(g)}};this.replace=function(i){var h,g=this.editor;if(!i){return false}if(g){g.getWin().focus();if($.type(i)=="object"&&("html" in i)){i=i.html;h="html"}else{if($.type(i)=="object"){i=i.text||""}i=rcmail.quote_html(i).replace(/\r?\n/g,"<br/>");h="text"}g.selection.setContent(i,{format:h})}else{if(g=rcube_find_object(this.id)){var j=$(g).is(":focus")?rcmail.get_input_selection(g):{start:0,end:0},l=g.value,f=l.substring(0,j.start),k=l.substring(j.end,l.length);if($.type(i)=="object"){i=i.text||""}g.value=f+i+k;rcmail.set_caret_pos(g,j.start+i.length);g.focus()}}};this.get_content=function(i){var h,g=this.editor,f="",j=false,k={refresh:true,selection:false,nosig:false,format:"html"};i=$.extend(k,i);if(i.refresh){this.spellcheck_stop()}if(g){if(i.selection){f=g.selection.getContent({format:i.format})}if(!f){f=g.getContent({format:i.format});j=i.format=="text"}}else{if(g=rcube_find_object(this.id)){if(i.selection&&$(g).is(":focus")){f=rcmail.get_input_selection(g).text}if(!f){f=g.value;j=true}}}if(j&&i.nosig){h=f.indexOf("-- \n");if(h>0){f=f.substring(0,h)}}return f};this.change_signature=function(n,i){var f,g,o=-1,j=$("#"+this.id),l=j.val(),k=rcmail.env.identity;if(!this.editor){if(i&&k&&rcmail.env.signatures&&rcmail.env.signatures[k]){k=rcmail.env.signatures[k].text;k=k.replace(/\r\n/g,"\n");o=rcmail.env.top_posting?l.indexOf(k):l.lastIndexOf(k);if(o>=0){l=l.substring(0,o)+l.substring(o+k.length,l.length)}}if(i&&rcmail.env.signatures&&rcmail.env.signatures[n]){k=rcmail.env.signatures[n].text;k=k.replace(/\r\n/g,"\n");if(o>=0){l=l.substring(0,o)+k+l.substring(o,l.length);g=o-1}else{if(!l||!rcmail.env.compose_mode){g=l.length;l+="\n\n"+k}else{if(rcmail.env.top_posting&&!rcmail.env.sig_below){if(pos=rcmail.get_caret_pos(j.get(0))){l=l.substring(0,pos)+"\n"+k+"\n\n"+l.substring(pos,l.length);g=pos}else{l="\n\n"+k+"\n\n"+l.replace(/^[\r\n]+/,"");g=0}}else{l=l.replace(/[\r\n]+$/,"");g=!rcmail.env.top_posting&&l.length?l.length+1:0;l+="\n\n"+k}}}}else{g=rcmail.env.top_posting?0:l.length}j.val(l);rcmail.set_caret_pos(j.get(0),g)}else{if(i&&rcmail.env.signatures){var m=this.editor.dom.get("_rc_sig");if(!m){var h=this.editor.getBody();m=$('<div id="_rc_sig"></div>').get(0);if(rcmail.env.top_posting&&!rcmail.env.sig_below&&rcmail.env.compose_mode&&(h.childNodes.length>1||$(h).text())){this.editor.getWin().focus();var q=this.editor.selection.getNode();$(m).insertBefore(q.nodeName=="BODY"?h.firstChild:q.nextSibling);$("<p>").append($("<br>")).insertBefore(m)}else{h.appendChild(m);f=rcmail.env.top_posting&&rcmail.env.compose_mode?h.firstChild:$(m).prev()}}m.innerHTML=rcmail.env.signatures[n]?rcmail.env.signatures[n].html:""}else{if(!rcmail.env.top_posting){f=$(this.editor.getBody()).children().last()}}}if(this.editor&&f&&f.length){this.editor.selection.setCursorLocation(f.get(0));this.editor.getWin().scroll(0,f.offset().top)}};this.save=function(){if(this.editor){this.editor.save()}};this.focus=function(){(this.editor||rcube_find_object(this.id)).focus()};this.file_browser_callback=function(g,n,k){var h,f,m,j,l,i=[];j=this.editor.windowManager.open({title:rcmail.get_label("select"+k),width:500,height:300,html:'<div id="image-selector-list"><ul></ul></div><div id="image-selector-form"><div id="image-upload-button" class="mce-widget mce-btn" role="button" tabindex="0"></div></div>',buttons:[{text:"Cancel",onclick:function(){b.file_browser_close()}}]});rcmail.env.file_browser_field=g;rcmail.env.file_browser_type=k;for(h in rcmail.env.attachments){if(f=b.file_browser_entry(h,rcmail.env.attachments[h])){i.push(f)}}if(i.length){$("#image-selector-list > ul").append(i).find("li:first").focus()}$("div.mce-abs-end",j.getEl()).append($('<div class="hint">').text($("div.hint",rcmail.gui_objects.uploadform).text()));f=$("#image-upload-button").append($("<span>").text(rcmail.get_label("add"+k)));m=f.parents(".mce-panel").find("button:last").parent();f.keydown(function(o){if(o.which==9){if(rcube_event.get_modifier(o)==SHIFT_KEY){$("#image-selector-list li:last").focus()}else{m.focus()}return false}});m.keydown(function(o){if(o.which==9){if(rcube_event.get_modifier(o)==SHIFT_KEY){f.focus()}else{$("#image-selector-list li:first").focus()}return false}});this.hack_file_input(f,rcmail.gui_objects.uploadform);if((window.XMLHttpRequest&&XMLHttpRequest.prototype&&XMLHttpRequest.prototype.sendAsBinary)||window.FormData){if(!rcmail.env.filedrop){rcmail.env.filedrop={}}if(rcmail.gui_objects.filedrop){rcmail.env.old_file_drop=rcmail.gui_objects.filedrop}rcmail.gui_objects.filedrop=$("#image-selector-form");rcmail.gui_objects.filedrop.addClass("droptarget").on("dragover dragleave",function(o){o.preventDefault();o.stopPropagation();$(this)[(o.type=="dragover"?"addClass":"removeClass")]("hover")}).get(0).addEventListener("drop",function(o){return rcmail.file_dropped(o)},false)}if(!rcmail.env.file_dialog_event){rcmail.env.file_dialog_event=true;rcmail.addEventListener("fileuploaded",function(p){var o;if(o=b.file_browser_entry(p.name,p.attachment)){$("#image-selector-list > ul").prepend(o);o.focus()}})}};this.file_browser_close=function(g){var f=$("#"+rcmail.env.file_browser_field);if(g){f.val(g)}this.editor.windowManager.close();f.focus();if(rcmail.env.old_file_drop){rcmail.gui_objects.filedrop=rcmail.env.old_file_drop}};this.file_browser_entry=function(k,i){if(!i.complete||!i.mimetype){return}if(rcmail.file_upload_id){rcmail.set_busy(false,null,rcmail.file_upload_id)}var g,m;switch(rcmail.env.file_browser_type){case"image":g=/^image\//i;break;case"media":g=/^video\//i;m="program/resources/tinymce/video.png";break;default:return}if(g.test(i.mimetype)){var f=rcmail.env.comm_path+"&_from="+rcmail.env.action,l=rcmail.env.compose_id?"&_id="+rcmail.env.compose_id+"&_action=display-attachment":"&_action=upload-display",j=f+l+"&_file="+k,h=$("<img>").attr({title:i.name,src:m?m:j+"&_thumbnail=1"});return $("<li>").attr({tabindex:0}).data("url",j).append($('<span class="img">').append(h)).append($('<span class="name">').text(i.name)).click(function(){b.file_browser_close($(this).data("url"))}).keydown(function(n){if(n.which==13){b.file_browser_close($(this).data("url"))}else{if(n.which==9){if(rcube_event.get_modifier(n)==SHIFT_KEY){if(!$(this).prev().focus().length){$("#image-upload-button").parents(".mce-panel").find("button:last").parent().focus()}}else{if(!$(this).next().focus().length){$("#image-upload-button").focus()}}return false}}})}};this.hack_file_input=function(g,i){var h,l=$(g),f=$("<input>").attr("name","_file[]"),j=$("<form>").attr({method:"post",enctype:"multipart/form-data"});if(i){f.attr("name",$('input[type="file"]',i).attr("name"));j.attr("action",$(i).attr("action")).append($("<input>").attr({type:"hidden",name:"_token",value:rcmail.env.request_token}))}function k(m){if(!h){h=l.offset()}f.css({top:(m.pageY-h.top-10)+"px",left:(m.pageX-h.left-10)+"px"})}f.attr({type:"file",multiple:"multiple",size:5,title:"",tabindex:-1}).change(function(){rcmail.upload_file(j,"upload")}).click(function(){setTimeout(function(){l.mouseleave()},20)}).css({opacity:0,cursor:"pointer",position:"relative",outline:"none"}).appendTo(j);if(navigator.userAgent.match(/Firefox|MSIE/)){f.css({marginLeft:"-80px"})}l.css({overflow:"hidden",cursor:"pointer"}).mouseenter(function(){this.__active=true}).mousemove(function(m){if(this.__active){k(m)}else{$(this).mouseleave()}}).mouseleave(function(){f.css({top:"-10000px",left:"-10000px"});this.__active=false}).click(function(m){if(!this.__active){this.__active=true;k(m);f.trigger(m)}}).keydown(function(m){if(m.which==13){f.trigger("click")}}).mouseleave().append(j)}};