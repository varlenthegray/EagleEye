function rcube_treelist_widget(aC,ak){ak=$.extend({id_prefix:"",autoexpand:1000,selectable:false,scroll_delay:500,scroll_step:5,scroll_speed:20,save_state:false,keyboard:true,tabexit:true,parent_focus:false,check_droptarget:function(a){return !a.virtual}},ak||{});var az=$(aC),aE=ak.data||[],ao={},a4=null,p=false,aV=false,aO="",bg=false,aT={},aB=[],bf,aG,a6=0,aj=0,aU,aK,aR,ar,aQ,aX,at,a2=(az.attr("id")||ak.id_prefix||"0"),aZ=this;this.container=az;this.expand=be;this.collapse=aW;this.select=al;this.render=aD;this.reset=aq;this.drag_start=ax;this.drag_end=a1;this.intersects=a3;this.droppable=bc;this.draggable=aN;this.update=aI;this.insert=ba;this.remove=aS;this.get_item=au;this.get_node=ap;this.get_selection=a5;this.is_search=aL;this.reset_search=ay;if(!az.length){return}if(ak.data){aA({children:aE})}else{aJ()}if(a4){a7(aY(a4,true))}az.attr("role","tree").on("focusin",function(a){bg=true}).on("focusout",function(a){bg=false}).on("click","div.treetoggle",function(a){aM(aP($(this).parent()));a.stopPropagation()}).on("click","li",function(b){if($(b.target).is("input")){return true}var a=ak.selectable?ao[aP($(this))]:null;if(a&&!a.virtual){al(a.id);b.stopPropagation()}}).on("mousedown","a",function(b){var c=$(b.target),a=ao[aP(c.closest("li"))];if(a&&a.virtual&&!c.attr("href")){b.preventDefault();b.stopPropagation();return false}});if(ak.searchbox){aK=$(ak.searchbox).off("keyup.treelist").on("keyup.treelist",function(b){var c=rcube_event.get_keycode(b),a=rcube_event.get_modifier(b);switch(c){case 9:break;case 13:aH(this.value,true);return rcube_event.cancel(b);case 27:ay();break;case 38:case 37:case 39:case 40:return;default:aH(this.value,false);break}}).attr("autocomplete","off");aK.parent().find("a.reset").off("click.treelist").on("click.treelist",function(a){ay();return false})}$(document.body).on("keydown",am);if(ak.parent_focus){az.parent(":not(body)").click(function(a){if($(a.target).is("input")){return true}if(!bg&&a4){$(au(a4)).find(":focusable").first().focus()}else{if(!bg){az.children("li:has(:focusable)").first().find(":focusable").first().focus()}}})}function aW(a,c,b){var d;if(d=ao[a]){d.collapsed=typeof b=="undefined"||b;a0(d);if(c&&d.children){for(var e=0;e<d.children.length;e++){aW(d.children[e].id,c,b)}}aZ.triggerEvent(d.collapsed?"collapse":"expand",d);av(a,d.collapsed)}}function be(b,a){aW(b,a,false)}function aM(b,a){var c;if(c=ao[b]){aW(b,a,!c.collapsed)}}function al(b){if(aZ.triggerEvent("beforeselect",ao[b])===false){return}if(a4){aY(a4,true).removeClass("selected").removeAttr("aria-selected");if(aV){aY(a4).removeClass("selected").removeAttr("aria-selected")}a4=null}if(!b){return}var a=aY(b,true);if(a.length){a.addClass("selected").attr("aria-selected","true");a4=b;if(aV){aY(b).addClass("selected").attr("aria-selected","true")}a7(a)}aZ.triggerEvent("select",ao[b])}function a5(){return a4}function ap(a){return ao[a]}function au(b,a){return aY(b,a).get(0)}function ba(e,d,f){var c,b,a=d?ao[d]:null;search_=aV;if(ao[e.id]){return}state=bd(e.id,e.collapsed);if(state!==undefined){e.collapsed=state}if(a){e.level=a.level+1;if(!a.children){a.children=[]}aV=false;a.children.push(e);b=aY(d);if(a.children.length==1){bb(a,null,b);c=aY(e.id)}else{c=bb(e,b.children("ul").first())}if(search_){aV=search_;if(!c.is(":visible")){$("<li>").attr("id",c.attr("id")+"--xsR").attr("class",c.attr("class")).addClass("searchresult__").append(c.children().first().clone(true,true)).appendTo(az)}}}else{e.level=0;aE.push(e);c=bb(e,az)}ao[e.id]=e;if(typeof e.html=="object"){ao[e.id].html=aY(e.id,true).children()}if(f){a8(c,typeof f=="string"?'[class~="'+f+'"]':"")}}function aI(a,d,g){var f,h,c,b,e=ao[a];if(e){f=aY(a);h=f.parent();if(d.id||d.html||d.children||d.classes||d.parent){if(d.parent&&(c=ao[d.parent])){if(h.closest("li").length&&(b=ao[aP(h.closest("li"))])){b.children=$.grep(b.children,function(i,j){return i.id!=e.id})}h=aY(d.parent).children("ul").first();if(!c.children){c.children=[]}c.children.push(e)}else{if(d.parent!==undefined){h=az}}$.extend(e,d);f=bb(e,h,f)}if(e.id!=a){delete ao[a];ao[e.id]=e}if(g){a8(f,typeof g=="string"?'[class~="'+g+'"]':"")}}}function a8(d,c){var b,e,f=d.get(0).id,a=d.children().first().text().toUpperCase();d.parent().children("li"+c).each(function(h,g){if(h==0){b=g}if(g.id==f){}else{if(g.id!=f&&a>=$(g).children().first().text().toUpperCase()){e=g}else{return false}}});if(e){d.insertAfter(e)}else{if(b&&b.id!=f){d.insertBefore(b)}}aJ()}function aS(b){var c,a,d;if(c=ao[b]){a=aY(b,true);d=a.parent();a.remove();c.deleted=true;delete ao[b];if(aV){aY(b,false).remove()}if(!d.children().length){d.parent().find("div.treetoggle").remove();d.remove()}return true}return false}function aJ(){aE=a9(az,0)}function a0(b){var a=aY(b.id,true);a.attr("aria-expanded",b.collapsed?"false":"true");a.children("ul").first()[(b.collapsed?"hide":"show")]();a.children("div.treetoggle").removeClass("collapsed expanded").addClass(b.collapsed?"collapsed":"expanded");aZ.triggerEvent("toggle",b)}function aq(a){al("");aE=[];ao={};p=false;if(a){if(aX){if(aQ){aN("destroy")}aN(aX)}if(at){if(ar){bc("destroy")}bc(at)}aJ()}else{az.html("")}ay()}function aH(c,b){c=String(c).toLowerCase();if(!c.length){return ay()}else{if(c==aO&&!b){return 0}}var a=[];var d=function(e){$.each(e,function(g,f){var i,h;if(!f.virtual&&!f.deleted&&String(f.text).toLowerCase().indexOf(c)>=0&&a.indexOf(f.id)<0){i=aY(f.id);if(i.data("filtered")){return}h=$("<li>").attr("id",i.attr("id")+"--xsR").attr("class",i.attr("class")).addClass("searchresult__").append(i.children(":not(div.treetoggle,ul)").clone(true,true)).appendTo(az);a.push(f.id)}if(f.children&&f.children.length){d(f.children)}})};if(aV){$(az).children("li.searchresult__").remove();aV=false}$(az).children("li").hide().removeClass("selected");d(aE);aV=true;aZ.triggerEvent("search",{query:c,last:aO,count:a.length,ids:a,execute:b||false});aO=c;return a.count}function ay(){if(aK){aK.val("")}$(az).children("li.searchresult__").remove();$(az).children("li").filter(function(){return !$(this).data("filtered")}).show();aV=false;aZ.triggerEvent("search",{query:false,last:aO});aO="";if(a4){al(a4)}}function aL(){return aV}function aD(){if(aZ.triggerEvent("renderBefore",aE)===false){return}az.html("");for(var a=0;a<aE.length;a++){aE[a].level=0;bb(aE[a],az)}aZ.triggerEvent("renderAfter",az)}function bb(a,b,d){if(a.deleted){return}var c=$("<li>").attr("id",ak.id_prefix+(ak.id_encode?ak.id_encode(a.id):a.id)).attr("role","treeitem").addClass((a.classes||[]).join(" ")).data("id",a.id);if(d){d.replaceWith(c);if(b){c.appendTo(b)}}else{c.appendTo(b)}if(typeof a.html=="string"){c.html(a.html)}else{if(typeof a.html=="object"){c.append(a.html)}}if(!a.text){a.text=c.children().first().text()}if(a.virtual){c.addClass("virtual")}if(a.id==a4){c.addClass("selected")}if(a.children&&a.children.length){c.attr("aria-expanded",a.collapsed?"false":"true");$('<div class="treetoggle '+(a.collapsed?"collapsed":"expanded")+'">&nbsp;</div>').appendTo(c);var e=$("<ul>").appendTo(c).attr("class",a.childlistclass).attr("role","group");if(a.collapsed){e.hide()}for(var f=0;f<a.children.length;f++){a.children[f].level=a.level+1;bb(a.children[f],e)}}return c}function a9(c,b){var a=[];c.children("li").each(function(g,d){var e,i=$(d),h=i.children("ul");var f={id:aP(i),classes:String(i.attr("class")).split(" "),virtual:i.hasClass("virtual"),level:b,html:i.children().first().get(0).outerHTML,text:i.children().first().text(),children:a9(h,b+1)};if(h.length){f.childlistclass=h.attr("class")}if(f.children.length){if(f.collapsed===undefined){f.collapsed=h.css("display")=="none"}e=bd(f.id,f.collapsed);if(e!==undefined){f.collapsed=e;h[(e?"hide":"show")]()}if(!i.children("div.treetoggle").length){$('<div class="treetoggle '+(f.collapsed?"collapsed":"expanded")+'">&nbsp;</div>').appendTo(i)}i.attr("aria-expanded",f.collapsed?"false":"true")}if(i.hasClass("selected")){i.attr("aria-selected","true");a4=f.id}i.data("id",f.id);i.attr("role","treeitem").attr("aria-level",f.level+1);if(f.virtual){i.children("a:first").attr("tabindex","0")}a.push(f);ao[f.id]=f});c.attr("role",b==0?"tree":"group");return a}function aA(a){if(a.id){ao[a.id]=a}for(var b=0;a.children&&b<a.children.length;b++){aA(a.children[b])}}function aP(a){var b=String(a.attr("id")).replace(new RegExp("^"+(ak.id_prefix)||"%"),"").replace(/--xsR$/,"");return ak.id_decode?ak.id_decode(b):b}function aY(b,c){var a=ak.id_encode?ak.id_encode(b):b,d=aV&&!c?"--xsR":"";return $("#"+ak.id_prefix+a+d,az)}function a7(d){var b=az.parent(),c=b.scrollTop(),a=d.offset().top-b.offset().top;if(a<0||a+d.height()>b.height()){b.scrollTop(a+c)}}function av(b,c){if(ak.save_state&&window.rcmail){var a="treelist-"+a2;if(!aR){aR=rcmail.local_storage_get_item(a,{})}if(aR[b]!=c){aR[b]=c;rcmail.local_storage_set_item(a,aR)}}}function bd(a){if(ak.save_state&&window.rcmail){if(!aR){aR=rcmail.local_storage_get_item("treelist-"+a2,{})}return aR[a]}return undefined}function am(b){var c=b.target||{},e=rcube_event.get_keycode(b);if(!bg||c.nodeName=="INPUT"&&e!=38&&e!=40||c.nodeName=="TEXTAREA"||c.nodeName=="SELECT"){return true}switch(e){case 38:case 40:case 63232:case 63233:var d=ak.keyboard?az.find(":focus").closest("li"):[];if(d.length){aF(d,(mod=e==38||e==63232?-1:1))}return rcube_event.cancel(b);case 37:case 39:var a,f,d=az.find(":focus").closest("li");if(d.length){a=aP(d);f=ao[a];if(f&&f.children.length&&f.collapsed!=(e==37)){aM(a,rcube_event.get_modifier(b)==SHIFT_KEY)}}return false;case 9:if(ak.keyboard&&ak.tabexit){var g=rcube_event.get_modifier(b)==SHIFT_KEY?"first":"last";aw(az.find("li[role=treeitem]:has(a)")[g]().find("a:"+g))}break}return true}function aF(e,d,f){var c=d<0?"prev":"next",a=e[c](),g,b;if(d>0&&!f&&e.children("ul[role=group]:visible").length){e.children("ul").children("li:first").find("a:first").focus()}else{if(d<0&&!f&&a.children("ul[role=group]:visible").length){a.children("ul").children("li:last").find("a:first").focus()}else{if(a.length&&a.find("a:first").focus().length){}else{b=e.parent().closest("li[role=treeitem]");if(b.length){if(d<0){b.find("a:first").focus()}else{aF(b,d,true)}}}}}}function aw(a){if(a.length){var c=az.parent().get(0)||{scrollTop:0},b=c.scrollTop||c.scrollY;a.focus();c.scrollTop=b}}function ax(d){if(!d&&p){return}p=true;var f,e,c,a=az.offset();a6=bw.ie?0:window.pageYOffset;aj=az.parent().scrollTop();a.top+=aj;aT={x1:a.left,y1:a.top,x2:a.left+az.width(),y2:a.top+az.height()};aB=[];for(var b in ao){f=aY(b);e=f.children().first().get(0);if(e&&(c=e.offsetHeight)){a=$(e).offset();a.top+=aj;aB[b]={x1:a.left,y1:a.top,x2:a.left+e.offsetWidth,y2:a.top+c,on:b==aG}}}if(az.height()>az.parent().height()){az.parent().mousemove(function(g){var i=0,h=rcube_event.get_mouse_pos(g);h.y-=az.parent().offset().top;if(h.y<25&&aj>0){i=-1}else{if(h.y>az.parent().height()-25){i=1}}if(p&&i!=0){if(!aU){aU=window.setTimeout(function(){an(i)},ak.scroll_delay)}}else{if(aU){window.clearTimeout(aU);aU=null}}}).mouseleave(function(){if(aU){window.clearTimeout(aU);aU=null}})}}function a1(){if(!p){return}p=false;aU=null;if(bf){clearTimeout(bf);bf=null;aG=null}$("li.droptarget",az).removeClass("droptarget")}function an(b){if(!p){return}var a=aj;az.parent().get(0).scrollTop+=ak.scroll_step*b;aj=az.parent().scrollTop();aU=null;if(aj!=a){aU=window.setTimeout(function(){an(b)},ak.scroll_speed)}}function a3(f,g){var h=bw.ie?-document.documentElement.scrollTop:a6,c=az.parent().scrollTop(),e=null;f.top=f.y+c-h;if(f.x<aT.x1||f.x>=aT.x2||f.top<aT.y1||f.top>=aT.y2){if(g){$("li.droptarget",az).removeClass("droptarget")}return e}var a,b,d;for(a in aB){b=aB[a];if(f.x>=b.x1&&f.x<b.x2&&f.top>=b.y1&&f.top<b.y2){d=ao[a];if(d.children&&d.children.length&&d.collapsed&&ak.autoexpand&&aG!=a){if(bf){clearTimeout(bf)}aG=a;bf=setTimeout(function(){be(aG);ax(true);aG=null;if(ar){$.ui.ddmanager.prepareOffsets($.ui.ddmanager.current,null)}},ak.autoexpand)}else{if(bf&&aG!=a){clearTimeout(bf);aG=null;bf=null}}if(ak.check_droptarget(d)){if(g){aY(a).addClass("droptarget");b.on=true}e=a}else{e=null}}else{if(b.on){aY(a).removeClass("droptarget");b.on=false}}}return e}function bc(b){if(!b){b={}}if($.type(b)=="string"){if(b=="destroy"){ar=null}$("li:not(.virtual)",az).droppable(b);return this}at=b;var a=$.extend({greedy:true,tolerance:"pointer",hoverClass:"droptarget",addClasses:false},b);a.activate=function(c,d){ax();ar=d;if(b.activate){b.activate(c,d)}};a.deactivate=function(c,d){a1();ar=null;if(b.deactivate){b.deactivate(c,d)}};a.over=function(c,d){a3(rcube_event.get_mouse_pos(c),false);if(b.over){b.over(c,d)}};$("li:not(.virtual)",az).droppable(a);return this}function aN(b){if(!b){b={}}if($.type(b)=="string"){if(b=="destroy"){aQ=null}$("li:not(.virtual)",az).draggable(b);return this}aX=b;var a=$.extend({appendTo:"body",revert:"invalid",iframeFix:true,addClasses:false,cursorAt:{left:-20,top:5},create:function(c,d){aQ=d},helper:function(c){return $("<div>").attr("id","rcmdraglayer").text($.trim($(c.target).first().text()))}},b);$("li:not(.virtual)",az).draggable(a);return this}}rcube_treelist_widget.prototype.addEventListener=rcube_event_engine.prototype.addEventListener;rcube_treelist_widget.prototype.removeEventListener=rcube_event_engine.prototype.removeEventListener;rcube_treelist_widget.prototype.triggerEvent=rcube_event_engine.prototype.triggerEvent;