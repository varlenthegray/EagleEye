var GOOGIE_CUR_LANG,GOOGIE_DEFAULT_LANG="en";function GoogieSpell(k,g,h){var f=this,j=rcmail.get_cookie("language");GOOGIE_CUR_LANG=j!=null?j:GOOGIE_DEFAULT_LANG;this.array_keys=function(c){var a=[];for(var b in c){a.push([b])}return a};this.img_dir=k;this.server_url=g;this.org_lang_to_word={da:"Dansk",de:"Deutsch",en:"English",es:"Español",fr:"Français",it:"Italiano",nl:"Nederlands",pl:"Polski",pt:"Português",ru:"Русский",fi:"Suomi",sv:"Svenska"};this.lang_to_word=this.org_lang_to_word;this.langlist_codes=this.array_keys(this.lang_to_word);this.show_change_lang_pic=true;this.change_lang_pic_placement="right";this.report_state_change=true;this.ta_scroll_top=0;this.el_scroll_top=0;this.lang_chck_spell="Check spelling";this.lang_revert="Revert to";this.lang_close="Close";this.lang_rsm_edt="Resume editing";this.lang_no_error_found="No spelling errors found";this.lang_no_suggestions="No suggestions";this.lang_learn_word="Add to dictionary";this.show_spell_img=false;this.decoration=true;this.use_close_btn=false;this.edit_layer_dbl_click=true;this.report_ta_not_found=true;this.custom_ajax_error=null;this.custom_no_spelling_error=null;this.custom_menu_builder=[];this.custom_item_evaulator=null;this.extra_menu_items=[];this.custom_spellcheck_starter=null;this.main_controller=true;this.has_dictionary=h;this.lang_state_observer=null;this.spelling_state_observer=null;this.show_menu_observer=null;this.all_errors_fixed_observer=null;this.use_focus=false;this.focus_link_t=null;this.focus_link_b=null;this.cnt_errors=0;this.cnt_errors_fixed=0;$(document).click(function(a){var b=$(a.target);if(b.attr("googie_action_btn")!="1"&&f.isLangWindowShown()){f.hideLangWindow()}if(b.attr("googie_action_btn")!="1"&&f.isErrorWindowShown()){f.hideErrorWindow()}});this.decorateTextarea=function(a){this.text_area=typeof a==="string"?document.getElementById(a):a;if(this.text_area){if(!this.spell_container&&this.decoration){var d=document.createElement("table"),n=document.createElement("tbody"),b=document.createElement("tr"),c=document.createElement("td"),o=this.isDefined(this.force_width)?this.force_width:this.text_area.offsetWidth,e=this.isDefined(this.force_height)?this.force_height:16;b.appendChild(c);n.appendChild(b);$(d).append(n).insertBefore(this.text_area).width("100%").height(e);$(c).height(e).width(o).css("text-align","right");this.spell_container=c}this.checkSpellingState()}else{if(this.report_ta_not_found){alert("Text area not found")}}};this.setSpellContainer=function(a){this.spell_container=typeof a==="string"?document.getElementById(a):a};this.setLanguages=function(a){this.lang_to_word=a;this.langlist_codes=this.array_keys(a)};this.setCurrentLanguage=function(a){GOOGIE_CUR_LANG=a;var b=new Date();b.setTime(b.getTime()+365*24*60*60*1000);rcmail.set_cookie("language",a,b)};this.setForceWidthHeight=function(a,b){this.force_width=a;this.force_height=b};this.setDecoration=function(a){this.decoration=a};this.dontUseCloseButtons=function(){this.use_close_btn=false};this.appendNewMenuItem=function(b,a,c){this.extra_menu_items.push([b,a,c])};this.appendCustomMenuBuilder=function(a,b){this.custom_menu_builder.push([a,b])};this.setFocus=function(){try{this.focus_link_b.focus();this.focus_link_t.focus();return true}catch(a){return false}};this.setStateChanged=function(a){this.state=a;if(this.spelling_state_observer!=null&&this.report_state_change){this.spelling_state_observer(a,this)}};this.setReportStateChange=function(a){this.report_state_change=a};this.getUrl=function(){return this.server_url+GOOGIE_CUR_LANG};this.escapeSpecial=function(a){return a?a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):""};this.createXMLReq=function(a){return'<?xml version="1.0" encoding="utf-8" ?><spellrequest textalreadyclipped="0" ignoredups="0" ignoredigits="1" ignoreallcaps="1"><text>'+a+"</text></spellrequest>"};this.spellCheck=function(a){this.prepare(a);var b=this.escapeSpecial(this.orginal_text),c=this;$.ajax({type:"POST",url:this.getUrl(),data:this.createXMLReq(b),dataType:"text",error:function(d){if(c.custom_ajax_error){c.custom_ajax_error(c)}else{alert("An error was encountered on the server. Please try again later.")}if(c.main_controller){$(c.spell_span).remove();c.removeIndicator()}c.checkSpellingState()},success:function(d){c.processData(d);if(!c.results.length){if(!c.custom_no_spelling_error){c.flashNoSpellingErrorState()}else{c.custom_no_spelling_error(c)}}c.removeIndicator()}})};this.learnWord=function(b,a){b=this.escapeSpecial(b.innerHTML);var c=this,d='<?xml version="1.0" encoding="utf-8" ?><learnword><text>'+b+"</text></learnword>";$.ajax({type:"POST",url:this.getUrl(),data:d,dataType:"text",error:function(e){if(c.custom_ajax_error){c.custom_ajax_error(c)}else{alert("An error was encountered on the server. Please try again later.")}},success:function(e){}})};this.prepare=function(a,b){this.cnt_errors_fixed=0;this.cnt_errors=0;this.setStateChanged("checking_spell");this.orginal_text="";if(!b&&this.main_controller){this.appendIndicator(this.spell_span)}this.error_links=[];this.ta_scroll_top=this.text_area.scrollTop;this.ignore=a;this.hideLangWindow();var d=$(this.text_area);if(d.val()==""||a){if(!this.custom_no_spelling_error){this.flashNoSpellingErrorState()}else{this.custom_no_spelling_error(this)}this.removeIndicator();return}this.createEditLayer(d.width(),d.height());this.createErrorWindow();$("body").append(this.error_window);try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(c){}if(this.main_controller){$(this.spell_span).off("click")}this.orginal_text=d.val()};this.parseResult=function(G){var y=/\w+="(\d+|true)"/g,d=/\t/g,B=G.match(/<c[^>]*>[^<]*<\/c>/g),c=[];if(B==null){return c}for(var b=0,a=B.length;b<a;b++){var C=[];this.errorFound();C.attrs=[];var E,z,D=B[b].match(y);for(var e=0;e<D.length;e++){E=D[e].split(/=/);z=E[1].replace(/"/g,"");C.attrs[E[0]]=z!="true"?parseInt(z):z}C.suggestions=[];var F=B[b].replace(/<[^>]*>/g,""),A=F.split(d);for(var x=0;x<A.length;x++){if(A[x]!=""){C.suggestions.push(A[x])}}c.push(C)}return c};this.processData=function(a){this.results=this.parseResult(a);if(this.results.length){this.showErrorsInIframe();this.resumeEditingState()}};this.createErrorWindow=function(){this.error_window=document.createElement("div");$(this.error_window).addClass("googie_window popupmenu").attr("googie_action_btn","1")};this.isErrorWindowShown=function(){return $(this.error_window).is(":visible")};this.hideErrorWindow=function(){$(this.error_window).hide();$(this.error_window_iframe).hide()};this.updateOrginalText=function(q,c,a,t){var r=this.orginal_text.substring(0,q),s=this.orginal_text.substring(q+c.length),b=a.length-c.length;this.orginal_text=r+a+s;$(this.text_area).val(this.orginal_text);for(var e=0,d=this.results.length;e<d;e++){if(e!=t&&e>t){this.results[e]["attrs"]["o"]+=b}}};this.saveOldValue=function(a,b){a.is_changed=true;a.old_value=b};this.createListSeparator=function(){var a=document.createElement("td"),b=document.createElement("tr");$(a).html(" ").attr("googie_action_btn","1").css({cursor:"default","font-size":"3px","border-top":"1px solid #ccc","padding-top":"3px"});b.appendChild(a);return b};this.correctError=function(q,a,b,p){var o=a.innerHTML,e=b.nodeType==3?b.nodeValue:b.innerHTML,c=this.results[q]["attrs"]["o"];if(p){var d=a.previousSibling.innerHTML;a.previousSibling.innerHTML=d.slice(0,d.length-1);o=" "+o;c--}this.hideErrorWindow();this.updateOrginalText(c,o,e,q);$(a).html(e).css("color","green").attr("is_corrected",true);this.results[q]["attrs"]["l"]=e.length;if(!this.isDefined(a.old_value)){this.saveOldValue(a,o)}this.errorFixed()};this.ignoreError=function(a,b){$(a).removeAttr("class").css("color","").off();this.hideErrorWindow()};this.showErrorWindow=function(Z,ag){if(this.show_menu_observer){this.show_menu_observer(this)}var ak=this,aj=$(Z).offset(),T=document.createElement("table"),R=document.createElement("tbody");$(this.error_window).html("");$(T).addClass("googie_list").attr("googie_action_btn","1");var af=false;for(var Y=0;Y<this.custom_menu_builder.length;Y++){var ah=this.custom_menu_builder[Y];if(ah[0](this.results[ag])){af=ah[1](this,R,Z);break}}if(!af){var P=this.results[ag]["suggestions"],al=this.results[ag]["attrs"]["o"],V=this.results[ag]["attrs"]["l"],ab,e,a;if(this.has_dictionary&&!$(Z).attr("is_corrected")){ab=document.createElement("tr"),e=document.createElement("td"),a=document.createElement("span");$(a).text(this.lang_learn_word);$(e).attr("googie_action_btn","1").css("cursor","default").mouseover(ak.item_onmouseover).mouseout(ak.item_onmouseout).click(function(l){ak.learnWord(Z,ag);ak.ignoreError(Z,ag)});e.appendChild(a);ab.appendChild(e);R.appendChild(ab)}for(var X=0,V=P.length;X<V;X++){ab=document.createElement("tr"),e=document.createElement("td"),a=document.createElement("span");$(a).html(P[X]);$(e).mouseover(this.item_onmouseover).mouseout(this.item_onmouseout).click(function(l){ak.correctError(ag,Z,l.target.firstChild)});e.appendChild(a);ab.appendChild(e);R.appendChild(ab)}if(Z.is_changed&&Z.innerHTML!=Z.old_value){var aq=Z.old_value,ao=document.createElement("tr"),ar=document.createElement("td"),ad=document.createElement("span");$(ad).addClass("googie_list_revert").html(this.lang_revert+" "+aq);$(ar).mouseover(this.item_onmouseover).mouseout(this.item_onmouseout).click(function(l){ak.updateOrginalText(al,Z.innerHTML,aq,ag);$(Z).removeAttr("is_corrected").css("color","#b91414").html(aq);ak.hideErrorWindow()});ar.appendChild(ad);ao.appendChild(ar);R.appendChild(ao)}var c=document.createElement("tr"),ae=document.createElement("td"),b=document.createElement("input"),U=document.createElement("img"),ap=document.createElement("form");var am=function(){if(b.value!=""){if(!ak.isDefined(Z.old_value)){ak.saveOldValue(Z,Z.innerHTML)}ak.updateOrginalText(al,Z.innerHTML,b.value,ag);$(Z).attr("is_corrected",true).css("color","green").text(b.value);ak.hideErrorWindow()}return false};$(b).width(120).css({margin:0,padding:0}).val($(Z).text()).attr("googie_action_btn","1");$(ae).css("cursor","default").attr("googie_action_btn","1");$(U).attr("src",this.img_dir+"ok.gif").width(32).height(16).css({cursor:"pointer","margin-left":"2px","margin-right":"2px"}).click(am);$(ap).attr("googie_action_btn","1").css({margin:0,padding:0,cursor:"default","white-space":"nowrap"}).submit(am);ap.appendChild(b);ap.appendChild(U);ae.appendChild(ap);c.appendChild(ae);R.appendChild(c);if(this.extra_menu_items.length>0){R.appendChild(this.createListSeparator())}var d=function(n){if(n<ak.extra_menu_items.length){var o=ak.extra_menu_items[n];if(!o[2]||o[2](Z,ak)){var l=document.createElement("tr"),m=document.createElement("td");$(m).html(o[0]).mouseover(ak.item_onmouseover).mouseout(ak.item_onmouseout).click(function(){return o[1](Z,ak)});l.appendChild(m);R.appendChild(l)}d(n+1)}};d(0);d=null;if(this.use_close_btn){R.appendChild(this.createCloseButton(this.hideErrorWindow))}}T.appendChild(R);this.error_window.appendChild(T);var ai=$(this.error_window).height(),aa=$(this.error_window).width(),S=$(document).height(),ac=$(document).width(),Q=aj.top+ai+20<S?aj.top+20:aj.top-ai,an=aj.left+aa<ac?aj.left:aj.left-aa;$(this.error_window).css({top:Q+"px",left:an+"px"}).show();if(document.all&&!window.opera){if(!this.error_window_iframe){var W=$("<iframe>").css({position:"absolute","z-index":-1});$("body").append(W);this.error_window_iframe=W}$(this.error_window_iframe).css({top:this.error_window.offsetTop,left:this.error_window.offsetLeft,width:this.error_window.offsetWidth,height:this.error_window.offsetHeight}).show()}};this.createEditLayer=function(b,c){this.edit_layer=document.createElement("div");$(this.edit_layer).addClass("googie_edit_layer").attr("id","googie_edit_layer").width(b).height(c);if(this.text_area.nodeName.toLowerCase()!="input"||$(this.text_area).val()==""){$(this.edit_layer).css("overflow","auto")}else{$(this.edit_layer).css("overflow","hidden")}var a=this;if(this.edit_layer_dbl_click){$(this.edit_layer).dblclick(function(d){if(d.target.className!="googie_link"&&!a.isErrorWindowShown()){a.resumeEditing();var e=function(){$(a.text_area).focus();e=null};window.setTimeout(e,10)}return false})}};this.resumeEditing=function(){this.setStateChanged("ready");if(this.edit_layer){this.el_scroll_top=this.edit_layer.scrollTop}this.hideErrorWindow();if(this.main_controller){$(this.spell_span).removeClass().addClass("googie_no_style")}if(!this.ignore){if(this.use_focus){$(this.focus_link_t).remove();$(this.focus_link_b).remove()}$(this.edit_layer).remove();$(this.text_area).show();if(this.el_scroll_top!=undefined){this.text_area.scrollTop=this.el_scroll_top}}this.checkSpellingState(false)};this.createErrorLink=function(c,a){var b=document.createElement("span"),e=this,d=function(m){e.showErrorWindow(b,a);d=null;return false};$(b).html(c).addClass("googie_link").click(d).removeAttr("is_corrected").attr({googie_action_btn:"1",g_id:a});return b};this.createPart=function(a){if(a==" "){return document.createTextNode(" ")}a=this.escapeSpecial(a);a=a.replace(/\n/g,"<br>");a=a.replace(/    /g," &nbsp;");a=a.replace(/^ /g,"&nbsp;");a=a.replace(/ $/g,"&nbsp;");var b=document.createElement("span");$(b).html(a);return b};this.showErrorsInIframe=function(){var t=document.createElement("div"),z=0,d=this.results;if(d.length>0){for(var c=0,v=d.length;c<v;c++){var e=d[c]["attrs"]["o"],a=d[c]["attrs"]["l"],w=this.orginal_text.substring(z,e),u=this.createPart(w);t.appendChild(u);z+=e-z;var y=this.createErrorLink(this.orginal_text.substr(e,a),c);this.error_links.push(y);t.appendChild(y);z+=a}var b=this.orginal_text.substr(z,this.orginal_text.length),x=this.createPart(b);t.appendChild(x)}else{t.innerHTML=this.orginal_text}$(t).css("text-align","left");var A=this;if(this.custom_item_evaulator){$.map(this.error_links,function(l){A.custom_item_evaulator(A,l)})}$(this.edit_layer).append(t);$(this.text_area).hide();$(this.edit_layer).insertBefore(this.text_area);if(this.use_focus){this.focus_link_t=this.createFocusLink("focus_t");this.focus_link_b=this.createFocusLink("focus_b");$(this.focus_link_t).insertBefore(this.edit_layer);$(this.focus_link_b).insertAfter(this.edit_layer)}};this.createLangWindow=function(){this.language_window=document.createElement("div");$(this.language_window).addClass("googie_window popupmenu").width(100).attr("googie_action_btn","1");var c=document.createElement("table"),b=document.createElement("tbody"),d=this,a,e,m;$(c).addClass("googie_list").width("100%");this.lang_elms=[];for(i=0;i<this.langlist_codes.length;i++){a=document.createElement("tr");e=document.createElement("td");m=document.createElement("span");$(m).text(this.lang_to_word[this.langlist_codes[i]]);this.lang_elms.push(e);$(e).attr("googieId",this.langlist_codes[i]).click(function(l){d.deHighlightCurSel();d.setCurrentLanguage($(this).attr("googieId"));if(d.lang_state_observer!=null){d.lang_state_observer()}d.highlightCurSel();d.hideLangWindow()}).mouseover(function(l){if(this.className!="googie_list_selected"){this.className="googie_list_onhover"}}).mouseout(function(l){if(this.className!="googie_list_selected"){this.className="googie_list_onout"}});e.appendChild(m);a.appendChild(e);b.appendChild(a)}if(this.use_close_btn){b.appendChild(this.createCloseButton(function(){d.hideLangWindow.apply(d)}))}this.highlightCurSel();c.appendChild(b);this.language_window.appendChild(c)};this.isLangWindowShown=function(){return $(this.language_window).is(":visible")};this.hideLangWindow=function(){$(this.language_window).hide();$(this.switch_lan_pic).removeClass().addClass("googie_lang_3d_on")};this.showLangWindow=function(q){if(this.show_menu_observer){this.show_menu_observer(this)}this.createLangWindow();$("body").append(this.language_window);var r=$(q).offset(),p=$(q).height(),d=$(q).width(),e=$(this.language_window).height(),c=$(document).height(),a=this.change_lang_pic_placement=="right"?r.left-100+d:r.left+d,b=r.top+e<c?r.top+p:r.top-e-4;$(this.language_window).css({top:b+"px",left:a+"px"}).show();this.highlightCurSel()};this.deHighlightCurSel=function(){$(this.lang_cur_elm).removeClass().addClass("googie_list_onout")};this.highlightCurSel=function(){if(GOOGIE_CUR_LANG==null){GOOGIE_CUR_LANG=GOOGIE_DEFAULT_LANG}for(var a=0;a<this.lang_elms.length;a++){if($(this.lang_elms[a]).attr("googieId")==GOOGIE_CUR_LANG){this.lang_elms[a].className="googie_list_selected";this.lang_cur_elm=this.lang_elms[a]}else{this.lang_elms[a].className="googie_list_onout"}}};this.createChangeLangPic=function(){var b=$("<img>").attr({src:this.img_dir+"change_lang.gif",alt:"Change language",googie_action_btn:"1"}),a=document.createElement("span");f=this;$(a).addClass("googie_lang_3d_on").append(b).click(function(d){var c=this.tagName.toLowerCase()=="img"?this.parentNode:this;if($(c).hasClass("googie_lang_3d_click")){c.className="googie_lang_3d_on";f.hideLangWindow()}else{c.className="googie_lang_3d_click";f.showLangWindow(c)}});return a};this.createSpellDiv=function(){var a=document.createElement("span");$(a).addClass("googie_check_spelling_link").text(this.lang_chck_spell);if(this.show_spell_img){$(a).append(" ").append($("<img>").attr("src",this.img_dir+"spellc.gif"))}return a};this.flashNoSpellingErrorState=function(e){this.setStateChanged("no_error_found");var b=this;if(this.main_controller){var a;if(e){var c=function(){e();b.checkSpellingState()};a=c}else{a=function(){b.checkSpellingState()}}var d=$("<span>").text(this.lang_no_error_found);$(this.switch_lan_pic).hide();$(this.spell_span).empty().append(d).removeClass().addClass("googie_check_spelling_ok");window.setTimeout(a,1000)}};this.resumeEditingState=function(){this.setStateChanged("resume_editing");if(this.main_controller){var c=$("<span>").text(this.lang_rsm_edt);var b=this;$(this.switch_lan_pic).hide();$(this.spell_span).empty().off().append(c).click(function(){b.resumeEditing()}).removeClass().addClass("googie_resume_editing")}try{this.edit_layer.scrollTop=this.ta_scroll_top}catch(a){}};this.checkSpellingState=function(b){if(b){this.setStateChanged("ready")}if(this.show_change_lang_pic){this.switch_lan_pic=this.createChangeLangPic()}else{this.switch_lan_pic=document.createElement("span")}var c=this.createSpellDiv(),a=this;if(this.custom_spellcheck_starter){$(c).click(function(d){a.custom_spellcheck_starter()})}else{$(c).click(function(d){a.spellCheck()})}if(this.main_controller){if(this.change_lang_pic_placement=="left"){$(this.spell_container).empty().append(this.switch_lan_pic).append(" ").append(c)}else{$(this.spell_container).empty().append(c).append(" ").append(this.switch_lan_pic)}}this.spell_span=c};this.isDefined=function(a){return(a!==undefined&&a!==null)};this.errorFixed=function(){this.cnt_errors_fixed++;if(this.all_errors_fixed_observer){if(this.cnt_errors_fixed==this.cnt_errors){this.hideErrorWindow();this.all_errors_fixed_observer()}}};this.errorFound=function(){this.cnt_errors++};this.createCloseButton=function(a){return this.createButton(this.lang_close,"googie_list_close",a)};this.createButton=function(e,c,a){var b=document.createElement("tr"),d=document.createElement("td"),m;if(c){m=document.createElement("span");$(m).addClass(c).html(e)}else{m=document.createTextNode(e)}$(d).click(a).mouseover(this.item_onmouseover).mouseout(this.item_onmouseout);d.appendChild(m);b.appendChild(d);return b};this.removeIndicator=function(a){if(window.rcmail){rcmail.set_busy(false,null,this.rc_msg_id)}};this.appendIndicator=function(a){if(window.rcmail){this.rc_msg_id=rcmail.set_busy(true,"checking")}};this.createFocusLink=function(b){var a=document.createElement("a");$(a).attr({href:"javascript:;",name:b});return a};this.item_onmouseover=function(a){if(this.className!="googie_list_revert"&&this.className!="googie_list_close"){this.className="googie_list_onhover"}else{this.parentNode.className="googie_list_onhover"}};this.item_onmouseout=function(a){if(this.className!="googie_list_revert"&&this.className!="googie_list_close"){this.className="googie_list_onout"}else{this.parentNode.className="googie_list_onout"}}};