var GOOGIE_CUR_LANG,GOOGIE_DEFAULT_LANG="en";function GoogieSpell(d,c,b){var a=this,e=rcmail.get_cookie("language");GOOGIE_CUR_LANG=null!=e?e:GOOGIE_DEFAULT_LANG;this.array_keys=function(g){var f=[],h;for(h in g){f.push([h])}return f};this.img_dir=d;this.server_url=c;this.lang_to_word=this.org_lang_to_word={da:"Dansk",de:"Deutsch",en:"English",es:"Espa\u00f1ol",fr:"Fran\u00e7ais",it:"Italiano",nl:"Nederlands",pl:"Polski",pt:"Portugu\u00eas",ru:"\u0420\u0443\u0441\u0441\u043a\u0438\u0439",fi:"Suomi",sv:"Svenska"};this.langlist_codes=this.array_keys(this.lang_to_word);this.show_change_lang_pic=!0;this.change_lang_pic_placement="right";this.report_state_change=!0;this.el_scroll_top=this.ta_scroll_top=0;this.lang_chck_spell="Check spelling";this.lang_revert="Revert to";this.lang_close="Close";this.lang_rsm_edt="Resume editing";this.lang_no_error_found="No spelling errors found";this.lang_no_suggestions="No suggestions";this.lang_learn_word="Add to dictionary";this.show_spell_img=!1;this.decoration=!0;this.use_close_btn=!1;this.report_ta_not_found=this.edit_layer_dbl_click=!0;this.custom_no_spelling_error=this.custom_ajax_error=null;this.custom_menu_builder=[];this.custom_item_evaulator=null;this.extra_menu_items=[];this.custom_spellcheck_starter=null;this.main_controller=!0;this.has_dictionary=b;this.all_errors_fixed_observer=this.show_menu_observer=this.spelling_state_observer=this.lang_state_observer=null;this.use_focus=!1;this.focus_link_b=this.focus_link_t=null;this.cnt_errors_fixed=this.cnt_errors=0;$(document).click(function(f){f=$(f.target);"1"!=f.attr("googie_action_btn")&&a.isLangWindowShown()&&a.hideLangWindow();"1"!=f.attr("googie_action_btn")&&a.isErrorWindowShown()&&a.hideErrorWindow()});this.decorateTextarea=function(h){if(this.text_area="string"===typeof h?document.getElementById(h):h){if(!this.spell_container&&this.decoration){h=document.createElement("table");var f=document.createElement("tbody"),m=document.createElement("tr"),l=document.createElement("td"),k=this.isDefined(this.force_width)?this.force_width:this.text_area.offsetWidth,j=this.isDefined(this.force_height)?this.force_height:16;m.appendChild(l);f.appendChild(m);$(h).append(f).insertBefore(this.text_area).width("100%").height(j);$(l).height(j).width(k).css("text-align","right");this.spell_container=l}this.checkSpellingState()}else{this.report_ta_not_found&&alert("Text area not found")}};this.setSpellContainer=function(f){this.spell_container="string"===typeof f?document.getElementById(f):f};this.setLanguages=function(f){this.lang_to_word=f;this.langlist_codes=this.array_keys(f)};this.setCurrentLanguage=function(g){GOOGIE_CUR_LANG=g;var f=new Date;f.setTime(f.getTime()+31536000000);rcmail.set_cookie("language",g,f)};this.setForceWidthHeight=function(g,f){this.force_width=g;this.force_height=f};this.setDecoration=function(f){this.decoration=f};this.dontUseCloseButtons=function(){this.use_close_btn=!1};this.appendNewMenuItem=function(g,f,h){this.extra_menu_items.push([g,f,h])};this.appendCustomMenuBuilder=function(g,f){this.custom_menu_builder.push([g,f])};this.setFocus=function(){try{return this.focus_link_b.focus(),this.focus_link_t.focus(),!0}catch(f){return !1}};this.setStateChanged=function(f){this.state=f;null!=this.spelling_state_observer&&this.report_state_change&&this.spelling_state_observer(f,this)};this.setReportStateChange=function(f){this.report_state_change=f};this.getUrl=function(){return this.server_url+GOOGIE_CUR_LANG};this.escapeSpecial=function(f){return f?f.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):""};this.createXMLReq=function(f){return'<?xml version="1.0" encoding="utf-8" ?><spellrequest textalreadyclipped="0" ignoredups="0" ignoredigits="1" ignoreallcaps="1"><text>'+f+"</text></spellrequest>"};this.spellCheck=function(g){this.prepare(g);g=this.escapeSpecial(this.orginal_text);var f=this;$.ajax({type:"POST",url:this.getUrl(),data:this.createXMLReq(g),dataType:"text",error:function(h){f.custom_ajax_error?f.custom_ajax_error(f):alert("An error was encountered on the server. Please try again later.");f.main_controller&&($(f.spell_span).remove(),f.removeIndicator());f.checkSpellingState()},success:function(h){f.processData(h);f.results.length||(f.custom_no_spelling_error?f.custom_no_spelling_error(f):f.flashNoSpellingErrorState());f.removeIndicator()}})};this.learnWord=function(g,f){g=this.escapeSpecial(g.innerHTML);var h=this;g='<?xml version="1.0" encoding="utf-8" ?><learnword><text>'+g+"</text></learnword>";$.ajax({type:"POST",url:this.getUrl(),data:g,dataType:"text",error:function(j){h.custom_ajax_error?h.custom_ajax_error(h):alert("An error was encountered on the server. Please try again later.")},success:function(j){}})};this.prepare=function(g,f){this.cnt_errors=this.cnt_errors_fixed=0;this.setStateChanged("checking_spell");this.orginal_text="";!f&&this.main_controller&&this.appendIndicator(this.spell_span);this.error_links=[];this.ta_scroll_top=this.text_area.scrollTop;this.ignore=g;this.hideLangWindow();f=$(this.text_area);if(""==f.val()||g){this.custom_no_spelling_error?this.custom_no_spelling_error(this):this.flashNoSpellingErrorState(),this.removeIndicator()}else{this.createEditLayer(f.width(),f.height());this.createErrorWindow();$("body").append(this.error_window);try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead")}catch(h){}this.main_controller&&$(this.spell_span).off("click");this.orginal_text=f.val()}};this.parseResult=function(w){var v=/\w+="(\d+|true)"/g,u=/\t/g;w=w.match(/<c[^>]*>[^<]*<\/c>/g);var t=[];if(null==w){return t}for(var s=0,q=w.length;s<q;s++){var o=[];this.errorFound();o.attrs=[];for(var r,p,j=w[s].match(v),n=0;n<j.length;n++){r=j[n].split(/=/),p=r[1].replace(/"/g,""),o.attrs[r[0]]="true"!=p?parseInt(p):p}o.suggestions=[];r=w[s].replace(/<[^>]*>/g,"").split(u);for(p=0;p<r.length;p++){""!=r[p]&&o.suggestions.push(r[p])}t.push(o)}return t};this.processData=function(f){this.results=this.parseResult(f);this.results.length&&(this.showErrorsInIframe(),this.resumeEditingState())};this.createErrorWindow=function(){this.error_window=document.createElement("div");$(this.error_window).addClass("googie_window popupmenu").attr("googie_action_btn","1")};this.isErrorWindowShown=function(){return $(this.error_window).is(":visible")};this.hideErrorWindow=function(){$(this.error_window).hide();$(this.error_window_iframe).hide()};this.updateOrginalText=function(g,f,k,j){var h=this.orginal_text.substring(0,g);g=this.orginal_text.substring(g+f.length);f=k.length-f.length;this.orginal_text=h+k+g;$(this.text_area).val(this.orginal_text);k=0;for(h=this.results.length;k<h;k++){k!=j&&k>j&&(this.results[k].attrs.o+=f)}};this.saveOldValue=function(g,f){g.is_changed=!0;g.old_value=f};this.createListSeparator=function(){var g=document.createElement("td"),f=document.createElement("tr");$(g).html(" ").attr("googie_action_btn","1").css({cursor:"default","font-size":"3px","border-top":"1px solid #ccc","padding-top":"3px"});f.appendChild(g);return f};this.correctError=function(h,f,m,l){var k=f.innerHTML;m=3==m.nodeType?m.nodeValue:m.innerHTML;var j=this.results[h].attrs.o;l&&(l=f.previousSibling.innerHTML,f.previousSibling.innerHTML=l.slice(0,l.length-1),k=" "+k,j--);this.hideErrorWindow();this.updateOrginalText(j,k,m,h);$(f).html(m).css("color","green").attr("is_corrected",!0);this.results[h].attrs.l=m.length;this.isDefined(f.old_value)||this.saveOldValue(f,k);this.errorFixed()};this.ignoreError=function(g,f){$(g).removeAttr("class").css("color","").off();this.hideErrorWindow()};this.showErrorWindow=function(F,E){this.show_menu_observer&&this.show_menu_observer(this);var D=this,C=$(F).offset(),B=document.createElement("table"),z=document.createElement("tbody");$(this.error_window).html("");$(B).addClass("googie_list").attr("googie_action_btn","1");for(var x=!1,A=0;A<this.custom_menu_builder.length;A++){var y=this.custom_menu_builder[A];if(y[0](this.results[E])){x=y[1](this,z,F);break}}if(!x){x=this.results[E].suggestions;var v=this.results[E].attrs.o;A=this.results[E].attrs.l;if(this.has_dictionary&&!$(F).attr("is_corrected")){y=document.createElement("tr");var w=document.createElement("td");var u=document.createElement("span");$(u).text(this.lang_learn_word);$(w).attr("googie_action_btn","1").css("cursor","default").mouseover(D.item_onmouseover).mouseout(D.item_onmouseout).click(function(f){D.learnWord(F,E);D.ignoreError(F,E)});w.appendChild(u);y.appendChild(w);z.appendChild(y)}var o=0;for(A=x.length;o<A;o++){y=document.createElement("tr"),w=document.createElement("td"),u=document.createElement("span"),$(u).html(x[o]),$(w).mouseover(this.item_onmouseover).mouseout(this.item_onmouseout).click(function(f){D.correctError(E,F,f.target.firstChild)}),w.appendChild(u),y.appendChild(w),z.appendChild(y)}if(F.is_changed&&F.innerHTML!=F.old_value){var j=F.old_value;x=document.createElement("tr");A=document.createElement("td");y=document.createElement("span");$(y).addClass("googie_list_revert").html(this.lang_revert+" "+j);$(A).mouseover(this.item_onmouseover).mouseout(this.item_onmouseout).click(function(f){D.updateOrginalText(v,F.innerHTML,j,E);$(F).removeAttr("is_corrected").css("color","#b91414").html(j);D.hideErrorWindow()});A.appendChild(y);x.appendChild(A);z.appendChild(x)}x=document.createElement("tr");A=document.createElement("td");var s=document.createElement("input");y=document.createElement("img");w=document.createElement("form");u=function(){""!=s.value&&(D.isDefined(F.old_value)||D.saveOldValue(F,F.innerHTML),D.updateOrginalText(v,F.innerHTML,s.value,E),$(F).attr("is_corrected",!0).css("color","green").text(s.value),D.hideErrorWindow());return !1};$(s).width(120).css({margin:0,padding:0}).val($(F).text()).attr("googie_action_btn","1");$(A).css("cursor","default").attr("googie_action_btn","1");$(y).attr("src",this.img_dir+"ok.gif").width(32).height(16).css({cursor:"pointer","margin-left":"2px","margin-right":"2px"}).click(u);$(w).attr("googie_action_btn","1").css({margin:0,padding:0,cursor:"default","white-space":"nowrap"}).submit(u);w.appendChild(s);w.appendChild(y);A.appendChild(w);x.appendChild(A);z.appendChild(x);0<this.extra_menu_items.length&&z.appendChild(this.createListSeparator());var G=function(g){if(g<D.extra_menu_items.length){var l=D.extra_menu_items[g];if(!l[2]||l[2](F,D)){var k=document.createElement("tr"),h=document.createElement("td");$(h).html(l[0]).mouseover(D.item_onmouseover).mouseout(D.item_onmouseout).click(function(){return l[1](F,D)});k.appendChild(h);z.appendChild(k)}G(g+1)}};G(0);G=null;this.use_close_btn&&z.appendChild(this.createCloseButton(this.hideErrorWindow))}B.appendChild(z);this.error_window.appendChild(B);A=$(this.error_window).height();B=$(this.error_window).width();y=$(document).height();x=$(document).width();A=C.top+A+20<y?C.top+20:C.top-A;C=C.left+B<x?C.left:C.left-B;$(this.error_window).css({top:A+"px",left:C+"px"}).show();document.all&&!window.opera&&(this.error_window_iframe||(C=$("<iframe>").css({position:"absolute","z-index":-1}),$("body").append(C),this.error_window_iframe=C),$(this.error_window_iframe).css({top:this.error_window.offsetTop,left:this.error_window.offsetLeft,width:this.error_window.offsetWidth,height:this.error_window.offsetHeight}).show())};this.createEditLayer=function(g,f){this.edit_layer=document.createElement("div");$(this.edit_layer).addClass("googie_edit_layer").attr("id","googie_edit_layer").width(g).height(f);"input"!=this.text_area.nodeName.toLowerCase()||""==$(this.text_area).val()?$(this.edit_layer).css("overflow","auto"):$(this.edit_layer).css("overflow","hidden");var h=this;this.edit_layer_dbl_click&&$(this.edit_layer).dblclick(function(k){if("googie_link"!=k.target.className&&!h.isErrorWindowShown()){h.resumeEditing();var j=function(){$(h.text_area).focus();j=null};window.setTimeout(j,10)}return !1})};this.resumeEditing=function(){this.setStateChanged("ready");this.edit_layer&&(this.el_scroll_top=this.edit_layer.scrollTop);this.hideErrorWindow();this.main_controller&&$(this.spell_span).removeClass().addClass("googie_no_style");this.ignore||(this.use_focus&&($(this.focus_link_t).remove(),$(this.focus_link_b).remove()),$(this.edit_layer).remove(),$(this.text_area).show(),void 0!=this.el_scroll_top&&(this.text_area.scrollTop=this.el_scroll_top));this.checkSpellingState(!1)};this.createErrorLink=function(g,f){var k=document.createElement("span"),j=this,h=function(l){j.showErrorWindow(k,f);h=null;return !1};$(k).html(g).addClass("googie_link").click(h).removeAttr("is_corrected").attr({googie_action_btn:"1",g_id:f});return k};this.createPart=function(g){if(" "==g){return document.createTextNode(" ")}g=this.escapeSpecial(g);g=g.replace(/\n/g,"<br>");g=g.replace(/    /g," &nbsp;");g=g.replace(/^ /g,"&nbsp;");g=g.replace(/ $/g,"&nbsp;");var f=document.createElement("span");$(f).html(g);return f};this.showErrorsInIframe=function(){var s=document.createElement("div"),r=0,q=this.results;if(0<q.length){for(var p=0,o=q.length;p<o;p++){var m=q[p].attrs.o,j=q[p].attrs.l,n=this.orginal_text.substring(r,m);n=this.createPart(n);s.appendChild(n);r+=m-r;m=this.createErrorLink(this.orginal_text.substr(m,j),p);this.error_links.push(m);s.appendChild(m);r+=j}r=this.orginal_text.substr(r,this.orginal_text.length);r=this.createPart(r);s.appendChild(r)}else{s.innerHTML=this.orginal_text}$(s).css("text-align","left");var l=this;this.custom_item_evaulator&&$.map(this.error_links,function(f){l.custom_item_evaulator(l,f)});$(this.edit_layer).append(s);$(this.text_area).hide();$(this.edit_layer).insertBefore(this.text_area);this.use_focus&&(this.focus_link_t=this.createFocusLink("focus_t"),this.focus_link_b=this.createFocusLink("focus_b"),$(this.focus_link_t).insertBefore(this.edit_layer),$(this.focus_link_b).insertAfter(this.edit_layer))};this.createLangWindow=function(){this.language_window=document.createElement("div");$(this.language_window).addClass("googie_window popupmenu").width(100).attr("googie_action_btn","1");var h=document.createElement("table"),f=document.createElement("tbody"),m=this;$(h).addClass("googie_list").width("100%");this.lang_elms=[];for(i=0;i<this.langlist_codes.length;i++){var l=document.createElement("tr");var k=document.createElement("td");var j=document.createElement("span");$(j).text(this.lang_to_word[this.langlist_codes[i]]);this.lang_elms.push(k);$(k).attr("googieId",this.langlist_codes[i]).click(function(g){m.deHighlightCurSel();m.setCurrentLanguage($(this).attr("googieId"));null!=m.lang_state_observer&&m.lang_state_observer();m.highlightCurSel();m.hideLangWindow()}).mouseover(function(g){"googie_list_selected"!=this.className&&(this.className="googie_list_onhover")}).mouseout(function(g){"googie_list_selected"!=this.className&&(this.className="googie_list_onout")});k.appendChild(j);l.appendChild(k);f.appendChild(l)}this.use_close_btn&&f.appendChild(this.createCloseButton(function(){m.hideLangWindow.apply(m)}));this.highlightCurSel();h.appendChild(f);this.language_window.appendChild(h)};this.isLangWindowShown=function(){return $(this.language_window).is(":visible")};this.hideLangWindow=function(){$(this.language_window).hide();$(this.switch_lan_pic).removeClass().addClass("googie_lang_3d_on")};this.showLangWindow=function(g){this.show_menu_observer&&this.show_menu_observer(this);this.createLangWindow();$("body").append(this.language_window);var f=$(g).offset(),k=$(g).height(),j=$(g).width();g=$(this.language_window).height();var h=$(document).height();j="right"==this.change_lang_pic_placement?f.left-100+j:f.left+j;f=f.top+g<h?f.top+k:f.top-g-4;$(this.language_window).css({top:f+"px",left:j+"px"}).show();this.highlightCurSel()};this.deHighlightCurSel=function(){$(this.lang_cur_elm).removeClass().addClass("googie_list_onout")};this.highlightCurSel=function(){null==GOOGIE_CUR_LANG&&(GOOGIE_CUR_LANG=GOOGIE_DEFAULT_LANG);for(var f=0;f<this.lang_elms.length;f++){$(this.lang_elms[f]).attr("googieId")==GOOGIE_CUR_LANG?(this.lang_elms[f].className="googie_list_selected",this.lang_cur_elm=this.lang_elms[f]):this.lang_elms[f].className="googie_list_onout"}};this.createChangeLangPic=function(){var g=$("<img>").attr({src:this.img_dir+"change_lang.gif",alt:"Change language",googie_action_btn:"1"}),f=document.createElement("span");a=this;$(f).addClass("googie_lang_3d_on").append(g).click(function(h){h="img"==this.tagName.toLowerCase()?this.parentNode:this;$(h).hasClass("googie_lang_3d_click")?(h.className="googie_lang_3d_on",a.hideLangWindow()):(h.className="googie_lang_3d_click",a.showLangWindow(h))});return f};this.createSpellDiv=function(){var f=document.createElement("span");$(f).addClass("googie_check_spelling_link").text(this.lang_chck_spell);this.show_spell_img&&$(f).append(" ").append($("<img>").attr("src",this.img_dir+"spellc.gif"));return f};this.flashNoSpellingErrorState=function(g){this.setStateChanged("no_error_found");var f=this;if(this.main_controller){var j=g?function(){g();f.checkSpellingState()}:function(){f.checkSpellingState()};var h=$("<span>").text(this.lang_no_error_found);$(this.switch_lan_pic).hide();$(this.spell_span).empty().append(h).removeClass().addClass("googie_check_spelling_ok");window.setTimeout(j,1000)}};this.resumeEditingState=function(){this.setStateChanged("resume_editing");if(this.main_controller){var g=$("<span>").text(this.lang_rsm_edt),f=this;$(this.switch_lan_pic).hide();$(this.spell_span).empty().off().append(g).click(function(){f.resumeEditing()}).removeClass().addClass("googie_resume_editing")}try{this.edit_layer.scrollTop=this.ta_scroll_top}catch(h){}};this.checkSpellingState=function(g){g&&this.setStateChanged("ready");this.switch_lan_pic=this.show_change_lang_pic?this.createChangeLangPic():document.createElement("span");g=this.createSpellDiv();var f=this;this.custom_spellcheck_starter?$(g).click(function(h){f.custom_spellcheck_starter()}):$(g).click(function(h){f.spellCheck()});this.main_controller&&("left"==this.change_lang_pic_placement?$(this.spell_container).empty().append(this.switch_lan_pic).append(" ").append(g):$(this.spell_container).empty().append(g).append(" ").append(this.switch_lan_pic));this.spell_span=g};this.isDefined=function(f){return void 0!==f&&null!==f};this.errorFixed=function(){this.cnt_errors_fixed++;this.all_errors_fixed_observer&&this.cnt_errors_fixed==this.cnt_errors&&(this.hideErrorWindow(),this.all_errors_fixed_observer())};this.errorFound=function(){this.cnt_errors++};this.createCloseButton=function(f){return this.createButton(this.lang_close,"googie_list_close",f)};this.createButton=function(h,f,m){var l=document.createElement("tr"),k=document.createElement("td");if(f){var j=document.createElement("span");$(j).addClass(f).html(h)}else{j=document.createTextNode(h)}$(k).click(m).mouseover(this.item_onmouseover).mouseout(this.item_onmouseout);k.appendChild(j);l.appendChild(k);return l};this.removeIndicator=function(f){window.rcmail&&rcmail.set_busy(!1,null,this.rc_msg_id)};this.appendIndicator=function(f){window.rcmail&&(this.rc_msg_id=rcmail.set_busy(!0,"checking"))};this.createFocusLink=function(g){var f=document.createElement("a");$(f).attr({href:"javascript:;",name:g});return f};this.item_onmouseover=function(f){"googie_list_revert"!=this.className&&"googie_list_close"!=this.className?this.className="googie_list_onhover":this.parentNode.className="googie_list_onhover"};this.item_onmouseout=function(f){"googie_list_revert"!=this.className&&"googie_list_close"!=this.className?this.className="googie_list_onout":this.parentNode.className="googie_list_onout"}};