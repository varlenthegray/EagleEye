function rcube_text_editor(c,e){var d=this,b=location.href.replace(/[?#].*$/,"").replace(/\/$/,""),a={selector:"#"+($("#"+e).is(".mce_editor")?e:"fake-editor-id"),cache_suffix:"s=4050800",theme:"modern",language:c.lang,content_css:rcmail.assets_path("program/resources/tinymce/content.css"),menubar:false,statusbar:false,toolbar_items_size:"small",extended_valid_elements:"font[face|size|color|style],span[id|class|align|style]",fontsize_formats:"8pt 9pt 10pt 11pt 12pt 14pt 18pt 24pt 36pt",relative_urls:false,remove_script_host:false,convert_urls:false,image_description:false,paste_webkit_style:"color font-size font-family",paste_data_images:true,browser_spellcheck:true};this.spellcheck_observer=function(){};if(c.spellchecker){this.spellchecker=c.spellchecker;if(c.spellcheck_observer){this.spellchecker.spelling_state_observer=this.spellcheck_observer=c.spellcheck_observer}}if(!tinymce.registered_request_token){tinymce.registered_request_token=true;tinymce.util.XHR.on("beforeSend",function(f){f.xhr.setRequestHeader("X-Roundcube-Request",rcmail.env.request_token)})}if(c.mode=="identity"){$.extend(a,{plugins:"autolink charmap code colorpicker hr image link paste tabfocus textcolor",toolbar:"bold italic underline alignleft aligncenter alignright alignjustify | outdent indent charmap hr link unlink image code forecolor | fontselect fontsizeselect",file_browser_callback:function(g,f,h,i){d.file_browser_callback(g,f,h)},file_browser_callback_types:"image"})}else{$.extend(a,{plugins:"autolink charmap code colorpicker directionality link lists image media nonbreaking paste table tabfocus textcolor searchreplace spellchecker",toolbar:"bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent ltr rtl blockquote | forecolor backcolor | fontselect fontsizeselect | link unlink table | $extra charmap image media | code searchreplace undo redo",spellchecker_rpc_url:b+"/?_task=utils&_action=spell_html&_remote=1",spellchecker_language:rcmail.env.spell_lang,accessibility_focus:false,file_browser_callback:function(g,f,h,i){d.file_browser_callback(g,f,h)},file_browser_callback_types:"image media"})}$.each(c.extra_plugins||[],function(){if(a.plugins.indexOf(this)<0){a.plugins=a.plugins+" "+this}});$.each(c.extra_buttons||[],function(){if(a.toolbar.indexOf(this)<0){a.toolbar=a.toolbar.replace("$extra","$extra "+this)}});$.each(c.disabled_plugins||[],function(){a.plugins=a.plugins.replace(this,"")});$.each(c.disabled_buttons||[],function(){a.toolbar=a.toolbar.replace(this,"")});a.toolbar=a.toolbar.replace("$extra","").replace(/\|\s+\|/g,"|");if(window.rcmail_editor_settings){$.extend(a,window.rcmail_editor_settings)}a.setup=function(f){f.on("init",function(g){d.init_callback(g)});f.on("SpellcheckStart SpellcheckEnd",function(g){d.spellcheck_active=g.type=="spellcheckstart";d.spellcheck_observer()});f.on("keypress",function(){rcmail.compose_type_activity++})};this.id=e;this.editor=null;tinymce.init(a);this.init_callback=function(k){this.editor=k.target;if(rcmail.env.action!="compose"){return}var j=$("#"+this.id),f=$("div.mce-toolbar-grp:first",j.parent()).height();if(f>200||f>j.height()){return setTimeout(function(){d.init_callback(k)},300)}var h={},i=rcube_find_object("_from"),g=rcmail.env.compose_focus_elem;if(rcmail.env.default_font){h["font-family"]=rcmail.env.default_font}if(rcmail.env.default_font_size){h["font-size"]=rcmail.env.default_font_size}if(h["font-family"]||h["font-size"]){$(this.editor.getBody()).css(h)}if(i&&i.type=="select-one"){if(!rcmail.env.identities_initialized){rcmail.change_identity(i)}if(g&&g.id!=this.id&&g.nodeName!="BODY"){window.focus();g.focus();rcmail.env.compose_focus_elem=null}}d.tabindex(g&&g.id==d.id);$(window).resize()};this.tabindex=function(j){if(rcmail.env.task=="mail"&&this.editor){var i=this.editor.getElement(),h=this.editor.getBody(),l=this.editor.getContentAreaContainer().childNodes[0];if(i&&l){l.tabIndex=i.tabIndex}if(i.tabIndex>0){var g=null,f=[":prev",":next"],k=tinymce.DOM.select("*[tabindex="+i.tabIndex+"]:not(iframe)");tinymce.each(k,function(n,m){if(n.id==d.id){g=m;return false}});if(g!==null){if(k[g-1]&&k[g-1].id){f[0]=k[g-1].id}if(k[g+1]&&k[g+1].id){f[1]=k[g+1].id}this.editor.settings.tabfocus_elements=f.join(",")}}if(bw.mz&&bw.vendver<25){$(h).prop("contenteditable",false).prop("contenteditable",true)}if(j){h.focus()}}};this.toggle=function(m,i){var o,l,p,f="\u0002\u0003",n=$("#"+this.id),h=rcmail.env.identity?rcmail.env.signatures[rcmail.env.identity]:null,k=h&&h.text&&h.text.length>1;this.spellcheck_stop();if(m){l=n.val();if(k){l=l.replace(/\r\n/,"\n");l=l.replace(h.text.replace(/\r\n/,"\n"),f)}var j=function(r){if(k){r=r.replace(f,'<div id="_rc_sig">'+h.html+"</div>")}n.val(r);tinymce.execCommand("mceAddEditor",false,d.id);if(d.editor){var q=$(d.editor.getBody());d.tabindex(true);d.editor.selection.setCursorLocation(q.children().first().get(0))}};if(!i){p=rcmail.plain2html(l,j)}else{j(l);p=true}}else{if(this.editor){if(k){if(o=this.editor.dom.get("_rc_sig")){o=o.innerHTML}this.editor.dom.setHTML("_rc_sig",f)}l=this.editor.getContent();var g=function(q){tinymce.execCommand("mceRemoveEditor",false,d.id);d.editor=null;if(k){q=q.replace(f,"\n"+h.text)}n.val(q).focus();rcmail.set_caret_pos(n.get(0),0)};if(!i){p=rcmail.html2plain(l,g)}else{g(n.val());p=true}if(!p&&o){this.editor.dom.setHTML("_rc_sig",o)}}}return p};this.spellcheck_start=function(){if(this.editor){tinymce.execCommand("mceSpellCheck",true);this.spellcheck_observer()}else{if(this.spellchecker&&this.spellchecker.spellCheck){this.spellchecker.spellCheck()}}};this.spellcheck_stop=function(){var f=this.editor;if(f){if(f.plugins&&f.plugins.spellchecker&&this.spellcheck_active){f.execCommand("mceSpellCheck",false);this.spellcheck_observer()}}else{if(f=this.spellchecker){if(f.state&&f.state!="ready"&&f.state!="no_error_found"){$(f.spell_span).trigger("click")}}}};this.spellcheck_state=function(){var f;if(this.editor){return this.spellcheck_active}else{if((f=this.spellchecker)&&f.state){return f.state!="ready"&&f.state!="no_error_found"}}};this.spellcheck_resume=function(g){var f=this.editor;if(f){f.plugins.spellchecker.markErrors(g)}else{if(f=this.spellchecker){f.prepare(false,true);f.processData(g)}}};this.get_language=function(){if(this.editor){return this.editor.settings.spellchecker_language||rcmail.env.spell_lang}else{if(this.spellchecker){return GOOGIE_CUR_LANG}}};this.set_language=function(g){var f=this.editor;if(f){f.settings.spellchecker_language=g}if(f=this.spellchecker){f.setCurrentLanguage(g)}};this.replace=function(h){var l,g=this.editor;if(!h){return false}if(g){g.getWin().focus();if($.type(h)=="object"&&("html" in h)){h=h.html;l="html"}else{if($.type(h)=="object"){h=h.text||""}h=rcmail.quote_html(h).replace(/\r?\n/g,"<br/>");l="text"}g.selection.setContent(h,{format:l})}else{if(g=rcube_find_object(this.id)){var i=$(g).is(":focus")?rcmail.get_input_selection(g):{start:0,end:0},j=g.value,k=j.substring(0,i.start),f=j.substring(i.end,j.length);if($.type(h)=="object"){h=h.text||""}g.value=k+h+f;rcmail.set_caret_pos(g,i.start+h.length);g.focus()}}};this.get_content=function(g){var k,f=this.editor,j="",h=false,i={refresh:true,selection:false,nosig:false,format:"html"};g=$.extend(i,g);if(g.refresh){this.spellcheck_stop()}if(f){if(g.selection){j=f.selection.getContent({format:g.format})}if(!j){j=f.getContent({format:g.format});h=g.format=="text"}}else{if(f=rcube_find_object(this.id)){if(g.selection&&$(f).is(":focus")){j=rcmail.get_input_selection(f).text}if(!j){j=f.value;h=true}}}if(h&&g.nosig){k=j.indexOf("-- \n");if(k>0){j=j.substring(0,k)}}return j};this.change_signature=function(g,m){var j,k,h=-1,n=$("#"+this.id),q=n.val(),o=rcmail.env.identity;if(!this.editor){if(m&&o&&rcmail.env.signatures&&rcmail.env.signatures[o]){o=rcmail.env.signatures[o].text;o=o.replace(/\r\n/g,"\n");h=rcmail.env.top_posting?q.indexOf(o):q.lastIndexOf(o);if(h>=0){q=q.substring(0,h)+q.substring(h+o.length,q.length)}}if(m&&rcmail.env.signatures&&rcmail.env.signatures[g]){o=rcmail.env.signatures[g].text;o=o.replace(/\r\n/g,"\n");if(h>=0){q=q.substring(0,h)+o+q.substring(h,q.length);k=h-1}else{if(!q||!rcmail.env.compose_mode){k=q.length;q+="\n\n"+o}else{if(rcmail.env.top_posting&&!rcmail.env.sig_below){if(pos=rcmail.get_caret_pos(n.get(0))){q=q.substring(0,pos)+"\n"+o+"\n\n"+q.substring(pos,q.length);k=pos}else{q="\n\n"+o+"\n\n"+q.replace(/^[\r\n]+/,"");k=0}}else{q=q.replace(/[\r\n]+$/,"");k=!rcmail.env.top_posting&&q.length?q.length+1:0;q+="\n\n"+o}}}}else{k=rcmail.env.top_posting?0:q.length}n.val(q);rcmail.set_caret_pos(n.get(0),k)}else{if(m&&rcmail.env.signatures){var f=this.editor.dom.get("_rc_sig");if(!f){var l=this.editor.getBody();f=$('<div id="_rc_sig"></div>').get(0);if(rcmail.env.top_posting&&!rcmail.env.sig_below&&rcmail.env.compose_mode&&(l.childNodes.length>1||$(l).text())){this.editor.getWin().focus();var i=this.editor.selection.getNode();$(f).insertBefore(i.nodeName=="BODY"?l.firstChild:i.nextSibling);$("<p>").append($("<br>")).insertBefore(f)}else{l.appendChild(f);j=rcmail.env.top_posting&&rcmail.env.compose_mode?l.firstChild:$(f).prev()}}f.innerHTML=rcmail.env.signatures[g]?rcmail.env.signatures[g].html:""}else{if(!rcmail.env.top_posting){j=$(this.editor.getBody()).children().last()}}}if(this.editor&&j&&j.length){this.editor.selection.setCursorLocation(j.get(0));this.editor.getWin().scroll(0,j.offset().top)}};this.save=function(){if(this.editor){this.editor.save()}};this.focus=function(){(this.editor||rcube_find_object(this.id)).focus()};this.file_browser_callback=function(h,f,m){var j,g,o,l,n,k=[];l=this.editor.windowManager.open({title:rcmail.get_label("select"+m),width:500,height:300,html:'<div id="image-selector-list"><ul></ul></div><div id="image-selector-form"><div id="image-upload-button" class="mce-widget mce-btn" role="button" tabindex="0"></div></div>',buttons:[{text:"Cancel",onclick:function(){d.file_browser_close()}}]});rcmail.env.file_browser_field=h;rcmail.env.file_browser_type=m;for(j in rcmail.env.attachments){if(g=d.file_browser_entry(j,rcmail.env.attachments[j])){k.push(g)}}if(k.length){$("#image-selector-list > ul").append(k).find("li:first").focus()}$("div.mce-abs-end",l.getEl()).append($('<div class="hint">').text($("div.hint",rcmail.gui_objects.uploadform).text()));g=$("#image-upload-button").append($("<span>").text(rcmail.get_label("add"+m)));o=g.parents(".mce-panel").find("button:last").parent();g.keydown(function(i){if(i.which==9){if(rcube_event.get_modifier(i)==SHIFT_KEY){$("#image-selector-list li:last").focus()}else{o.focus()}return false}});o.keydown(function(i){if(i.which==9){if(rcube_event.get_modifier(i)==SHIFT_KEY){g.focus()}else{$("#image-selector-list li:first").focus()}return false}});this.hack_file_input(g,rcmail.gui_objects.uploadform);if((window.XMLHttpRequest&&XMLHttpRequest.prototype&&XMLHttpRequest.prototype.sendAsBinary)||window.FormData){if(!rcmail.env.filedrop){rcmail.env.filedrop={}}if(rcmail.gui_objects.filedrop){rcmail.env.old_file_drop=rcmail.gui_objects.filedrop}rcmail.gui_objects.filedrop=$("#image-selector-form");rcmail.gui_objects.filedrop.addClass("droptarget").on("dragover dragleave",function(i){i.preventDefault();i.stopPropagation();$(this)[(i.type=="dragover"?"addClass":"removeClass")]("hover")}).get(0).addEventListener("drop",function(i){return rcmail.file_dropped(i)},false)}if(!rcmail.env.file_dialog_event){rcmail.env.file_dialog_event=true;rcmail.addEventListener("fileuploaded",function(i){var p;if(p=d.file_browser_entry(i.name,i.attachment)){$("#image-selector-list > ul").prepend(p);p.focus()}})}};this.file_browser_close=function(g){var f=$("#"+rcmail.env.file_browser_field);if(g){f.val(g)}this.editor.windowManager.close();f.focus();if(rcmail.env.old_file_drop){rcmail.gui_objects.filedrop=rcmail.env.old_file_drop}};this.file_browser_entry=function(j,i){if(!i.complete||!i.mimetype){return}if(rcmail.file_upload_id){rcmail.set_busy(false,null,rcmail.file_upload_id)}var m,h;switch(rcmail.env.file_browser_type){case"image":m=/^image\//i;break;case"media":m=/^video\//i;h="program/resources/tinymce/video.png";break;default:return}if(m.test(i.mimetype)){var l=rcmail.env.comm_path+"&_from="+rcmail.env.action,k=rcmail.env.compose_id?"&_id="+rcmail.env.compose_id+"&_action=display-attachment":"&_action=upload-display",g=l+k+"&_file="+j,f=$("<img>").attr({title:i.name,src:h?h:g+"&_thumbnail=1"});return $("<li>").attr({tabindex:0}).data("url",g).append($('<span class="img">').append(f)).append($('<span class="name">').text(i.name)).click(function(){d.file_browser_close($(this).data("url"))}).keydown(function(n){if(n.which==13){d.file_browser_close($(this).data("url"))}else{if(n.which==9){if(rcube_event.get_modifier(n)==SHIFT_KEY){if(!$(this).prev().focus().length){$("#image-upload-button").parents(".mce-panel").find("button:last").parent().focus()}}else{if(!$(this).next().focus().length){$("#image-upload-button").focus()}}return false}}})}};this.hack_file_input=function(k,h){var l,j=$(k),g=$("<input>").attr("name","_file[]"),i=$("<form>").attr({method:"post",enctype:"multipart/form-data"});if(h){g.attr("name",$('input[type="file"]',h).attr("name"));i.attr("action",$(h).attr("action")).append($("<input>").attr({type:"hidden",name:"_token",value:rcmail.env.request_token}))}function f(m){if(!l){l=j.offset()}g.css({top:(m.pageY-l.top-10)+"px",left:(m.pageX-l.left-10)+"px"})}g.attr({type:"file",multiple:"multiple",size:5,title:"",tabindex:-1}).change(function(){rcmail.upload_file(i,"upload")}).click(function(){setTimeout(function(){j.mouseleave()},20)}).css({opacity:0,cursor:"pointer",position:"relative",outline:"none"}).appendTo(i);if(navigator.userAgent.match(/Firefox|MSIE/)){g.css({marginLeft:"-80px"})}j.css({overflow:"hidden",cursor:"pointer"}).mouseenter(function(){this.__active=true}).mousemove(function(m){if(this.__active){f(m)}else{$(this).mouseleave()}}).mouseleave(function(){g.css({top:"-10000px",left:"-10000px"});this.__active=false}).click(function(m){if(!this.__active){this.__active=true;f(m);g.trigger(m)}}).keydown(function(m){if(m.which==13){g.trigger("click")}}).mouseleave().append(i)}};