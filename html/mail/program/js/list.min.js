function rcube_list_widget(a,b){this.ENTER_KEY=13;this.DELETE_KEY=46;this.BACKSPACE_KEY=8;this.list=a?a:null;this.tagname=this.list?this.list.nodeName.toLowerCase():"table";this.id_regexp=/^rcmrow([a-z0-9\-_=\+\/]+)/i;this.rows={};this.selection=[];this.rowcount=0;this.colcount=0;this.subject_col=0;this.modkey=0;this.multiselect=false;this.multiexpand=false;this.multi_selecting=false;this.draggable=false;this.column_movable=false;this.keyboard=false;this.toggleselect=false;this.aria_listbox=false;this.parent_focus=true;this.drag_active=false;this.col_drag_active=false;this.column_fixed=null;this.last_selected=null;this.shift_start=null;this.focused=false;this.drag_mouse_start=null;this.dblclick_time=500;this.row_init=function(){};this.pointer_touch_start=0;this.pointer_touch_time=500;if(b&&typeof b==="object"){for(var c in b){this[c]=b[c]}}rcube_list_widget._instances.push(this)}rcube_list_widget.prototype={init:function(){if(this.tagname=="table"&&this.list&&this.list.tBodies[0]){this.thead=this.list.tHead;this.tbody=this.list.tBodies[0]}else{if(this.tagname!="table"&&this.list){this.tbody=this.list}}if($(this.list).attr("role")=="listbox"){this.aria_listbox=true;if(this.multiselect){$(this.list).attr("aria-multiselectable","true")}}var c=this;if(this.tbody){this.rows={};this.rowcount=0;var b,a,d=this.tbody.childNodes;for(b=0,a=d.length;b<a;b++){if(d[b].nodeType==1){this.rowcount+=this.init_row(d[b])?1:0}}this.init_header();this.frame=this.list.parentNode;if(this.keyboard){rcube_event.add_listener({event:"keydown",object:this,method:"key_press"});$(this.list).attr("tabindex","0").on("focus",function(f){c.focus(f)})}}if(this.parent_focus){this.list.parentNode.onclick=function(f){c.focus()}}return this},init_row:function(d){d.uid=this.get_row_uid(d);if(d&&d.uid){var a=this,b=d.uid;this.rows[b]={uid:b,id:d.id,obj:d};$(d).data("uid",b).mousedown(function(f){return a.drag_row(f,this.uid)}).mouseup(function(f){if(f.which==1&&!a.drag_active){return a.click_row(f,this.uid)}else{return true}});if((bw.ie||bw.edge)&&bw.pointer){$(d).on("pointerdown",function(f){if(f.pointerType=="touch"){a.pointer_touch_start=new Date().getTime();return false}}).on("pointerup",function(g){if(g.pointerType=="touch"){var f=(new Date().getTime()-a.pointer_touch_start);if(f<=a.pointer_touch_time){a.drag_row(g,this.uid);return a.click_row(g,this.uid)}}})}else{if(bw.touch&&d.addEventListener){d.addEventListener("touchstart",function(f){if(f.touches.length==1){a.touchmoved=false;a.drag_row(rcube_event.touchevent(f.touches[0]),this.uid)}},false);d.addEventListener("touchend",function(f){if(f.changedTouches.length==1){if(!a.touchmoved&&!a.click_row(rcube_event.touchevent(f.changedTouches[0]),this.uid)){f.preventDefault()}}},false);d.addEventListener("touchmove",function(f){if(f.changedTouches.length==1){a.touchmoved=true;if(a.drag_active){f.preventDefault()}}},false)}}if(this.aria_listbox){var c="l:"+d.id;$(d).attr("role","option").attr("aria-labelledby",c).find(this.col_tagname()).eq(this.subject_col).attr("id",c)}if(document.all){d.onselectstart=function(){return false}}this.row_init(this.rows[b]);this.triggerEvent("initrow",this.rows[b]);return true}},init_header:function(){if(this.thead){this.colcount=0;if(this.fixed_header){$(this.list.tHead).replaceWith($(this.fixed_header).find("thead").clone());$(this.list.tHead).find("th,td").attr("style","").find("a").attr("tabindex","-1")}else{if(!bw.touch&&this.list.className.indexOf("fixedheader")>=0){this.init_fixed_header()}}var a,b,c=this;if(this.column_movable&&this.thead&&this.thead.rows){for(b=0;b<this.thead.rows[0].cells.length;b++){if(this.column_fixed==b){continue}a=this.thead.rows[0].cells[b];a.onmousedown=function(d){return c.drag_column(d,this)};this.colcount++}}}},init_fixed_header:function(){var b=$(this.list.tHead).clone();if(!this.fixed_header){this.fixed_header=$("<table>").attr("class",this.list.className+" fixedcopy").attr("role","presentation").css({position:"fixed"}).append(b).append("<tbody></tbody>");$(this.list).before(this.fixed_header);var a=this;$(window).resize(function(){a.resize()});$(window).scroll(function(){var c=$(window);a.fixed_header.css({marginLeft:-c.scrollLeft()+"px",marginTop:-c.scrollTop()+"px"})})}else{$(this.fixed_header).find("thead").replaceWith(b)}$(this.list.tHead).find("a.sortcol").attr("tabindex","-1");b.find("a.sortcol").attr("tabindex","0");this.thead=b.get(0);this.resize()},resize:function(){if(!this.fixed_header){return}var a=[];$(this.tbody).parent().find("thead th,thead td").each(function(b){a[b]=$(this).width()});$(this.thead).parent().width($(this.tbody).parent().width());$(this.thead).find("th,td").each(function(b){$(this).width(a[b])});$(window).scroll()},clear:function(b){if(this.tagname=="table"){var a=document.createElement("tbody");this.list.insertBefore(a,this.tbody);this.list.removeChild(this.list.tBodies[1]);this.tbody=a}else{$(this.row_tagname()+":not(.thead)",this.tbody).remove()}this.rows={};this.rowcount=0;this.last_selected=null;if(b){this.clear_selection()}if(this.frame){this.frame.scrollTop=0}this.resize()},remove_row:function(b,d){var a=this,c=this.rows[b]?this.rows[b].obj:null;if(!c){return}c.style.display="none";if(d){this.select_next()}delete this.rows[b];this.rowcount--;clearTimeout(this.resize_timeout);this.resize_timeout=setTimeout(function(){a.resize()},50)},insert_row:function(k,h){var j=this,c=this.tbody;if(k.nodeName===undefined){var b,f,g,a,d=document.createElement(this.row_tagname());if(k.id){d.id=k.id}if(k.uid){d.uid=k.uid}if(k.className){d.className=k.className}if(k.style){$.extend(d.style,k.style)}for(b=0;k.cols&&b<k.cols.length;b++){a=k.cols[b];g=a.dom;if(!g){g=document.createElement(this.col_tagname());if(a.className){g.className=a.className}if(a.innerHTML){g.innerHTML=a.innerHTML}for(f in a.events){g["on"+f]=a.events[f]}}d.appendChild(g)}k=d}if(h&&c.childNodes.length){c.insertBefore(k,(typeof h=="object"&&h.parentNode==c)?h:c.firstChild)}else{c.appendChild(k)}this.init_row(k);this.rowcount++;clearTimeout(this.resize_timeout);this.resize_timeout=setTimeout(function(){j.resize()},50)},update_row:function(g,e,b,a){var f=this.rows[g];if(!f){return false}var c,d=f.obj;for(c=0;e&&c<e.length;c++){this.get_cell(d,c).html(e[c])}if(b){delete this.rows[g];d.uid=b;d.id="rcmrow"+b;this.init_row(d);if(a){this.selection[0]=b}if(this.last_selected==g){this.last_selected=b}}},focus:function(b){if(this.focused){return}this.focused=true;if(b){rcube_event.cancel(b)}var a=null;if(this.last_selected&&this.rows[this.last_selected]){a=$(this.rows[this.last_selected].obj).find(this.col_tagname()).eq(this.subject_col).attr("tabindex","0")}if(a&&a.length){this.focus_noscroll(a)}else{$("iframe,:focus:not(body)").blur();window.focus()}$(this.list).addClass("focus").removeAttr("tabindex");if(!this.last_selected){this.select_first(CONTROL_KEY)}},blur:function(b){this.focused=false;var a=this;setTimeout(function(){$(a.list).attr("tabindex","0")},20);if(this.last_selected&&this.rows[this.last_selected]){$(this.rows[this.last_selected].obj).find(this.col_tagname()).eq(this.subject_col).removeAttr("tabindex")}$(this.list).removeClass("focus")},focus_noscroll:function(a){var b=this.frame.scrollTop||this.frame.scrollY;a.focus();this.frame.scrollTop=b},hide_column:function(a,b){var c=b?"addClass":"removeClass";if(this.fixed_header){$(this.row_tagname()+" "+this.col_tagname()+"."+a,this.fixed_header)[c]("hidden")}$(this.row_tagname()+" "+this.col_tagname()+"."+a,this.list)[c]("hidden")},drag_column:function(c,a){if(this.colcount>1){this.drag_start=true;this.drag_mouse_start=rcube_event.get_mouse_pos(c);rcube_event.add_listener({event:"mousemove",object:this,method:"column_drag_mouse_move"});rcube_event.add_listener({event:"mouseup",object:this,method:"column_drag_mouse_up"});this.add_dragfix();for(var b=0;b<this.thead.rows[0].cells.length;b++){if(a==this.thead.rows[0].cells[b]){this.selected_column=b;break}}}return false},drag_row:function(b,c){if(!this.is_event_target(b)){return true}if(rcube_event.get_button(b)==2){return true}this.in_selection_before=b&&b.istouch||this.in_selection(c)?c:false;if(!this.in_selection_before){var a=rcube_event.get_modifier(b);this.select_row(c,a,true)}if(this.draggable&&this.selection.length&&this.in_selection(c)){this.drag_start=true;this.drag_mouse_start=rcube_event.get_mouse_pos(b);rcube_event.add_listener({event:"mousemove",object:this,method:"drag_mouse_move"});rcube_event.add_listener({event:"mouseup",object:this,method:"drag_mouse_up"});if(bw.touch){rcube_event.add_listener({event:"touchmove",object:this,method:"drag_mouse_move"});rcube_event.add_listener({event:"touchend",object:this,method:"drag_mouse_up"})}this.add_dragfix()}return false},click_row:function(c,d){if(!d||!this.rows[d]){return false}if(!this.is_event_target(c)){return true}var b=new Date().getTime(),a=b-this.rows[d].clicked<this.dblclick_time;if(!this.drag_active&&!a&&this.in_selection_before==d){this.select_row(d,rcube_event.get_modifier(c),true)}this.drag_start=false;this.in_selection_before=false;if(this.rowcount&&a&&this.in_selection(d)){this.triggerEvent("dblclick");b=0}else{this.triggerEvent("click")}if(!this.drag_active){this.del_dragfix();rcube_event.cancel(c)}this.rows[d].clicked=b;this.focus();return false},is_event_target:function(c){var b=rcube_event.get_target(c),a=b.tagName.toLowerCase();return !(b&&(a=="input"||a=="img"||(a!="a"&&b.onclick)))},find_root:function(a){var b=this.rows[a];if(b&&b.parent_uid){return this.find_root(b.parent_uid)}else{return a}},expand_row:function(c,f){var d=this.rows[f],b=rcube_event.get_target(c),a=rcube_event.get_modifier(c);d.clicked=0;if(d.expanded){b.className="collapsed";if(a==CONTROL_KEY||this.multiexpand){this.collapse_all(d)}else{this.collapse(d)}}else{b.className="expanded";if(a==CONTROL_KEY||this.multiexpand){this.expand_all(d)}else{this.expand(d)}}},collapse:function(d){var b,c=d.depth,a=d?d.obj.nextSibling:null;d.expanded=false;this.triggerEvent("expandcollapse",{uid:d.uid,expanded:d.expanded,obj:d.obj});while(a){if(a.nodeType==1){b=this.rows[a.uid];if(b&&b.depth<=c){break}$(a).css("display","none");if(b.expanded){b.expanded=false;this.triggerEvent("expandcollapse",{uid:b.uid,expanded:b.expanded,obj:a})}}a=a.nextSibling}this.resize();this.triggerEvent("listupdate");return false},expand:function(g){var d,e,f,b,a;if(g){g.expanded=true;f=g.depth;b=g.obj.nextSibling;this.update_expando(g.id,true);this.triggerEvent("expandcollapse",{uid:g.uid,expanded:g.expanded,obj:g.obj})}else{var c=this.tbody;b=c.firstChild;f=0;a=0}while(b){if(b.nodeType==1){d=this.rows[b.uid];if(d){if(g&&(!d.depth||d.depth<=f)){break}if(d.parent_uid){e=this.rows[d.parent_uid];if(e&&e.expanded){if((g&&e==g)||a>=e.depth-1){a=e.depth;$(b).css("display","");d.expanded=true;this.triggerEvent("expandcollapse",{uid:d.uid,expanded:d.expanded,obj:b})}}else{if(g&&(!e||e.depth<=f)){break}}}}}b=b.nextSibling}this.resize();this.triggerEvent("listupdate");return false},collapse_all:function(d){var c,a,b;if(d){d.expanded=false;c=d.depth;a=d.obj.nextSibling;this.update_expando(d.id);this.triggerEvent("expandcollapse",{uid:d.uid,expanded:d.expanded,obj:d.obj});if(c&&this.multiexpand){return false}}else{a=this.tbody.firstChild;c=0}while(a){if(a.nodeType==1){if(b=this.rows[a.uid]){if(d&&(!b.depth||b.depth<=c)){break}if(d||b.depth){$(a).css("display","none")}if(b.has_children&&b.expanded){b.expanded=false;this.update_expando(b.id,false);this.triggerEvent("expandcollapse",{uid:b.uid,expanded:b.expanded,obj:a})}}}a=a.nextSibling}this.resize();this.triggerEvent("listupdate");return false},expand_all:function(d){var c,a,b;if(d){d.expanded=true;c=d.depth;a=d.obj.nextSibling;this.update_expando(d.id,true);this.triggerEvent("expandcollapse",{uid:d.uid,expanded:d.expanded,obj:d.obj})}else{a=this.tbody.firstChild;c=0}while(a){if(a.nodeType==1){if(b=this.rows[a.uid]){if(d&&b.depth<=c){break}$(a).css("display","");if(b.has_children&&!b.expanded){b.expanded=true;this.update_expando(b.id,true);this.triggerEvent("expandcollapse",{uid:b.uid,expanded:b.expanded,obj:a})}}}a=a.nextSibling}this.resize();this.triggerEvent("listupdate");return false},update_expando:function(c,a){var b=document.getElementById("rcmexpando"+c);if(b){b.className=a?"expanded":"collapsed"}},get_row_uid:function(b){if(!b){return}if(!b.uid){var a=$(b).data("uid");if(a){b.uid=a}else{if(String(b.id).match(this.id_regexp)){b.uid=RegExp.$1}}}return b.uid},get_next_row:function(){if(!this.rowcount){return false}var b=this.rows[this.last_selected],a=b?b.obj.nextSibling:null;while(a&&(a.nodeType!=1||a.style.display=="none")){a=a.nextSibling}return a},get_prev_row:function(){if(!this.rowcount){return false}var b=this.rows[this.last_selected],a=b?b.obj.previousSibling:null;while(a&&(a.nodeType!=1||a.style.display=="none")){a=a.previousSibling}return a},get_first_row:function(){if(this.rowcount){var b,a,c=this.tbody.childNodes;for(b=0;b<c.length;b++){if(c[b].id&&(a=this.get_row_uid(c[b]))){return a}}}return null},get_last_row:function(){if(this.rowcount){var b,a,c=this.tbody.childNodes;for(b=c.length-1;b>=0;b--){if(c[b].id&&(a=this.get_row_uid(c[b]))){return a}}}return null},row_tagname:function(){var a={table:"tr",ul:"li","*":"div"};return a[this.tagname]||a["*"]},col_tagname:function(){var a={table:"td","*":"span"};return a[this.tagname]||a["*"]},get_cell:function(b,a){return $(this.col_tagname(),b).eq(a)},select_row:function(e,a,d){var b=this.selection.join(","),c=this.in_selection(e);if(!this.multiselect&&d){a=0}if(!this.shift_start){this.shift_start=e}if(!a){this.shift_start=e;this.highlight_row(e,false);this.multi_selecting=false}else{switch(a){case SHIFT_KEY:this.shift_select(e,false);break;case CONTROL_KEY:if(d){this.shift_start=e;this.highlight_row(e,true)}break;case CONTROL_SHIFT_KEY:this.shift_select(e,true);break;default:this.highlight_row(e,false);break}this.multi_selecting=true}if(this.last_selected&&this.rows[this.last_selected]){$(this.rows[this.last_selected].obj).removeClass("focused").find(this.col_tagname()).eq(this.subject_col).removeAttr("tabindex")}if(this.toggleselect&&c&&!a){this.clear_selection()}else{if(this.selection.join(",")!=b){this.triggerEvent("select")}}if(this.rows[e]){$(this.rows[e].obj).addClass("focused");if(this.focused){this.focus_noscroll($(this.rows[e].obj).find(this.col_tagname()).eq(this.subject_col).attr("tabindex","0"))}}if(!this.selection.length){this.shift_start=null}this.last_selected=e},select:function(a){this.select_row(a,false);this.scrollto(a)},select_next:function(){var b=this.get_next_row(),c=this.get_prev_row(),a=(b)?b:c;if(a){this.select_row(a.uid,false,false)}},select_first:function(a){var b=this.get_first_row();if(b){this.select_row(b,a,false);this.scrollto(b)}},select_last:function(a){var b=this.get_last_row();if(b){this.select_row(b,a,false);this.scrollto(b)}},select_children:function(d){var c,b=this.row_children(d),a=b.length;for(c=0;c<a;c++){if(!this.in_selection(b[c])){this.select_row(b[c],CONTROL_KEY,true)}}},shift_select:function(h,f){if(!this.rows[this.shift_start]||!this.selection.length){this.shift_start=h}var g,d,c,a=this.rows[h],e=this._rowIndex(this.rows[this.shift_start].obj),b=this._rowIndex(a.obj);if(e<b&&!a.expanded&&a.has_children){if(a=this.rows[(this.row_children(h)).pop()]){b=this._rowIndex(a.obj)}}d=((e<b)?e:b),c=((e>b)?e:b);for(g in this.rows){if(this._rowIndex(this.rows[g].obj)>=d&&this._rowIndex(this.rows[g].obj)<=c){if(!this.in_selection(g)){this.highlight_row(g,true)}}else{if(this.in_selection(g)&&!f){this.highlight_row(g,true)}}}},_rowIndex:function(a){return(a.rowIndex!==undefined)?a.rowIndex:$(a).prevAll().length},in_selection:function(c,a){for(var b in this.selection){if(this.selection[b]==c){return a?parseInt(b):true}}return false},select_all:function(b){if(!this.rowcount){return false}var c,a=this.selection.join(",");this.selection=[];for(c in this.rows){if(!b||this.rows[c][b]==true){this.last_selected=c;this.highlight_row(c,true,true)}else{$(this.rows[c].obj).removeClass("selected").removeAttr("aria-selected")}}if(this.selection.join(",")!=a){this.triggerEvent("select")}this.focus();return true},invert_selection:function(){if(!this.rowcount){return false}var b,a=this.selection.join(",");for(b in this.rows){this.highlight_row(b,true)}if(this.selection.join(",")!=a){this.triggerEvent("select")}this.focus();return true},clear_selection:function(d,b){var c,a=this.selection.length;if(d){for(c in this.selection){if(this.selection[c]==d){this.selection.splice(c,1);break}}}else{for(c in this.selection){if(this.rows[this.selection[c]]){$(this.rows[this.selection[c]].obj).removeClass("selected").removeAttr("aria-selected")}}this.selection=[]}if(a&&!this.selection.length&&!b){this.triggerEvent("select");this.last_selected=null}},get_selection:function(b){var f=$.merge([],this.selection);if(b!==false&&f.length){for(var e,g,d=0,a=f.length;d<a;d++){e=f[d];if(this.rows[e]&&this.rows[e].has_children&&!this.rows[e].expanded){g=this.row_children(e);for(var c=0,h=g.length;c<h;c++){e=g[c];if(!this.in_selection(e)){f.push(e)}}}}}return f},get_single_selection:function(){if(this.selection.length==1){return this.selection[0]}else{return null}},highlight_row:function(f,a,e){if(!this.rows[f]){return}if(!a){if(this.selection.length>1||!this.in_selection(f)){this.clear_selection(null,true);this.selection[0]=f;$(this.rows[f].obj).addClass("selected").attr("aria-selected","true")}}else{var d,b,c=this.in_selection(f,true);if(c===false){this.selection.push(f);$(this.rows[f].obj).addClass("selected").attr("aria-selected","true");if(!e&&!this.rows[f].expanded){this.highlight_children(f,true)}}else{d=this.selection.slice(0,c);b=this.selection.slice(c+1,this.selection.length);this.selection=d.concat(b);$(this.rows[f].obj).removeClass("selected").removeAttr("aria-selected");if(!e&&!this.rows[f].expanded){this.highlight_children(f,false)}}}},highlight_children:function(f,b){var d,e,c=this.row_children(f),a=c.length;for(d=0;d<a;d++){e=this.in_selection(c[d]);if((b&&!e)||(!b&&e)){this.highlight_row(c[d],true,true)}}},key_press:function(f){var d=f.target||{};if(!this.focused||d.nodeName=="INPUT"||d.nodeName=="TEXTAREA"||d.nodeName=="SELECT"){return true}var c=rcube_event.get_keycode(f),a=rcube_event.get_modifier(f);switch(c){case 40:case 38:case 63233:case 63232:rcube_event.cancel(f);return this.use_arrow_key(c,a);case 32:rcube_event.cancel(f);return this.select_row(this.last_selected,a,true);case 37:case 39:rcube_event.cancel(f);var b=this.use_arrow_key(c,a);this.key_pressed=c;this.modkey=a;this.triggerEvent("keypress");this.modkey=0;return b;case 36:this.select_first(a);return rcube_event.cancel(f);case 35:this.select_last(a);return rcube_event.cancel(f);case 27:if(this.drag_active){return this.drag_mouse_up(f)}if(this.col_drag_active){this.selected_column=null;return this.column_drag_mouse_up(f)}return rcube_event.cancel(f);case 9:this.blur();break;case 13:if(!this.selection.length){this.select_row(this.last_selected,a,false)}default:this.key_pressed=c;this.modkey=a;this.triggerEvent("keypress");this.modkey=0;if(this.key_pressed==this.BACKSPACE_KEY){return rcube_event.cancel(f)}}return true},use_arrow_key:function(d,b){var a,c=this.rows[this.last_selected];if(d==40||d==63233){a=this.get_next_row()}else{if(d==38||d==63232){a=this.get_prev_row()}else{if(!c||!c.has_children){return}if(d==39){if(c.expanded){return}if(b==CONTROL_KEY||this.multiexpand){this.expand_all(c)}else{this.expand(c)}}else{if(!c.expanded){return}if(b==CONTROL_KEY||this.multiexpand){this.collapse_all(c)}else{this.collapse(c)}}this.update_expando(c.id,c.expanded);return false}}if(a){if(!b&&!this.selection.length){b=CONTROL_KEY}this.select_row(a.uid,b,false);this.scrollto(a.uid)}else{if(!a&&!c){this.select_first(CONTROL_KEY)}}return false},scrollto:function(e){var d=this.rows[e]?this.rows[e].obj:null;if(d&&this.frame){var b=Number(d.offsetTop),c=0;if(!b&&this.rows[e].parent_uid){var a=this.find_root(this.rows[e].uid);this.expand_all(this.rows[a]);b=Number(d.offsetTop)}if(this.fixed_header){c=Number(this.thead.offsetHeight)}if(b<Number(this.frame.scrollTop)+c){this.frame.scrollTop=b-c}else{if(b+Number(d.offsetHeight)>Number(this.frame.scrollTop)+Number(this.frame.offsetHeight)){this.frame.scrollTop=(b+Number(d.offsetHeight))-Number(this.frame.offsetHeight)}}}},drag_mouse_move:function(f){if(f.type=="touchmove"){if(f.touches.length==1&&f.changedTouches.length==1){f=rcube_event.touchevent(f.changedTouches[0])}else{return rcube_event.cancel(f)}}if(this.drag_start){var a=rcube_event.get_mouse_pos(f),b=10,d=[],c=this;if(!this.drag_mouse_start||(Math.abs(a.x-this.drag_mouse_start.x)<3&&Math.abs(a.y-this.drag_mouse_start.y)<3)){return false}this.drag_start_pos={left:a.x,top:a.y};if(!this.draglayer){this.draglayer=$("<div>").attr("id","rcmdraglayer").css({position:"absolute",display:"none","z-index":2000}).appendTo(document.body)}else{this.draglayer.html("")}$(this.row_tagname()+".selected",this.tbody).each(function(){var e=c.get_row_uid(this),h=c.rows[e];if(!h||$.inArray(e,d)>-1){return}d.push(e);if(h.has_children&&!h.expanded){$.each(c.row_children(e),function(){if($.inArray(this,d)>-1){return}d.push(this)})}if(d.length>b+1){return false}});$.each(d,function(h,e){if(h>b){c.draglayer.append("...");return false}$("> "+c.col_tagname(),c.rows[e].obj).each(function(k,i){if(c.subject_col<0||(c.subject_col>=0&&c.subject_col==k)){i=$(i).clone();$(i).find(".skip-on-drag").remove();var j=i.text();if(j){j=$.trim(j);j=(j.length>50?j.substring(0,50)+"...":j);c.draglayer.append($("<div>").text(j));return false}}})});this.draglayer.show();this.drag_active=true;this.triggerEvent("dragstart")}if(this.drag_active&&this.draglayer){var g=rcube_event.get_mouse_pos(f);this.draglayer.css({left:(g.x+20)+"px",top:(g.y-5+(bw.ie?document.documentElement.scrollTop:0))+"px"});this.triggerEvent("dragmove",f?f:window.event)}this.drag_start=false;return false},drag_mouse_up:function(a){document.onmousemove=null;if(a.type=="touchend"){if(a.changedTouches.length!=1){return rcube_event.cancel(a)}}if(this.draglayer&&this.draglayer.is(":visible")){if(this.drag_start_pos){this.draglayer.animate(this.drag_start_pos,300,"swing").hide(20)}else{this.draglayer.hide()}}if(this.drag_active){this.focus()}this.drag_active=false;rcube_event.remove_listener({event:"mousemove",object:this,method:"drag_mouse_move"});rcube_event.remove_listener({event:"mouseup",object:this,method:"drag_mouse_up"});if(bw.touch){rcube_event.remove_listener({event:"touchmove",object:this,method:"drag_mouse_move"});rcube_event.remove_listener({event:"touchend",object:this,method:"drag_mouse_up"})}this.del_dragfix();this.triggerEvent("dragend",a);return rcube_event.cancel(a)},column_drag_mouse_move:function(f){if(this.drag_start){var c,a=rcube_event.get_mouse_pos(f);if(!this.drag_mouse_start||(Math.abs(a.x-this.drag_mouse_start.x)<3&&Math.abs(a.y-this.drag_mouse_start.y)<3)){return false}if(!this.col_draglayer){var d=$(this.list).offset(),b=this.thead.rows[0].cells;d.top+=this.list.scrollTop+this.list.parentNode.scrollTop;this.col_draglayer=$("<div>").attr("id","rcmcoldraglayer").css(d).css({position:"absolute","z-index":2001,"background-color":"white",opacity:0.75,height:(this.frame.offsetHeight-2)+"px",width:(this.frame.offsetWidth-2)+"px"}).appendTo(document.body).append($("<div>").attr("id","rcmcolumnindicator").css({position:"absolute","border-right":"2px dotted #555","z-index":2002,height:(this.frame.offsetHeight-2)+"px"}));this.cols=[];this.list_pos=this.list_min_pos=d.left;for(c=0;c<b.length;c++){this.cols[c]=b[c].offsetWidth;if(this.column_fixed!==null&&c<=this.column_fixed){this.list_min_pos+=this.cols[c]}}}this.col_draglayer.show();this.col_drag_active=true;this.triggerEvent("column_dragstart")}if(this.col_drag_active&&this.col_draglayer){var c,h=0,g=rcube_event.get_mouse_pos(f);for(c=0;c<this.cols.length;c++){if(g.x>=this.cols[c]/2+this.list_pos+h){h+=this.cols[c]}else{break}}if(c==0&&this.list_min_pos>g.x){h=this.list_min_pos-this.list_pos}else{if(!this.list.rowcount&&c==this.cols.length){h-=2}}$("#rcmcolumnindicator").css({width:h+"px"});this.triggerEvent("column_dragmove",f?f:window.event)}this.drag_start=false;return false},column_drag_mouse_up:function(b){document.onmousemove=null;if(this.col_draglayer){(this.col_draglayer).remove();this.col_draglayer=null}rcube_event.remove_listener({event:"mousemove",object:this,method:"column_drag_mouse_move"});rcube_event.remove_listener({event:"mouseup",object:this,method:"column_drag_mouse_up"});this.del_dragfix();if(this.col_drag_active){this.col_drag_active=false;this.focus();this.triggerEvent("column_dragend",b);if(this.selected_column!==null&&this.cols&&this.cols.length){var a,d=0,c=rcube_event.get_mouse_pos(b);for(a=0;a<this.cols.length;a++){if(c.x>=this.cols[a]/2+this.list_pos+d){d+=this.cols[a]}else{break}}if(a!=this.selected_column&&a!=this.selected_column+1){this.column_replace(this.selected_column,a)}}}return rcube_event.cancel(b)},row_children:function(b){if(!this.rows[b]||!this.rows[b].has_children){return[]}var a=[],d=this.rows[b].depth,c=this.rows[b].obj.nextSibling;while(c){if(c.nodeType==1){if(r=this.rows[c.uid]){if(!r.depth||r.depth<=d){break}a.push(r.uid)}}c=c.nextSibling}return a},add_dragfix:function(){$("iframe").each(function(){$('<div class="iframe-dragdrop-fix"></div>').css({background:"#fff",width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1000}).css($(this).offset()).appendTo(document.body)})},del_dragfix:function(){$("div.iframe-dragdrop-fix").remove()},column_replace:function(g,f){if(!this.thead||!this.thead.rows){return}var a,b=this.thead.rows[0].cells,c=b[g],d=b[f],e=document.createElement("td");if(d){b[0].parentNode.insertBefore(e,d)}else{b[0].parentNode.appendChild(e)}b[0].parentNode.replaceChild(c,e);for(r=0,a=this.tbody.rows.length;r<a;r++){row=this.tbody.rows[r];c=row.cells[g];d=row.cells[f];e=document.createElement("td");if(d){row.insertBefore(e,d)}else{row.appendChild(e)}row.replaceChild(c,e)}if(this.subject_col==g){this.subject_col=f>g?f-1:f}else{if(this.subject_col<g&&f<=this.subject_col){this.subject_col++}else{if(this.subject_col>g&&f>=this.subject_col){this.subject_col--}}}if(this.fixed_header){this.init_header()}this.triggerEvent("column_replace")}};rcube_list_widget.prototype.addEventListener=rcube_event_engine.prototype.addEventListener;rcube_list_widget.prototype.removeEventListener=rcube_event_engine.prototype.removeEventListener;rcube_list_widget.prototype.triggerEvent=rcube_event_engine.prototype.triggerEvent;rcube_list_widget._instances=[];