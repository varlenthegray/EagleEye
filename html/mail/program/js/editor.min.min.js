function rcube_text_editor(j,h){var i=this,f=location.href.replace(/[?#].*$/,"").replace(/\/$/,""),g={selector:"#"+($("#"+h).is(".mce_editor")?h:"fake-editor-id"),cache_suffix:"s=4050800",theme:"modern",language:j.lang,content_css:rcmail.assets_path("program/resources/tinymce/content.css"),menubar:false,statusbar:false,toolbar_items_size:"small",extended_valid_elements:"font[face|size|color|style],span[id|class|align|style]",fontsize_formats:"8pt 9pt 10pt 11pt 12pt 14pt 18pt 24pt 36pt",relative_urls:false,remove_script_host:false,convert_urls:false,image_description:false,paste_webkit_style:"color font-size font-family",paste_data_images:true,browser_spellcheck:true};this.spellcheck_observer=function(){};if(j.spellchecker){this.spellchecker=j.spellchecker;if(j.spellcheck_observer){this.spellchecker.spelling_state_observer=this.spellcheck_observer=j.spellcheck_observer}}if(!tinymce.registered_request_token){tinymce.registered_request_token=true;tinymce.util.XHR.on("beforeSend",function(a){a.xhr.setRequestHeader("X-Roundcube-Request",rcmail.env.request_token)})}if(j.mode=="identity"){$.extend(g,{plugins:"autolink charmap code colorpicker hr image link paste tabfocus textcolor",toolbar:"bold italic underline alignleft aligncenter alignright alignjustify | outdent indent charmap hr link unlink image code forecolor | fontselect fontsizeselect",file_browser_callback:function(c,d,b,a){i.file_browser_callback(c,d,b)},file_browser_callback_types:"image"})}else{$.extend(g,{plugins:"autolink charmap code colorpicker directionality link lists image media nonbreaking paste table tabfocus textcolor searchreplace spellchecker",toolbar:"bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent ltr rtl blockquote | forecolor backcolor | fontselect fontsizeselect | link unlink table | $extra charmap image media | code searchreplace undo redo",spellchecker_rpc_url:f+"/?_task=utils&_action=spell_html&_remote=1",spellchecker_language:rcmail.env.spell_lang,accessibility_focus:false,file_browser_callback:function(c,d,b,a){i.file_browser_callback(c,d,b)},file_browser_callback_types:"image media"})}$.each(j.extra_plugins||[],function(){if(g.plugins.indexOf(this)<0){g.plugins=g.plugins+" "+this}});$.each(j.extra_buttons||[],function(){if(g.toolbar.indexOf(this)<0){g.toolbar=g.toolbar.replace("$extra","$extra "+this)}});$.each(j.disabled_plugins||[],function(){g.plugins=g.plugins.replace(this,"")});$.each(j.disabled_buttons||[],function(){g.toolbar=g.toolbar.replace(this,"")});g.toolbar=g.toolbar.replace("$extra","").replace(/\|\s+\|/g,"|");if(window.rcmail_editor_settings){$.extend(g,window.rcmail_editor_settings)}g.setup=function(a){a.on("init",function(b){i.init_callback(b)});a.on("SpellcheckStart SpellcheckEnd",function(b){i.spellcheck_active=b.type=="spellcheckstart";i.spellcheck_observer()});a.on("keypress",function(){rcmail.compose_type_activity++})};this.id=h;this.editor=null;tinymce.init(g);this.init_callback=function(a){this.editor=a.target;if(rcmail.env.action!="compose"){return}var b=$("#"+this.id),l=$("div.mce-toolbar-grp:first",b.parent()).height();if(l>200||l>b.height()){return setTimeout(function(){i.init_callback(a)},300)}var d={},c=rcube_find_object("_from"),e=rcmail.env.compose_focus_elem;if(rcmail.env.default_font){d["font-family"]=rcmail.env.default_font}if(rcmail.env.default_font_size){d["font-size"]=rcmail.env.default_font_size}if(d["font-family"]||d["font-size"]){$(this.editor.getBody()).css(d)}if(c&&c.type=="select-one"){if(!rcmail.env.identities_initialized){rcmail.change_identity(c)}if(e&&e.id!=this.id&&e.nodeName!="BODY"){window.focus();e.focus();rcmail.env.compose_focus_elem=null}}i.tabindex(e&&e.id==i.id);$(window).resize()};this.tabindex=function(c){if(rcmail.env.task=="mail"&&this.editor){var d=this.editor.getElement(),e=this.editor.getBody(),a=this.editor.getContentAreaContainer().childNodes[0];if(d&&a){a.tabIndex=d.tabIndex}if(d.tabIndex>0){var m=null,n=[":prev",":next"],b=tinymce.DOM.select("*[tabindex="+d.tabIndex+"]:not(iframe)");tinymce.each(b,function(l,k){if(l.id==i.id){m=k;return false}});if(m!==null){if(b[m-1]&&b[m-1].id){n[0]=b[m-1].id}if(b[m+1]&&b[m+1].id){n[1]=b[m+1].id}this.editor.settings.tabfocus_elements=n.join(",")}}if(bw.mz&&bw.vendver<25){$(e).prop("contenteditable",false).prop("contenteditable",true)}if(c){e.focus()}}};this.toggle=function(d,s){var b,e,a,v="\u0002\u0003",c=$("#"+this.id),t=rcmail.env.identity?rcmail.env.signatures[rcmail.env.identity]:null,q=t&&t.text&&t.text.length>1;this.spellcheck_stop();if(d){e=c.val();if(q){e=e.replace(/\r\n/,"\n");e=e.replace(t.text.replace(/\r\n/,"\n"),v)}var r=function(k){if(q){k=k.replace(v,'<div id="_rc_sig">'+t.html+"</div>")}c.val(k);tinymce.execCommand("mceAddEditor",false,i.id);if(i.editor){var l=$(i.editor.getBody());i.tabindex(true);i.editor.selection.setCursorLocation(l.children().first().get(0))}};if(!s){a=rcmail.plain2html(e,r)}else{r(e);a=true}}else{if(this.editor){if(q){if(b=this.editor.dom.get("_rc_sig")){b=b.innerHTML}this.editor.dom.setHTML("_rc_sig",v)}e=this.editor.getContent();var u=function(k){tinymce.execCommand("mceRemoveEditor",false,i.id);i.editor=null;if(q){k=k.replace(v,"\n"+t.text)}c.val(k).focus();rcmail.set_caret_pos(c.get(0),0)};if(!s){a=rcmail.html2plain(e,u)}else{u(c.val());a=true}if(!a&&b){this.editor.dom.setHTML("_rc_sig",b)}}}return a};this.spellcheck_start=function(){if(this.editor){tinymce.execCommand("mceSpellCheck",true);this.spellcheck_observer()}else{if(this.spellchecker&&this.spellchecker.spellCheck){this.spellchecker.spellCheck()}}};this.spellcheck_stop=function(){var a=this.editor;if(a){if(a.plugins&&a.plugins.spellchecker&&this.spellcheck_active){a.execCommand("mceSpellCheck",false);this.spellcheck_observer()}}else{if(a=this.spellchecker){if(a.state&&a.state!="ready"&&a.state!="no_error_found"){$(a.spell_span).trigger("click")}}}};this.spellcheck_state=function(){var a;if(this.editor){return this.spellcheck_active}else{if((a=this.spellchecker)&&a.state){return a.state!="ready"&&a.state!="no_error_found"}}};this.spellcheck_resume=function(a){var b=this.editor;if(b){b.plugins.spellchecker.markErrors(a)}else{if(b=this.spellchecker){b.prepare(false,true);b.processData(a)}}};this.get_language=function(){if(this.editor){return this.editor.settings.spellchecker_language||rcmail.env.spell_lang}else{if(this.spellchecker){return GOOGIE_CUR_LANG}}};this.set_language=function(a){var b=this.editor;if(b){b.settings.spellchecker_language=a}if(b=this.spellchecker){b.setCurrentLanguage(a)}};this.replace=function(e){var a,m=this.editor;if(!e){return false}if(m){m.getWin().focus();if($.type(e)=="object"&&("html" in e)){e=e.html;a="html"}else{if($.type(e)=="object"){e=e.text||""}e=rcmail.quote_html(e).replace(/\r?\n/g,"<br/>");a="text"}m.selection.setContent(e,{format:a})}else{if(m=rcube_find_object(this.id)){var d=$(m).is(":focus")?rcmail.get_input_selection(m):{start:0,end:0},c=m.value,b=c.substring(0,d.start),n=c.substring(d.end,c.length);if($.type(e)=="object"){e=e.text||""}m.value=b+e+n;rcmail.set_caret_pos(m,d.start+e.length);m.focus()}}};this.get_content=function(e){var a,l=this.editor,b="",d=false,c={refresh:true,selection:false,nosig:false,format:"html"};e=$.extend(c,e);if(e.refresh){this.spellcheck_stop()}if(l){if(e.selection){b=l.selection.getContent({format:e.format})}if(!b){b=l.getContent({format:e.format});d=e.format=="text"}}else{if(l=rcube_find_object(this.id)){if(e.selection&&$(l).is(":focus")){b=rcmail.get_input_selection(l).text}if(!b){b=l.value;d=true}}}if(d&&e.nosig){a=b.indexOf("-- \n");if(a>0){b=b.substring(0,a)}}return b};this.change_signature=function(u,d){var r,p,t=-1,c=$("#"+this.id),a=c.val(),b=rcmail.env.identity;if(!this.editor){if(d&&b&&rcmail.env.signatures&&rcmail.env.signatures[b]){b=rcmail.env.signatures[b].text;b=b.replace(/\r\n/g,"\n");t=rcmail.env.top_posting?a.indexOf(b):a.lastIndexOf(b);if(t>=0){a=a.substring(0,t)+a.substring(t+b.length,a.length)}}if(d&&rcmail.env.signatures&&rcmail.env.signatures[u]){b=rcmail.env.signatures[u].text;b=b.replace(/\r\n/g,"\n");if(t>=0){a=a.substring(0,t)+b+a.substring(t,a.length);p=t-1}else{if(!a||!rcmail.env.compose_mode){p=a.length;a+="\n\n"+b}else{if(rcmail.env.top_posting&&!rcmail.env.sig_below){if(pos=rcmail.get_caret_pos(c.get(0))){a=a.substring(0,pos)+"\n"+b+"\n\n"+a.substring(pos,a.length);p=pos}else{a="\n\n"+b+"\n\n"+a.replace(/^[\r\n]+/,"");p=0}}else{a=a.replace(/[\r\n]+$/,"");p=!rcmail.env.top_posting&&a.length?a.length+1:0;a+="\n\n"+b}}}}else{p=rcmail.env.top_posting?0:a.length}c.val(a);rcmail.set_caret_pos(c.get(0),p)}else{if(d&&rcmail.env.signatures){var v=this.editor.dom.get("_rc_sig");if(!v){var e=this.editor.getBody();v=$('<div id="_rc_sig"></div>').get(0);if(rcmail.env.top_posting&&!rcmail.env.sig_below&&rcmail.env.compose_mode&&(e.childNodes.length>1||$(e).text())){this.editor.getWin().focus();var s=this.editor.selection.getNode();$(v).insertBefore(s.nodeName=="BODY"?e.firstChild:s.nextSibling);$("<p>").append($("<br>")).insertBefore(v)}else{e.appendChild(v);r=rcmail.env.top_posting&&rcmail.env.compose_mode?e.firstChild:$(v).prev()}}v.innerHTML=rcmail.env.signatures[u]?rcmail.env.signatures[u].html:""}else{if(!rcmail.env.top_posting){r=$(this.editor.getBody()).children().last()}}}if(this.editor&&r&&r.length){this.editor.selection.setCursorLocation(r.get(0));this.editor.getWin().scroll(0,r.offset().top)}};this.save=function(){if(this.editor){this.editor.save()}};this.focus=function(){(this.editor||rcube_find_object(this.id)).focus()};this.file_browser_callback=function(q,s,c){var p,r,a,d,b,e=[];d=this.editor.windowManager.open({title:rcmail.get_label("select"+c),width:500,height:300,html:'<div id="image-selector-list"><ul></ul></div><div id="image-selector-form"><div id="image-upload-button" class="mce-widget mce-btn" role="button" tabindex="0"></div></div>',buttons:[{text:"Cancel",onclick:function(){i.file_browser_close()}}]});rcmail.env.file_browser_field=q;rcmail.env.file_browser_type=c;for(p in rcmail.env.attachments){if(r=i.file_browser_entry(p,rcmail.env.attachments[p])){e.push(r)}}if(e.length){$("#image-selector-list > ul").append(e).find("li:first").focus()}$("div.mce-abs-end",d.getEl()).append($('<div class="hint">').text($("div.hint",rcmail.gui_objects.uploadform).text()));r=$("#image-upload-button").append($("<span>").text(rcmail.get_label("add"+c)));a=r.parents(".mce-panel").find("button:last").parent();r.keydown(function(k){if(k.which==9){if(rcube_event.get_modifier(k)==SHIFT_KEY){$("#image-selector-list li:last").focus()}else{a.focus()}return false}});a.keydown(function(k){if(k.which==9){if(rcube_event.get_modifier(k)==SHIFT_KEY){r.focus()}else{$("#image-selector-list li:first").focus()}return false}});this.hack_file_input(r,rcmail.gui_objects.uploadform);if((window.XMLHttpRequest&&XMLHttpRequest.prototype&&XMLHttpRequest.prototype.sendAsBinary)||window.FormData){if(!rcmail.env.filedrop){rcmail.env.filedrop={}}if(rcmail.gui_objects.filedrop){rcmail.env.old_file_drop=rcmail.gui_objects.filedrop}rcmail.gui_objects.filedrop=$("#image-selector-form");rcmail.gui_objects.filedrop.addClass("droptarget").on("dragover dragleave",function(k){k.preventDefault();k.stopPropagation();$(this)[(k.type=="dragover"?"addClass":"removeClass")]("hover")}).get(0).addEventListener("drop",function(k){return rcmail.file_dropped(k)},false)}if(!rcmail.env.file_dialog_event){rcmail.env.file_dialog_event=true;rcmail.addEventListener("fileuploaded",function(k){var l;if(l=i.file_browser_entry(k.name,k.attachment)){$("#image-selector-list > ul").prepend(l);l.focus()}})}};this.file_browser_close=function(a){var b=$("#"+rcmail.env.file_browser_field);if(a){b.val(a)}this.editor.windowManager.close();b.focus();if(rcmail.env.old_file_drop){rcmail.gui_objects.filedrop=rcmail.env.old_file_drop}};this.file_browser_entry=function(d,e){if(!e.complete||!e.mimetype){return}if(rcmail.file_upload_id){rcmail.set_busy(false,null,rcmail.file_upload_id)}var a,n;switch(rcmail.env.file_browser_type){case"image":a=/^image\//i;break;case"media":a=/^video\//i;n="program/resources/tinymce/video.png";break;default:return}if(a.test(e.mimetype)){var b=rcmail.env.comm_path+"&_from="+rcmail.env.action,c=rcmail.env.compose_id?"&_id="+rcmail.env.compose_id+"&_action=display-attachment":"&_action=upload-display",o=b+c+"&_file="+d,p=$("<img>").attr({title:e.name,src:n?n:o+"&_thumbnail=1"});return $("<li>").attr({tabindex:0}).data("url",o).append($('<span class="img">').append(p)).append($('<span class="name">').text(e.name)).click(function(){i.file_browser_close($(this).data("url"))}).keydown(function(k){if(k.which==13){i.file_browser_close($(this).data("url"))}else{if(k.which==9){if(rcube_event.get_modifier(k)==SHIFT_KEY){if(!$(this).prev().focus().length){$("#image-upload-button").parents(".mce-panel").find("button:last").parent().focus()}}else{if(!$(this).next().focus().length){$("#image-upload-button").focus()}}return false}}})}};this.hack_file_input=function(b,e){var a,c=$(b),m=$("<input>").attr("name","_file[]"),d=$("<form>").attr({method:"post",enctype:"multipart/form-data"});if(e){m.attr("name",$('input[type="file"]',e).attr("name"));d.attr("action",$(e).attr("action")).append($("<input>").attr({type:"hidden",name:"_token",value:rcmail.env.request_token}))}function n(k){if(!a){a=c.offset()}m.css({top:(k.pageY-a.top-10)+"px",left:(k.pageX-a.left-10)+"px"})}m.attr({type:"file",multiple:"multiple",size:5,title:"",tabindex:-1}).change(function(){rcmail.upload_file(d,"upload")}).click(function(){setTimeout(function(){c.mouseleave()},20)}).css({opacity:0,cursor:"pointer",position:"relative",outline:"none"}).appendTo(d);if(navigator.userAgent.match(/Firefox|MSIE/)){m.css({marginLeft:"-80px"})}c.css({overflow:"hidden",cursor:"pointer"}).mouseenter(function(){this.__active=true}).mousemove(function(k){if(this.__active){n(k)}else{$(this).mouseleave()}}).mouseleave(function(){m.css({top:"-10000px",left:"-10000px"});this.__active=false}).click(function(k){if(!this.__active){this.__active=true;n(k);m.trigger(k)}}).keydown(function(k){if(k.which==13){m.trigger("click")}}).mouseleave().append(d)}};