function rcube_treelist_widget(H,X){X=$.extend({id_prefix:"",autoexpand:1000,selectable:false,scroll_delay:500,scroll_step:5,scroll_speed:20,save_state:false,keyboard:true,tabexit:true,parent_focus:false,check_droptarget:function(p){return !p.virtual}},X||{});var J=$(H),ah=X.data||[],T={},m=null,Z=false,w=false,B="",a=false,y={},ai=[],b,F,k=0,Y=0,x,D,aa,Q,A,u,P,o=(J.attr("id")||X.id_prefix||"0"),s=this;this.container=J;this.expand=c;this.collapse=v;this.select=W;this.render=G;this.reset=R;this.drag_start=L;this.drag_end=q;this.intersects=n;this.droppable=e;this.draggable=ac;this.update=E;this.insert=g;this.remove=z;this.get_item=O;this.get_node=S;this.get_selection=l;this.is_search=ad;this.reset_search=K;if(!J.length){return}if(X.data){I({children:ah})}else{ae()}if(m){j(t(m,true))}J.attr("role","tree").on("focusin",function(p){a=true}).on("focusout",function(p){a=false}).on("click","div.treetoggle",function(p){C(ab($(this).parent()));p.stopPropagation()}).on("click","li",function(aj){if($(aj.target).is("input")){return true}var p=X.selectable?T[ab($(this))]:null;if(p&&!p.virtual){W(p.id);aj.stopPropagation()}}).on("mousedown","a",function(ak){var aj=$(ak.target),p=T[ab(aj.closest("li"))];if(p&&p.virtual&&!aj.attr("href")){ak.preventDefault();ak.stopPropagation();return false}});if(X.searchbox){D=$(X.searchbox).off("keyup.treelist").on("keyup.treelist",function(ak){var aj=rcube_event.get_keycode(ak),p=rcube_event.get_modifier(ak);switch(aj){case 9:break;case 13:af(this.value,true);return rcube_event.cancel(ak);case 27:K();break;case 38:case 37:case 39:case 40:return;default:af(this.value,false);break}}).attr("autocomplete","off");D.parent().find("a.reset").off("click.treelist").on("click.treelist",function(p){K();return false})}$(document.body).on("keydown",V);if(X.parent_focus){J.parent(":not(body)").click(function(p){if($(p.target).is("input")){return true}if(!a&&m){$(O(m)).find(":focusable").first().focus()}else{if(!a){J.children("li:has(:focusable)").first().find(":focusable").first().focus()}}})}function v(am,p,al){var ak;if(ak=T[am]){ak.collapsed=typeof al=="undefined"||al;r(ak);if(p&&ak.children){for(var aj=0;aj<ak.children.length;aj++){v(ak.children[aj].id,p,al)}}s.triggerEvent(ak.collapsed?"collapse":"expand",ak);N(am,ak.collapsed)}}function c(aj,p){v(aj,p,false)}function C(ak,p){var aj;if(aj=T[ak]){v(ak,p,!aj.collapsed)}}function W(aj){if(s.triggerEvent("beforeselect",T[aj])===false){return}if(m){t(m,true).removeClass("selected").removeAttr("aria-selected");if(w){t(m).removeClass("selected").removeAttr("aria-selected")}m=null}if(!aj){return}var p=t(aj,true);if(p.length){p.addClass("selected").attr("aria-selected","true");m=aj;if(w){t(aj).addClass("selected").attr("aria-selected","true")}j(p)}s.triggerEvent("select",T[aj])}function l(){return m}function S(p){return T[p]}function O(aj,p){return t(aj,p).get(0)}function g(ak,al,aj){var p,am,an=al?T[al]:null;search_=w;if(T[ak.id]){return}state=d(ak.id,ak.collapsed);if(state!==undefined){ak.collapsed=state}if(an){ak.level=an.level+1;if(!an.children){an.children=[]}w=false;an.children.push(ak);am=t(al);if(an.children.length==1){f(an,null,am);p=t(ak.id)}else{p=f(ak,am.children("ul").first())}if(search_){w=search_;if(!p.is(":visible")){$("<li>").attr("id",p.attr("id")+"--xsR").attr("class",p.attr("class")).addClass("searchresult__").append(p.children().first().clone(true,true)).appendTo(J)}}}else{ak.level=0;ah.push(ak);p=f(ak,J)}T[ak.id]=ak;if(typeof ak.html=="object"){T[ak.id].html=t(ak.id,true).children()}if(aj){i(p,typeof aj=="string"?'[class~="'+aj+'"]':"")}}function E(ap,am,ak){var p,aj,an,ao,al=T[ap];if(al){p=t(ap);aj=p.parent();if(am.id||am.html||am.children||am.classes||am.parent){if(am.parent&&(an=T[am.parent])){if(aj.closest("li").length&&(ao=T[ab(aj.closest("li"))])){ao.children=$.grep(ao.children,function(ar,aq){return ar.id!=al.id})}aj=t(am.parent).children("ul").first();if(!an.children){an.children=[]}an.children.push(al)}else{if(am.parent!==undefined){aj=J}}$.extend(al,am);p=f(al,aj,p)}if(al.id!=ap){delete T[ap];T[al.id]=al}if(ak){i(p,typeof ak=="string"?'[class~="'+ak+'"]':"")}}}function i(p,al){var am,ak,aj=p.get(0).id,an=p.children().first().text().toUpperCase();p.parent().children("li"+al).each(function(ao,ap){if(ao==0){am=ap}if(ap.id==aj){}else{if(ap.id!=aj&&an>=$(ap).children().first().text().toUpperCase()){ak=ap}else{return false}}});if(ak){p.insertAfter(ak)}else{if(am&&am.id!=aj){p.insertBefore(am)}}ae()}function z(al){var ak,p,aj;if(ak=T[al]){p=t(al,true);aj=p.parent();p.remove();ak.deleted=true;delete T[al];if(w){t(al,false).remove()}if(!aj.children().length){aj.parent().find("div.treetoggle").remove();aj.remove()}return true}return false}function ae(){ah=h(J,0)}function r(aj){var p=t(aj.id,true);p.attr("aria-expanded",aj.collapsed?"false":"true");p.children("ul").first()[(aj.collapsed?"hide":"show")]();p.children("div.treetoggle").removeClass("collapsed expanded").addClass(aj.collapsed?"collapsed":"expanded");s.triggerEvent("toggle",aj)}function R(p){W("");ah=[];T={};Z=false;if(p){if(u){if(A){ac("destroy")}ac(u)}if(P){if(Q){e("destroy")}e(P)}ae()}else{J.html("")}K()}function af(ak,al){ak=String(ak).toLowerCase();if(!ak.length){return K()}else{if(ak==B&&!al){return 0}}var p=[];var aj=function(am){$.each(am,function(ap,aq){var an,ao;if(!aq.virtual&&!aq.deleted&&String(aq.text).toLowerCase().indexOf(ak)>=0&&p.indexOf(aq.id)<0){an=t(aq.id);if(an.data("filtered")){return}ao=$("<li>").attr("id",an.attr("id")+"--xsR").attr("class",an.attr("class")).addClass("searchresult__").append(an.children(":not(div.treetoggle,ul)").clone(true,true)).appendTo(J);p.push(aq.id)}if(aq.children&&aq.children.length){aj(aq.children)}})};if(w){$(J).children("li.searchresult__").remove();w=false}$(J).children("li").hide().removeClass("selected");aj(ah);w=true;s.triggerEvent("search",{query:ak,last:B,count:p.length,ids:p,execute:al||false});B=ak;return p.count}function K(){if(D){D.val("")}$(J).children("li.searchresult__").remove();$(J).children("li").filter(function(){return !$(this).data("filtered")}).show();w=false;s.triggerEvent("search",{query:false,last:B});B="";if(m){W(m)}}function ad(){return w}function G(){if(s.triggerEvent("renderBefore",ah)===false){return}J.html("");for(var p=0;p<ah.length;p++){ah[p].level=0;f(ah[p],J)}s.triggerEvent("renderAfter",J)}function f(an,am,al){if(an.deleted){return}var p=$("<li>").attr("id",X.id_prefix+(X.id_encode?X.id_encode(an.id):an.id)).attr("role","treeitem").addClass((an.classes||[]).join(" ")).data("id",an.id);if(al){al.replaceWith(p);if(am){p.appendTo(am)}}else{p.appendTo(am)}if(typeof an.html=="string"){p.html(an.html)}else{if(typeof an.html=="object"){p.append(an.html)}}if(!an.text){an.text=p.children().first().text()}if(an.virtual){p.addClass("virtual")}if(an.id==m){p.addClass("selected")}if(an.children&&an.children.length){p.attr("aria-expanded",an.collapsed?"false":"true");$('<div class="treetoggle '+(an.collapsed?"collapsed":"expanded")+'">&nbsp;</div>').appendTo(p);var ak=$("<ul>").appendTo(p).attr("class",an.childlistclass).attr("role","group");if(an.collapsed){ak.hide()}for(var aj=0;aj<an.children.length;aj++){an.children[aj].level=an.level+1;f(an.children[aj],ak)}}return p}function h(aj,ak){var p=[];aj.children("li").each(function(an,aq){var ap,al=$(aq),am=al.children("ul");var ao={id:ab(al),classes:String(al.attr("class")).split(" "),virtual:al.hasClass("virtual"),level:ak,html:al.children().first().get(0).outerHTML,text:al.children().first().text(),children:h(am,ak+1)};if(am.length){ao.childlistclass=am.attr("class")}if(ao.children.length){if(ao.collapsed===undefined){ao.collapsed=am.css("display")=="none"}ap=d(ao.id,ao.collapsed);if(ap!==undefined){ao.collapsed=ap;am[(ap?"hide":"show")]()}if(!al.children("div.treetoggle").length){$('<div class="treetoggle '+(ao.collapsed?"collapsed":"expanded")+'">&nbsp;</div>').appendTo(al)}al.attr("aria-expanded",ao.collapsed?"false":"true")}if(al.hasClass("selected")){al.attr("aria-selected","true");m=ao.id}al.data("id",ao.id);al.attr("role","treeitem").attr("aria-level",ao.level+1);if(ao.virtual){al.children("a:first").attr("tabindex","0")}p.push(ao);T[ao.id]=ao});aj.attr("role",ak==0?"tree":"group");return p}function I(p){if(p.id){T[p.id]=p}for(var aj=0;p.children&&aj<p.children.length;aj++){I(p.children[aj])}}function ab(p){var aj=String(p.attr("id")).replace(new RegExp("^"+(X.id_prefix)||"%"),"").replace(/--xsR$/,"");return X.id_decode?X.id_decode(aj):aj}function t(al,ak){var p=X.id_encode?X.id_encode(al):al,aj=w&&!ak?"--xsR":"";return $("#"+X.id_prefix+p+aj,J)}function j(aj){var p=J.parent(),ak=p.scrollTop(),al=aj.offset().top-p.offset().top;if(al<0||al+aj.height()>p.height()){p.scrollTop(al+ak)}}function N(ak,aj){if(X.save_state&&window.rcmail){var p="treelist-"+o;if(!aa){aa=rcmail.local_storage_get_item(p,{})}if(aa[ak]!=aj){aa[ak]=aj;rcmail.local_storage_set_item(p,aa)}}}function d(p){if(X.save_state&&window.rcmail){if(!aa){aa=rcmail.local_storage_get_item("treelist-"+o,{})}return aa[p]}return undefined}function V(an){var am=an.target||{},al=rcube_event.get_keycode(an);if(!a||am.nodeName=="INPUT"&&al!=38&&al!=40||am.nodeName=="TEXTAREA"||am.nodeName=="SELECT"){return true}switch(al){case 38:case 40:case 63232:case 63233:var p=X.keyboard?J.find(":focus").closest("li"):[];if(p.length){ag(p,(mod=al==38||al==63232?-1:1))}return rcube_event.cancel(an);case 37:case 39:var ao,ak,p=J.find(":focus").closest("li");if(p.length){ao=ab(p);ak=T[ao];if(ak&&ak.children.length&&ak.collapsed!=(al==37)){C(ao,rcube_event.get_modifier(an)==SHIFT_KEY)}}return false;case 9:if(X.keyboard&&X.tabexit){var aj=rcube_event.get_modifier(an)==SHIFT_KEY?"first":"last";M(J.find("li[role=treeitem]:has(a)")[aj]().find("a:"+aj))}break}return true}function ag(p,al,ak){var am=al<0?"prev":"next",ao=p[am](),aj,an;if(al>0&&!ak&&p.children("ul[role=group]:visible").length){p.children("ul").children("li:first").find("a:first").focus()}else{if(al<0&&!ak&&ao.children("ul[role=group]:visible").length){ao.children("ul").children("li:last").find("a:first").focus()}else{if(ao.length&&ao.find("a:first").focus().length){}else{an=p.parent().closest("li[role=treeitem]");if(an.length){if(al<0){an.find("a:first").focus()}else{ag(an,al,true)}}}}}}function M(p){if(p.length){var aj=J.parent().get(0)||{scrollTop:0},ak=aj.scrollTop||aj.scrollY;p.focus();aj.scrollTop=ak}}function L(al){if(!al&&Z){return}Z=true;var aj,ak,p,an=J.offset();k=bw.ie?0:window.pageYOffset;Y=J.parent().scrollTop();an.top+=Y;y={x1:an.left,y1:an.top,x2:an.left+J.width(),y2:an.top+J.height()};ai=[];for(var am in T){aj=t(am);ak=aj.children().first().get(0);if(ak&&(p=ak.offsetHeight)){an=$(ak).offset();an.top+=Y;ai[am]={x1:an.left,y1:an.top,x2:an.left+ak.offsetWidth,y2:an.top+p,on:am==F}}}if(J.height()>J.parent().height()){J.parent().mousemove(function(aq){var ao=0,ap=rcube_event.get_mouse_pos(aq);ap.y-=J.parent().offset().top;if(ap.y<25&&Y>0){ao=-1}else{if(ap.y>J.parent().height()-25){ao=1}}if(Z&&ao!=0){if(!x){x=window.setTimeout(function(){U(ao)},X.scroll_delay)}}else{if(x){window.clearTimeout(x);x=null}}}).mouseleave(function(){if(x){window.clearTimeout(x);x=null}})}}function q(){if(!Z){return}Z=false;x=null;if(b){clearTimeout(b);b=null;F=null}$("li.droptarget",J).removeClass("droptarget")}function U(aj){if(!Z){return}var p=Y;J.parent().get(0).scrollTop+=X.scroll_step*aj;Y=J.parent().scrollTop();x=null;if(Y!=p){x=window.setTimeout(function(){U(aj)},X.scroll_speed)}}function n(al,ak){var aj=bw.ie?-document.documentElement.scrollTop:k,an=J.parent().scrollTop(),p=null;al.top=al.y+an-aj;if(al.x<y.x1||al.x>=y.x2||al.top<y.y1||al.top>=y.y2){if(ak){$("li.droptarget",J).removeClass("droptarget")}return p}var ap,ao,am;for(ap in ai){ao=ai[ap];if(al.x>=ao.x1&&al.x<ao.x2&&al.top>=ao.y1&&al.top<ao.y2){am=T[ap];if(am.children&&am.children.length&&am.collapsed&&X.autoexpand&&F!=ap){if(b){clearTimeout(b)}F=ap;b=setTimeout(function(){c(F);L(true);F=null;if(Q){$.ui.ddmanager.prepareOffsets($.ui.ddmanager.current,null)}},X.autoexpand)}else{if(b&&F!=ap){clearTimeout(b);F=null;b=null}}if(X.check_droptarget(am)){if(ak){t(ap).addClass("droptarget");ao.on=true}p=ap}else{p=null}}else{if(ao.on){t(ap).removeClass("droptarget");ao.on=false}}}return p}function e(aj){if(!aj){aj={}}if($.type(aj)=="string"){if(aj=="destroy"){Q=null}$("li:not(.virtual)",J).droppable(aj);return this}P=aj;var p=$.extend({greedy:true,tolerance:"pointer",hoverClass:"droptarget",addClasses:false},aj);p.activate=function(al,ak){L();Q=ak;if(aj.activate){aj.activate(al,ak)}};p.deactivate=function(al,ak){q();Q=null;if(aj.deactivate){aj.deactivate(al,ak)}};p.over=function(al,ak){n(rcube_event.get_mouse_pos(al),false);if(aj.over){aj.over(al,ak)}};$("li:not(.virtual)",J).droppable(p);return this}function ac(aj){if(!aj){aj={}}if($.type(aj)=="string"){if(aj=="destroy"){A=null}$("li:not(.virtual)",J).draggable(aj);return this}u=aj;var p=$.extend({appendTo:"body",revert:"invalid",iframeFix:true,addClasses:false,cursorAt:{left:-20,top:5},create:function(al,ak){A=ak},helper:function(ak){return $("<div>").attr("id","rcmdraglayer").text($.trim($(ak.target).first().text()))}},aj);$("li:not(.virtual)",J).draggable(p);return this}}rcube_treelist_widget.prototype.addEventListener=rcube_event_engine.prototype.addEventListener;rcube_treelist_widget.prototype.removeEventListener=rcube_event_engine.prototype.removeEventListener;rcube_treelist_widget.prototype.triggerEvent=rcube_event_engine.prototype.triggerEvent;