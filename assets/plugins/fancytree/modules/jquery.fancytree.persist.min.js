/*!
 * jquery.fancytree.persist.js
 *
 * Persist tree status in cookiesRemove or highlight tree nodes, based on a filter.
 * (Extension module for jquery.fancytree.js: https://github.com/mar10/fancytree/)
 *
 * @depends: js-cookie or jquery-cookie
 *
 * Copyright (c) 2008-2019, Martin Wendt (http://wwWendt.de)
 *
 * Released under the MIT license
 * https://github.com/mar10/fancytree/wiki/LicenseInfo
 *
 * @version 2.30.2
 * @date 2019-01-13T08:17:01Z
 */
(function(a){if(typeof define==="function"&&define.amd){define(["jquery","./jquery.fancytree"],a)}else{if(typeof module==="object"&&module.exports){require("./jquery.fancytree");module.exports=a(require("jquery"))}else{a(jQuery)}}})(function(c){var b=null,h=window.localStorage?{get:function(k){return window.localStorage.getItem(k)},set:function(k,l){window.localStorage.setItem(k,l)},remove:function(k){window.localStorage.removeItem(k)}}:null,i=window.sessionStorage?{get:function(k){return window.sessionStorage.getItem(k)},set:function(k,l){window.sessionStorage.setItem(k,l)},remove:function(k){window.sessionStorage.removeItem(k)}}:null,e=c.ui.fancytree.assert,j="active",f="expanded",g="focus",d="selected";if(typeof Cookies==="function"){b={get:Cookies.get,set:function(k,l){Cookies.set(k,l,this.options.persist.cookie)},remove:Cookies.remove}}else{if(c&&typeof c.cookie==="function"){b={get:c.cookie,set:function(k,l){c.cookie.set(k,l,this.options.persist.cookie)},remove:c.removeCookie}}}function a(x,u,q,s,w){var r,v,n,m,t=false,p=x.options.persist.expandOpts,o=[],k=[];q=q||[];w=w||c.Deferred();for(r=0,n=q.length;r<n;r++){v=q[r];m=x.getNodeByKey(v);if(m){if(s&&m.isUndefined()){t=true;x.debug("_loadLazyNodes: "+m+" is lazy: loading...");if(s==="expand"){o.push(m.setExpanded(true,p))}else{o.push(m.load())}}else{x.debug("_loadLazyNodes: "+m+" already loaded.");m.setExpanded(true,p)}}else{k.push(v);x.debug("_loadLazyNodes: "+m+" was not yet found.")}}c.when.apply(c,o).always(function(){if(t&&k.length>0){a(x,u,k,s,w)}else{if(k.length){x.warn("_loadLazyNodes: could not load those keys: ",k);for(r=0,n=k.length;r<n;r++){v=q[r];u._appendKey(f,q[r],false)}}w.resolve()}});return w}c.ui.fancytree._FancytreeClass.prototype.clearPersistData=function(l){var k=this.ext.persist,m=k.cookiePrefix;l=l||"active expanded focus selected";if(l.indexOf(j)>=0){k._data(m+j,null)}if(l.indexOf(f)>=0){k._data(m+f,null)}if(l.indexOf(g)>=0){k._data(m+g,null)}if(l.indexOf(d)>=0){k._data(m+d,null)}};c.ui.fancytree._FancytreeClass.prototype.clearCookies=function(k){this.warn("'tree.clearCookies()' is deprecated since v2.27.0: use 'clearPersistData()' instead.");return this.clearPersistData(k)};c.ui.fancytree._FancytreeClass.prototype.getPersistData=function(){var l=this.ext.persist,m=l.cookiePrefix,n=l.cookieDelimiter,k={};k[j]=l._data(m+j);k[f]=(l._data(m+f)||"").split(n);k[d]=(l._data(m+d)||"").split(n);k[g]=l._data(m+g);return k};c.ui.fancytree.registerExtension({name:"persist",version:"2.30.2",options:{cookieDelimiter:"~",cookiePrefix:undefined,cookie:{raw:false,expires:"",path:"",domain:"",secure:false},expandLazy:false,expandOpts:undefined,fireActivate:true,overrideSource:true,store:"auto",types:"active expanded focus selected"},_data:function(l,m){var k=this._local.store;if(m===undefined){return k.get.call(this,l)}else{if(m===null){k.remove.call(this,l)}else{k.set.call(this,l,m)}}},_appendKey:function(p,t,o){t=""+t;var r=this._local,n=this.options.persist,k=n.cookieDelimiter,q=r.cookiePrefix+p,m=r._data(q),l=m?m.split(k):[],s=c.inArray(t,l);if(s>=0){l.splice(s,1)}if(o){l.push(t)}r._data(q,l.join(k))},treeInit:function(m){var l=m.tree,o=m.options,n=this._local,k=this.options.persist;n.cookiePrefix=k.cookiePrefix||"fancytree-"+l._id+"-";n.storeActive=k.types.indexOf(j)>=0;n.storeExpanded=k.types.indexOf(f)>=0;n.storeSelected=k.types.indexOf(d)>=0;n.storeFocus=k.types.indexOf(g)>=0;n.store=null;if(k.store==="auto"){k.store=h?"local":"cookie"}if(c.isPlainObject(k.store)){n.store=k.store}else{if(k.store==="cookie"){n.store=b}else{if(k.store==="local"){n.store=k.store==="local"?h:i}else{if(k.store==="session"){n.store=k.store==="local"?h:i}}}}e(n.store,"Need a valid store.");l.$div.on("fancytreeinit",function(v){if(l._triggerTreeEvent("beforeRestore",null,{})===false){return}var t,q,s,w,u,r=n._data(n.cookiePrefix+g),p=k.fireActivate===false;t=n._data(n.cookiePrefix+f);w=t&&t.split(k.cookieDelimiter);if(n.storeExpanded){q=a(l,n,w,k.expandLazy?"expand":false,null)}else{q=new c.Deferred().resolve()}q.done(function(){if(n.storeSelected){t=n._data(n.cookiePrefix+d);if(t){w=t.split(k.cookieDelimiter);for(s=0;s<w.length;s++){u=l.getNodeByKey(w[s]);if(u){if(u.selected===undefined||(k.overrideSource&&u.selected===false)){u.selected=true;u.renderStatus()}}else{n._appendKey(d,w[s],false)}}}if(l.options.selectMode===3){l.visit(function(x){if(x.selected){x.fixSelection3AfterClick();return"skip"}})}}if(n.storeActive){t=n._data(n.cookiePrefix+j);if(t&&(o.persist.overrideSource||!l.activeNode)){u=l.getNodeByKey(t);if(u){u.debug("persist: set active",t);u.setActive(true,{noFocus:true,noEvents:p})}}}if(n.storeFocus&&r){u=l.getNodeByKey(r);if(u){if(l.options.titlesTabbable){c(u.span).find(".fancytree-title").focus()}else{c(l.$container).focus()}}}l._triggerTreeEvent("restore",null,{})})});return this._superApply(arguments)},nodeSetActive:function(m,l,k){var o,n=this._local;l=l!==false;o=this._superApply(arguments);if(n.storeActive){n._data(n.cookiePrefix+j,this.activeNode?this.activeNode.key:null)}return o},nodeSetExpanded:function(m,l,k){var o,p=m.node,n=this._local;l=l!==false;o=this._superApply(arguments);if(n.storeExpanded){n._appendKey(f,p.key,l)}return o},nodeSetFocus:function(l,k){var n,m=this._local;k=k!==false;n=this._superApply(arguments);if(m.storeFocus){m._data(m.cookiePrefix+g,this.focusNode?this.focusNode.key:null)}return n},nodeSetSelected:function(o,n,l){var q,m,k=o.tree,r=o.node,p=this._local;n=n!==false;q=this._superApply(arguments);if(p.storeSelected){if(k.options.selectMode===3){m=c.map(k.getSelectedNodes(true),function(s){return s.key});m=m.join(o.options.persist.cookieDelimiter);p._data(p.cookiePrefix+d,m)}else{p._appendKey(d,r.key,r.selected)}}return q}});return c.ui.fancytree});