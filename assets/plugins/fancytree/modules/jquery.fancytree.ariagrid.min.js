/*!
 * jquery.fancytree.ariagrid.js
 *
 * Support ARIA compliant markup and keyboard navigation for tree grids with
 * embedded input controls.
 * (Extension module for jquery.fancytree.js: https://github.com/mar10/fancytree/)
 *
 * @requires ext-table
 *
 * Copyright (c) 2008-2019, Martin Wendt (http://wwWendt.de)
 *
 * Released under the MIT license
 * https://github.com/mar10/fancytree/wiki/LicenseInfo
 *
 * @version 2.30.2
 * @date 2019-01-13T08:17:01Z
 */
(function(a){if(typeof define==="function"&&define.amd){define(["jquery","./jquery.fancytree","./jquery.fancytree.table"],a)}else{if(typeof module==="object"&&module.exports){require("./jquery.fancytree.table");module.exports=a(require("jquery"))}else{a(jQuery)}}})(function(e){var n=e.ui.fancytree,l="fancytree-active-cell",i="fancytree-cell-mode",b="fancytree-cell-nav-mode",j=["allow","force","start","off"],g={text:["left","right","home","end","backspace"],number:["up","down","left","right","home","end","backspace"],checkbox:[],link:[],radiobutton:["up","down"],"select-one":["up","down"],"select-multiple":["up","down"]},c=["up","down","left","right","home","end"];function f(p,o){var q=o?o.uniqueId().attr("id"):"";p.$container.attr("aria-activedescendant",q)}function m(p,q){var s,r=q.get(0),o=0;p.children().each(function(){if(this===r){return false}s=e(this).prop("colspan");o+=s?s:1});return o}function k(q,s){var r,p=null,o=0;q.children().each(function(){if(o>=s){p=e(this);return false}r=e(this).prop("colspan");o+=r?r:1});return p}function h(p,o,t){var u=o.closest("td"),q=u.parent(),s=p.options,v=m(q,u),r=null;switch(t){case"left":r=s.rtl?u.next():u.prev();break;case"right":r=s.rtl?u.prev():u.next();break;case"up":case"down":while(true){q=t==="up"?q.prev():q.next();if(!q.length){break}if(q.is(":hidden")){continue}r=k(q,v);break}break;case"ctrl+home":r=k(q.siblings().first(),v);if(r.is(":hidden")){r=h(p,r.parent(),"down")}break;case"ctrl+end":r=k(q.siblings().last(),v);if(r.is(":hidden")){r=h(p,r.parent(),"up")}break;case"home":r=s.rtl?q.children("td").last():q.children("td").first();break;case"end":r=s.rtl?q.children("td").first():q.children("td").last();break}return r&&r.length?r:null}function a(o){if(o.$activeTd){return o.forceNavMode?"cell-nav":"cell-edit"}return"row"}function d(q){var p=document.createEvent("MouseEvent");p=new CustomEvent("click");var o=q.find("a")[0];o.dispatchEvent(p)}e.ui.fancytree._FancytreeClass.prototype.activateCell=function(q,r){var t,w,u,v,z=this,x=this.$activeTd||null,y=q?n.getNode(q):null,o=x?n.getNode(x):null,s=y||o,p=x?x.closest("tr"):null;s.debug("activateCell("+(x?x.text():"null")+" -> "+(q?q.text():"OFF"));if(q){n.assert(q.length,"Invalid active cell");t=m(e(y.tr),q);v=this._triggerNodeEvent("activateCell",y,r,{activeTd:z.$activeTd,colIdx:t,mode:null});if(v===false){return false}this.$container.addClass(i);this.$container.toggleClass(b,!!this.forceNavMode);u=q.closest("tr");if(x){if(x.is(q)){return}x.removeAttr("tabindex").removeClass(l);if(!p.is(u)){p.find(">td :input,a").attr("tabindex","-1")}}u.find(">td :input:enabled,a").attr("tabindex","0");y.setActive();q.addClass(l);this.$activeTd=q;w=q.find(":input:enabled,a");this.debug("Focus input",w);if(w.length){w.focus();f(this,w)}else{q.attr("tabindex","-1").focus();f(this,q)}}else{v=this._triggerNodeEvent("activateCell",o,r,{activeTd:null,colIdx:null,mode:"row"});if(v===false){return false}this.$container.removeClass(i+" "+b);if(x){x.removeAttr("tabindex").removeClass(l);p.find("td").blur().removeAttr("tabindex");p.find(">td :input,a").attr("tabindex","-1");this.$activeTd=null;this.activeNode.setFocus();f(this,u)}else{}}};e.ui.fancytree.registerExtension({name:"ariagrid",version:"2.30.2",options:{activateCellOnDoubelclick:true,cellFocus:"allow",label:"Tree Grid"},treeInit:function(p){var o=p.tree,r=p.options,q=r.ariagrid;this._requireExtension("table",true,true);if(!r.aria){e.error("ext-ariagrid requires `aria: true`")}if(e.inArray(q.cellFocus,j)<0){e.error("Invalid `cellFocus` option")}this._superApply(arguments);this.$activeTd=null;this.forceNavMode=true;this.$container.addClass("fancytree-ext-ariagrid").toggleClass(b,!!this.forceNavMode).attr("aria-label",""+q.label);this.$container.find("thead > tr > th").attr("role","columnheader");this.nodeColumnIdx=r.table.nodeColumnIdx;this.checkboxColumnIdx=r.table.checkboxColumnIdx;if(this.checkboxColumnIdx==null){this.checkboxColumnIdx=this.nodeColumnIdx}this.$container.on("focusin",function(t){var s=n.getNode(t.target),u=e(t.target).closest("td");if(s&&!u.is(o.$activeTd)&&e(t.target).is(":input")){s.debug("Activate cell on INPUT focus event");o.activateCell(u)}}).on("fancytreeinit",function(s,t){if(q.cellFocus==="start"||q.cellFocus==="force"){o.debug("Enforce cell-mode on init");o.debug("init",o.getActiveNode()||o.getFirstChild());(o.getActiveNode()||o.getFirstChild()).setActive(true,{cell:o.nodeColumnIdx});o.debug("init2",o.getActiveNode()||o.getFirstChild())}}).on("fancytreefocustree",function(t,u){if(q.cellFocus==="force"&&!o.activeTd){var s=o.getActiveNode()||o.getFirstChild();o.debug("Enforce cell-mode on focusTree event");s.setActive(true,{cell:0})}})},nodeClick:function(p){var s=p.targetType,o=p.tree,r=p.node,q=p.originalEvent,t=e(q.target).closest("td");o.debug("nodeClick: node: "+(r?r.title:"null")+", targetType: "+s+", target: "+(t.length?t.text():null)+", node was active: "+(r&&r.isActive())+", last cell: "+(o.$activeTd?o.$activeTd.text():null));if(o.$activeTd){o.activateCell(t);if(e(q.target).is(":input")){return}return false}return this._superApply(arguments)},nodeDblclick:function(p){var o=p.tree,s=p.options,r=s.ariagrid,q=p.originalEvent,t=e(q.target).closest("td");if(r.activateCellOnDoubelclick&&!o.$activeTd&&r.cellFocus==="allow"){o.activateCell(t);return false}return this._superApply(arguments)},nodeRenderStatus:function(o){var p,r=o.node,q=e(r.tr);p=this._super(o);if(r.parent){q.attr("aria-level",r.getLevel()).attr("aria-setsize",r.parent.children.length).attr("aria-posinset",r.getIndex()+1);if(this.$activeTd&&q.attr("aria-expanded")!=null){q.remove("aria-expanded");q.find("td").eq(this.nodeColumnIdx).attr("aria-expanded",r.isExpanded())}else{q.find("td").eq(this.nodeColumnIdx).removeAttr("aria-expanded")}}return p},nodeSetActive:function(r,q,p){var u,t=r.node,o=r.tree,s=e(t.tr);q=q!==false;t.debug("nodeSetActive("+q+")",p);if(q&&p&&p.cell!=null){if(typeof p.cell==="number"){u=k(s,p.cell)}else{u=e(p.cell)}o.activateCell(u);return}return this._superApply(arguments)},nodeKeydown:function(D){var A,u,y,r,C=null,E=D.tree,v=D.node,x=D.options,o=x.ariagrid,q=D.originalEvent,z=n.eventToString(q),s=e(q.target),B=this.$activeTd,t=B?B.closest("tr"):null,w=B?m(t,B):-1,p=B&&E.forceNavMode&&e.inArray(z,c)>=0;if(o.cellFocus==="off"){return this._superApply(arguments)}if(s.is(":input:enabled")){u=s.prop("type")}else{if(s.is("a")){u="link"}}if(B&&B.find(":checkbox:enabled").length===1){C=B.find(":checkbox:enabled");u="checkbox"}D.tree.debug("nodeKeydown("+z+"), activeTd: '"+(B&&B.text())+"', inputType: "+u);if(u&&z!=="esc"&&!p){A=g[u];if(A&&e.inArray(z,A)>=0){return}}switch(z){case"right":if(B){r=h(E,B,z);if(r){E.activateCell(r)}}else{if(v&&!v.isExpanded()&&v.hasChildren()!==false){break}else{r=e(v.tr).find(">td:first");E.activateCell(r)}}return false;case"left":case"home":case"end":case"ctrl+home":case"ctrl+end":case"up":case"down":if(B){r=h(E,B,z);if(!r&&"left right".indexOf(z)<0){return false}if(r||o.cellFocus!=="force"){E.activateCell(r)}return false}break;case"esc":if(B&&!E.forceNavMode){E.forceNavMode=true;E.debug("Enter cell-nav-mode");E.$container.toggleClass(b,!!E.forceNavMode);return false}else{if(B&&o.cellFocus!=="force"){E.activateCell(null);return false}}break;case"return":y=E._triggerNodeEvent("defaultGridAction",v,q,{activeTd:E.$activeTd?E.$activeTd[0]:null,colIdx:w,mode:a(E)});if(y===false){return false}if(B){if(w===this.nodeColumnIdx){v.toggleExpanded()}else{if(w===this.checkboxColumnIdx){v.toggleSelected()}else{if(C){C.prop("checked",!C.prop("checked"))}else{if(E.forceNavMode&&s.is(":input")){E.forceNavMode=false;E.$container.removeClass(b);E.debug("enable cell-edit-mode")}else{if(B.find("a").length===1){d(B)}}}}}}else{r=e(v.tr).find(">td:nth("+this.nodeColumnIdx+")");E.activateCell(r)}return false;case"space":if(B){if(w===this.checkboxColumnIdx){v.toggleSelected()}else{if(C){C.prop("checked",!C.prop("checked"))}}return false}break;default:}return this._superApply(arguments)},treeSetOption:function(p,q,s){var o=p.tree,r=o.options.ariagrid;if(q==="ariagrid"){if(s.cellFocus!==r.cellFocus){if(e.inArray(s.cellFocus,j)<0){e.error("Invalid `cellFocus` option")}}}return this._superApply(arguments)}});return e.ui.fancytree});