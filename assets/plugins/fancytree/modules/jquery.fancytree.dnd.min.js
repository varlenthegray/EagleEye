/*!
 * jquery.fancytree.dnd.js
 *
 * Drag-and-drop support (jQuery UI draggable/droppable).
 * (Extension module for jquery.fancytree.js: https://github.com/mar10/fancytree/)
 *
 * Copyright (c) 2008-2019, Martin Wendt (http://wwWendt.de)
 *
 * Released under the MIT license
 * https://github.com/mar10/fancytree/wiki/LicenseInfo
 *
 * @version 2.30.2
 * @date 2019-01-13T08:17:01Z
 */
(function(a){if(typeof define==="function"&&define.amd){define(["jquery","jquery-ui/ui/widgets/draggable","jquery-ui/ui/widgets/droppable","./jquery.fancytree"],a)}else{if(typeof module==="object"&&module.exports){require("./jquery.fancytree");module.exports=a(require("jquery"))}else{a(jQuery)}}})(function(e){var d=false,c="fancytree-drop-accept",f="fancytree-drop-after",j="fancytree-drop-before",k="fancytree-drop-over",b="fancytree-drop-reject",g="fancytree-drop-target";function i(l){return l===0?"":l>0?"+"+l:""+l}function a(){if(d){return}e.ui.plugin.add("draggable","connectToFancytree",{start:function(n,o){var l=e(this).data("ui-draggable")||e(this).data("draggable"),m=o.helper.data("ftSourceNode")||null;if(m){l.offset.click.top=-2;l.offset.click.left=+16;return m.tree.ext.dnd._onDragEvent("start",m,null,n,o,l)}},drag:function(l,r){var t,s,m,u=e(this).data("ui-draggable")||e(this).data("draggable"),o=r.helper.data("ftSourceNode")||null,n=r.helper.data("ftTargetNode")||null,q=e.ui.fancytree.getNode(l.target),p=o&&o.tree.options.dnd;if(l.target&&!q){s=e(l.target).closest("div.fancytree-drag-helper,#fancytree-drop-marker").length>0;if(s){m=o||n||e.ui.fancytree;m.debug("Drag event over helper: ignored.");return}}r.helper.data("ftTargetNode",q);if(p&&p.updateHelper){t=o.tree._makeHookContext(o,l,{otherNode:q,ui:r,draggable:u,dropMarker:e("#fancytree-drop-marker")});p.updateHelper.call(o.tree,o,t)}if(n&&n!==q){n.tree.ext.dnd._onDragEvent("leave",n,o,l,r,u)}if(q){if(!q.tree.options.dnd.dragDrop){}else{if(q===n){q.tree.ext.dnd._onDragEvent("over",q,o,l,r,u)}else{q.tree.ext.dnd._onDragEvent("enter",q,o,l,r,u);q.tree.ext.dnd._onDragEvent("over",q,o,l,r,u)}}}},stop:function(o,p){var m,l=e(this).data("ui-draggable")||e(this).data("draggable"),n=p.helper.data("ftSourceNode")||null,q=p.helper.data("ftTargetNode")||null,r=o.type==="mouseup"&&o.which===1;if(!r){m=n||q||e.ui.fancytree;m.debug("Drag was cancelled")}if(q){if(r){q.tree.ext.dnd._onDragEvent("drop",q,n,o,p,l)}q.tree.ext.dnd._onDragEvent("leave",q,n,o,p,l)}if(n){n.tree.ext.dnd._onDragEvent("stop",n,null,o,p,l)}}});d=true}function h(l){var m=l.options.dnd||null,n=l.options.glyph||null;if(m){a()}if(m&&m.dragStart){l.widget.element.draggable(e.extend({addClasses:false,appendTo:l.$container,containment:false,delay:0,distance:4,revert:false,scroll:true,scrollSpeed:7,scrollSensitivity:10,connectToFancytree:true,helper:function(q){var s,r,p,o=e.ui.fancytree.getNode(q.target);if(!o){return"<div>ERROR?: helper requested but sourceNode not found</div>"}p=o.tree.options.dnd;r=e(o.span);s=e("<div class='fancytree-drag-helper'><span class='fancytree-drag-helper-img' /></div>").css({zIndex:3,position:"relative"}).append(r.find("span.fancytree-title").clone());s.data("ftSourceNode",o);if(n){s.find(".fancytree-drag-helper-img").addClass(n.map._addClass+" "+n.map.dragHelper)}if(p.initHelper){p.initHelper.call(o.tree,o,{node:o,tree:o.tree,originalEvent:q,ui:{helper:s}})}return s},start:function(p,q){var o=q.helper.data("ftSourceNode");return !!o}},l.options.dnd.draggable))}if(m&&m.dragDrop){l.widget.element.droppable(e.extend({addClasses:false,tolerance:"intersect",greedy:false},l.options.dnd.droppable))}}e.ui.fancytree.registerExtension({name:"dnd",version:"2.30.2",options:{autoExpandMS:1000,draggable:null,droppable:null,focusOnClick:false,preventVoidMoves:true,preventRecursiveMoves:true,smartRevert:true,dropMarkerOffsetX:-24,dropMarkerInsertOffsetX:-16,dragStart:null,dragStop:null,initHelper:null,updateHelper:null,dragEnter:null,dragOver:null,dragExpand:null,dragDrop:null,dragLeave:null},treeInit:function(m){var l=m.tree;this._superApply(arguments);if(l.options.dnd.dragStart){l.$container.on("mousedown",function(o){if(m.options.dnd.focusOnClick){var n=e.ui.fancytree.getNode(o);if(n){n.debug("Re-enable focus that was prevented by jQuery UI draggable.")}setTimeout(function(){e(o.target).closest(":tabbable").focus()},10)}})}h(l)},_setDndStatus:function(p,v,o,s,q){var t,x,w="center",y=this._local,n=this.options.dnd,r=this.options.glyph,u=p?e(p.span):null,l=e(v.span),m=l.find("span.fancytree-title");if(!y.$dropMarker){y.$dropMarker=e("<div id='fancytree-drop-marker'></div>").hide().css({"z-index":1000}).prependTo(e(this.$div).parent());if(r){y.$dropMarker.addClass(r.map._addClass+" "+r.map.dropMarker)}}if(s==="after"||s==="before"||s==="over"){t=n.dropMarkerOffsetX||0;switch(s){case"before":w="top";t+=n.dropMarkerInsertOffsetX||0;break;case"after":w="bottom";t+=n.dropMarkerInsertOffsetX||0;break}x={my:"left"+i(t)+" center",at:"left "+w,of:m};if(this.options.rtl){x.my="right"+i(-t)+" center";x.at="right "+w}y.$dropMarker.toggleClass(f,s==="after").toggleClass(k,s==="over").toggleClass(j,s==="before").toggleClass("fancytree-rtl",!!this.options.rtl).show().position(e.ui.fancytree.fixPositionOptions(x))}else{y.$dropMarker.hide()}if(u){u.toggleClass(c,q===true).toggleClass(b,q===false)}l.toggleClass(g,s==="after"||s==="before"||s==="over").toggleClass(f,s==="after").toggleClass(j,s==="before").toggleClass(c,q===true).toggleClass(b,q===false);o.toggleClass(c,q===true).toggleClass(b,q===false)},_onDragEvent:function(q,z,y,B,w,p){var o,C,D,m,G,t,n,E,v,u=this.options,x=u.dnd,A=this._makeHookContext(z,B,{otherNode:y,ui:w,draggable:p}),F=null,s=this,l=e(z.span);if(x.smartRevert){p.options.revert="invalid"}switch(q){case"start":if(z.isStatusNode()){F=false}else{if(x.dragStart){F=x.dragStart(z,A)}}if(F===false){this.debug("tree.dragStart() cancelled");w.helper.trigger("mouseup").hide()}else{if(x.smartRevert){m=z[A.tree.nodeContainerAttrName].getBoundingClientRect();D=e(p.options.appendTo)[0].getBoundingClientRect();p.originalPosition.left=Math.max(0,m.left-D.left);p.originalPosition.top=Math.max(0,m.top-D.top)}l.addClass("fancytree-drag-source");e(document).on("keydown.fancytree-dnd,mousedown.fancytree-dnd",function(r){if(r.type==="keydown"&&r.which===e.ui.keyCode.ESCAPE){s.ext.dnd._cancelDrag()}else{if(r.type==="mousedown"){s.ext.dnd._cancelDrag()}}})}break;case"enter":if(x.preventRecursiveMoves&&z.isDescendantOf(y)){v=false}else{v=x.dragEnter?x.dragEnter(z,A):null}if(!v){F=false}else{if(e.isArray(v)){F={over:e.inArray("over",v)>=0,before:e.inArray("before",v)>=0,after:e.inArray("after",v)>=0}}else{F={over:v===true||v==="over",before:v===true||v==="before",after:v===true||v==="after"}}}w.helper.data("enterResponse",F);break;case"over":n=w.helper.data("enterResponse");E=null;if(n===false){}else{if(typeof n==="string"){E=n}else{C=l.offset();G={x:B.pageX-C.left,y:B.pageY-C.top};t={x:G.x/l.width(),y:G.y/l.height()};if(n.after&&t.y>0.75){E="after"}else{if(!n.over&&n.after&&t.y>0.5){E="after"}else{if(n.before&&t.y<=0.25){E="before"}else{if(!n.over&&n.before&&t.y<=0.5){E="before"}else{if(n.over){E="over"}}}}}if(x.preventVoidMoves){if(z===y){this.debug("    drop over source node prevented");E=null}else{if(E==="before"&&y&&z===y.getNextSibling()){this.debug("    drop after source node prevented");E=null}else{if(E==="after"&&y&&z===y.getPrevSibling()){this.debug("    drop before source node prevented");E=null}else{if(E==="over"&&y&&y.parent===z&&y.isLastSibling()){this.debug("    drop last child over own parent prevented");E=null}}}}}w.helper.data("hitMode",E)}}if(E!=="before"&&E!=="after"&&x.autoExpandMS&&z.hasChildren()!==false&&!z.expanded&&(!x.dragExpand||x.dragExpand(z,A)!==false)){z.scheduleAction("expand",x.autoExpandMS)}if(E&&x.dragOver){A.hitMode=E;F=x.dragOver(z,A)}o=F!==false&&E!==null;if(x.smartRevert){p.options.revert=!o}this._local._setDndStatus(y,z,w.helper,E,o);break;case"drop":E=w.helper.data("hitMode");if(E&&x.dragDrop){A.hitMode=E;x.dragDrop(z,A)}break;case"leave":z.scheduleAction("cancel");w.helper.data("enterResponse",null);w.helper.data("hitMode",null);this._local._setDndStatus(y,z,w.helper,"out",undefined);if(x.dragLeave){x.dragLeave(z,A)}break;case"stop":l.removeClass("fancytree-drag-source");e(document).off(".fancytree-dnd");if(x.dragStop){x.dragStop(z,A)}break;default:e.error("Unsupported drag event: "+q)}return F},_cancelDrag:function(){var l=e.ui.ddmanager.current;if(l){l.cancel()}}});return e.ui.fancytree});