/*!
 * jquery.fancytree.dnd5.js
 *
 * Drag-and-drop support (native HTML5).
 * (Extension module for jquery.fancytree.js: https://github.com/mar10/fancytree/)
 *
 * Copyright (c) 2008-2019, Martin Wendt (http://wwWendt.de)
 *
 * Released under the MIT license
 * https://github.com/mar10/fancytree/wiki/LicenseInfo
 *
 * @version 2.30.2
 * @date 2019-01-13T08:17:01Z
 */
(function(a){if(typeof define==="function"&&define.amd){define(["jquery","./jquery.fancytree"],a)}else{if(typeof module==="object"&&module.exports){require("./jquery.fancytree");module.exports=a(require("jquery"))}else{a(jQuery)}}})(function(f){var b=f.ui.fancytree,j=/Mac/.test(navigator.platform),y="fancytree-drag-source",h="fancytree-drag-remove",l="fancytree-drop-accept",g="fancytree-drop-after",u="fancytree-drop-before",o="fancytree-drop-over",n="fancytree-drop-reject",c="fancytree-drop-target",x="application/x-fancytree-node",v=null,m=null,k=null,r=null,q=null,w=null,p=null;function e(){m=null;k=null;if(r){r.removeClass(y+" "+h)}r=null;q=null;p=null}function s(z){return z===0?"":z>0?"+"+z:""+z}function a(A){var z;if(!A){return false}if(f.isPlainObject(A)){z={over:!!A.over,before:!!A.before,after:!!A.after}}else{if(f.isArray(A)){z={over:f.inArray("over",A)>=0,before:f.inArray("before",A)>=0,after:f.inArray("after",A)>=0}}else{z={over:A===true||A==="over",before:A===true||A==="before",after:A===true||A==="after"}}}if(Object.keys(z).length===0){return false}return z}function d(I,z){var F,C,H,G=I.options.dnd5,B=I.$scrollParent[0],E=G.scrollSensitivity,D=G.scrollSpeed,A=0;if(B!==document&&B.tagName!=="HTML"){F=I.$scrollParent.offset();C=B.scrollTop;if(F.top+B.offsetHeight-z.pageY<E){H=B.scrollHeight-I.$scrollParent.innerHeight()-C;if(H>0){B.scrollTop=A=C+D}}else{if(C>0&&z.pageY-F.top<E){B.scrollTop=A=C-D}}}else{C=f(document).scrollTop();if(C>0&&z.pageY-C<E){A=C-D;f(document).scrollTop(A)}else{if(f(window).height()-(z.pageY-C)<E){A=C+D;f(document).scrollTop(A)}}}if(A){I.debug("autoScroll: "+A+"px")}return A}function i(z,E){if(E.options.dnd5.scroll){d(E.tree,z)}if(!E.node){E.tree.warn("Ignored dragover for non-node");return w}var G,C,K,L,F=null,N=E.tree,M=N.options,J=M.dnd5,I=E.node,D=E.otherNode,H="center",A=f(I.span),B=A.find("span.fancytree-title");if(q===false){N.debug("Ignored dragover, since dragenter returned false.");return false}else{if(typeof q==="string"){f.error("assert failed: dragenter returned string")}else{C=A.offset();L=(z.pageY-C.top)/A.height();if(q.after&&L>0.75){F="after"}else{if(!q.over&&q.after&&L>0.5){F="after"}else{if(q.before&&L<=0.25){F="before"}else{if(!q.over&&q.before&&L<=0.5){F="before"}else{if(q.over){F="over"}}}}}if(J.preventVoidMoves){if(I===D){I.debug("Drop over source node prevented.");F=null}else{if(F==="before"&&D&&I===D.getNextSibling()){I.debug("Drop after source node prevented.");F=null}else{if(F==="after"&&D&&I===D.getPrevSibling()){I.debug("Drop before source node prevented.");F=null}else{if(F==="over"&&D&&D.parent===I&&D.isLastSibling()){I.debug("Drop last child over own parent prevented.");F=null}}}}}}}E.hitMode=F;if(F&&J.dragOver){J.dragOver(I,E);F=E.hitMode}w=F;if(F==="after"||F==="before"||F==="over"){G=J.dropMarkerOffsetX||0;switch(F){case"before":H="top";G+=J.dropMarkerInsertOffsetX||0;break;case"after":H="bottom";G+=J.dropMarkerInsertOffsetX||0;break}K={my:"left"+s(G)+" center",at:"left "+H,of:B};if(M.rtl){K.my="right"+s(-G)+" center";K.at="right "+H}v.toggleClass(g,F==="after").toggleClass(o,F==="over").toggleClass(u,F==="before").show().position(b.fixPositionOptions(K))}else{v.hide()}f(I.span).toggleClass(c,F==="after"||F==="before"||F==="over").toggleClass(g,F==="after").toggleClass(u,F==="before").toggleClass(l,F==="over").toggleClass(n,F===false);return F}function t(A,C){var B=C.options.dnd5,z=B.dropEffectDefault;if(B.dropEffect){return B.dropEffect(A,C)}if(j){if(A.metaKey&&A.altKey){return"link"}else{if(A.metaKey){return"move"}else{if(A.altKey){return"copy"}}}}else{if(A.ctrlKey){return"copy"}else{if(A.shiftKey){return"move"}else{if(A.altKey){return"link"}}}}return z}f.ui.fancytree.registerExtension({name:"dnd5",version:"2.30.2",options:{autoExpandMS:1500,dropMarkerInsertOffsetX:-16,dropMarkerOffsetX:-24,multiSource:false,dragImage:null,dropEffect:null,dropEffectDefault:"move",preventForeignNodes:false,preventNonNodes:false,preventRecursiveMoves:true,preventVoidMoves:true,scroll:true,scrollSensitivity:20,scrollSpeed:5,setTextTypeJson:false,dragStart:null,dragDrag:f.noop,dragEnd:f.noop,dragEnter:null,dragOver:f.noop,dragExpand:f.noop,dragDrop:f.noop,dragLeave:f.noop},treeInit:function(G){var F,B,E,H=G.tree,z=G.options,D=z.glyph||null,C=z.dnd5,A=b.getNode;if(f.inArray("dnd",z.extensions)>=0){f.error("Extensions 'dnd' and 'dnd5' are mutually exclusive.")}if(C.dragStop){f.error("dragStop is not used by ext-dnd5. Use dragEnd instead.")}if(C.dragStart){b.overrideMethod(G.options,"createNode",function(I,J){this._super.apply(this,arguments);J.node.span.draggable=true})}this._superApply(arguments);this.$container.addClass("fancytree-ext-dnd5");E=f("<span>").appendTo(this.$container);this.$scrollParent=E.scrollParent();E.remove();v=f("#fancytree-drop-marker");if(!v.length){v=f("<div id='fancytree-drop-marker'></div>").hide().css({"z-index":1000,"pointer-events":"none"}).prependTo("body");if(D){b.setSpanIcon(v[0],D.map._addClass,D.map.dropMarker)}}v.toggleClass("fancytree-rtl",!!z.rtl);if(C.dragStart){H.$container.on("dragstart drag dragend",function(M){var K,L=A(M),P=M.dataTransfer||M.originalEvent.dataTransfer,O={node:L,tree:H,options:H.options,originalEvent:M,dataTransfer:P,isCancelled:undefined},N=t(M,O),I=N==="move";switch(M.type){case"dragstart":if(!L){H.info("Ignored dragstart on a non-node.");return false}m=L;if(C.multiSource===false){k=[L]}else{if(C.multiSource===true){k=H.getSelectedNodes();if(!L.isSelected()){k.unshift(L)}}else{k=C.multiSource(L,O)}}r=f(f.map(k,function(Q){return Q.span}));r.addClass(y);K=JSON.stringify(L.toDict());try{P.setData(x,K);P.setData("text/html",f(L.span).html());P.setData("text/plain",L.title)}catch(J){H.warn("Could not set data (IE only accepts 'text') - "+J)}if(C.setTextTypeJson){P.setData("text",K)}else{P.setData("text",L.title)}P.effectAllowed="all";B=null;if(C.dragImage){C.dragImage(L,O)}else{F=f(L.span).find(".fancytree-title");if(k&&k.length>1){B=f("<span class='fancytree-childcounter'/>").text("+"+(k.length-1)).appendTo(F)}if(P.setDragImage){P.setDragImage(F[0],-10,-10)}}if(C.dragStart(L,O)!==false){return true}e();return false;case"drag":r.toggleClass(h,I);C.dragDrag(L,O);break;case"dragend":e();O.isCancelled=N==="none";v.hide();if(B){B.remove();B=null}C.dragEnd(L,O);break}})}if(C.dragEnter){H.$container.on("dragenter dragover dragleave drop",function(J){var S,K,N,I,Q,O=null,L=A(J),R=J.dataTransfer||J.originalEvent.dataTransfer,M={node:L,tree:H,options:H.options,hitMode:q,originalEvent:J,dataTransfer:R,otherNode:m||null,otherNodeList:k||null,otherNodeData:null,dropEffect:undefined,isCancelled:undefined};switch(J.type){case"dragenter":p=null;if(!L){H.debug("Ignore non-node "+J.type+": "+J.target.tagName+"."+J.target.className);q=false;break}f(L.span).addClass(o).removeClass(l+" "+n);N=f.inArray(x,R.types)>=0;if(C.preventNonNodes&&!N){L.debug("Reject dropping a non-node.");q=false;break}else{if(C.preventForeignNodes&&(!m||m.tree!==L.tree)){L.debug("Reject dropping a foreign node.");q=false;break}}v.show();if(C.preventRecursiveMoves&&L.isDescendantOf(M.otherNode)){L.debug("Reject dropping below own ancestor.");Q=false}else{I=C.dragEnter(L,M);Q=a(I)}q=Q;O=Q&&(Q.over||Q.before||Q.after);break;case"dragover":if(!L){H.debug("Ignore non-node "+J.type+": "+J.target.tagName+"."+J.target.className);break}w=i(J,M);O=!!w;if(w==="over"&&!L.expanded&&L.hasChildren()!==false){if(!p){p=Date.now()}else{if(C.autoExpandMS&&Date.now()-p>C.autoExpandMS&&(!C.dragExpand||C.dragExpand(L,M)!==false)){L.setExpanded()}}}else{p=null}break;case"dragleave":if(!L){H.debug("Ignore non-node "+J.type+": "+J.target.tagName+"."+J.target.className);break}if(!f(L.span).hasClass(o)){L.debug("Ignore dragleave (multi).");break}f(L.span).removeClass(o+" "+l+" "+n);L.scheduleAction("cancel");C.dragLeave(L,M);v.hide();break;case"drop":if(f.inArray(x,R.types)>=0){K=R.getData(x);H.info(J.type+": getData('application/x-fancytree-node'): '"+K+"'")}if(!K){K=R.getData("text");H.info(J.type+": getData('text'): '"+K+"'")}if(K){try{S=JSON.parse(K);if(S.title!==undefined){M.otherNodeData=S}}catch(P){}}H.debug(J.type+": nodeData: '"+K+"', otherNodeData: ",M.otherNodeData);f(L.span).removeClass(o+" "+l+" "+n);v.hide();M.hitMode=w;M.dropEffect=R.dropEffect;M.isCancelled=M.dropEffect==="none";C.dragDrop(L,M);J.preventDefault();e();break}if(O){J.preventDefault();return false}})}}});return f.ui.fancytree});